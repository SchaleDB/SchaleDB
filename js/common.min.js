const raid_level=[17,25,35,50,70,80],maxbond=[10,10,20,20,50],gear_minlevelreq=[0,15,35],raid_reward_coin=[[40,0],[60,0],[80,0],[100,10],[120,20],[140,40]],languages=["En","Jp","Kr","Tw","Cn","Th"],label_smalltext_threshold={En:11,Jp:5,Kr:5,Tw:5,Cn:5,Th:11},label_craft_smalltext_threshold={En:8,Jp:4,Kr:4,Tw:4,Cn:4,Th:8},label_enemy_smalltext_threshold={En:12,Jp:6,Kr:6,Tw:6,Cn:6,Th:12},label_raid_smalltext_threshold={En:20,Jp:10,Kr:11,Tw:10,Cn:10,Th:20},adaptaionAmount={0:"D",1:"C",2:"B",3:"A",4:"S",5:"SS"},terrain_dmg_bonus={D:.8,C:.9,B:1,A:1.1,S:1.2,SS:1.3},terrain_block_bonus={D:0,C:15,B:30,A:45,S:60,SS:75},skill_ex_upgrade_credits=[8e4,5e5,3e6,1e7],skill_upgrade_credits=[5e3,7500,6e4,9e4,3e5,45e4,15e5,24e5,4e6],gear_upgrade_credits=[5e5],enemy_rank={Champion:1,Elite:2,Minion:3},max_gifts=35,max_gifts_ssr=13,conquest_events=[815],module_list=["home","students","raids","stages","items","craft"],striker_bonus_coefficient={MaxHP:.1,AttackPower:.1,DefensePower:.05,HealPower:.05},gearId={Hat:1e3,Gloves:2e3,Shoes:3e3,Bag:4e3,Badge:5e3,Hairpin:6e3,Charm:7e3,Watch:8e3,Necklace:9e3},timeAttackBG={Shooting:"TimeAttack_SlotBG_02",Defense:"TimeAttack_SlotBG_01",Destruction:"TimeAttack_SlotBG_03"},searchDelay=100,altSprite=[10017,10033,10041,10042,10043,10048,20009,20014],buffIconKeys={AttackPower:"ATK",DefensePower:"DEF",CriticalPoint:"CriticalChance",CriticalDamageRate:"CriticalDamage",CriticalDamageResistRate:"CriticalDamageRateResist",DodgePoint:"Dodge",HealEffectivenessRate:"HealEffectiveness",AccuracyPoint:"HIT",MaxHP:"MAXHP",DefensePenetration:"Penetration",StabilityPoint:"Stability",RegenCost:"CostRegen"},studentStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","OppressionPower","OppressionResist","HealEffectivenessRate","AmmoCount"],studentStatListFull=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","OppressionPower","OppressionResist","HealEffectivenessRate","RegenCost","AttackSpeed","BlockRate","DefensePenetration","AmmoCount"],enemyStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","MoveSpeed","AmmoCount"],raidEnemyStatList=["MaxHP","AttackPower","DefensePower","DamagedRatio","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range"];let userLang,regionID;if(localStorage.getItem("language")&&languages.includes(localStorage.getItem("language")))userLang=localStorage.getItem("language");else{let e=window.navigator.language;switch(e.split("-")[0]){case"ja":userLang="Jp";break;case"ko":userLang="Kr";break;case"th":userLang="Th";break;case"zh":userLang=e.toLowerCase().startsWith("zh-cn")?"Cn":"Tw";break;default:userLang="En"}}regionID=localStorage.getItem("region")?localStorage.getItem("region"):0;let data={},json_list={common:getCacheVerResourceName("./data/common.min.json"),raids:getCacheVerResourceName("./data/raids.min.json"),stages:getCacheVerResourceName("./data/stages.min.json"),crafting:getCacheVerResourceName("./data/crafting.min.json"),summons:getCacheVerResourceName("./data/summons.min.json")},json_lang_list=getLanguageJSONList(userLang.toLowerCase());function getLanguageJSONList(e){return{localization:getCacheVerResourceName(`./data/${e}/localization.min.json`),students:getCacheVerResourceName(`./data/${e}/students.min.json`),enemies:getCacheVerResourceName(`./data/${e}/enemies.min.json`),items:getCacheVerResourceName(`./data/${e}/items.min.json`),furniture:getCacheVerResourceName(`./data/${e}/furniture.min.json`),equipment:getCacheVerResourceName(`./data/${e}/equipment.min.json`),currency:getCacheVerResourceName(`./data/${e}/currency.min.json`)}}const html_list={craft:getCacheVerResourceName("./html/craft.html"),home:getCacheVerResourceName("./html/home.html"),items:getCacheVerResourceName("./html/items.html"),raids:getCacheVerResourceName("./html/raids.html"),stages:getCacheVerResourceName("./html/stages.html"),students:getCacheVerResourceName("./html/students.html")},sort_functions={Default:(e,t)=>(e.DefaultOrder-t.DefaultOrder)*search_options.sortby_dir,Name:(e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))*search_options.sortby_dir,AttackPower100:(e,t)=>(t.AttackPower100-e.AttackPower100)*search_options.sortby_dir,DefensePower100:(e,t)=>(t.DefensePower100-e.DefensePower100)*search_options.sortby_dir,MaxHP100:(e,t)=>(t.MaxHP100-e.MaxHP100)*search_options.sortby_dir,HealPower100:(e,t)=>(t.HealPower100-e.HealPower100)*search_options.sortby_dir,CriticalPoint:(e,t)=>(t.CriticalPoint-e.CriticalPoint)*search_options.sortby_dir,StabilityPoint:(e,t)=>(t.StabilityPoint-e.StabilityPoint)*search_options.sortby_dir,Range:(e,t)=>(t.Range-e.Range)*search_options.sortby_dir,AccuracyPoint:(e,t)=>(t.AccuracyPoint-e.AccuracyPoint)*search_options.sortby_dir,DodgePoint:(e,t)=>(t.DodgePoint-e.DodgePoint)*search_options.sortby_dir,EXCost:(e,t)=>(find(t.Skills,"SkillType","ex")[0].Cost[4]-find(e.Skills,"SkillType","ex")[0].Cost[4])*search_options.sortby_dir,EXHits:(e,t)=>(find(t.Skills,"SkillType","ex")[0].DamageDist.length-find(e.Skills,"SkillType","ex")[0].DamageDist.length)*search_options.sortby_dir},itemSortFunctions={Default:(e,t)=>(e.Id-t.Id)*itemSearchOptions.sortby_dir,Name:(e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))*itemSearchOptions.sortby_dir};let loadedModule,student,studentList,studentCompare,statPreviewStarGrade,statPreviewWeaponGrade,statPreviewLevel,statPreviewWeaponLevel,statPreviewEquipment,statPreviewBondLevel,statPreviewBondAltLevel,statPreviewPassiveLevel,statPreviewExLevel,statPreviewIncludePassive,statPreviewIncludeExGear,statPreviewIncludeBond,statPreviewIncludeBondAlts,statPreviewIncludeEquipment,statPreviewIncludeBuffs,statPreviewViewSupportStats=!1,statPreviewSelectedChar=0,statPreviewExternalBuffs,statPreviewCustomBuffs,statPreviewSupportStats,studentCollection={},collectionUpdateTimeout,toastMessageTimeout,searchDelayTimeout,eventRefreshInterval,recalculationLimitTimeout,compareMode=!1,selectCompareMode=!1,showAltSprite=!1,showStudentListInfo=!1,loadedRaid,loadedItem,loadedItemType,loadedStage,loadedConquest,loadedCraftNode,loadedCraftId=0,itemList,furnitureList,equipmentList,loadedStageList=null,loadedItemList=null,loadObserver,region,student_bondalts,darkTheme,highContrast,enableCustomBuffs=!1,raid,selectedEnemy=0,raid_difficulty=0,ta_difficulty=0,gridItemDisplayStyle="detailed",showNodeProbability=!1,searchResultsCount=0,searchResultsSelection=0,studentSelectorModal,statPreviewModal,stageMapModal,scrolling=!1,scrollPosition={top:0,left:0,x:0,y:0},search_options={groupby:"none",sortby:"Default",sortby_dir:1,filter:{SquadType:{Main:!1,Support:!1},Collection:{Owned:!1,NotOwned:!1},TacticRole:{Tanker:!1,DamageDealer:!1,Healer:!1,Supporter:!1,Vehicle:!1},StarGrade:{3:!1,2:!1,1:!1},BulletType:{Explosion:!1,Pierce:!1,Mystic:!1},ArmorType:{LightArmor:!1,HeavyArmor:!1,Unarmed:!1},School:{Abydos:!1,Arius:!1,Gehenna:!1,Hyakkiyako:!1,Millennium:!1,RedWinter:!1,Shanhaijing:!1,Trinity:!1,Valkyrie:!1,SRT:!1,Others:!1},WeaponType:{SG:!1,SMG:!1,AR:!1,GL:!1,HG:!1,SR:!1,RG:!1,MG:!1,RL:!1,MT:!1},Position:{Front:!1,Middle:!1,Back:!1},IsLimited:{0:!1,1:!1,2:!1},StreetBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1},OutdoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1},IndoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1},Gear1:{Hat:!1,Gloves:!1,Shoes:!1},Gear2:{Bag:!1,Badge:!1,Hairpin:!1},Gear3:{Charm:!1,Necklace:!1,Watch:!1},BondGear:!1}},itemSearchOptions={sortby:"Default",sortby_dir:1,filter:{ItemCategory:{Material:!1,Coin:!1,Favor:!1,SecretStone:!1,Consumable:!1,Collectible:!1},FurnitureSubCategory:{Wallpaper:!1,Floor:!1,Background:!1,Table:!1,Chair:!1,Closet:!1,FloorDecoration:!1,WallDecoration:!1,Prop:!1,HomeAppliance:!1,Bed:!1,FurnitureEtc:!1},EquipmentCategory:{Exp:!1,WeaponExpGrowth:!1,Hat:!1,Gloves:!1,Shoes:!1,Bag:!1,Badge:!1,Hairpin:!1,Charm:!1,Necklace:!1,Watch:!1},Rarity:{N:!1,R:!1,SR:!1,SSR:!1},FurnitureSet:{100:!1,101:!1,102:!1,103:!1,104:!1,105:!1,106:!1,107:!1,108:!1},EquipmentTier:{1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1},FurnitureInteraction:!1}};class CharacterStats{constructor(e,t,a,s=[],i=0){let n;this.stats={},0==i?n=((t-1)/99).toFixed(4):1==i&&(n=CharacterStats.getTimeAttackLevelScale(t)),0==s.length&&(s=[[0,1e3,1200,1400,1700],[0,500,700,900,1400],[0,750,1e3,1200,1500]]);let l=1,r=1,o=1;for(let e=0;e<a;e++)l+=s[0][e]/1e4,r+=s[1][e]/1e4,o+=s[2][e]/1e4;let d=Math.ceil((Math.round((e.MaxHP1+(e.MaxHP100-e.MaxHP1)*n).toFixed(4))*r).toFixed(4)),c=Math.ceil((Math.round((e.AttackPower1+(e.AttackPower100-e.AttackPower1)*n).toFixed(4))*l).toFixed(4)),u=Math.round((e.DefensePower1+(e.DefensePower100-e.DefensePower1)*n).toFixed(4)),g=Math.ceil((Math.round((e.HealPower1+(e.HealPower100-e.HealPower1)*n).toFixed(4))*o).toFixed(4));this.level=t,this.terrain=[e.StreetBattleAdaptation?e.StreetBattleAdaptation:2,e.OutdoorBattleAdaptation?e.OutdoorBattleAdaptation:2,e.IndoorBattleAdaptation?e.IndoorBattleAdaptation:2],this.activeBuffs={},this.bulletType=e.BulletType,this.armorType=e.ArmorType,this.stats.MaxHP=[d,0,1],this.stats.AttackPower=[c,0,1],this.stats.DefensePower=[u,0,1],this.stats.HealPower=[g,0,1],this.stats.AccuracyPoint=[e.AccuracyPoint,0,1],this.stats.DodgePoint=[e.DodgePoint,0,1],this.stats.CriticalPoint=[e.CriticalPoint,0,1],this.stats.CriticalDamageRate=[e.CriticalDamageRate,0,1],this.stats.CriticalChanceResistPoint=[e.CriticalResistPoint?e.CriticalResistPoint:100,0,1],this.stats.CriticalDamageResistRate=[e.CriticalDamageResistRate?e.CriticalDamageResistRate:5e3,0,1],this.stats.StabilityPoint=[e.StabilityPoint,0,1],this.stats.AmmoCount=[e.AmmoCount,0,1],this.stats.AmmoCost=[e.AmmoCost,0,1],this.stats.Range=[e.Range,0,1],this.stats.RegenCost=[e.RegenCost,0,1],this.stats.DamagedRatio=[e.DamagedRatio,0,1],this.stats.HealEffectivenessRate=[1e4,0,1],this.stats.OppressionPower=[100,0,1],this.stats.OppressionResist=[100,0,1],this.stats.AttackSpeed=[1e4,0,1],this.stats.BlockRate=[0,0,1],this.stats.DefensePenetration=[0,0,1],this.stats.MoveSpeed=[e.MoveSpeed?e.MoveSpeed:200,0,1],this.stats.EnhanceExplosionRate=[1e4,0,1],this.stats.EnhancePierceRate=[1e4,0,1],this.stats.EnhanceMysticRate=[1e4,0,1],this.stats.ExtendBuffDuration=[1e4,0,1],this.stats.ExtendDebuffDuration=[1e4,0,1],this.stats.ExtendCCDuration=[1e4,0,1]}addBuff(e,t){let a=e.split("_");a.length>1?"Base"==a[1]?this.stats[a[0]][1]+=t:"Coefficient"==a[1]&&(this.stats[a[0]][2]+=t/1e4):this.stats[a[0]][1]+=t}addCharacterStatsAsBuff(e,t,a){this.stats[t][1]+=Math.round(e.getTotal(t)*(a/1e4))}getTotal(e){return Math.max(Math.round(((this.stats[e][0]+this.stats[e][1])*this.stats[e][2]).toFixed(4)),0)}getTotalString(e){let t=this.getTotal(e);return CharacterStats.isRateStat(e)?(t/100).toFixed(0).toLocaleString()+"%":t.toLocaleString()}getBaseString(e){let t=this.stats[e][0];return"DamagedRatio"==e?((t-1e4)/100).toFixed(0).toLocaleString()+"%":CharacterStats.isRateStat(e)?(t/100).toFixed(0).toLocaleString()+"%":t.toLocaleString()}getFlatString(e){const t=this.stats[e][1]>=0?"+":"";return t+this.stats[e][1].toLocaleString()}getCoefficientString(e){let t=100*(this.stats[e][2]-1);const a=t>=0?"+":"";return t=Math.abs(t)<100?t.toFixed(1):t.toFixed(0),a+parseFloat(t).toLocaleString()+"%"}getStrikerBonus(e){return Math.floor(this.getTotal(e)*striker_bonus_coefficient[e])}getStabilityMinDamageMod(){let e=this.getTotal("StabilityPoint");return e/(e+1e3)+.2}getStabilityMinDamage(){return parseFloat((100*this.getStabilityMinDamageMod()).toFixed(2))+"%"}getDefenseDamageReductionMod(e=0){let t;return 1e7/(6e3*Math.max(this.getTotal("DefensePower")-e,0)+1e7)}getDefenseDamageReduction(){return parseFloat((100*(1-this.getDefenseDamageReductionMod())).toFixed(2))+"%"}getCriticalHitChance(e){let t=this.getTotal("CriticalPoint");return Math.max(Math.min(parseFloat((100*(1-4e6/(6e3*(t-e)+4e6))).toFixed(2)),100),0)+"%"}addActiveBuffIcon(e,t,a=1){let s;s=(e=e.replace("_Coefficient","").replace("_Base","").replace("100","").replace("1","")).startsWith("Special_")?e:`${t>0?"Buff":"Debuff"}_${e in buffIconKeys?buffIconKeys[e]:e}`,s in this.activeBuffs?this.activeBuffs[s]+=a:this.activeBuffs[s]=a}renderActiveBuffs(e,t){let a="",s=0,i=0;for(const e in this.activeBuffs){const n=this.activeBuffs[e];s++,s<=t?a+=`<div class="active-buff"><img src="images/buff/Combat_Icon_${e}.png" width="22" height="26" class="">${n>1?`<span class="stack-count">${n}</span>`:""}</div>`:i++}i&&(a+=`<div class="px-1"><b>+${i}</b></div>`),$(e).toggle(s>0).html(a)}static isRateStat(e){return"Rate"==e.slice(-4)||e.startsWith("AttackSpeed")||e.startsWith("DamagedRatio")}static getTimeAttackLevelScale(e){return e<=1?0:2==e?.0101:e<=24?.0707:25==e?.0808:e<=39?.1919:40==e?.202:e<=64?.4444:65==e?.4545:e<=77?.7172:78==e?.7273:e>=79?((e-1)/99).toFixed(4):void 0}calculateDamage(e,t,a){const s=this.getTotal("AttackPower"),i=(2e4-e.getTotal("DamagedRatio"))/1e4,n=Math.max(Math.min(1-.02*(e.level-this.level),1),.4),l=e.getDefenseDamageReductionMod(),r=.8+.1*this.terrain[a],o=this.getEffectiveMod(e.armorType);return s*r*o*t*l*i*n}getEffectiveMod(e){let t=1;switch(this.bulletType){case"Explosion":"LightArmor"==e?t+=this.getTotal("EnhanceExplosionRate")/1e4:"Unarmed"==e&&(t-=.5);break;case"Pierce":"HeavyArmor"==e?t+=this.getTotal("EnhancePierceRate")/1e4:"LightArmor"==e&&(t-=.5);break;case"Mystic":"Unarmed"==e?t+=this.getTotal("EnhanceMysticRate")/1e4:"HeavyArmor"==e&&(t-=.5)}return t}}class Buffs{buffs=[];addBuff(e){this.buffs.push(e)}removeBuff(e){this.buffs.splice(e,1)}static getBuffAmountText(e){let t="";return e.Skill.Effect.Effects.forEach((a,s)=>{let i;""!=t&&(t+=", "),i="StackSame"in a?a.Value[0][e.Level-1]*e.Stacks:a.Value[e.Stacks-1][e.Level-1],t+=`<span data-effect='${s}'>${getStatName(a.Stat)} <b>${i<0?"":"+"}${ExternalBuffs.statValueToString(a.Stat,i)}</b></span>`}),t}static statValueToString(e,t){return e.endsWith("_Coefficient")?`${parseFloat((t/100).toFixed(1))}%`:t.toLocaleString()}}class ExternalBuffs extends Buffs{elements={controls:null,searchBox:null,searchButton:null,autoAddButton:null,searchResults:null};searchResultPopper=null;searchBoxTimeout=null;searchResultsSelection=0;searchResultsCount=0;constructor(e){super(),this.elements=e,$(this.elements.controls).on("input",'input[type="range"]',e=>{this.updateBuffLevel(e.currentTarget.dataset.index,e.currentTarget.value)}),$(this.elements.controls).on("click",".stack-count",e=>{this.updateStackCount(e.currentTarget.dataset.index)}),$(this.elements.controls).on("click","button.buff-remove",e=>{this.removeBuff(e.currentTarget.dataset.index)}),this.searchResultPopper=new ResultsPopper($(this.elements.searchBox).parent()[0],this.elements.searchResults),$(this.elements.searchResults).find(".search-list > div").on("click","div[data-student-id]",e=>{const t=find(data.students,"Id",e.currentTarget.dataset.studentId)[0],a=find(t.Skills,"SkillType",e.currentTarget.dataset.skillType)[0];this.addBuff(t.Id,a),$(e.currentTarget).toggleClass("disabled",!0),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchButton).on("click",e=>{$(this.elements.searchResults).is(":visible")?this.searchResultPopper.hide():(this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBuffs())}),$(this.elements.autoAddButton).on("click",e=>{$(this.elements.searchResults).is(":visible")&&this.searchResultPopper.hide();const t=student.Id;let a=[t];statPreviewSupportStats.supportStudents.forEach(e=>{a.push(e.student.Id)}),a.forEach(e=>{const a=find(data.students,"Id",e)[0];a.Skills.forEach(e=>{if("Effect"in e&&(a.Id==t||2==e.Effect.Type)){let t=!0;find(this.buffs,"StudentId",a.Id).forEach(a=>{a.Skill.SkillType==e.SkillType&&(t=!1)}),"gearnormal"!=e.SkillType||a.Gear.Released[regionID]||(t=!1),t&&this.addBuff(a.Id,e)}})})}),$(this.elements.searchBox).on("input",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBoxTimeout=setTimeout(()=>{""!=e.currentTarget.value?this.searchBuffs():this.searchResultPopper.hide()},100)}).on("blur",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),""==e.currentTarget.value&&this.searchResultPopper.hide()}).on("keyup keydown",e=>{switch(e.code){case"Enter":e.preventDefault(),$(this.elements.searchResults).is(":visible")&&"keyup"==e.type&&(0==this.searchResultsSelection&&this.searchResultsCount>0?$(this.elements.searchResults).find('.search-list-item[data-index="1"]').trigger("click"):$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`).trigger("click"));break;case"ArrowDown":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection<this.searchResultsCount){this.searchResultsSelection++,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"ArrowUp":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection>1){this.searchResultsSelection--,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"Escape":e.preventDefault(),$(this.elements.searchBox).val("").trigger("blur")}})}addBuff(e,t){const a="ex"==t.SkillType?5:10,s="StackSame"in t.Effect.Effects[0]?t.Effect.Effects[0].StackSame:t.Effect.Effects[0].Value.length;super.addBuff({StudentId:e,Skill:t,MaxLevel:a,Level:a,Stacks:1,MaxStacks:s}),this.renderControls(),recalculateStats()}removeBuff(e,t=!0){super.removeBuff(e),t&&(this.renderControls(),recalculateStats())}changeStudent(e){for(let t=0;t<this.buffs.length;t++){const a=this.buffs[t];1==a.Skill.Effect.Type&&a.StudentId!=e&&this.removeBuff(t--,!1)}this.renderControls(),$(this.elements.searchBox).val("").trigger("blur")}updateBuffLevel(e,t){const a=this.buffs[e],s=find(data.students,"Id",a.StudentId)[0];a.Level=t,$(this.elements.controls).find(`div[data-index='${e}'] .ba-slider-label.skill-level`).html(t==a.MaxLevel?'<img src="images/ui/ImageFont_Max.png">':`Lv.${t}`),$(this.elements.controls).find(`div[data-index='${e}'] .buff-description`).html(ExternalBuffs.getBuffAmountText(a)),recalculateStats()}updateStackCount(e){const t=this.buffs[e],a=find(data.students,"Id",t.StudentId)[0];++t.Stacks>t.MaxStacks&&(t.Stacks=1),$(this.elements.controls).find(`div[data-index='${e}'] .ba-slider-label.stack-count .label`).html(`&times;${t.Stacks}`),$(this.elements.controls).find(`div[data-index='${e}'] .buff-description`).html(ExternalBuffs.getBuffAmountText(t)),recalculateStats()}renderControls(){let e="";this.buffs.forEach((t,a)=>{const s=find(data.students,"Id",t.StudentId)[0];e+=`<div data-index="${a}" class="ba-panel p-2"><div class="mb-1 d-flex flex-row align-items-center gap-2"><div class="transferable-skill-icon align-self-start"><img class="student-icon" src="images/student/icon/${s.CollectionTexture}.png"><img class="skill-icon bg-skill ${s.BulletType.toLowerCase()}" src="images/skill/${t.Skill.Icon}.png"></div><div class="flex-fill"><h5>${getTranslatedString(t.Skill,"Name")} <small>(${translateUI(`student_skill_${t.Skill.SkillType}`)})</small></h5><p class="mb-0 buff-description" style="font-size: 0.875rem; line-height: 1rem;">${ExternalBuffs.getBuffAmountText(t)}</p></div><button class="btn btn-sm btn-dark stat-panel-btn-sm buff-remove no-wrap align-self-start" type="button" data-index="${a}"><i class="fa-solid fa-xmark"></i></button></div><div class="d-flex flex-row align-items-center gap-2">${t.MaxStacks>1?`<span class="ba-slider-label stack-count" data-index="${a}"><img class="stack-icon invert-light" src="images/skill/${t.Skill.Icon}.png"><span class="label">&times;${t.Stacks}</span></span>`:""}<input type="range" data-index="${a}" class="form-range flex-fill" value="${t.Level}" min="1" max="${t.MaxLevel}"><span class="ba-slider-label skill-level">${t.Level==t.MaxLevel?'<img src="images/ui/ImageFont_Max.png">':`Lv.${t.Level}`}</span></div></div>`}),$("#ba-statpreview-status-buffs").toggleClass("disabled",0==this.buffs.length),$("#ba-statpreview-status-buffs-count").text(`(${this.buffs.length})`),$(this.elements.controls).html(e)}searchBuffs(){let e="",t=0;const a=student.Id,s=this.elements.searchBox.value.toLowerCase();data.students.forEach(i=>{i.IsReleased[regionID]&&i.Skills.forEach(n=>{if("Effect"in n&&(i.Id==a||2==n.Effect.Type)&&(searchContains(s,getTranslatedString(i,"Name"))||searchContains(s,getTranslatedString(n,"Name")))){let a=!0;if(find(this.buffs,"StudentId",i.Id).forEach(e=>{e.Skill.SkillType==n.SkillType&&(a=!1)}),"gearnormal"!=n.SkillType||i.Gear.Released[regionID]||(a=!1),a){let a="";const s="ex"==n.SkillType?4:9;n.Effect.Effects.forEach(e=>{let t;""!=a&&(a+=", "),a+=`${getStatName(e.Stat)} <b>${e.Value[0][0]<0?"":"+"}${ExternalBuffs.statValueToString(e.Stat,e.Value[0][0])}`,t="StackSame"in e?e.Value[0][s]*e.StackSame:e.Value[e.Value.length-1][s],e.Value[0][0]!=t&&(a+=`~${ExternalBuffs.statValueToString(e.Stat,t)}`),a+="</b>"}),e+=ExternalBuffs.getSearchResultListItemHtml(i,n,a,++t)}}})}),this.searchResultsSelection=0,this.searchResultsCount=t,""!=e?this.searchResultPopper.show():this.searchResultPopper.hide(),$(this.elements.searchResults).find(".search-list > div").html(e)}toggleDisabled(e){$(this.elements.searchBox).add(this.elements.searchButton).add(this.elements.autoAddButton).attr("disabled",e),$(this.elements.controls).toggleClass("disabled",e)}static getSearchResultListItemHtml(e,t,a,s){return`<div class="search-list-item" data-index="${s}" data-student-id="${e.Id}" data-skill-type="${t.SkillType}"><div class="transferable-skill-icon me-2"><img class="student-icon" src="images/student/icon/${e.CollectionTexture}.png"><img class="skill-icon bg-skill ${e.BulletType.toLowerCase()}" src="images/skill/${t.Icon}.png"></div><div class="search-list-item-detail"><span class="skill-name">${getTranslatedString(t,"Name")} <small>(${translateUI(`student_skill_${t.SkillType}`)})</small></span><span class="skill-details">${a}</span></div></div>`}}class CustomBuffs extends Buffs{container;elements={controls:null,inputForm:null};isCoefficient=!1;constructor(e){super(),this.container=e,$(this.container).find("button.add-base").on("click",e=>{this.addBuff(!1)}),$(this.container).find("button.add-coefficient").on("click",e=>{this.addBuff(!0)}),$(this.container).on("click","button.buff-remove",e=>{this.removeBuff(e.currentTarget.dataset.index)}),this.renderForm()}renderForm(){let e;studentStatListFull.forEach(t=>{e+=`<option value="${t}">${getLocalizedString("Stat",t)}</option>`}),$(this.container).find(".stat-select").html(e)}renderControls(){let e="";this.buffs.forEach((t,a)=>{e+=`<div data-index="${a}" class="ba-panel p-2">\n            <div class="d-flex flex-row align-items-center gap-2">\n                <div class="flex-fill">\n                    ${""!=t.Name?`<h5 class="px-1">${t.Name}</h5>`:""}\n                    <div class="d-flex">\n                        <span class="stat-icon"><img class="invert-light" src="images/staticon/Stat_${t.Stat.split("_")[0]}.png"></span>\n                        <p class="mb-0">${getStatName(t.Stat)} <b>${t.Amount>=0?"+":""}${Buffs.statValueToString(t.Stat,t.Amount)}</b></p>\n                    </div>\n                </div>\n                <button class="btn btn-sm btn-dark buff-remove stat-panel-btn-sm no-wrap align-self-start" type="button" data-index="${a}">\n                    <i class="fa-solid fa-xmark"></i>\n                </button>\n            </div>\n        </div>`}),$(this.container).find(".controls").html(e)}addBuff(e){const t=$(this.container).find(".stat-select").val(),a=$(this.container).find(".amount-input").val(),s=$(this.container).find(".name-input").val();isNaN(parseInt(a))?toastMessage(`<i class="fa-solid fa-circle-xmark me-2"></i>${translateUI("toast_amount_invalid")}`,2500,"failure"):(e?super.addBuff({Name:s,Stat:t+"_Coefficient",Amount:parseInt(100*a)}):super.addBuff({Name:s,Stat:t+"_Base",Amount:parseInt(a)}),this.renderControls(),recalculateStats())}removeBuff(e){super.removeBuff(e),this.renderControls(),recalculateStats()}}class ResultsPopper{popperInstance=null;reference=null;popup=null;constructor(e,t){this.reference=e,this.popup=t,this.popperInstance=Popper.createPopper(e,t,{placement:"bottom-start",modifiers:[{name:"offset",options:{offset:[0,8]}},{name:"flip",options:{fallbackPlacements:["bottom-start","top-start"]}},{name:"preventOverflow",options:{boundary:$("ba-info-statpreview-panel .panel-sliders")[0]}},{name:"updateWidth",enabled:!0,phase:"main",fn:({state:e})=>{e.elements.popper.style.width=`${e.elements.reference.offsetWidth}px`}}]})}show(){$(this.popup).show(),this.popperInstance.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!0}]}))}hide(){$(this.popup).hide(),this.popperInstance.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!1}]}))}}class SupportStats{elements={controls:null,searchBox:null,searchButton:null,searchResults:null};supportStudents=[];searchBoxTimeout=null;searchResultsSelection=0;searchResultsCount=0;constructor(e){this.elements=e,this.searchResultPopper=new ResultsPopper($(this.elements.searchBox).parent()[0],this.elements.searchResults),$(this.elements.searchResults).find(".search-list > div").on("click","div[data-student-id]",e=>{this.addSupportStudent(e.currentTarget.dataset.studentId),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchButton).on("click",e=>{$(this.elements.searchResults).is(":visible")?this.searchResultPopper.hide():(this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchResultPopper.show(),this.searchStudents())}),$(this.elements.searchBox).on("input",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBoxTimeout=setTimeout(()=>{""!=e.currentTarget.value?(this.searchResultPopper.show(),this.searchStudents()):this.searchResultPopper.hide()},100)}).on("blur",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),""==e.currentTarget.value&&this.searchResultPopper.hide()}).on("keyup keydown",e=>{switch(e.code){case"Enter":e.preventDefault(),$(this.elements.searchResults).is(":visible")&&"keyup"==e.type&&(0==this.searchResultsSelection&&this.searchResultsCount>0?$(this.elements.searchResults).find('.search-list-item[data-index="1"]').trigger("click"):$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`).trigger("click"));break;case"ArrowDown":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection<this.searchResultsCount){this.searchResultsSelection++,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"ArrowUp":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection>1){this.searchResultsSelection--,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"Escape":e.preventDefault(),$(this.elements.searchBox).val("").trigger("blur")}}),$(this.elements.controls).on("input",".support-level input",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.supportStudents[t].level=e.currentTarget.value;const a=$(`#supportstats-controls-${t}`),s=this.supportStudents[t];$(`#supportstats-controls-${t} .support-level .ba-slider-label`).text(`Lv.${s.level}`),recalculateStatsWithDelay()}),$(this.elements.controls).on("click",".ba-statpreview-star",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=parseInt(e.currentTarget.dataset.val);this.supportStudents[t].starGrade=a,this.supportStudents[t].weaponStarGrade=0,this.updateControlValues(t)}),$(this.elements.controls).on("click",".ba-weaponpreview-star",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=parseInt(e.currentTarget.dataset.val);this.supportStudents[t].starGrade=5,this.supportStudents[t].weaponStarGrade=a,this.supportStudents[t].weaponLevel=20+10*a,this.updateControlValues(t)}),$(this.elements.controls).on("change",".support-bond",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=e.currentTarget.dataset.bond,s=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.supportStudents[t].bond[a]=s,this.updateControlValues(t)}).on("click",".support-bond",e=>{e.currentTarget.select()}),$(this.elements.controls).on("change",".support-stat-weapon-level",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.supportStudents[t].weaponLevel=a,this.updateControlValues(t)}),$(this.elements.controls).on("click",".support-gear .dropdown-item",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=$(e.currentTarget).closest("[data-slot]").data("slot");this.supportStudents[t].equipment[a-1]=parseInt(e.currentTarget.dataset.tier),this.updateControlValues(t)}),$(this.elements.controls).on("click",".support-ex-gear",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.supportStudents[t].gear=!this.supportStudents[t].gear,$(e.currentTarget).toggleClass("deactivated",!this.supportStudents[t].gear),this.updateControlValues(t)}),$(this.elements.controls).on("click",".student-remove",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.removeSupportStudent(t)}),$(this.elements.controls).on("click","button.panel-collapse",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");$(`#supportstats-controls-${t}`).hasClass("collapsing")||(this.supportStudents[t].panelOpen=!this.supportStudents[t].panelOpen,$(e.currentTarget).toggleClass("active",this.supportStudents[t].panelOpen),$(`#supportstats-controls-${t}`).collapse(this.supportStudents[t].panelOpen?"show":"hide"))})}showSearchResults(){$(this.elements.searchResults).show(),this.searchResultPopper.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!0}]}))}hideSearchResults(){$(this.elements.searchResults).hide(),this.searchResultPopper.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!1}]}))}addSupportStudent(e){const t=find(data.students,"Id",e)[0],a={student:t};if(e in studentCollection){const t=studentCollection[e];a.level=t.l,a.starGrade=t.s,a.weaponStarGrade=t.ws,a.weaponLevel=t.wl,a.equipment=[t.e1,t.e2,t.e3],a.gear=!1,a.bond=[t.b]}else a.level=data.common.regions[regionID].studentlevel_max,a.starGrade=5,a.weaponStarGrade=3,a.weaponLevel=data.common.regions[regionID].weaponlevel_max,a.equipment=[data.common.regions[regionID].gear1_max,data.common.regions[regionID].gear2_max,data.common.regions[regionID].gear3_max],a.gear=!1,a.bond=[20];t.FavorAlts.forEach(e=>{a.bond.push(e in studentCollection?studentCollection[e].b:1)}),a.panelOpen=!1,this.supportStudents.push(a),this.renderControls()}removeSupportStudent(e){this.supportStudents.splice(e,1),this.renderControls()}searchStudents(){let e="",t=0;const a=this.elements.searchBox.value.toLowerCase();data.students.forEach(s=>{"Support"==s.SquadType&&s.IsReleased[regionID]&&!this.supportStudents.find(e=>e.student.Id==s.Id)&&searchContains(a,getTranslatedString(s,"Name"))&&(e+=SupportStats.getSearchResultListItemHtml(s,++t))}),this.searchResultsSelection=0,this.searchResultsCount=t,""!=e?this.searchResultPopper.show():this.searchResultPopper.hide(),$(this.elements.searchResults).find(".search-list > div").html(e)}static getSearchResultListItemHtml(e,t){return`<div class="search-list-item" data-index="${t}" data-student-id="${e.Id}"><div class="search-list-item-icon"><img class="student-icon" src="images/student/icon/${e.CollectionTexture}.png"></div><div class="search-list-item-detail"><span>${getTranslatedString(e,"Name")}</span>${e.Id in studentCollection?`<span class="text-small"><i class="me-1 fa-solid fa-circle-check"></i><span>${translateUI("collection_owned")}</span></span>`:`<span class="text-small text-muted"><i class="me-1 fa-solid fa-circle-xmark"></i><span>${translateUI("collection_notowned")}</span></span>`}</div></div>`}renderControls(){let e="";this.supportStudents.forEach((t,a)=>{e+=`\n            <div data-index="${a}" class="ba-panel p-2">\n                <div class="d-flex flex-row align-items-center gap-2">\n                    <div class="support-stats">\n                        <img src="images/student/icon/${t.student.CollectionTexture}.png">\n                    </div>\n                    <div class="flex-fill">\n                        <h5 class="support-stats-name">${t.student.Name}</h5>\n                        <p class="support-stats-desc mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p>\n                    </div>\n                    <div class="d-flex flex-column justify-content-between align-self-stretch">\n                        <button class="btn btn-sm btn-dark stat-panel-btn-sm no-wrap student-remove" type="button"><i class="fa-solid fa-xmark"></i></button>\n                        <button class="btn btn-sm btn-dark stat-panel-btn-sm no-wrap panel-collapse ${t.panelOpen?" active":""}"><i class="fa-solid fa-gear"></i></button>\n                    </div>\n                </div>\n                <div class="collapse${t.panelOpen?" show":""}" id="supportstats-controls-${a}">\n                    <div class="d-flex flex-column gap-2 pt-3">\n                        <div class="d-flex flex-row align-items-center gap-2 support-level">\n                            <input type="range" class="form-range flex-fill" value="${t.level}" min="1" max="${data.common.regions[regionID].studentlevel_max}">\n                            <span class="ba-slider-label">Lv.${t.level}</span>\n                        </div>  \n                        <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2">\n                            <div class="d-inline-block ba-panel statpreview-stars px-2 d-flex align-items-center">\n                                <span class="ba-statpreview-star" data-val="1"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="4"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="5"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-weaponpreview-star ms-2" data-val="1"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-weaponpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-weaponpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>\n                            </div>\n                            ${SupportStats.renderBondControls(t.student)}\n                            <input style="display:none;" type="number" class="support-stat-weapon-level form-control" value="${t.weaponLevel}" min="1" step="1" max="50"></span>\n                            \n\n                            \n                        </div>\n                        <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2 text-bold">\n                            ${SupportStats.renderGearDropdown(1,t.student.Equipment[0])}\n                            ${SupportStats.renderGearDropdown(2,t.student.Equipment[1])}\n                            ${SupportStats.renderGearDropdown(3,t.student.Equipment[2])}`,"Released"in t.student.Gear&&t.student.Gear.Released[regionID]&&(e+=`\n                <button class="btn-pill support-ex-gear ${t.gear?"":"deactivated"}">\n                    <div class="icon"><img class="ba-item-n" src="images/gear/Gear_Icon_${t.student.Id}.png" width="28" height="28"></div>\n                    <i class="fa-regular fa-square off mx-2"></i>\n                    <i class="fa-solid fa-square-check on mx-2"></i>\n                </button>\n                `),e+="  </div>\n                    </div>\n                </div>\n            </div>\n            "}),$(this.elements.controls).html(e),this.supportStudents.forEach((e,t)=>this.updateControlValues(t,!1)),$(this.elements.searchBox).add(this.elements.searchButton).attr("disabled",this.supportStudents.length>=2),recalculateStats()}updateControlValues(e,t=!0){const a=$(`#supportstats-controls-${e}`),s=this.supportStudents[e];a.find(".support-level .ba-slider-label").text(`Lv.${s.level}`);for(let e=1;e<=5;e++)a.find(`.ba-statpreview-star[data-val="${e}"]`).toggleClass("active",e<=s.starGrade);for(let e=1;e<=3;e++)a.find(`.ba-weaponpreview-star[data-val="${e}"]`).toggleClass("active",e<=s.weaponStarGrade);for(let e=0;e<s.bond.length;e++)a.find(`.support-bond[data-bond="${e}"]`).val(s.bond[e]);a.find(".support-stat-weapon-level").attr("max",20+10*s.weaponStarGrade).val(s.weaponLevel).attr("disabled",0==s.weaponStarGrade),a.find(".support-gear .dropdown-item.active").removeClass("active");for(let e=1;e<=3;e++)a.find(`.support-gear[data-slot="${e}"] .dropdown-item[data-tier="${s.equipment[e-1]}"]`).addClass("active"),a.find(`.support-gear[data-slot="${e}"] .support-gear-icon`).attr("src",`images/equipment/Equipment_Icon_${s.student.Equipment[e-1]}_Tier${s.equipment[e-1]}.png`),a.find(`.support-gear[data-slot="${e}"] .support-gear-label`).text(`T${s.equipment[e-1]}`);t&&recalculateStats()}static renderGearDropdown(e,t){let a=`<div class="support-gear" data-slot="${e}">\n        <button class="btn-pill" data-bs-toggle="dropdown">\n            <div class="icon"><img class="support-gear-icon ba-item-n" src="" width="28" height="28"></div>\n            <span class="support-gear-label label"></span>\n            <i class="caret fa-solid fa-caret-down me-2"></i>\n        </button>\n        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-start">`;for(let s=1;s<=data.common.regions[regionID][`gear${e}_max`];s++)a+=`<li><a class="dropdown-item dropdown-item-icon" data-tier="${s}" href="javascript:;"><img class="ba-item-n" src="images/equipment/Equipment_Icon_${t}_Tier${s}.png"><span>T${s}</span></a></li>`;return a+="</ul></div>",a}static renderBondControls(e){let t=`<div class="d-flex align-items-center justify-content-center gap-2"><div class="input-small"><div class="icon bond-small"><img src="images/student/icon/${e.CollectionTexture}.png"></div><input data-bond="0" class="form-control support-bond" type="number" value="1" min="1" max="${data.common.regions[regionID].bondlevel_max}"></div>`;return e.FavorAlts.forEach((e,a)=>{const s=find(data.students,"Id",e)[0];t+=`<div class="input-small"><div class="icon bond-small"><img src="images/student/icon/${s.CollectionTexture}.png"></div><input data-bond="${a+1}" class="form-control support-bond" type="number" value="1" min="1" max="${data.common.regions[regionID].bondlevel_max}"></div>`}),t+="</div>",t}}let loadPromise=loadJSON(Object.assign(json_list,json_lang_list),e=>{data=e});function loadModuleFromURL(e){var t=new URL(window.location.href).searchParams;t.get("chara")?loadStudent(t.get("chara")):t.get("charaid")?loadStudentById(t.get("charaid")):t.get("item")?loadItem(t.get("item")):t.get("raid")?loadRaid(t.get("raid")):t.get("stage")?loadStage(t.get("stage")):t.get("craftnode")?loadCraft(t.get("craftnode")):e?loadLastModule():loadModule("home")}function loadLastModule(){localStorage.getItem("module")&&module_list.includes(localStorage.getItem("module"))?loadModule(localStorage.getItem("module")):loadModule("home")}function loadModule(e,t=null){if(loadObserver&&loadObserver.disconnect(),$(".modal").not("#modal-changelog").modal("hide"),clearInterval(eventRefreshInterval),"students"==e)loadedModule="students",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-students").addClass("active"),$("#loaded-module").load(html_list.students,(function(){loadRegion(regionID),loadLanguage(userLang),$("#statpreview-buff-custom").toggle(enableCustomBuffs),studentSelectorModal=new bootstrap.Modal(document.getElementById("ba-student-modal-students"),{}),document.getElementById("ba-student-modal-students").addEventListener("hidden.bs.modal",(function(e){selectCompareMode=!1})),generateStatTable("#ba-student-stat-table",studentStatList,6),generateStatTable("#ba-student-stat-modal-table",studentStatListFull,12,1),generateStatTable("#ba-weapon-stat-table",["AttackPower","MaxHP","HealPower"],6),statPreviewViewSupportStats=!1,compareMode=!1,updateCompareModeControl(),selectCompareMode=!1,$("#ba-statpreview-levelrange").val(statPreviewLevel),changeStatPreviewLevel(document.getElementById("ba-statpreview-levelrange"),!1),$("#ba-statpreview-weapon-range").val(statPreviewWeaponLevel),$("#ba-statpreview-gear1-range").val(statPreviewEquipment[0]),$("#ba-statpreview-gear2-range").val(statPreviewEquipment[1]),$("#ba-statpreview-gear3-range").val(statPreviewEquipment[2]),$("#ba-statpreview-passiveskill-range").val(statPreviewPassiveLevel),$("#ba-statpreview-summon-range").val(statPreviewExLevel),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0),$(".tooltip").tooltip("hide"),statPreviewExternalBuffs=new ExternalBuffs({controls:$("#statpreview-buff-transferable-controls")[0],searchBox:$("#statpreview-buff-transferable-search-text")[0],searchButton:$("#statpreview-buff-transferable-search-btn")[0],autoAddButton:$("#statpreview-buff-transferable-autoadd-btn")[0],searchResults:$("#statpreview-buff-transferable-search .search-list-container")[0]}),statPreviewCustomBuffs=new CustomBuffs($("#statpreview-buff-custom")[0]),statPreviewSupportStats=new SupportStats({controls:$("#statpreview-supportstats-controls")[0],searchBox:$("#statpreview-supportstats-search-text")[0],searchButton:$("#statpreview-supportstats-search-btn")[0],searchResults:$("#statpreview-supportstats-search-list")[0]});var e=new URL(window.location.href).searchParams;null!=t?loadStudent(t):e.has("chara")?loadStudent(e.get("chara")):e.has("charaid")?loadStudentById(e.get("charaid")):localStorage.getItem("chara")?loadStudent(localStorage.getItem("chara")):loadStudent("Aru"),populateStudentList(),localStorage.getItem("chara_groupby")?searchOptionSet("groupby",localStorage.getItem("chara_groupby"),!1):searchOptionSet("groupby","none",!1),localStorage.getItem("chara_sortby_dir")&&(search_options.sortby_dir=parseInt(localStorage.getItem("chara_sortby_dir"))),localStorage.getItem("chara_sortby")?searchSetOrder(localStorage.getItem("chara_sortby"),!1,!1):searchSetOrder("Default",!1,!1),localStorage.getItem("show_student_list_info")&&(showStudentListInfo="true"==localStorage.getItem("show_student_list_info")),Object.entries(search_options.filter).forEach(e=>{"boolean"==typeof e[1]?$(`#ba-student-search-filter-${e[0].toLowerCase()}`).toggleClass("active",e[1]):Object.entries(e[1]).forEach(t=>{$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",t[1])})}),activeFilters=getNumActiveFilters(),$("#ba-student-search-filter-amount").text(0==activeFilters?"":` (${activeFilters})`),$("#ba-student-search-reset").toggle(activeFilters>0||""!=$("#ba-student-search-text").val()),$("#ba-student-search-filters-panel").on("show.bs.collapse",(function(){$("#student-search-filters-btn").toggleClass("active",!0)})).on("hide.bs.collapse",(function(){$("#student-search-filters-btn").toggleClass("active",!1)})),$(".summon-list").on("click",".dropdown-item",(function(){changeStudentSummon($(this).data("summon-id"))})),updateStudentList(updateSortMethod=!0),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),$("#ba-student, #ba-student-list-btn").show(),$("#ba-statpreview-status-equipment").tooltip({title:getBasicTooltip(translateUI("tooltip_equipment_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-buffs").tooltip({title:getBasicTooltip(translateUI("tooltip_buffs_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-passive-level").tooltip({title:getBasicTooltip(translateUI("tooltip_passiveskill_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-strikerbonus").tooltip({title:getBasicTooltip(translateUI("tooltip_supportstats")),placement:"top",html:!0}),$("#ba-student-modal-students").on("shown.bs.modal",(function(e){"shortcut"===e.relatedTarget&&$("#ba-student-search-text").trigger("focus")})),$("#ba-student-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(updateStudentList,100)})),$("#ba-student-toggle-sprite-btn").on("click",e=>{showAltSprite=!showAltSprite,$("#ba-student-img").attr("src",`images/student/portrait/Portrait_${student.DevName}${showAltSprite?"_2":""}.webp`)}),$("#ba-student-search-showinfo").tooltip({title:getBasicTooltip(translateUI("student_search_info")),html:!0,placement:"top"}),$("#ba-student-search-showinfo").toggleClass("active",showStudentListInfo),$("#ba-student-search-showinfo").on("click",(function(){showStudentListInfo=!showStudentListInfo,localStorage.setItem("show_student_list_info",showStudentListInfo),$(this).toggleClass("active",showStudentListInfo).tooltip("hide"),$("#student-select-grid").toggleClass("show-info",showStudentListInfo)})),$("#student-select-grid").toggleClass("show-info",showStudentListInfo),$("#ba-student-modal-statpreview").on("shown.bs.modal hidden.bs.modal",recalculateStats),window.scrollTo({top:0,left:0,behavior:"instant"})}));else if("items"==e){var a;loadedModule="items",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-items").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_MainOffice_Night.jpg",$("#loaded-module").load(html_list.items,(function(){loadRegion(regionID),loadLanguage(userLang),loadedItemList=null,$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;switch(localStorage.getItem("item_sortby_dir")&&(itemSearchOptions.sortby_dir=parseInt(localStorage.getItem("item_sortby_dir"))),localStorage.getItem("item_sortby")?searchSetOrderItems(localStorage.getItem("item_sortby"),!1,!1):searchSetOrderItems("Default",!1,!1),localStorage.getItem("grid_item_display_style")&&(gridItemDisplayStyle=localStorage.getItem("grid_item_display_style")),$("#item-search-displaytype-"+gridItemDisplayStyle).addClass("active"),gridItemDisplayStyle){case"detailed":$("#item-select-grid").addClass("items");break;case"compact":$("#item-select-grid").addClass("items-compact")}$("#item-select-grid").on("click","div[data-itemid]",(function(e){loadItem($(this).data("itemid"))})),Object.entries(itemSearchOptions.filter).forEach(e=>{"boolean"==typeof e[1]?$(`#item-search-filter-${e[0].toLowerCase()}`).toggleClass("active",e[1]):Object.entries(e[1]).forEach(t=>{$(`#item-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",t[1])})}),null!=t?loadItem(t):e.has("item")?loadItem(e.get("item")):localStorage.getItem("item")?loadItem(localStorage.getItem("item")):loadItem(1),$("#item-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(updateItemList,100)})),$("#item-search-filters-panel").on("show.bs.collapse",(function(){$("#item-search-filters-btn").toggleClass("active",!0)})).on("hide.bs.collapse",(function(){$("#item-search-filters-btn").toggleClass("active",!1)})),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("raids"==e){loadedModule="raids",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-raids").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src="images/background/BG_Raid.jpg",$("#loaded-module").load(html_list.raids,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");let e=new URL(window.location.href).searchParams;generateStatTable("#ba-raid-enemy-stats",raidEnemyStatList,6),generateStatTable("#ba-stage-enemy-stat-table",enemyStatList,6),populateRaidList(),null!=t?loadRaid(t):e.has("raid")?loadRaid(e.get("raid")):localStorage.getItem("raid")?loadRaid(localStorage.getItem("raid")):loadRaid(1),1==regionID&&$("#ba-raid-list-tab-worldraid").hide(),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("stages"==e){loadedModule="stages",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-stages").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src="images/background/BG_HQ.jpg",$("#loaded-module").load(html_list.stages,(function(){loadLanguage(userLang),loadedStageList=null,stageMapModal=new bootstrap.Modal(document.getElementById("ba-stage-modal-map"),{}),0==region.weaponlevel_max&&$("#ba-stages-list-tab-schooldungeon").hide(),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;generateStatTable("#ba-stage-enemy-stat-table",enemyStatList,6),null!=t?loadStage(t):e.has("stage")?loadStage(e.get("stage")):localStorage.getItem("stage")?loadStage(localStorage.getItem("stage")):loadStage(1011101),makeDraggable($("#ba-stage-map")),makeDraggable($("#ba-conquest-map")),makeDraggable($("#ba-stage-modal-map-container")),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("craft"==e){var a;loadedModule="craft",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-craft").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_CraftChamber_Night.jpg",$("#loaded-module").load(html_list.craft,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;localStorage.getItem("show_node_probability")&&(showNodeProbability="true"==localStorage.getItem("show_node_probability")),null!=t?loadCraft(t):e.has("craftnode")?loadCraft(e.get("craftnode")):localStorage.getItem("craftnode")?loadCraft(localStorage.getItem("craftnode")):loadCraft(1),populateCraftList(),loadedCraftId>=1e5?$("#ba-item-list-tab-fusion").tab("show"):$("#ba-item-list-tab-synthesis").tab("show"),$("#fusion-select-grid").on("click","div[data-itemid]",(function(e){loadCraft($(this).data("itemid"))})),$("#craft-toggle-chance").toggleClass("active",showNodeProbability),$("#craft-toggle-chance").on("click",(function(){showNodeProbability=!showNodeProbability,localStorage.setItem("show_node_probability",showNodeProbability),$(this).toggleClass("active",showNodeProbability),$("#craft-select-grid .stage-droprate").toggleClass("hidden",!showNodeProbability)})),$("#craft-select-grid .stage-droprate").toggleClass("hidden",!showNodeProbability),$("#craft-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(populateCraftList,100)})),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else{var a;loadedModule="home",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-home").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src="images/background/BG_ReceptionRoom.jpg",$("#loaded-module").load(html_list.home,(function(){loadLanguage(userLang),loadRegion(regionID),populateEvents(),eventRefreshInterval=window.setInterval(updateEventTimers,6e4),$("#ba-home-server-info").text(translateUI("current_events",[getLocalizedString("ServerName",regionID)])),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50);let e=new URL(window.location.href);""!=e.searchParams.toString()&&(e.searchParams.forEach((t,a)=>e.searchParams.delete(a)),history.pushState(null,"",e)),$("title").html("Schale DB"),$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"})}))}localStorage.setItem("module",loadedModule)}function populateEvents(){let e=translateUI("gacha_pickup")+"\n",t="",a=(new Date).getTime()/1e3,s={month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",timeZoneName:"short"},i=!1;$("#events-row-1").hide(),$.each(data.common.regions[regionID].current_gacha,(function(n,l){if((a>=l.start&&a<l.end||a<=l.start)&&!i){for(let e=0;e<l.characters.length;e++){var r=find(data.students,"Id",l.characters[e])[0];t+=getStudentListCardHTML(r)}$("#events-row-1").show(),e+=new Date(1e3*l.start).toLocaleString([],s)+" - "+new Date(1e3*l.end).toLocaleString([],s),e+=`\n<span id="ba-home-gacha-timer" class="home-timer" data-start="${l.start}" data-end="${l.end}"></span>`,i=!0}})),$("#ba-home-gacha-text").html(e),$("#ba-home-gacha-list").html(t);let n="",l="";$("#events-row-2").hide(),i=!1,$.each(data.common.regions[regionID].current_raid,(function(e,t){if((a>=t.start&&a<t.end||a<=t.start)&&!i){if(t.raid>=1e3){n=getLocalizedString("StageType","TimeAttack")+"\n";let e=find(data.raids.TimeAttack,"Id",t.raid)[0];l+=getTimeAttackCardHTML(e,e.Terrain)}else{n=getLocalizedString("StageType","Raid")+"\n";let e=find(data.raids.Raid,"Id",t.raid)[0];l+=getRaidCardHTML(e,t.terrain)}$("#events-row-2").show(),n+=new Date(1e3*t.start).toLocaleString([],s)+" - "+new Date(1e3*t.end).toLocaleString([],s),n+=`\n<span id="ba-home-raid-timer" class="home-timer" data-start="${t.start}" data-end="${t.end}"></span>`,i=!0}})),$("#ba-home-raid-text").html(n),$("#ba-home-raid-list").html(l);let r="",o="";$("#ba-home-event").hide(),i=!1,$.each(data.common.regions[regionID].current_events,(function(e,t){(a>=t.start&&a<t.end||a<=t.start)&&!i&&(r=getLocalizedString("StageType","Event")+"\n",o+=getEventCardHTML(t.event),$("#ba-home-event").show(),r+=new Date(1e3*t.start).toLocaleString([],s)+" - "+new Date(1e3*t.end).toLocaleString([],s),r+=`\n<span id="ba-home-event-timer" class="home-timer" data-start="${t.start}" data-end="${t.end}"></span>`,i=!0)})),$("#ba-home-event-text").html(r),$("#ba-home-event-list").html(o);var d="",c=new Date;c.setHours(0,0,0,0);var u=new Date;if(u.setHours(0,0,0,0),u.setDate(c.getDate()+7),birthdayStudents=[],data.students.forEach(e=>{if(e.IsReleased[regionID]&&!e.PathName.includes("_")){var t=getNextBirthdayDate(e.BirthDay);t.getTime()<u.getTime()&&t.getTime()>=c.getTime()&&birthdayStudents.push(e)}}),birthdayStudents.length>0){birthdayStudents.sort((e,t)=>getNextBirthdayDate(e.BirthDay).getTime()-getNextBirthdayDate(t.BirthDay).getTime());for(let e=0;e<birthdayStudents.length;e++)d+='<div class="d-flex flex-column mx-1 mb-1">'+getStudentIconSmall(birthdayStudents[e])+'<div class="ba-panel mt-1 mx-1 p-1 text-center">'+getNextBirthdayDate(birthdayStudents[e].BirthDay).toLocaleDateString([],{month:"numeric",day:"numeric"})+"</div></div>";$("#ba-home-birthdays-list").html(d)}else $("#ba-home-birthdays").hide();$(".ba-item-student").tooltip({html:!0}),updateEventTimers()}function updateEventTimers(){const e=(new Date).getTime()/1e3;$(".home-timer").each((function(t){const a=$(this).data("start"),s=$(this).data("end");$(this).html(e>=a?translateUI("event_ends",duration(s-e)):translateUI("event_starts",duration(a-e)))}))}function finalizeLoad(e,t,a,s=null,i=null){var n=new URL(window.location.href);n.searchParams.get(t)!=a&&(n.searchParams.forEach((e,t)=>n.searchParams.delete(t)),n.searchParams.set(t,a),history.pushState(null,"",n)),$("title").html(`${e} | Schale DB`),$("#ba-navbar-content").collapse("hide"),localStorage.setItem(t,a),s&&window.setTimeout((function(){gtag("event",s,{event_label:i,user_language:userLang})}),500)}function getNextBirthdayDate(e){var t=new Date;t.setHours(0,0,0,0);var a=new Date;return a.setHours(0,0,0,0),a.setMonth(parseInt(e.split("/")[0])-1,parseInt(e.split("/")[1])),a.setFullYear(a.getMonth()<t.getMonth()?t.getFullYear()+1:t.getFullYear()),a}function duration(e){if(e<0)return[0,0,0];let t=e,a=Math.floor(t/86400);t-=86400*a;let s=Math.floor(t/3600),i;return t-=3600*s,[a,s,Math.floor(t/60)]}function setSortedDataLists(){data.students.sort(sort_functions.Name),studentList=data.students.map(e=>e),itemList=data.items.map(e=>e),furnitureList=data.furniture.map(e=>e),equipmentList=data.equipment.map(e=>e)}function populateStudentList(){let e="";data.students.forEach(t=>{t.IsReleased[regionID]&&(e+=getStudentListCardHTML(t))}),e+=`<div id="student-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`,$("#student-select-grid").html(e)}function updateStudentList(e=!1){let t=$("#ba-student-search-text").val(),a=sort_functions[search_options.sortby];const s=buildFilterList(search_options.filter);e&&studentList.sort(a);let i=0;$.each(studentList,(function(a,n){if(n.IsReleased[regionID]){if(e)if($("#student-select-"+n.Id).css("order",a),"Default"==search_options.sortby||"Name"==search_options.sortby)$("#student-select-"+n.Id+" .label-text:not(.hover)").text(getTranslatedString(n,"Name")).toggleClass("smalltext",getTranslatedString(n,"Name").length>label_smalltext_threshold[userLang]).toggleClass("unhover",!1),$("#student-select-"+n.Id+" .label-text.hover").hide();else if("EXCost"==search_options.sortby){const e=find(n.Skills,"SkillType","ex")[0].Cost;e[0]==e[4]?$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e[0]).toggleClass("smalltext",!1).toggleClass("unhover",!0):$("#student-select-"+n.Id+" .label-text:not(.hover)").text(`${e[0]}~${e[4]}`).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("EXHits"==search_options.sortby){const e=find(n.Skills,"SkillType","ex")[0].DamageDist.length;$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else $("#student-select-"+n.Id+" .label-text:not(.hover)").text(n[search_options.sortby].toLocaleString()).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show();checkFilters(n,s,t)?(i++,$("#student-select-"+n.Id).show()):$("#student-select-"+n.Id).hide()}})),$("#student-select-noresult").toggle(0==i);const n=getNumActiveFilters();$("#ba-student-search-filter-amount").text(0==n?"":` (${n})`),$("#ba-student-search-reset").toggle(n>0||""!=$("#ba-student-search-text").val())}function buildFilterList(e){let t=[];return $.each(e,(function(e,a){if("boolean"==typeof a)a&&t.push(e);else{let s=!0,i=!0;$.each(a,(function(e,t){s=s&&!t,i=i&&t})),s||i||t.push(e)}})),t}function updateItemList(e=!1){let t=$("#item-search-text").val(),a=itemSortFunctions[itemSearchOptions.sortby];const s=buildFilterList(itemSearchOptions.filter);let i,n;switch(loadedItemList){case"items":i=itemList,n=0;break;case"furniture":i=furnitureList,n=1e6;break;case"equipment":i=equipmentList,n=2e6}e&&i.sort(a);let l=0;$.each(i,(function(a,i){i.IsReleased[regionID]&&(e&&$(`#item-select-${i.Id+n}`).css("order",a),itemCheckFilters(i,s,t)?(l++,$(`#item-select-${i.Id+n}`).show()):$(`#item-select-${i.Id+n}`).hide())})),$("#item-select-noresult").toggle(0==l)}function checkFilters(e,t,a){if(!e.IsReleased[regionID])return!1;if(0==t.length);else for(let a=0;a<t.length;a++)if("Collection"==t[a]){if(!search_options.filter.Collection[e.Id in studentCollection?"Owned":"NotOwned"])return!1}else if(t[a].startsWith("Gear")){const s=parseInt(t[a].replace("Gear",""));if(!search_options.filter[t[a]][e.Equipment[s-1]])return!1}else if("BondGear"==t[a]){if(search_options.filter[t[a]]&&!("Released"in e.Gear&&e.Gear.Released[regionID]))return!1}else if(!search_options.filter[t[a]][e[t[a]]])return!1;return""==a||getTranslatedString(e,"Name").toLowerCase().includes(a.toLowerCase())}function itemCheckFilters(e,t,a){if(!e.IsReleased[regionID])return!1;if(0==t.length);else for(let a=0;a<t.length;a++)switch(t[a]){case"ItemCategory":if("items"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.Category])return!1;break;case"EquipmentCategory":if("equipment"==loadedItemList)if(e.Category.startsWith("WeaponExpGrowth")){if(!itemSearchOptions.filter[t[a]].WeaponExpGrowth)return!1}else if(!itemSearchOptions.filter[t[a]][e.Category])return!1;break;case"FurnitureSubCategory":if("furniture"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.SubCategory])return!1;break;case"FurnitureSet":if("furniture"==loadedItemList&&!itemSearchOptions.filter[t[a]][String(e.SetGroupId)])return!1;break;case"Rarity":if("equipment"!=loadedItemList&&!itemSearchOptions.filter[t[a]][e[t[a]]])return!1;break;case"FurnitureInteraction":if("furniture"==loadedItemList&&!e.Interaction[regionID])return!1;break;case"EquipmentTier":if("equipment"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.Tier])return!1;break;default:if(!itemSearchOptions.filter[t[a]][e[t[a]]])return!1}return""==a||getTranslatedString(e,"Name").toLowerCase().includes(a.toLowerCase())}function searchOptionSet(e,t,a=!0){$(`#ba-student-search-${e} a`).removeClass("active"),$(`#ba-student-search-${e} button`).removeClass("active"),$(`#ba-student-search-${e}-${t}`).addClass("active"),$("#ba-student-search-sortby-stat").text(translateUI("stat")+" "),"sortby"==e&&"default"!=t&&"name"!=t&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat").text($(`#ba-student-search-sortby-${t}`).text()+" ")),search_options[e]=t,localStorage.setItem(`chara_${e}`,t),a&&updateStudentList()}function getNumActiveFilters(){let e=0;return $.each(search_options.filter,(function(t,a){"boolean"==typeof a?a&&(e+=1):$.each(a,(function(t,a){!0===a&&(e+=1)}))})),e}function searchSetOrder(e,t=!0,a=!0){a&&(e==search_options.sortby?search_options.sortby_dir=-search_options.sortby_dir:search_options.sortby_dir=1),e in sort_functions||(e="Default"),$("#ba-student-search-sortby a").removeClass("active"),$("#ba-student-search-sortby .btn-search-filter").removeClass("active"),$(`#ba-student-search-sortby-${e.toLowerCase()}`).addClass("active"),$("#ba-student-search-sortby-stat").text(translateUI("stat")),$(".sort-direction-label").text(""),$(`#ba-student-search-sortby-${e.toLowerCase()} > .sort-direction-label`).html(1==search_options.sortby_dir!=("Name"==e||"Default"==e)?'<i class="fa-solid fa-arrow-down-long ms-2"></i>':'<i class="fa-solid fa-arrow-up-long ms-2"></i>'),"Default"!=e&&"Name"!=e&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat").html($(`#ba-student-search-sortby-${e.toLowerCase()}`).html())),search_options.sortby=e,localStorage.setItem("chara_sortby",e),localStorage.setItem("chara_sortby_dir",search_options.sortby_dir),t&&updateStudentList(updateSortMethod=!0)}function searchSetOrderItems(e,t=!0,a=!0){a&&(e==itemSearchOptions.sortby?itemSearchOptions.sortby_dir=-itemSearchOptions.sortby_dir:itemSearchOptions.sortby_dir=1),$("#item-search-sortby a").removeClass("active"),$("#item-search-sortby button").removeClass("active"),$(`#item-search-sortby-${e.toLowerCase()}`).addClass("active"),$(".sort-direction-label").text(""),$(`#item-search-sortby-${e.toLowerCase()} > .sort-direction-label`).html(1==itemSearchOptions.sortby_dir?'<i class="fa-solid fa-arrow-up-long ms-2"></i>':'<i class="fa-solid fa-arrow-down-long ms-2"></i>'),itemSearchOptions.sortby=e,localStorage.setItem("item_sortby",e),localStorage.setItem("item_sortby_dir",itemSearchOptions.sortby_dir),t&&updateItemList(updateSortMethod=!0)}function searchSetFilter(e,t,a=!0){if(null!=t){if(search_options.filter[e][t]=!search_options.filter[e][t],$(`#ba-student-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).hasClass("mutually-exclusive"))for(option in $(`#ba-student-search-filter-${e.toLowerCase()} .btn-search-filter`).toggleClass("active",!1),search_options.filter[e])option!=t&&(search_options.filter[e][option]=!1);$(`#ba-student-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).toggleClass("active",search_options.filter[e][t])}else search_options.filter[e]=!search_options.filter[e],$(`#ba-student-search-filter-${e.toLowerCase()}`).toggleClass("active",search_options.filter[e]);a&&updateStudentList()}function searchSetFilterItems(e,t,a=!0){null!=t?(itemSearchOptions.filter[e][t]=!itemSearchOptions.filter[e][t],$(`#item-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).toggleClass("active",itemSearchOptions.filter[e][t])):(itemSearchOptions.filter[e]=!itemSearchOptions.filter[e],$(`#item-search-filter-${e.toLowerCase()}`).toggleClass("active",itemSearchOptions.filter[e])),a&&updateItemList()}function searchResetFilter(){$("#ba-student-search-text").val(""),Object.entries(search_options.filter).forEach(e=>{"boolean"==typeof e[1]?(search_options.filter[e[0]]=!1,$(`#ba-student-search-filter-${e[0].toLowerCase()}`).toggleClass("active",!1)):Object.entries(e[1]).forEach(t=>{search_options.filter[e[0]][t[0]]=!1,$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",!1)})}),$("#ba-student-search-reset").hide(),$("#ba-student-search-filter-amount").text(""),document.getElementById("ba-student-search-reset").blur(),updateStudentList()}function setGridItemDisplayStyle(e){if(gridItemDisplayStyle!=e){switch(gridItemDisplayStyle=e,localStorage.setItem("grid_item_display_style",gridItemDisplayStyle),$("#item-search-displaytype button").removeClass("active"),$("#item-search-displaytype-"+e).addClass("active"),e){case"detailed":$("#item-select-grid").removeClass("items-compact").addClass("items");break;case"compact":$("#item-select-grid").removeClass("items").addClass("items-compact")}populateItemList(loadedItemList)}}function processStudent(){showAltSprite=!1,$("#ba-student-img").attr("src",`images/student/portrait/Portrait_${student.DevName}.webp`);let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src=`images/background/${student.CollectionBG}.jpg`,$("#ba-student-name").html(getTranslatedString(student,"Name").replace(/([(].+[)])/,"<small>$1</small>")),$("#ba-student-class").text(getLocalizedString("SquadType",student.SquadType)).removeClass("ba-class-main ba-class-support").addClass(`ba-class-${student.SquadType.toLowerCase()}`),$("#ba-student-stargrade").html('<i class="fa-solid fa-star"></i>'.repeat(student.StarGrade)),student.IsLimited>0&&$("#ba-student-stargrade").append(`<span class="ms-1">(${getLocalizedString("IsLimited",""+student.IsLimited)})</span>`),$(".summon-list").toggleClass("disabled",0==student.Summons.length);let t="",a;t+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-summon-id="0" class="btn btn-dark"><img src="images/student/icon/${student.CollectionTexture}.png"><span>${getTranslatedString(student,"Name")}</span></a></li>`,student.Summons.forEach((e,a)=>{const s=find(data.summons,"Id",e.Id)[0],i=find(student.Skills,"SkillType",e.SourceSkill)[0];t+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-summon-id="${a+1}" class="btn btn-dark"><img class="bg-skill ${student.BulletType.toLowerCase()}" src="images/skill/${i.Icon}.png"><span>${getTranslatedString(s,"Name")}</span></a></li>`}),$(".summon-list .dropdown-menu").html(t),changeStudentSummon(0,!1),$("#ba-student-role-label").text(getLocalizedString("TacticRole",student.TacticRole)),$("#ba-student-role-icon").attr("src",`images/ui/Role_${student.TacticRole}.png`),$(".bg-skill").removeClass("explosion pierce mystic").addClass(`${student.BulletType.toLowerCase()}`),$("#ba-student-attacktype").removeClass("bg-atk-explosion bg-atk-pierce bg-atk-mystic").addClass(`bg-atk-${student.BulletType.toLowerCase()}`),$("#ba-student-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed").addClass(`bg-def-${student.ArmorType.toLowerCase()}`),$("#ba-student-academy-label").text(`${getLocalizedString("School",student.School)} / ${getLocalizedString("Club",student.Club)}`),$("#ba-student-school-img, #ba-student-academy-icon").attr("src",`images/schoolicon/School_Icon_${student.School.toUpperCase()}_W.png`),$("#ba-student-position-label").text(student.Position.toUpperCase()),$("#ba-student-attacktype-label").text(getLocalizedString("BulletType",student.BulletType)),$("#ba-student-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",student.BulletType)}`,translateUI("attacktype"),null,getAttackTypeText(student.BulletType),32),placement:"top",html:!0}),$("#ba-student-defensetype-label").text(getLocalizedString("ArmorType",student.ArmorType)),$("#ba-student-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",student.ArmorType)}`,translateUI("defensetype"),null,getDefenseTypeText(student.ArmorType),32),placement:"top",html:!0}),$("#ba-student-usescover-icon").toggle(student.Cover),$("#ba-student-weapontype-label").text(student.WeaponType),$(".ba-type-weapon").css("background-image",`url('images/weapon/${student.WeaponImg}.png')`),student.Skills.forEach(e=>{$(`#ba-skill-${e.SkillType}-name`).text(getTranslatedString(e,"Name")),$(`#ba-skill-${e.SkillType}-icon`).attr("src",`images/skill/${e.Icon}.png`),"passive"==e.SkillType&&$("#ba-statpreview-passiveskill-icon, #ba-statpreview-status-passive-icon").attr("src",`images/skill/${e.Icon}.png`),"ex"==e.SkillType&&($("#ba-skill-ex-cost").removeClass("ba-col-explosion ba-col-pierce ba-col-mystic"),e.Cost[0]!=e.Cost[4]&&$("#ba-skill-ex-cost").addClass(`ba-col-${student.BulletType.toLowerCase()}`))});for(let e=2;e<=5;e++)a="",$.each(student.SkillExMaterial[e-2],(function(t,s){a+=getMaterialIconHTML(s,student.SkillExMaterialAmount[e-2][t])})),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_ex_upgrade_credits[e-2])),$("#ba-skill-ex-materials-"+e).html(a),$("#ba-skill-ex-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));for(let e=2;e<=9;e++)a="",$.each(student.SkillMaterial[e-2],(function(t,s){a+=getMaterialIconHTML(s,student.SkillMaterialAmount[e-2][t])})),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[e-2])),$("#ba-skill-materials-"+e).html(a),$("#ba-skill-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));a="",a+=getMaterialIconHTML(9999,1),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[8])),$("#ba-skill-materials-10").html(a),$("#ba-skill-materials-10 div").each((function(e,t){$(t).tooltip({html:!0})})),$("#ba-student-weapon-name, #ba-statpreview-weapon-name").text(getTranslatedString(student.Weapon,"Name")),$("#ba-weapon-description").text(getTranslatedString(student.Weapon,"Desc").replace("\n\n","\n")),$("#ba-student-weapon-type").text(student.WeaponType),$("#ba-student-weapon-img, #ba-statpreview-weapon-img").attr("src",`images/weapon/${student.WeaponImg}.png`),$("#ba-weapon-bonus-terrain-type").attr("src",`images/ui/Terrain_${student.Weapon.AdaptationType}.png`);let s=adaptaionAmount[student[student.Weapon.AdaptationType+"BattleAdaptation"]],i=adaptaionAmount[student[student.Weapon.AdaptationType+"BattleAdaptation"]+student.Weapon.AdaptationValue];if($("#ba-weapon-bonus-terrain-adaption").attr("src",`images/ui/Ingame_Emo_Adaptresult${i}.png`),$("#ba-weapon-bonus-terrain-adaption-description").html(`${translateUI("terrain_adaption",[getLocalizedString("AdaptationType",student.Weapon.AdaptationType)])} ${s}  <b>${i}</b><br>(${getAdaptationText(student.Weapon.AdaptationType,i)})`),$("#ba-weapon-stat-table .stat-HealPower").parent().toggle(student.Weapon.HealPower1>0),"Released"in student.Gear&&student.Gear.Released[regionID]){$("#ba-student-tab-gear, #ba-statpreview-ex-gear-container").show(),$("#ba-student-gear-name, #ba-statpreview-ex-gear-name").html(student.Gear.Name),$("#ba-student-gear-description").html(`${student.Gear.Desc}\n\n<i>${translateUI("bond_req_equip",["20",student.Name])}`),$("#ba-student-gear-icon, #ba-statpreview-ex-gear-icon, #ba-student-gear-4-icon").attr("src",`images/gear/${student.Gear.Icon}.png`),$("#ba-student-gear-4-icon").tooltip("dispose").tooltip({title:getRichTooltip(`images/gear/${student.Gear.Icon}.png`,getTranslatedString(student.Gear,"Name"),translateUI("student_ex_gear"),null,getTranslatedString(student.Gear,"Desc")+`\n\n<b>${translateUI("stat_info")}:</b>\n`+getGearStatsText(student.Gear,"\n"),50,"img-scale-larger"),placement:"top",html:!0}).toggleClass("gear-disabled",!statPreviewIncludeExGear);let e="";for(let t=0;t<student.Gear.TierUpMaterial[0].length;t++)e+=getMaterialIconHTML(student.Gear.TierUpMaterial[0][t],student.Gear.TierUpMaterialAmount[0][t]);let t=student.Gear.StatType.map(e=>e.split("_")[0]);generateStatTable("#ba-gear-stat-table",t,6);for(let e=0;e<student.Gear.StatValue.length;e++){let a=student.Gear.StatValue[e][1];"Coefficient"==student.Gear.StatType[e].split("_")[1]&&(a=parseFloat((a/100).toFixed(2))+"%"),$(`#ba-gear-stat-table .stat-${t[e]} .stat-value`).text("+"+a)}e+=getMaterialIconHTML(3000001,abbreviateNumber(gear_upgrade_credits[0])),$("#ba-statpreview-ex-gear-description").html(getGearStatsText(student.Gear,", ")),$("#ba-student-gear-materials-t2").html(e),$("#ba-student-gear-materials-t2>div").tooltip({html:!0}),$("#ba-student-bondreq-t2").html(translateUI("bond_req_upgrade",["25",student.Name]))}else $("#ba-student-tab-gear, #ba-statpreview-ex-gear-container").hide(),$("#ba-student-tab-gear").hasClass("active")&&$("#ba-student-tab-stats").tab("show"),$("#ba-student-gear-4-icon").attr("src","images/gear/Gear_Icon_Empty.png").tooltip("dispose").toggleClass("gear-disabled",!0);"Jp"!=userLang?$("#ba-student-fullname").text(getTranslatedString(student,"FamilyName")+" "+getTranslatedString(student,"PersonalName")):$("#ba-student-fullname").text(getTranslatedString(student,"FamilyName")+getTranslatedString(student,"PersonalName")),$("#ba-profile-school-label").text(getLocalizedString("SchoolLong",student.School)),$("#ba-profile-club-label").text(getLocalizedString("Club",student.Club)),$("#ba-profile-schoolyear-label").text(getTranslatedString(student,"SchoolYear")).toggle(""!=getTranslatedString(student,"SchoolYear")),$("#ba-profile-portrait-img").attr("src",`images/student/collection/${student.CollectionTexture}.webp`);var n="";n+=getTranslatedString(student,"ProfileIntroduction"),3==student.StarGrade&&(n+=`\n\n<i class="text-bold">"${getTranslatedString(student,"CharacterSSRNew")}"</i>`),$("#ba-student-profile-text").html(n),student.MemoryLobby[regionID]>0?($(".ba-student-lobby").show(),$("#ba-student-lobby-img").attr("src",`images/student/lobby/Lobbyillust_Icon_${student.DevName}_01.png`),$("#ba-student-lobby-unlock").text(student.MemoryLobby[regionID]),$(".ba-student-lobby").tooltip("dispose").tooltip({title:getRichTooltip(null,translateUI("memory_lobby_student",[getTranslatedString(student,"Name")]),null,null,translateUI("memory_lobby_unlock",[student.MemoryLobby[regionID],getTranslatedString(student,"Name")])),placement:"top",html:!0})):$(".ba-student-lobby").hide(),$("#ba-student-profile-age").text(getTranslatedString(student,"CharacterAge")),$("#ba-student-profile-birthday").text(getTranslatedString(student,"Birthday")),$("#ba-student-profile-hobbies").text(getTranslatedString(student,"Hobby")),$("#ba-student-profile-height").text(student.CharHeightMetric),$("#ba-student-profile-cv").text(getTranslatedString(student,"CharacterVoice")),$("#ba-student-profile-illustrator").text(student.ArtistName),$("#ba-student-toggle-sprite-btn").toggle(altSprite.includes(student.Id));let l=student.FavorItemTags;l.push(student.FavorItemUniqueTags[0]),l.push(student.FavorItemUniqueTags[0]+"2");let r="";if(0==regionID){const e=getFavouriteSSRItems(l);$(e[0]).each((function(e,t){r+=getFavourIconHTML(t,4)})),$(e[1]).each((function(e,t){r+=getFavourIconHTML(t,3)}))}const o=getFavouriteItems(l);$(o[0]).each((function(e,t){r+=getFavourIconHTML(t,3)})),$(o[1]).each((function(e,t){r+=getFavourIconHTML(t,2)})),$("#ba-student-favoured-items").empty().html(r),""==r?$("#ba-student-favoured-items").empty().html(`<span class="pb-2 text-center">${translateUI("favoritem_none")}</span>`):$("#ba-student-favoured-items").empty().html(r);let d="";$(student.FurnitureInteraction[regionID]).each((function(e,t){let a=find(data.furniture,"Id",t)[0];a.IsReleased[regionID]&&(d+=getFurnitureIconHTML(a))})),$("#ba-student-favoured-furniture").empty().html(d),""==d?$("#ba-student-favoured-furniture").empty().html(`<span class="pb-2 text-center">${translateUI("furniture_none")}</span>`):$("#ba-student-favoured-furniture").empty().html(d),$(".ba-favor-item").tooltip({html:!0}),generateStatTable("#ba-bond-stat-table",student.FavorStatType,6),"Main"==student.SquadType?($("#ba-student-stat-table").removeClass("striker-bonus"),$("#ba-statpreview-status-strikerbonus").hide(),$("#statpreview-supportstats").show(),statPreviewViewSupportStats=!1):($("#ba-statpreview-status-strikerbonus").show(),$("#statpreview-supportstats").hide()),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewViewSupportStats),$("#ba-statpreview-bond-targets").empty().html(getBondTargetsHTML(1,student)),$("#ba-statpreview-status-bond-icon").attr("src",`images/student/icon/${student.CollectionTexture}.png`),student_bondalts=[],$("#ba-statpreview-status-bond-level").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_relationship_bonus",[student.Name])),placement:"top",html:!0});for(let e=0;e<student.FavorAlts.length;e++){var c=find(data.students,"Id",student.FavorAlts[e])[0];c.IsReleased[regionID]&&(student_bondalts.push(c),$("#ba-statpreview-status-bond-alt-icon").attr("src",`images/student/icon/${c.CollectionTexture}.png`),$("#ba-statpreview-bond-targets").append(getBondTargetsHTML(1+student_bondalts.length,c)),$("#ba-statpreview-status-bond-alt-level").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_relationship_bonus",[c.Name])),placement:"top",html:!0}))}$("#ba-statpreview-status-bond-alt-level").toggle(student_bondalts.length>0),student.Id in studentCollection?(statPreviewStarGrade=studentCollection[student.Id].s,statPreviewLevel=studentCollection[student.Id].l,$("#ba-statpreview-levelrange").val(statPreviewLevel),changeStatPreviewLevel(document.getElementById("ba-statpreview-levelrange"),!1),statPreviewEquipment=[studentCollection[student.Id].e1,studentCollection[student.Id].e2,studentCollection[student.Id].e3],$("#ba-statpreview-gear1-range").val(statPreviewEquipment[0]),$("#ba-statpreview-gear2-range").val(statPreviewEquipment[1]),$("#ba-statpreview-gear3-range").val(statPreviewEquipment[2]),statPreviewWeaponGrade=studentCollection[student.Id].ws,statPreviewWeaponLevel=studentCollection[student.Id].wl,$("#ba-statpreview-weapon-range").val(statPreviewWeaponLevel),statPreviewBondLevel=studentCollection[student.Id].b,$("#ba-statpreview-bond-1-range").val(statPreviewBondLevel),$("#ba-statpreview-passiveskill-range").val(studentCollection[student.Id].s3),changeStatPreviewPassiveSkillLevel(document.getElementById("ba-statpreview-passiveskill-range"),!1),statPreviewIncludeBond=!0,statPreviewIncludeEquipment=!0,$("#ba-student-collection-btn").toggleClass("active",!0).html('<i class="fa-solid fa-circle-check"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_remove")),placement:"top",html:!0})):($("#ba-student-collection-btn").toggleClass("active",!1).html('<i class="fa-solid fa-circle-plus"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_add")),placement:"top",html:!0})),statPreviewExternalBuffs.changeStudent(student.Id),updateGearIcon(),changeStatPreviewStars(statPreviewStarGrade,statPreviewWeaponGrade,!1),recalculateTerrainAffinity(),changeStatPreviewPassiveSkillLevel(document.getElementById("ba-statpreview-passiveskill-range"),!1),recalculateWeaponPreview(),updateWeaponLevelStatPreview($("#ba-statpreview-weapon-range").val()),recalculateSkillPreview(),recalculateWeaponSkillPreview(),recalculateGearSkillPreview(),recalculateEXSkillPreview(),recalculateBondPreview(),changeGearLevel(1,document.getElementById("ba-statpreview-gear1-range"),!1),changeGearLevel(2,document.getElementById("ba-statpreview-gear2-range"),!1),changeGearLevel(3,document.getElementById("ba-statpreview-gear3-range"),!1);for(let e=1;e<=student_bondalts.length+1;e++)e>1&&student_bondalts[e-2].Id in studentCollection&&(statPreviewBondAltLevel=studentCollection[student_bondalts[e-2].Id].b,$(`#ba-statpreview-bond-${e}-range`).val(studentCollection[student_bondalts[e-2].Id].b),statPreviewIncludeBondAlts=!0),changeStatPreviewBondLevel(e,!1);refreshStatTableControls(),recalculateStats(),finalizeLoad(getTranslatedString(student,"Name"),"chara",student.PathName,"View Student",student.Id),studentSelectorModal.hide()}function loadStudent(e){"students"==loadedModule?selectCompareMode?(studentCompare=find(data.students,"PathName",e),0==studentCompare.length&&(studentCompare=findOrDefault(data.students,"DevName",e,"Aru")),studentCompare=studentCompare[0],selectCompareMode=!1,changeStudentSummon(0,!1),compareMode=!0,updateCompareModeControl(),recalculateStats(),studentSelectorModal.hide()):(student=find(data.students,"PathName",e),0==student.length&&(student=findOrDefault(data.students,"DevName",e,"Aru")),student=student[0],compareMode&&student.Id==studentCompare.Id&&(compareMode=!1,updateCompareModeControl()),processStudent()):loadModule("students",e)}function loadStudentById(e){"students"==loadedModule?(student=findOrDefault(data.students,"Id",e,1e4)[0],processStudent()):loadModule("students")}function loadItem(e){if("items"==loadedModule){var t="",a;if($(".tooltip").tooltip("hide"),$("#item-select-grid .card-items.selected").removeClass("selected"),$("#ba-item-furniture-row").hide(),e>=2e6?(t="equipment",a=findOrDefault(data.equipment,"Id",e-2e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))):e>=1e6?(t="furniture",a=findOrDefault(data.furniture,"Id",e-1e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.SubCategory)),$("#ba-item-furniture-row").show(),$("#ba-item-furniture-set").html(0==a.SetGroupId?"":` <i>${getLocalizedString("FurnitureSet",String(a.SetGroupId))}</i>`),$("#ba-item-furniture-comfort").html(`<img class="inline-img" src="images/ui/Cafe_Icon_Comfort.png"> ${a.ComfortBonus}`)):(t="items",a=findOrDefault(data.items,"Id",e,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))),loadedItem=a,loadedItemType=t,$("#ba-item-name").html(getTranslatedString(a,"Name")),"equipment"==t&&a.Id>=1e3?$("#ba-item-rarity").html(`T${a.Tier}`):"furniture"==t?$("#ba-item-rarity").html(getRarityStars(a.Rarity)):$("#ba-item-rarity").html(getRarityTier(a.Rarity)),$("#ba-item-icon").removeClass("ba-item-n ba-item-r ba-item-sr ba-item-ssr").addClass("ba-item-"+a.Rarity.toLowerCase()),$("#ba-item-icon-img").attr("src",`images/${t}/${a.Icon}.png`),$("#ba-item-description").html(getTranslatedString(a,"Desc")),"equipment"==t&&a.Id>=1e3&&a.Id<=1e4&&$("#ba-item-description").append(`\n\n<b>${translateUI("stat_info")}:</b>\n`+getGearStatsText(a,"\n")),a.Category.includes("WeaponExpGrowth")&&$("#ba-item-description").append(`\n\n<i>${getLocalizedString("WeaponPartExpBonus",a.Category)}</i>`),$("#ba-equipment-recipe").empty().hide(),$("#ba-item-usage").empty().hide(),$("#ba-item-sources").empty().hide(),$("#ba-item-shops").empty().hide(),"Material"==a.Category||"CharacterExpGrowth"==a.Category?($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-sources").html(getItemDropStages(a.Id))):"Consumable"==a.Category?$("#ba-item-sources").html(getItemDropStages(a.Id)):"Favor"==a.Category?a.Id<5998?($("#ba-item-usage").html(getLikedByStudents(a)),$(".ba-item-student").tooltip({html:!0})):$("#ba-item-usage").html(`<i>${translateUI("item_specialgift",['<img class="inline-img" src="images/ui/Cafe_Interaction_Gift_03.png">'])}</i>`).show():"SecretStone"==a.Category?($("#ba-item-sources").html(getItemDropStages(a.Id)),$("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0})):"equipment"==t?($("#ba-item-usage").html(getUsedByStudents(a,t)),$("#ba-item-sources").html(getItemDropStages(a.Id+2e6)),$("#ba-equipment-recipe").html(getEquipmentRecipe(a)),$("#ba-equipment-recipe div").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-item-student").tooltip({html:!0})):"Coin"==a.Category&&$("#ba-item-sources").html(getItemDropStages(a.Id)),"furniture"==t&&($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0})),a.Shops){let e="";a.Shops.forEach(t=>{t.Released[regionID]&&(e+=getShopCardHTML(t))}),""!=e&&($("#ba-item-shops").html(`<div class="mb-2"><i>${translateUI("item_purchasedfrom")}</i></div><div class="selection-grid stage selection-grid-flex">${e}</div>`).show(),$("#ba-item-shops .shop-cost").tooltip({html:!0,placement:"top"}))}$(`#ba-item-list-tab-${t}`).tab("show"),$("#item-select-"+e).addClass("selected"),loadedItemList!=t&&populateItemList(t),finalizeLoad(getTranslatedString(a,"Name"),"item",e,"View Item",e)}else loadModule("items",e)}function loadCraft(e){if("craft"==loadedModule)if(loadedCraftId>0&&$("#craft-select-"+loadedCraftId).removeClass("selected"),e<1e5){const t=findOrDefault(data.crafting.Nodes[regionID],"Id",e,1)[0];loadedCraftNode=t,loadedCraftId=t.Id,$("#ba-craft-name").html(getTranslatedString(t,"Name")),$("#ba-craft-type").html(getLocalizedString("NodeTier",""+t.Tier)),$("#ba-craft-rarity").html(getLocalizedString("NodeQuality",""+t.Quality)),$("#ba-craft-icon").removeClass("ba-node-quality-1 ba-node-quality-2").addClass("ba-node-quality-"+t.Quality),$("#ba-craft-icon-img").attr("src",`images/ui/${t.Icon}.png`),$("#ba-craft-description").html(getTranslatedString(t,"Desc")),$("#ba-craft-rewards-title").text(translateUI("craft_rewards")),$("#ba-craft-rewards").empty();let a="",s=0;t.Groups.forEach(e=>{s+=e.Weight}),$.each(t.Groups,(function(e,t){let i=data.crafting.Groups[regionID][t.GroupId],n=0;for(let e=0;e<i.length;e++)n+=i[e].Weight;for(let e=0;e<i.length;e++){let l=(t.Weight/s*(i[e].Weight/n)).toFixed(4),r=i[e].ItemId;"Furniture"==i[e].Type?r+=1e6:"Equipment"==i[e].Type?r+=2e6:"Currency"==i[e].Type&&(r+=3e6),a+=getDropIconHTML(r,l,i[e].AmountMin,i[e].AmountMax,!0)}})),$("#ba-craft-rewards").html(a),$("#ba-craft-rewards div").each((function(e,t){$(t).tooltip({html:!0})})),$("#craft-select-"+loadedCraftNode.Id).addClass("selected"),finalizeLoad(getTranslatedString(t,"Name"),"craftnode",t.Id,"View Crafting",t.Id)}else{const t=findOrDefault(data.crafting.Fusion,"Id",e%1e5,1)[0],a=t.ResultId>=1e6?"furniture":"items",s=find(data[a],"Id",t.ResultId%1e6)[0];loadedCraftNode=t,loadedCraftId=t.Id+1e5,$("#ba-craft-name").html(getTranslatedString(s,"Name")),$("#ba-craft-type").html(translateUI("craft_fusion")),$("#ba-craft-rarity").html(getRarityTier(s.Rarity)),$("#ba-craft-icon").removeClass("ba-node-quality-1 ba-node-quality-2 ba-item-n ba-item-r ba-item-sr ba-item-ssr").addClass("ba-item-"+s.Rarity.toLowerCase()),$("#ba-craft-icon-img").attr("src",`images/${a}/${s.Icon}.png`),$("#ba-craft-description").html(getTranslatedString(s,"Desc")),$("#ba-craft-rewards-title").text(translateUI("craft_recipe_items")),$("#ba-craft-rewards").empty();let i="";i+=getMaterialIconHTML(t.RequireItem[0],t.RequireItem[1]),i+=getMaterialIconHTML(3000001,t.RequireGold),i+='<div class="ba-panel-separator mb-2"></div>',data.items.forEach(e=>{e.IsReleased[regionID]&&e.Tags.filter(e=>t.IngredientTag.includes(e)).length>0&&(i+=getDropIconHTML(e.Id,e.SynthQuality/t.IngredientExp,1,1,!0))}),data.furniture.forEach(e=>{e.IsReleased[regionID]&&e.Tags.filter(e=>t.IngredientTag.includes(e)).length>0&&(i+=getDropIconHTML(e.Id+1e6,e.SynthQuality/t.IngredientExp,1,1,!0))}),$("#ba-craft-rewards").html(i),$("#ba-craft-rewards div").each((function(e,t){$(t).tooltip({html:!0})})),$("#craft-select-"+loadedCraftId).addClass("selected"),finalizeLoad(getTranslatedString(s,"Name"),"craftnode",loadedCraftId,"View Crafting",loadedCraftId)}else loadModule("craft",e)}function loadRaid(e){if(selectedEnemy=0,"raids"==loadedModule){let t;if(isNaN(parseInt(e))&&(e=1),loadedRaid&&$("#raid-select-"+loadedRaid.Id).removeClass("selected"),e<1e3){$("#ba-raid-list-tab-raid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").hide(),$("#ba-raid-difficulty").show(),$("#ba-raid-season").show(),$("#ba-raid-info-tab-profile").show(),raid=findOrDefault(data.raids.Raid,"Id",e,1)[0],raid.IsReleasedInsane[regionID]?$("#ba-raid-difficulty-5").toggleClass("disabled",!1):($("#ba-raid-difficulty-5").toggleClass("disabled",!0),5==raid_difficulty&&(raid_difficulty=0)),$(`#ba-raid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","Raid")),t=getTranslatedString(raid,"Name"),$("#ba-raid-name").text(t),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),$("#ba-raid-profile-page").show(),$("#ba-raid-profile-name").text(getTranslatedString(raid,"Name")),$("#ba-raid-profile-affiliation").text(getLocalizedString("BossFaction",raid.Faction)),$("#ba-raid-profile").html(getTranslatedString(raid,"Profile")),raid.IsReleasedInsane[regionID]||5!=raid_difficulty||(raid_difficulty=0),changeRaidDifficulty(raid_difficulty),raidSeasons=find(data.raids["SeasonReward"+(0==regionID?"Jp":"Global")],"RaidId",raid.Id);let a=`<option value="0" disabled selected>${translateUI("raid_season_select")}</option>`;const s={year:"numeric",month:"numeric",day:"numeric"};raidSeasons.forEach((e,t)=>{const i=new Date(1e3*e.Start).toLocaleString([],s),n=new Date(1e3*e.End).toLocaleString([],s);a+=`<option value="${e.Season}">${translateUI("raid_season",[e.Season,getLocalizedString("AdaptationType",e.Terrain)])+" ["+i+"~"+n+"]"}</option>`}),$("#ba-raid-season-select").html(a),$("#ba-raid-season-rewards").html("")}else e<8e5?($("#ba-raid-list-tab-timeattack").tab("show"),$("#ba-raid-info").hide(),$("#ba-timeattack-info").show(),raid=findOrDefault(data.raids.TimeAttack,"Id",e,1e3)[0],$(`#ba-timeattack-difficulty-${ta_difficulty}`).tab("show"),t=getLocalizedString("TimeAttackStage",raid.DungeonType),$("#ba-timeattack-name").text(t),$("#ba-timeattack-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain}.png`),changeTimeAttackDifficulty(ta_difficulty)):($("#ba-raid-list-tab-worldraid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").show(),$("#ba-raid-difficulty").hide(),$("#ba-raid-season").hide(),$("#ba-raid-info-tab-profile").hasClass("active")&&$("#ba-raid-info-tab-skills").tab("show"),$("#ba-raid-info-tab-profile").hide(),raid=findOrDefault(data.raids.WorldRaid,"Id",e,1)[0],raid_difficulty>2&&(raid_difficulty=0),$(`#ba-worldraid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","WorldRaid")),t=getTranslatedString(raid,"Name"),$("#ba-raid-name").text(t),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),changeWorldRaidDifficulty(raid_difficulty));$("#ba-raid-season-rewards").hide(),loadedRaid=raid,$("#raid-select-"+raid.Id).addClass("selected"),finalizeLoad(t,"raid",raid.Id,"View Raid",raid.Id)}else loadModule("raids",e)}function loadRaidSeasonRewards(e){const t=find(data.raids["SeasonReward"+(0==regionID?"Jp":"Global")],"Season",$(e).val())[0];if(t){let e="";t.Rewards.forEach(([t,a])=>{""!=e&&(e+='<div class="ba-panel-separator"></div>'),e+=`<div class="d-flex"><span class="reward-point">${t.toLocaleString()+" Pt"}</span><div class="season-rewards mt-2">`,a.forEach(([t,a])=>{e+=getDropIconHTML(t,a)}),e+="</div></div>"}),$("#ba-raid-season-rewards").html(e),$("#ba-raid-season-rewards .season-rewards>div").tooltip({html:!0}),$("#ba-raid-season-rewards").show()}}function changeRaidDifficulty(e){raid_difficulty=e;let t="",a="";$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.PathName}${5==raid_difficulty?"_Insane":""}_Lobby.png')`),$("#ba-raid-level").text(`Lv. ${raid_level[raid_difficulty]}`),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0),raid.EnemyList[raid_difficulty].forEach((function(e,t){let s=find(data.enemies,"Id",e)[0];a+=`<button class="nav-link ${t==selectedEnemy?"active":""}" data-bs-toggle="tab" href="#" onclick="changeRaidEnemy(${t})">${getTranslatedString(s,"Name")}</button>`})),$("#ba-raid-enemy-tabs").empty().html(a),raid.RaidSkill.forEach((function(e,a){if(raid_difficulty<e.MinDifficulty)return;let s;switch(e.SkillType){case"EX":s=translateUI("student_skill_ex");break;case"Passive":s=translateUI("student_skill_passive");break;default:s="unknown"}""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-center mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/raid/skill/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4></div><div class="mt-1"><p class="d-inline" style="font-style: italic;">${s}</p>${e.ATGCost>0?'<p class="d-inline text-bold">  <i>ATG:</i> '+e.ATGCost+"</p>":""}</div></div></div><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(e,"Desc"),e["Parameters"+userLang],raid_difficulty+1,"raid")}</p>`})),$("#ba-raid-skills").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}));let s="";s+=getDropIconHTML(7,raid_reward_coin[raid_difficulty][0]),0!=raid_reward_coin[raid_difficulty][1]&&(s+=getDropIconHTML(9,raid_reward_coin[raid_difficulty][1])),$("#ba-raid-rewards").html(`<div class="d-flex flex-wrap justify-content-center">${s}</div>`),$("#ba-raid-rewards>div div").each((e,t)=>{$(t).tooltip({html:!0})}),changeRaidEnemy(selectedEnemy)}function changeTimeAttackDifficulty(e){ta_difficulty=e;let t="",a="";$("#ba-timeattack-level").text(`Lv.${raid.EnemyLevel[ta_difficulty]}`);const s=["Minion","Elite","Champion","Boss"];raid.Formations[ta_difficulty].EnemyList.forEach((function(e,t){let i=find(data.enemies,"Id",raid.Formations[ta_difficulty].EnemyList[t])[0],n="Summoned"==i.Rank?0:s.indexOf(i.Rank);a+=getEnemyCardHTML(i,raid.Formations[ta_difficulty].Level[n],raid.Formations[ta_difficulty].Grade[n],1)})),$("#ba-stage-enemies").html(a),$("#ba-stage-enemies > :first").trigger("click"),raid.Rules[e].forEach(e=>{rule=find(data.raids.TimeAttackRules,"Id",e)[0],""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-start mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/timeattack/${rule.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(rule,"Name")}</h4><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(rule,"Desc"),[],0,"raid")}</p></div></div></div>`}),$("#ba-timeattack-rules").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function changeWorldRaidDifficulty(e){raid_difficulty=e;let t="",a="";$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.PathName}_Lobby.png')`),$("#ba-raid-level").text(`Lv. ${raid.Level[raid_difficulty]}`),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0),raid.EnemyList[raid_difficulty].forEach((function(e,t){let s=find(data.enemies,"Id",e)[0];a+=`<button class="nav-link ${t==selectedEnemy?"active":""}" data-bs-toggle="tab" href="#" onclick="changeRaidEnemy(${t})">${getTranslatedString(s,"Name")}</button>`})),$("#ba-raid-enemy-tabs").empty().html(a),raid.RaidSkill.forEach((function(e,a){if(raid_difficulty<e.MinDifficulty)return;let s;switch(e.SkillType){case"EX":s=translateUI("student_skill_ex");break;case"Passive":s=translateUI("student_skill_passive");break;default:s="unknown"}""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-center mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/raid/skill/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4></div><div class="mt-1"><p class="d-inline" style="font-style: italic;">${s}</p>${e.ATGCost>0?'<p class="d-inline text-bold">  <i>ATG:</i> '+e.ATGCost+"</p>":""}</div></div></div><p class="mt-1 mb-2 p-1">${getSkillText(getTranslatedString(e,"Desc"),e.Parameters,raid_difficulty+1,"raid")}</p>`})),$("#ba-raid-skills").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}));let s="";raid.Rewards[raid_difficulty].forEach(e=>{s+=getDropIconHTML(e[0],e[1])}),$("#ba-raid-rewards").html(`<div class="d-flex flex-wrap justify-content-center">${s}</div>`),$("#ba-raid-rewards>div div").each((e,t)=>{$(t).tooltip({html:!0})}),changeRaidEnemy(selectedEnemy)}function changeRaidEnemy(e){selectedEnemy=e;let t=find(data.enemies,"Id",raid.EnemyList[raid_difficulty][e])[0],a=1,s;s=raid.Id<1e3?raid_level[raid_difficulty]:raid.Level[raid_difficulty];let i=new CharacterStats(t,s,1,t.Transcendence?t.Transcendence:[],0);raidEnemyStatList.forEach(e=>{"AmmoCount"==e?$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text("Main"==t.SquadType?i.getBaseString("AmmoCount")+" ("+i.getBaseString("AmmoCost")+")":"-"):"DefensePower"==e?$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).html(`<span class="has-tooltip">${i.getBaseString(e)}</span>`):$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text(i.getBaseString(e))});let n=translateUI("stat_defense_tooltip",[`<b>${i.getDefenseDamageReduction()}</b>`]);$(".stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(n),html:!0,placement:"top"});let l=raid_difficulty<5?raid.BulletType:raid.BulletTypeInsane;$("#ba-raid-attacktype").removeClass("bg-atk-explosion bg-atk-pierce bg-atk-mystic bg-atk-normal").addClass(`bg-atk-${l.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",l)}`,translateUI("attacktype"),null,getAttackTypeText(l),32),placement:"top",html:!0}),$("#ba-raid-attacktype-label").text(getLocalizedString("BulletType",l)),$("#ba-raid-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed bg-def-normal").addClass(`bg-def-${t.ArmorType.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",t.ArmorType)}`,translateUI("defensetype"),null,getDefenseTypeText(t.ArmorType),32),placement:"top",html:!0}),$("#ba-raid-defensetype-label").text(getLocalizedString("ArmorType",t.ArmorType));let r=getEnemySize(t);$("#ba-raid-enemy-size").text(null!=r?getLocalizedString("EnemyTags",r):"").toggle(null!=r)}function getEnemySize(e){let t=e.Tags.filter(e=>e.includes("Enemy"));return 0==t.length?null:t[0]}function loadStage(e){if("stages"==loadedModule){let t="";if(loadedStage&&$("#stage-select-"+loadedStage.Id).removeClass("selected"),e>=7e6){const a=parseInt(String(e).slice(0,3));conquest_events.includes(a)?(t="Conquest",stage=findOrDefault(data.stages.Conquest,"Id",e,8153902)[0],loadedStage=stage,loadedStageList!=""+stage.EventId%1e4&&populateEventStageList(stage.EventId)):(t="Event",stage=findOrDefault(data.stages.Event,"Id",e,8012301)[0],loadedStage=stage,loadedStageList!=""+stage.EventId%1e4&&populateEventStageList(stage.EventId))}else e>=1e6?(t="Campaign",stage=findOrDefault(data.stages.Campaign,"Id",e,1011101)[0],loadedStage=stage,"missions"!=loadedStageList&&populateStageList("missions")):e>=6e4?(t="SchoolDungeon",stage=findOrDefault(data.stages.SchoolDungeon,"Id",e,60101)[0],loadedStage=stage,"schooldungeon"!=loadedStageList&&populateStageList("schooldungeon")):e>=31e3?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,31101)[0],loadedStage=stage,"commissions"!=loadedStageList&&populateStageList("commissions")):e>=3e4?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,30101)[0],loadedStage=stage,"bounty"!=loadedStageList&&populateStageList("bounty")):(t="Campaign",stage=find(data.stages.Campaign,"Id",1011101)[0],loadedStage=stage,"missions"!=loadedStageList&&populateStageList("missions"));$("#ba-stage-drops-tabs").toggle("WeekDungeon"!=t),"WeekDungeon"==t&&$("#ba-stage-drops-default-tab").tab("show"),$("#ba-stage-name").html(getStageName(stage,t)),$("#ba-stage-title").html(getStageTitle(stage,t)),$("#ba-stage-level").text(translateUI("rec_level")+" Lv."+stage.Level),$("#ba-stage-terrain-img").attr("src",`images/ui/Terrain_${stage.Terrain}.png`),$("#ba-stage-fog").toggle("Campaign"==t&&1==stage.Difficulty);const a=["Default","FirstClear","ThreeStar"];a.forEach(e=>{if(e in stage.Rewards&&stage.Rewards[e].length>0){let t="";"FindGift"==stage.Type?(t+=getDropIconHTML(stage.Rewards[e][0][0],.1,stage.Rewards[e][0][1],stage.Rewards[e][0][1]),t+=getDropIconHTML(stage.Rewards[e][1][0],.5,stage.Rewards[e][1][1],stage.Rewards[e][1][1]),t+=getDropIconHTML(stage.Rewards[e][2][0],.4,stage.Rewards[e][2][1],stage.Rewards[e][2][1]),stage.Rewards[e]):1==regionID&&"RewardsGlobal"in stage?$.each(stage.RewardsGlobal[e],(function(e,a){t+=getDropIconHTML(a[0],a[1])})):$.each(stage.Rewards[e],(function(e,a){t+=getDropIconHTML(a[0],a[1])})),$(`#ba-stage-drops-${e.toLowerCase()}`).html(`<div class="d-flex flex-wrap justify-content-center">${t}</div>`),"FindGift"==stage.Type&&$(`#ba-stage-drops-${e.toLowerCase()}`).prepend(`<i class="d-block mb-2">${translateUI("rewards_findgift_msg")}</i><div class="d-flex flex-wrap justify-content-center"></div>`),$(`#ba-stage-drops-${e.toLowerCase()}>div div`).each((function(e,t){$(t).tooltip({html:!0})}))}else $(`#ba-stage-drops-${e.toLowerCase()}`).html(`<div class="d-flex flex-wrap justify-content-center"><span class="pb-2 text-center">${translateUI("rewards_none")}</span></div>`)});let s="",i={};const n=["Minion","Elite","Champion","Boss"];stage.Formations.forEach(e=>{for(let t=0;t<e.EnemyList.length;t++){let a=find(data.enemies,"Id",e.EnemyList[t])[0],s=n.indexOf(a.Rank);i[`${4-s}_${a.Id}_${e.Level[s]}_${e.Grade[s]}`]=a}}),Object.keys(i).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],s+=getEnemyCardHTML(i[e],e_level,e_grade)}),$("#ba-stage-enemies").html(s),$("#ba-stage-enemies > :first").trigger("click"),"HexaMap"in stage?($("#ba-stage-tab-map").toggleClass("disabled",!1),drawHexamap(stage,"#ba-stage-map-canvas"),$(".ba-stage-star-1").html(translateUI("starcondition_complete")),$(".ba-stage-star-2").html(translateUI("starcondition_sranks",[stage.StarCondition[0]])),$(".ba-stage-star-3").html(translateUI("starcondition_clearturns",[stage.StarCondition[1]]))):($("#ba-stage-tab-map").hasClass("active")&&$("#ba-stage-tab-enemies").tab("show"),$("#ba-stage-tab-map").toggleClass("disabled",!0),"Campaign"==t||"Event"==t?($(".ba-stage-star-1").html(translateUI("starcondition_defeatall")),$(".ba-stage-star-2").html(translateUI("starcondition_defeatalltime",["120"])),$(".ba-stage-star-3").html(translateUI("starcondition_allsurvive"))):"Conquest"==t?($(".ba-stage-star-1").html(translateUI("starcondition_defeatall")),$(".ba-stage-star-2").html(translateUI("starcondition_defeatalltime",[stage.StarCondition[1]])),$(".ba-stage-star-3").html(translateUI("starcondition_allsurvive"))):"Chaser"==stage.Type.slice(0,6)?($(".ba-stage-star-1").html(translateUI("starcondition_clear")),$(".ba-stage-star-2").html(translateUI("starcondition_allsurvive")),$(".ba-stage-star-3").html(translateUI("starcondition_cleartime",["150"]))):"Blood"==stage.Type?($(".ba-stage-star-1").html(translateUI("starcondition_clear")),$(".ba-stage-star-2").html(translateUI("starcondition_allsurvive")),$(".ba-stage-star-3").html(translateUI("starcondition_cleartime",["120"]))):"FindGift"==stage.Type?($(".ba-stage-star-1").html(translateUI("starcondition_earnrewards",["1"])),$(".ba-stage-star-2").html(translateUI("starcondition_earnrewards",["4"])),$(".ba-stage-star-3").html(translateUI("starcondition_earnrewards",["5"]))):"School"==stage.Type.slice(0,6)&&($(".ba-stage-star-1").html(translateUI("starcondition_clear")),$(".ba-stage-star-2").html(translateUI("starcondition_allsurvive")),$(".ba-stage-star-3").html(translateUI("starcondition_cleartime",["120"])))),s="","EntryCost"in stage&&stage.EntryCost.length>0&&stage.EntryCost.forEach(e=>{let t;t=e[0]<20?find(data.currency,"Id",e[0])[0]:find(data.items,"Id",e[0])[0],s+=`<span class="ba-info-pill bg-theme my-0 me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/items/${t.Icon}.png`,getTranslatedString(t,"Name"),getLocalizedString("ItemCategory","Currency"),"",getTranslatedString(t,"Desc"),50,"img-scale-larger")}"><img src="images/items/${t.Icon}.png" style="height:26px;width:auto;"><span class="label ps-0 text-bold">&times;${e[1]}</span></span>`}),$("#ba-stage-entrycost").html(s),$("#ba-stage-entrycost >span").tooltip({html:!0}),$("#ba-stage-map-enemies").html(`<p class="grid-text">${translateUI("maptile_enemy_default_msg")}</p>`),$("#stage-select-"+stage.Id).addClass("selected"),finalizeLoad($("#ba-stage-title").text(),"stage",e,"View Stage",e)}else loadModule("stages",e)}function populateEnemyList(e,t){let a="",s={};const i=["Minion","Elite","Champion","Boss"];t.forEach(e=>{for(let t=0;t<e.EnemyList.length;t++){let a=find(data.enemies,"Id",e.EnemyList[t])[0],n=i.indexOf(a.Rank);s[`${4-n}_${a.Id}_${e.Level[n]}_${e.Grade[n]}`]=a}}),Object.keys(s).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],a+=getEnemyCardHTML(s[e],e_level,e_grade)}),$(e).html(a),$(e).children().first().trigger("click")}function getStageName(e,t){switch(t){case"Event":return`${getLocalizedString("EventName",""+e.EventId%1e4)}\n${1==e.Difficulty?"Quest":"Challenge"} ${e.Stage.toString().padStart(2,"0")}`;case"Campaign":return`${e.Area}-${e.Stage} ${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageType",e.Type)}`;case"Conquest":return`${getLocalizedString("ConquestMap",e.EventId)}`}return console.log(`No name definition for stage type ${t}`),"undefined!!!"}function getStageTitle(e,t){switch(t){case"Event":case"Campaign":case"Conquest":return getTranslatedString(e,"Name");case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,String.fromCharCode(64+e.Stage))}`}return console.log(`No title definition for stage type ${t}`),"undefined!!!"}function getEventStage(e){let t=e.toString().slice(0,3),a=find(data.stages.events,"Id",t);if(a.length>0){let t=find(a[0].Stages,"Id",e);if(t.length>0)return t[0]}return data.stages.events[0].Stages[0]}function loadRegion(e){regionID=e,region=data.common.regions[regionID],$(".statpreview-level").attr("max",region.studentlevel_max),$("#ba-statpreview-level-modal").text(`Lv.1 / ${region.studentlevel_max}`),$("#ba-weaponpreview-levelrange, #ba-statpreview-weapon-range").attr("max",region.weaponlevel_max),0==region.weaponlevel_max&&($("#ba-student-nav-weapon").hide(),$("#ba-statpreview-weapon").hide(),$("#ba-weaponpreview-star-1").hide(),$("#ba-weaponpreview-star-2").hide(),$("#ba-weaponpreview-star-3").hide(),statPreviewWeaponGrade=0),$("#ba-bond-levelrange").attr("max",region.bondlevel_max),$("#ba-statpreview-gear1-range").attr("max",region.gear1_max),$("#ba-statpreview-gear2-range").attr("max",region.gear2_max),$("#ba-statpreview-gear3-range").attr("max",region.gear3_max),1==regionID&&($("#ba-student-search-filter-school-arius").hide(),$("#ba-student-search-filter-weapontype-rl").hide(),$("#item-search-filter-furnitureset-108").hide(),$("#item-search-filter-furnitureset-109").hide(),$("#item-search-filter-equipmenttier-7").hide(),$("#ba-student-gear-separator").hide(),$("#ba-student-gear-4").hide(),$("#ba-student-search-filter-bondgear").hide())}function getAdaptationText(e,t){return translateUI("terrain_adaption_details",[terrain_dmg_bonus[t],getLocalizedString("AdaptationType",e).toLowerCase(),terrain_block_bonus[t]])}function getStatName(e){return getLocalizedString("Stat",e.replace("_Coefficient","").replace("_Base","").replace("100","").replace("1",""))}function getFormattedStatAmount(e){return Number.isInteger(e)?e:`${parseFloat((100*e).toFixed(2))}%`}function changeGearLevel(e,t,a=!0){const s=student.Equipment[e-1],i=parseInt(t.value),n=find(data.equipment,"Id",gearId[s]+i-1)[0];statPreviewEquipment[e-1]=i,$(`#ba-statpreview-gear${e}-icon`).attr("src",`images/equipment/Equipment_Icon_${s}_Tier${i}.png`),$(`#ba-statpreview-gear${e}-level`).text(`T${i}`),$(`#ba-statpreview-gear${e}-name`).text(getTranslatedString(n,"Name")),$(`#ba-statpreview-gear${e}-description`).html(getGearStatsText(n)),statPreviewIncludeEquipment&&(a&&recalculateStatsWithDelay(),updateGearIcon())}function getEquipmentId(e,t){return find(data.equipment,"Category",e)[t-1]}function getGearStatsText(e,t=", "){let a=[];for(let t=0;t<e.StatType.length;t++){let s=e.StatValue[t][1];"Coefficient"==e.StatType[t].split("_")[1]&&(s=parseFloat((s/100).toFixed(2))+"%"),a.push(`${getStatName(e.StatType[t])} +<b>${s}</b>`)}return a.join(t)}function toggleStrikerBonus(){statPreviewViewSupportStats=!statPreviewViewSupportStats,statPreviewViewSupportStats&&statPreviewSelectedChar>0&&changeStudentSummon(0,!1),$("#ba-student-stat-table").toggleClass("striker-bonus",statPreviewViewSupportStats),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewViewSupportStats),recalculateStats()}function toggleGear(){statPreviewIncludeEquipment=!statPreviewIncludeEquipment,$("#ba-statpreview-status-equipment").toggleClass("deactivated",!statPreviewIncludeEquipment),$("#ba-statpreview-gear").toggleClass("disabled",!statPreviewIncludeEquipment),$("#ba-statpreview-gear-toggle").toggleClass("checked",statPreviewIncludeEquipment),$("#ba-statpreview-gear input").prop("disabled",!statPreviewIncludeEquipment),updateGearIcon(),recalculateStats()}function toggleBuffs(){statPreviewIncludeBuffs=!statPreviewIncludeBuffs,$("#ba-statpreview-status-buffs").toggleClass("deactivated",!statPreviewIncludeBuffs),$("#ba-statpreview-buff-toggle").toggleClass("checked",statPreviewIncludeBuffs),statPreviewExternalBuffs.toggleDisabled(!statPreviewIncludeBuffs),recalculateStats()}function toggleBond(e){1==e?(statPreviewIncludeBond=!statPreviewIncludeBond,$("#ba-statpreview-status-bond-level").toggleClass("deactivated",!statPreviewIncludeBond),$("#ba-statpreview-bond-1-toggle").toggleClass("checked",statPreviewIncludeBond),$("#ba-statpreview-bond-1").toggleClass("disabled",!statPreviewIncludeBond),$("#ba-statpreview-bond-1 input").prop("disabled",!statPreviewIncludeBond)):(statPreviewIncludeBondAlts=!statPreviewIncludeBondAlts,student_bondalts.length>0&&($("#ba-statpreview-status-bond-alt-level").toggleClass("deactivated",!statPreviewIncludeBondAlts),$(`#ba-statpreview-bond-${e}-toggle`).toggleClass("checked",statPreviewIncludeBondAlts),$(`#ba-statpreview-bond-${e}`).toggleClass("disabled",!statPreviewIncludeBondAlts),$(`#ba-statpreview-bond-${e} input`).prop("disabled",!statPreviewIncludeBondAlts))),recalculateStats()}function togglePassiveSkill(){statPreviewIncludePassive=!statPreviewIncludePassive,$("#ba-statpreview-status-passive-level").toggleClass("deactivated",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill-toggle").toggleClass("checked",statPreviewIncludePassive),$("#ba-statpreview-passiveskill").toggleClass("disabled",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill input").prop("disabled",!statPreviewIncludePassive),recalculateStats()}function toggleExGear(){statPreviewIncludeExGear=!statPreviewIncludeExGear,$("#ba-statpreview-ex-gear-toggle").toggleClass("checked",statPreviewIncludeExGear),$("#ba-statpreview-ex-gear").toggleClass("disabled",!statPreviewIncludeExGear),updateGearIcon(),recalculateStats()}function changeStatPreviewLevel(e,t=!0){const a=parseInt(e.value);if($(".statpreview-level").val(a),$("#ba-statpreview-level").text("Lv."+a),$("#ba-statpreview-level-modal").text(`Lv.${a} / ${e.max}`),statPreviewIncludeEquipment)for(let e=0;e<3;e++)$(`#ba-statpreview-gear${e+1}`).toggleClass("disabled",a<gear_minlevelreq[e]),$(`#ba-statpreview-gear${e+1}-range`).prop("disabled",a<gear_minlevelreq[e]);statPreviewLevel=a,t&&recalculateStatsWithDelay()}function changeSkillPreviewLevel(e){e.value==e.max?$("#ba-skill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-skill-level").html("Lv."+e.value),recalculateSkillPreview()}function changeWeaponSkillPreviewLevel(e){e.value==e.max?$("#ba-weapon-skill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-weapon-skill-level").html("Lv."+e.value),recalculateWeaponSkillPreview()}function changeGearSkillPreviewLevel(e){e.value==e.max?$("#ba-gear-skill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-gear-skill-level").html("Lv."+e.value),recalculateGearSkillPreview()}function changeEXSkillPreviewLevel(e){e.value==e.max?$("#ba-skill-ex-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-skill-ex-level").html("Lv."+e.value),recalculateEXSkillPreview()}function changeWeaponPreviewLevel(e){$("#ba-weaponpreview-level").text("Lv."+e.value),recalculateWeaponPreview()}function changeStatPreviewBondLevel(e,t=!0){const a=parseInt($(`#ba-statpreview-bond-${e}-range`).val());var s;$(`#ba-statpreview-bond-${e}-level`).html(`<i class="fa-solid fa-heart me-1"></i> ${a}`),1==e?(s=Object.entries(getBondStats(student,a)),statPreviewBondLevel=a,$("#ba-statpreview-status-bond-level .label").html(a)):(s=Object.entries(getBondStats(student_bondalts[e-2],a)),statPreviewBondAltLevel=a,$("#ba-statpreview-status-bond-alt-level .label").html(a)),$(`#ba-statpreview-bond-${e}-description`).html(`${getStatName(s[0][0])} <b>+${getFormattedStatAmount(s[0][1])}</b>, ${getStatName(s[1][0])} <b>+${getFormattedStatAmount(s[1][1])}</b>`),t&&recalculateStatsWithDelay()}function changeStatPreviewWeaponLevel(e){updateWeaponLevelStatPreview(e.value),recalculateStatsWithDelay()}function updateWeaponLevelStatPreview(e){$("#ba-statpreview-weapon-level, #ba-student-weapon-level").html("Lv."+e);let t=getWeaponStats(student,e),a="";$(Object.entries(t)).each((function(e,t){t[1]>0&&(a+=`${getStatName(t[0])} <b>+${getFormattedStatAmount(t[1])}</b>, `)})),statPreviewWeaponLevel=parseInt(e),$("#ba-statpreview-weapon-description").html(a.substring(0,a.length-2))}function changeStatPreviewPassiveSkillLevel(e,t=!0){e.value==e.max?$("#ba-statpreview-passiveskill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-statpreview-passiveskill-level").html("Lv."+e.value),statPreviewPassiveLevel=parseInt(e.value),updatePassiveSkillStatPreview(),t&&recalculateStatsWithDelay()}function changeStatPreviewSummonSourceSkillLevel(e,t=!0){statPreviewExLevel=parseInt(e.value),updateSummonSourceSkill(),t&&recalculateStatsWithDelay()}function getBondTargetsHTML(e,t){return`<div><div id="ba-statpreview-bond-${e}-toggle" class="d-flex header-toggle" onclick="toggleBond(${e})">\n    <h5 class="flex-fill">${translateUI("student_bond")}</h5>\n    <i class="fa-regular fa-square off"></i>\n    <i class="fa-solid fa-square-check on"></i></div>\n    <div id="ba-statpreview-bond-${e}" class="p-2 mb-2 ba-panel"><div class="mb-1 d-flex flex-row align-items-center"><div class="ba-bond-icon me-2" style="position: relative;"><img src="images/student/icon/${t.CollectionTexture}.png"></div><div class="flex-fill"><h5>${getTranslatedString(t,"Name")}</h5><p id="ba-statpreview-bond-${e}-description" class="mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p></div></div><div class="d-flex flex-row align-items-center"><input id="ba-statpreview-bond-${e}-range" oninput="changeStatPreviewBondLevel(${e})" type="range" class="form-range statpreview-bond me-2 flex-fill" value="${1==e?statPreviewBondLevel:statPreviewBondAltLevel}" min="1" max="${region.bondlevel_max}"><span id="ba-statpreview-bond-${e}-level" class="ba-slider-label"></span></div></div></div>`}function changeBondLevel(e){$("#ba-bond-level").html(e.value),recalculateBondPreview()}function updateGearIcon(){let e,t,a="";for(let s=1;s<=3;s++)t=statPreviewIncludeEquipment?$(`#ba-statpreview-gear${s}-range`).val():1,a+=(""==a?"":" / ")+"T"+$(`#ba-statpreview-gear${s}-range`).val(),e=find(data.equipment,"Id",gearId[student.Equipment[s-1]]+(t-1))[0],$(`#ba-student-gear-${s}-icon`).attr("src",`images/equipment/Equipment_Icon_${e.Category}_Tier${t}.png`).tooltip("dispose").tooltip({title:getRichTooltip(`images/equipment/Equipment_Icon_${e.Category}_Tier${t}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory",e.Category),`T${t}`,getTranslatedString(e,"Desc")+`\n\n<b>${translateUI("stat_info")}:</b>\n`+getGearStatsText(e,"\n"),50,"img-scale-larger"),placement:"top",html:!0}).toggleClass("gear-disabled",!statPreviewIncludeEquipment),$(`#ba-student-gear-${s}-icon`).attr("onclick",`loadItem(${e.Id+2e6})`);"Released"in student.Gear&&student.Gear.Released[regionID]&&$("#ba-student-gear-4-icon").toggleClass("gear-disabled",!statPreviewIncludeExGear||!statPreviewIncludeEquipment)}function recalculateTerrainAffinity(){let e;["Street","Outdoor","Indoor"].forEach(e=>{let t=adaptaionAmount[student[`${e}BattleAdaptation`]+(5==statPreviewStarGrade&&statPreviewWeaponGrade>=3&&student.Weapon.AdaptationType==e?student.Weapon.AdaptationValue:0)];$(`#ba-student-terrain-${e.toLowerCase()}-icon`).attr("src",`images/ui/Ingame_Emo_Adaptresult${t}.png`),$(`#ba-student-terrain-${e.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(`images/ui/Ingame_Emo_Adaptresult${t}.png`,translateUI("terrain_adaption",[getLocalizedString("AdaptationType",e)])+" "+t,null,null,getAdaptationText(e,t),30),placement:"top",html:!0})})}function recalculateWeaponPreview(){let e=$("#ba-weaponpreview-levelrange").val(),t=getWeaponStats(student,e);$("#ba-weapon-stat-table .stat-AttackPower .stat-value").text("+"+t.AttackPower.toLocaleString()),$("#ba-weapon-stat-table .stat-MaxHP .stat-value").text("+"+t.MaxHP.toLocaleString()),$("#ba-weapon-stat-table .stat-HealPower .stat-value").text("+"+t.HealPower.toLocaleString())}function generateStatTable(e,t,a,s=0){let i="";t.forEach((function(e){i+=`\n            <div class="col-${a}"><div class="stat-${e} d-flex align-items-center"><span class="stat-icon"><img class="invert-light" src="images/staticon/Stat_${e}.png"></span><span class="stat-name">${getLocalizedString("Stat",e)}</span><span class="flex-fill"></span><span class="stat-value">`,s&&(i+='<span class="stat-base"></span><span class="stat-flat"></span><span class="stat-coefficient"></span><span class="stat-final"></span>'),i+="</span></div></div>"})),i=`<div class="row g-0">${i}</div>`,$(e).html(i)}function recalculateStatsWithDelay(){recalculationLimitTimeout&&clearTimeout(recalculationLimitTimeout),setTimeout(recalculateStats,50)}function recalculateStats(){let e=$("#ba-student-stat-table").hasClass("striker-bonus"),t=$("#ba-statpreview-levelrange").val(),a,s,i;if(statPreviewSelectedChar>0&&(i=find(data.summons,"Id",student.Summons[statPreviewSelectedChar-1].Id)[0],s=new CharacterStats(i,t,i.StarBonus?statPreviewStarGrade:1)),a=new CharacterStats(student,t,statPreviewStarGrade),compareMode&&(studentCompareStats=new CharacterStats(studentCompare,t,statPreviewStarGrade)),statPreviewIncludeEquipment){let e,n;for(let l=0;l<3;l++){if(n=parseInt($(`#ba-statpreview-gear${l+1}-range`).val()),e=find(data.equipment,"Id",gearId[student.Equipment[l]]+n-1)[0],t>=gear_minlevelreq[l])for(let t=0;t<e.StatType.length;t++)a.addBuff(e.StatType[t],e.StatValue[t][1]),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e.StatType[t],e.StatValue[t][1]);if(compareMode&&(e=find(data.equipment,"Id",gearId[studentCompare.Equipment[l]]+n-1)[0],t>=gear_minlevelreq[l]))for(let t=0;t<e.StatType.length;t++)studentCompareStats.addBuff(e.StatType[t],e.StatValue[t][1])}statPreviewIncludeExGear&&"Released"in student.Gear&&student.Gear.Released[regionID]&&(a.addBuff(student.Gear.StatType[0],student.Gear.StatValue[0][1]),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(student.Gear.StatType[0],student.Gear.StatValue[0][1]),compareMode&&"Released"in studentCompare.Gear&&studentCompare.Gear.Released[regionID]&&studentCompareStats.addBuff(studentCompare.Gear.StatType[0],studentCompare.Gear.StatValue[0][1]))}if(statPreviewIncludeBond){let e=$("#ba-statpreview-bond-1-range").val(),t=getBondStats(student,Math.min(maxbond[statPreviewStarGrade-1],e));Object.entries(t).forEach(e=>{a.addBuff(e[0],e[1])}),compareMode&&(t=getBondStats(studentCompare,Math.min(maxbond[statPreviewStarGrade-1],e)),Object.entries(t).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if(statPreviewIncludeBondAlts)for(let e=2;e<=student_bondalts.length+1;e++){let t=$(`#ba-statpreview-bond-${e}-range`).val(),s=getBondStats(student_bondalts[e-2],t);Object.entries(s).forEach(e=>{a.addBuff(e[0],e[1])})}if($("#statpreview-buff-transferable-conflict").hide(),$("#statpreview-buff-transferable-incompatible").hide(),$("#statpreview-buff-transferable-controls .buff-description span").toggleClass("invalid",!1),statPreviewIncludeBuffs&&void 0!==statPreviewExternalBuffs&&!statPreviewViewSupportStats&&!compareMode){let e=[];statPreviewExternalBuffs.buffs.forEach((t,n)=>{t.Skill.Effect.Effects.forEach((l,r)=>{let o=!0;if("Restrictions"in l&&l.Restrictions.forEach(({Property:e,Operand:t,Value:a})=>{switch(t){case"Equal":o=student[e]==a}}),!o||"Support"==student.SquadType&&0==statPreviewSelectedChar&&"sub"!=t.Skill.SkillType)$("#statpreview-buff-transferable-incompatible").toggle(statPreviewIncludeBuffs),$(`#statpreview-buff-transferable-controls div[data-index='${n}'] .buff-description span[data-effect='${r}']`).toggleClass("invalid",!0);else if(e.find(e=>e.type==t.Skill.SkillType&&e.channel==l.Channel))$("#statpreview-buff-transferable-conflict").toggle(statPreviewIncludeBuffs),$(`#statpreview-buff-transferable-controls div[data-index='${n}'] .buff-description span[data-effect='${r}']`).toggleClass("invalid",!0);else{const n="StackSame"in l?l.Value[0][t.Level-1]*t.Stacks:l.Value[t.Stacks-1][t.Level-1];a.addBuff(l.Stat,n),statPreviewSelectedChar>0&&"sub"==t.Skill.SkillType||("Icon"in l?a.addActiveBuffIcon(l.Icon,0,"StackSame"in l?t.Stacks:1):a.addActiveBuffIcon(l.Stat,n,"StackSame"in l?t.Stacks:1),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(l.Stat,n)),e.push({type:t.Skill.SkillType,channel:l.Channel})}})})}if(statPreviewIncludePassive&&!statPreviewViewSupportStats){let e=find(student.Skills,"SkillType",(statPreviewWeaponGrade>=2?"weapon":"")+"passive")[0],t=getPassiveSkillBonus(e,$("#ba-statpreview-passiveskill-range").val());Object.entries(t).forEach(e=>{a.addBuff(e[0],e[1]),0==statPreviewSelectedChar&&a.addActiveBuffIcon(e[0],e[1])}),compareMode&&(e=find(studentCompare.Skills,"SkillType",(statPreviewWeaponGrade>=2?"weapon":"")+"passive")[0],t=getPassiveSkillBonus(e,$("#ba-statpreview-passiveskill-range").val()),Object.entries(t).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if(!enableCustomBuffs||void 0===statPreviewCustomBuffs||statPreviewViewSupportStats||compareMode||statPreviewCustomBuffs.buffs.forEach((e,t)=>{a.addBuff(e.Stat,e.Amount),a.addActiveBuffIcon(e.Stat,e.Amount),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e.Stat,e.Amount)}),5==statPreviewStarGrade&&statPreviewWeaponGrade>0){let e=getWeaponStats(student,$("#ba-statpreview-weapon-range").val());Object.entries(e).forEach(e=>{a.addBuff(e[0],e[1]),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e[0],e[1])}),compareMode&&(e=getWeaponStats(studentCompare,$("#ba-statpreview-weapon-range").val()),Object.entries(e).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if("Main"!=student.SquadType||void 0===statPreviewSupportStats||statPreviewViewSupportStats||compareMode||statPreviewSupportStats.supportStudents.forEach((e,t)=>{const s=new CharacterStats(e.student,e.level,e.starGrade);for(let t=0;t<3;t++){const a=e.equipment[t],i=find(data.equipment,"Id",gearId[e.student.Equipment[t]]+a-1)[0];if(e.level>=gear_minlevelreq[t])for(let e=0;e<i.StatType.length;e++)s.addBuff(i.StatType[e],i.StatValue[e][1])}if(e.gear&&"Released"in e.student.Gear&&e.student.Gear.Released[regionID]&&s.addBuff(e.student.Gear.StatType[0],e.student.Gear.StatValue[0][1]),5==e.starGrade&&e.weaponStarGrade>0){const t=getWeaponStats(e.student,e.weaponLevel);Object.entries(t).forEach(e=>{s.addBuff(e[0],e[1])})}const i=getBondStats(e.student,Math.min(maxbond[e.starGrade-1],e.bond[0]));Object.entries(i).forEach(e=>{s.addBuff(e[0],e[1])});for(let t=1;t<e.bond.length;t++){const a=find(data.students,"Id",e.student.FavorAlts[t-1])[0],i=getBondStats(a,e.bond[t]);Object.entries(i).forEach(e=>{s.addBuff(e[0],e[1])})}const n=s.getStrikerBonus("MaxHP"),l=s.getStrikerBonus("AttackPower"),r=s.getStrikerBonus("DefensePower"),o=s.getStrikerBonus("HealPower");let d="";d+=getStatName("MaxHP")+` +<b>${n}</b>, `,d+=getStatName("AttackPower")+` +<b>${l}</b>, `,d+=getStatName("DefensePower")+` +<b>${r}</b>, `,d+=getStatName("HealPower")+` +<b>${o}</b>`,$(statPreviewSupportStats.elements.controls).find(`div[data-index="${t}"] .support-stats-desc`).html(d),a.addBuff("MaxHP_Base",n),a.addBuff("AttackPower_Base",l),a.addBuff("DefensePower_Base",r),a.addBuff("HealPower_Base",o)}),statPreviewSelectedChar>0&&!compareMode){const e=$("#ba-statpreview-summon-range").val(),t=student.Summons[statPreviewSelectedChar-1];for(let i=0;i<t.InheritCasterStat.length;i++)s.addCharacterStatsAsBuff(a,t.InheritCasterStat[i],t.InheritCasterAmount[i][e-1]),a.addActiveBuffIcon(t.InheritCasterStat[i],1)}"Support"==student.SquadType&&(a.stats.AmmoCount[0]=0),compareMode&&"Support"==studentCompare.SquadType&&(studentCompareStats.stats.AmmoCount[0]=0);let n=statPreviewSelectedChar>0?s:a;const l=["DefensePower","CriticalPoint","StabilityPoint"];studentStatListFull.forEach((t,a)=>{let s,i,r="";if(e&&0==statPreviewSelectedChar&&a<4)s="+"+n.getStrikerBonus(t).toLocaleString();else if("AmmoCount"==t){let e=n.getTotalString("AmmoCount"),t=n.getTotalString("AmmoCost");s=0==e?"-":`<span class="has-tooltip">${e}&nbsp;(${t})</span>`}else s=n.getTotalString(t);if(compareMode){let a,s;a=e?"Support"!=studentCompare.SquadType?n.getStrikerBonus(t):n.getStrikerBonus(t)-studentCompareStats.getStrikerBonus(t):n.getTotal(t)-studentCompareStats.getTotal(t),s="Rate"==t.slice(-4)?`${parseFloat(Math.abs(a/100).toFixed(1)).toLocaleString()}%`:`${Math.abs(a).toLocaleString()}`,r=a<0?`<small class="comparison less"><i class="fa-solid fa-circle-chevron-down"></i>&nbsp;${s}</small>`:a>0?`<small class="comparison greater"><i class="fa-solid fa-circle-chevron-up"></i>&nbsp;${s}</small>`:'<small class="comparison"><i class="fa-solid fa-circle-dot"></i>&nbsp;0</small>'}if(l.includes(t)&&(!e||a>4)&&(s='<span class="has-tooltip">'+s+"</span>"),$("#ba-student-modal-statpreview").hasClass("show")){$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-base`).text(n.getBaseString(t));const e=n.getFlatString(t);$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-flat`).text(e).toggleClass("zero","+0"==e).toggleClass("negative",e.startsWith("-"));const a=n.getCoefficientString(t);$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-coefficient`).text(a).toggleClass("zero","+0%"==a).toggleClass("negative",a.startsWith("-")),$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-final`).html(s)}else $(`#ba-student-stat-table .stat-${t} .stat-value`).html(s+r)});let r=translateUI("stat_defense_tooltip",[`<b>${n.getDefenseDamageReduction()}</b>`]),o=translateUI("stat_crit_tooltip");const d=[20,100,500];d.forEach(e=>{o+="\n"+translateUI("stat_crit_amount_tooltip",[`<b>${n.getCriticalHitChance(e)}</b>`,e])});let c=translateUI("stat_stability_tooltip",[`<b>${n.getStabilityMinDamage()}</b>`]);$(".stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(r),html:!0,placement:"top"}),$(".stat-CriticalPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(o),html:!0,placement:"top"}),$(".stat-StabilityPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(c),html:!0,placement:"top"}),0!=n.getTotalString("AmmoCount")&&$(".stat-AmmoCount .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(getNormalAttackHitsText(statPreviewSelectedChar>0?i.DamageDist:student.DamageDist,n.getTotalString("AmmoCost"),statPreviewSelectedChar>0?i.WeaponType:student.WeaponType,student.BulletType.toLowerCase())),html:!0,placement:"top"}),a.renderActiveBuffs(".active-buffs",7),student.Id in studentCollection?(collectionUpdateTimeout&&clearTimeout(collectionUpdateTimeout),collectionUpdateTimeout=window.setTimeout(()=>{studentCollectionSave(),statPreviewSettingsSave()},50)):(collectionUpdateTimeout&&clearTimeout(collectionUpdateTimeout),collectionUpdateTimeout=window.setTimeout(()=>{statPreviewSettingsSave()},50))}function refreshStatTableControls(){if($("#ba-statpreview-status-bond-level").toggleClass("deactivated",!statPreviewIncludeBond),$("#ba-statpreview-status-bond-level .label").html($("#ba-statpreview-bond-1-range").val()),$("#ba-statpreview-bond-1-toggle").toggleClass("checked",statPreviewIncludeBond),$("#ba-statpreview-bond-1").toggleClass("disabled",!statPreviewIncludeBond),$("#ba-statpreview-bond-1 input").prop("disabled",!statPreviewIncludeBond),student_bondalts.length>0&&($("#ba-statpreview-status-bond-alt-level").toggleClass("deactivated",!statPreviewIncludeBondAlts),$("#ba-statpreview-status-bond-alt-level .label").html($("#ba-statpreview-bond-2-range").val()),$("#ba-statpreview-bond-2-toggle").toggleClass("checked",statPreviewIncludeBondAlts),$("#ba-statpreview-bond-2").toggleClass("disabled",!statPreviewIncludeBondAlts),$("#ba-statpreview-bond-2 input").prop("disabled",!statPreviewIncludeBondAlts)),$("#ba-statpreview-status-passive-level").toggleClass("deactivated",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill-toggle").toggleClass("checked",statPreviewIncludePassive),$("#ba-statpreview-passiveskill").toggleClass("disabled",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill input").prop("disabled",!statPreviewIncludePassive),$("#ba-statpreview-status-buffs").toggleClass("deactivated",!statPreviewIncludeBuffs),statPreviewExternalBuffs.toggleDisabled(!statPreviewIncludeBuffs),$("#ba-statpreview-buff-toggle").toggleClass("checked",statPreviewIncludeBuffs),$("#ba-statpreview-ex-gear-toggle").toggleClass("checked",statPreviewIncludeExGear),$("#ba-statpreview-ex-gear").toggleClass("disabled",!statPreviewIncludeExGear),$("#ba-statpreview-status-equipment").toggleClass("deactivated",!statPreviewIncludeEquipment),$("#ba-statpreview-gear").toggleClass("disabled",!statPreviewIncludeEquipment),$("#ba-statpreview-gear-toggle").toggleClass("checked",statPreviewIncludeEquipment),$("#ba-statpreview-gear input").prop("disabled",!statPreviewIncludeEquipment),statPreviewIncludeEquipment)for(let e=0;e<3;e++)$(`#ba-statpreview-gear${e+1}`).toggleClass("disabled",student.level<gear_minlevelreq[e]),$(`#ba-statpreview-gear${e+1}-range`).prop("disabled",student.level<gear_minlevelreq[e])}function recalculateEXSkillPreview(){$(".tooltip").tooltip("hide");let e=$("#ba-skillpreview-exrange").val(),t=find(student.Skills,"SkillType","ex")[0];$("#ba-skill-ex-description").html(getSkillText(getTranslatedString(t,"Desc"),t.Parameters,e,student.BulletType,t.DamageDist?t.DamageDist:[],t.DamageDistParam?t.DamageDistParam:1)),$("#ba-skill-ex-description .skill-hitinfo").tooltip({html:!0}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-skill-ex-materials").hide(),$("#ba-skill-ex-materials-"+e).show(),$("#ba-skill-ex-cost").text(t.Cost[e-1])}function recalculateSkillPreview(){$(".tooltip").tooltip("hide");let e=$("#ba-skillpreview-range").val(),t;["normal","passive","sub"].forEach(t=>{let a=find(student.Skills,"SkillType",t)[0];$(`#ba-skill-${t}-description`).html(getSkillText(getTranslatedString(a,"Desc"),a.Parameters,e,student.BulletType,a.DamageDist?a.DamageDist:[],a.DamageDistParam?a.DamageDistParam:1)),$(`#ba-skill-${t}-description .skill-hitinfo`).tooltip({html:!0})}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-skill-materials").hide(),$("#ba-skill-materials-"+e).show()}function getStudentListCardHTML(e){let t=getTranslatedString(e,"Name"),a;return`\n    <div id="student-select-${e.Id}" class="selection-grid-card card-student" onclick="loadStudent('${e.PathName}')">\n        <div class="card-img">\n            <img src="images/student/collection/${e.CollectionTexture}.webp">\n        </div>\n        <span class="card-badge student-role top-left bg-${e.SquadType.toLowerCase()}-t"><img src="images/ui/Role_${e.TacticRole}.png"></span>\n        <span class="card-badge student-type atk bg-atk-${e.BulletType.toLowerCase()}-t"><img src="images/ui/Type_Attack_s.png"></span>\n        <span class="card-badge student-type def bg-def-${e.ArmorType.toLowerCase()}-t"><img src="images/ui/Type_Defense_s.png"></span>\n        <span class="card-badge student-rarity">${'<i class="fa-solid fa-star"></i>'.repeat(e.StarGrade)}</span>\n        <div class="card-label">\n            <span class="label-text ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}">${t}</span>\n            <span class="label-text hover ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}" style="display: none;">${t}</span>\n        </div>\n    </div>`}function getStageCardHTML(e,t=0){let a="",s=label_enemy_smalltext_threshold.En;e.Id>=7e6?a="Event":e.Id>=1e6?a="Campaign":e.Id>=6e4?(a="SchoolDungeon",s=label_enemy_smalltext_threshold[userLang]):e.Id>=3e4?(a="WeekDungeon",s=label_enemy_smalltext_threshold[userLang]):a="Unknown";let i=l(e),n=`<div id="stage-select-${e.Id}" class="selection-grid-card card-stage" onclick="loadStage('${e.Id}')">\n    <div class="card-img"><img loading="lazy" src="images/campaign/${getStageIcon(e,a)}.png"></div>`;return t>0&&(n+=`<span class="card-badge stage-droprate">${getProbabilityText(t)}</span>`),n+='<div class="card-label">',n+=`<span class="label-text ${i.length>s?"smalltext":""}">${i}</span>`,n+="</div></div>",n;function l(){switch(a){case"Event":return`${1==e.Difficulty?"Quest":"Challenge"} ${e.Stage.toString().padStart(2,"0")}`;case"Campaign":return`${e.Area}-${e.Stage} ${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,[String.fromCharCode(64+e.Stage)])}`}}}function getShopCardHTML(e){let t=label_enemy_smalltext_threshold[userLang],a=getLocalizedString("ShopCategory",e.ShopCategory),s,i;switch(e.CostType){case"Item":s=find(data.items,"Id",e.CostId)[0],i=s.Category;break;case"Currency":s=find(data.currency,"Id",e.CostId)[0],i="Currency"}let n='<div class="selection-grid-card card-shop">\n    <div class="card-img"><img loading="lazy" src="images/ui/BG_Shop.png"></div>';return n+=`<span class="card-badge shop-cost" title="${getRichTooltip(`images/items/${s.Icon}.png`,getTranslatedString(s,"Name"),getLocalizedString("ItemCategory",i),getRarityTier(s.Rarity),getTranslatedString(s,"Desc").replace("&","&amp;"),50,"img-scale-larger")}"><img src="images/items/${s.Icon}.png"><span>&times;${abbreviateNumber(e.CostAmount)}${e.Amount>1?` (${e.Amount})`:""}</span></span>`,n+='<div class="card-label">',n+=`<span class="label-text ${a.length>t?"smalltext":""}">${a}</span>`,n+="</div></div>",n}function getEventCardHTML(e){let t=e%1e4,a=getLocalizedString("EventName",t)+(e>1e4?translateUI("event_rerun"):""),s;s=0!=regionID&&data.common.regions[regionID].events.includes(t)?"Cn"==userLang?"Tw":userLang:"Jp";let i=`\n    <div id="event-select-${e}" class="selection-grid-card card-event" onclick="populateEventStageList(${e});">\n        <div class="card-bg"><div style="background-image:url('images/campaign/Campaign_Event_${t}_Normal.png');"></div>\n        </div>\n        <div class="card-img"><img src="images/eventlogo/Event_${t}_${s}.png"></div>`;return i+=`<div class="card-label"><span class="label-text ${a.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${a}</span></div></div>`,i}function getStageIcon(e,t){switch(t){case"Event":return`Campaign_Event_${e.EventId>1e4?e.EventId-1e4:e.EventId}_${1==e.Difficulty?"Normal":"Hard"}`;case"Campaign":return`Campaign_Image_${e.Area.toString().padStart(2,"0")}_${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":return`WeekDungeon_Image_${e.Type}`;case"SchoolDungeon":return`SchoolDungeon_Image_${e.Type}`}}function getRaidCardHTML(e,t="",a=null){let s=getTranslatedString(e,"Name");a||(a=e.Terrain.length>1&&t==e.Terrain[1]?`Boss_Portrait_${e.PathName}_LobbyBG_${t}`:`Boss_Portrait_${e.PathName}_LobbyBG`);let i=`<div id="raid-select-${e.Id}" class="selection-grid-card card-raid" onclick="loadRaid(${e.Id});"><div class="card-bg"><div style="background-image:url('images/raid/${a}.png');"></div></div><div class="card-img"><img src="images/raid/Boss_Portrait_${e.PathName}_Lobby.png"></div><div class="card-badge raid-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png" style="width:100%;"></div>`;return""!=t&&(i+=`<div class="card-badge raid-terrain"><img class="invert-light" src="images/ui/Terrain_${t}.png"></div>`),i+=`<div class="card-label"><span class="label-text ${s.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${getTranslatedString(e,"Name")}</span></div></div>`,i}function getTimeAttackCardHTML(e){let t=getLocalizedString("TimeAttackStage",e.DungeonType),a=`<div id="raid-select-${e.Id}" class="selection-grid-card card-raid" onclick="loadRaid(${e.Id});"><div class="card-bg"><div style="background-image:url('images/timeattack/${timeAttackBG[e.DungeonType]}.png');"></div></div><div class="card-img ta-img"><img src="images/enemy/${e.Icon}.png"></div><div class="card-badge raid-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png"></div><div class="card-badge raid-terrain"><img class="invert-light" src="images/ui/Terrain_${e.Terrain}.png"></div>`;return a+=`<div class="card-label"><span class="label-text ${t.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${t}</span></div></div>`,a}function getEnemyCardHTML(e,t,a,s=0,i=!0){let n=getTranslatedString(e,"Name"),l=getSmallTextThreshold(n,label_enemy_smalltext_threshold),r=`<div class="selection-grid-card card-enemy" ${i?`data-enemy='${e.Id}_${t}_${a}_${s}'`:""} onclick="showEnemyInfo(${e.Id},${t},${a},${s},${!i})"><div class="card-img"><img src="images/enemy/${e.Icon}.png"></div>`;return"Elite"==e.Rank?r+='<div class="card-badge enemy-rank"><img src="images/ui/Common_Icon_Enemy_Elite.png" style="width:22px;"></div>':"Champion"==e.Rank&&(r+='<div class="card-badge enemy-rank"><img src="images/ui/Common_Icon_Enemy_Champion.png" style="width:31px;"></div>'),r+=`<div class="card-badge enemy-level">Lv.${t}</div><div class="card-badge enemy-atk bg-atk-${e.BulletType.toLowerCase()}"><img src="images/ui/Type_Attack_s.png" style="width:100%;"></div>\n    <div class="card-badge enemy-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="width:100%;"></div><div class="card-label"><span class="label-text ${n.length>l?"smalltext":""}">${n}</span></div></div>`,r}function showEnemyInfo(e,t,a=1,s=0,i=!1){$(".card-enemy").removeClass("selected"),"stages"==loadedModule&&i&&$("#ba-stage-tab-enemies").tab("show"),$(`.card-enemy[data-enemy='${e}_${t}_${a}_${s}']`).addClass("selected");let n=find(data.enemies,"Id",e)[0];$("#ba-stage-enemy-name").html(getTranslatedString(n,"Name")),$("#ba-stage-enemy-img").attr("src",`images/enemy/${n.Icon}.png`),$("#ba-stage-enemy-rank").text(`Lv.${t} ${getLocalizedString("EnemyRank",n.Rank)}`),$("#ba-stage-enemy-class").text(getLocalizedString("SquadType",n.SquadType)).removeClass("ba-class-main ba-class-support").addClass(`ba-class-${n.SquadType.toLowerCase()}`);let l=getEnemySize(n);$("#ba-stage-enemy-size").text(null!=l?getLocalizedString("EnemyTags",l):"").toggle(null!=l),$("#ba-stage-enemy-attacktype").removeClass("bg-atk-normal bg-atk-explosion bg-atk-pierce bg-atk-mystic").addClass(`bg-atk-${n.BulletType.toLowerCase()}`),$("#ba-stage-enemy-defensetype").removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed bg-def-normal").addClass(`bg-def-${n.ArmorType.toLowerCase()}`),$("#ba-stage-enemy-attacktype-label").text(getLocalizedString("BulletType",n.BulletType)),$("#ba-stage-enemy-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",n.BulletType)}`,translateUI("attacktype"),null,getAttackTypeText(n.BulletType),32),placement:"top",html:!0}),$("#ba-stage-enemy-defensetype-label").text(getLocalizedString("ArmorType",n.ArmorType)),$("#ba-stage-enemy-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",n.ArmorType)}`,translateUI("defensetype"),null,getDefenseTypeText(n.ArmorType),32),placement:"top",html:!0});let r=new CharacterStats(n,t,a,n.Transcendence?n.Transcendence:[],s);enemyStatList.forEach(e=>{"AmmoCount"==e?$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).text("Main"==n.SquadType?r.getBaseString("AmmoCount")+" ("+r.getBaseString("AmmoCost")+")":"-"):"DefensePower"==e?$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).html(`<span class="has-tooltip">${r.getBaseString(e)}</span>`):$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).text(r.getBaseString(e))});let o=translateUI("stat_defense_tooltip",[`<b>${r.getDefenseDamageReduction()}</b>`]);$(".stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(o),html:!0,placement:"top"})}function populateMapEnemyList(e){stageMapModal.hide();let t={};const a=["Minion","Elite","Champion","Boss"];let s=find(loadedStage.Formations,"Id",e)[0],i="";for(let e=0;e<s.EnemyList.length;e++){let i=find(data.enemies,"Id",s.EnemyList[e])[0],n=a.indexOf(i.Rank);t[`${4-n}_${i.Id}_${s.Level[n]}_${s.Grade[n]}`]=i}Object.keys(t).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],i+=getEnemyCardHTML(t[e],e_level,e_grade,0,!1)}),$("#ba-stage-map-enemies").html(i),window.scrollTo({top:$("#ba-stage-map-enemies").prop("offsetTop"),left:0})}function getMaterialIconHTML(e,t){let a,s,i;return e>=3e6?(a=find(data.currency,"Id",e-3e6)[0],s="Currency"):(a=find(data.items,"Id",e)[0],s=a.Category),i=`<div class="drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${a.Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/items/${a.Icon}.png`,getTranslatedString(a,"Name"),getLocalizedString("ItemCategory",s),getRarityTier(a.Rarity),getTranslatedString(a,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/items/${a.Icon}.png"><span class="ba-material-label" style="cursor:pointer;">&times;${t}</span></div>`,i}function getDropIconHTML(e,t,a=1,s=1,i=!1){let n,l,r,o,d;if(e>=4e6){if(groups=find(data.common.GachaGroup,"Id",e-4e6),!(groups.length>0))return"";r=groups[0],l="GachaGroup",d="Box",iconPath="items",o=!1}else e>=3e6?(n=find(data.currency,"Id",e-3e6)[0],l="Currency",d="Currency",iconPath="items",o=!1):e>=2e6?(n=find(data.equipment,"Id",e-2e6)[0],l="Equipment",d=n.Category,iconPath="equipment",o=!0):e>=1e6?(n=find(data.furniture,"Id",e-1e6)[0],l="Furniture",d=n.Category,iconPath="furniture",o=!0):(n=find(data.items,"Id",e)[0],l="Item",d=n.Category,iconPath="items",o=!0);let c="";n&&(c="Equipment"==l&&n.Id>=1e3?`T${n.Id%10+1}`:getRarityTier(n.Rarity));let u="";if("GachaGroup"==l){let e="N";if(1==r.ItemList.length)return getDropIconHTML(r.ItemList[0][0],t<1?t:r.ItemList[0][3]);{let a,s,i;if(r.Id>=6e5&&r.Id<7e5){i=translateUI("item_equipment_box")+"\n",iconPath="equipment";let e="",t="";const n=r.ItemList.reduce((e,t)=>e+t[1],0);for(let s=0;s<r.ItemList.length;s++){let l=find(data.equipment,"Id",r.ItemList[s][0]-2e6)[0];i+=`${getTranslatedString(l,"Name")} (${getProbabilityText(r.ItemList[s][1]/n)})\n`,a=l.Icon,t=getLocalizedString("ItemCategory",l.Category),""!=e&&(e+="/"),e+=`T${l.Id%10+1}`}s=translateUI("item_randombox_tier",[e,t])}else if(r.Id>=3e5&&r.Id<6e5){i=translateUI("item_equipment_box")+"\n",iconPath="equipment";let e="",t="";const n=r.ItemList.reduce((e,t)=>e+t[1],0);for(let s=0;s<r.ItemList.length;s++){let l=find(data.equipment,"Id",r.ItemList[s][0]-2e6)[0];i+=`${getTranslatedString(l,"Name")} (${getProbabilityText(r.ItemList[s][1]/n)})\n`,0==s&&(e=`T${l.Id%10+1} `,a=l.Icon),""!=t&&(t+="/"),t+=getLocalizedString("ItemCategory",l.Category)}s=translateUI("item_randombox_tier",[e,t])}else if(r.Id>=10100&&r.Id<=10103){tier=r.Id-10099,a=r.Icon,s=translateUI("item_randombox_tier",["T"+tier,getLocalizedString("ItemCategory","Artifact")]),i=translateUI("item_artifact_box")+"\n",e=r.Rarity;const t=r.ItemList.reduce((e,t)=>e+t[1],0);for(let e=0;e<r.ItemList.length;e++){let a;i+=`${getTranslatedString(find(data.items,"Id",r.ItemList[e][0])[0],"Name")} (${getProbabilityText(r.ItemList[e][1]/t)})\n`}}u=`<div class="item-drop drop-shadow" style="position: relative; data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/${iconPath}/${a}.png`,s,getLocalizedString("ItemCategory","Box"),"",i,50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.toLowerCase()}" src="images/${iconPath}/${a}.png"><span class="ba-material-label">${getProbabilityText(t)}</span></div>`}}else u=`<div class="item-drop drop-shadow" style="position: relative; ${o?'cursor:pointer;" onclick="loadItem('+e+')"':'"'} title="${getRichTooltip(`images/${iconPath}/${n.Icon}.png`,getTranslatedString(n,"Name"),getLocalizedString("ItemCategory",d),c,getTranslatedString(n,"Desc").replace("&","&amp;"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${n.Rarity.toLowerCase()}" src="images/${iconPath}/${n.Icon}.png"><span class="ba-material-label" ${o?'style="cursor:pointer;"':""}>${s>1||i?parseFloat((100*t).toFixed(2))+"&#37;":getProbabilityText(t)}</span>${s>1?`<span class="label-qty">&times;${a!=s?abbreviateNumber(a)+"~"+abbreviateNumber(s):abbreviateNumber(s)}</span>`:""}</div>`;return u}function formatString(e,t=[]){return e.replace(/\{([0-9]+)\}/g,(e,a)=>a<t.length?t[a]:"")}function getProbabilityText(e){return e>=1?"&times;"+abbreviateNumber(parseInt(e).toFixed(0)).toLocaleString():parseFloat((100*e).toFixed(2))+"&#37;"}function getStudentIconSmall(e){var t;return`<div class="ba-item-student drop-shadow d-inline-block" style="position: relative; cursor: pointer;" data-bs-toggle="tooltip" data-bs-placement="top" onclick="loadStudent('${e.PathName}')" title="${getRichTooltip(`images/student/icon/${e.CollectionTexture}.png`,getTranslatedString(e,"Name"),translateUI("student"),getRarityStars(e.StarGrade),getTranslatedString(e,"ProfileIntroduction").split("\n")[0],50,"circle")}"><img src="images/student/icon/${e.CollectionTexture}.png"></div>`}function getFavourIconHTML(e,t){var a=find(data.items,"Id",e)[0],s;return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${a.Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/items/${a.Icon}.png`,getTranslatedString(a,"Name"),getLocalizedString("ItemCategory",a.Category),getRarityTier(a.Rarity),getTranslatedString(a,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/items/${a.Icon}.png"><img class="ba-favor-label" src="images/ui/Cafe_Interaction_Gift_0${t}.png"></div>`}function getFurnitureIconHTML(e){var t;return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${e.Id+1e6})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/furniture/${e.Icon}.png`,getTranslatedString(e,"Name"),getLocalizedString("ItemCategory",e.Category),getRarityStars(e.Rarity),getTranslatedString(e,"Desc"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.Rarity.toLowerCase()} mb-2" src="images/furniture/${e.Icon}.png"></div>`}function recalculateWeaponSkillPreview(){let e=$("#ba-weapon-skillpreview-range").val(),t=find(student.Skills,"SkillType","weaponpassive")[0];$("#ba-skill-weaponpassive-description").html(getSkillText(getTranslatedString(t,"Desc"),t.Parameters,e,student.BulletType)),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function recalculateGearSkillPreview(){if(!("Released"in student.Gear))return;let e=$("#ba-gear-skillpreview-range").val(),t=find(student.Skills,"SkillType","gearnormal")[0];$("#ba-skill-gearnormal-description").html(getSkillText(getTranslatedString(t,"Desc"),t.Parameters,e,student.BulletType)),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function recalculateBondPreview(){var e=$("#ba-bond-levelrange").val(),t=getBondStats(student,e);$(`#ba-bond-stat-table .stat-${student.FavorStatType[0]} .stat-value`).text("+"+t[student.FavorStatType[0]].toLocaleString()),$(`#ba-bond-stat-table .stat-${student.FavorStatType[1]} .stat-value`).text("+"+t[student.FavorStatType[1]].toLocaleString())}function getBondStats(e,t){var a=0,s=0;for(let i=1;i<Math.min(t,50);i++)i<20?(a+=e.FavorStatValue[Math.floor(i/5)][0],s+=e.FavorStatValue[Math.floor(i/5)][1]):i<50&&(a+=e.FavorStatValue[2+Math.floor(i/10)][0],s+=e.FavorStatValue[2+Math.floor(i/10)][1]);return{[e.FavorStatType[0]]:a,[e.FavorStatType[1]]:s}}function getWeaponStats(e,t){let a={MaxHP:0,AttackPower:0,HealPower:0},s=(t-1)/99;return"Standard"==e.Weapon.StatLevelUpType&&(s=s.toFixed(4)),a.AttackPower=Math.round(e.Weapon.AttackPower1+(e.Weapon.AttackPower100-e.Weapon.AttackPower1)*s),a.MaxHP=Math.round(e.Weapon.MaxHP1+(e.Weapon.MaxHP100-e.Weapon.MaxHP1)*s),a.HealPower=Math.round(e.Weapon.HealPower1+(e.Weapon.HealPower100-e.Weapon.HealPower1)*s),a}function changeStatPreviewStars(e,t,a=!0){let s=statPreviewWeaponGrade;statPreviewStarGrade=e,statPreviewWeaponGrade=t;for(let t=1;t<=5;t++)$(`.statpreview-star-${t}`).toggleClass("active",t<=e);for(let e=1;e<=3;e++)$(`.weaponpreview-star-${e}`).toggleClass("active",e<=t);const i=parseInt($("#ba-statpreview-bond-1-range").val());if(i>maxbond[e-1]&&($("#ba-statpreview-bond-1-range").val(maxbond[e-1]),changeStatPreviewBondLevel(1,!1)),$("#ba-statpreview-bond-1-range").attr("max",maxbond[e-1]),t>0){$("#ba-statpreview-weapon").toggleClass("disabled",!1),$(".statpreview-weapon-range").prop("disabled",!1);let e=20+10*t;$(".statpreview-weapon-range").attr("max",e),a&&$(".statpreview-weapon-range").val(e),updateWeaponLevelStatPreview(e)}else $("#ba-statpreview-weapon").toggleClass("disabled",!0),$(".statpreview-weapon-range").prop("disabled",!0);$("#ba-student-weapon-level").toggle(statPreviewWeaponGrade>0),(3==t&&s<3||3==s&&t<3)&&recalculateTerrainAffinity(),(t>=2&&s<2||s>=2&&t<2)&&updatePassiveSkillStatPreview(),a&&recalculateStats()}function updatePassiveSkillStatPreview(){const e=$("#ba-statpreview-passiveskill-range").val(),t=statPreviewWeaponGrade>=2,a=find(student.Skills,"SkillType",(t?"weapon":"")+"passive")[0],s=getPassiveSkillBonus(a,e);$("#ba-statpreview-passiveskill-name").text(getTranslatedString(a,"Name"));let i="";$(Object.entries(s)).each((function(e,t){let a=t[1];t[0].includes("_Coefficient")&&(a/=1e4),a>0&&(i+=`${getStatName(t[0])} <b>+${getFormattedStatAmount(a)}</b>, `),a<0&&(i+=`${getStatName(t[0])} <b>${getFormattedStatAmount(a)}</b>, `)})),$("#ba-statpreview-passiveskill-desc").html(i.substring(0,i.length-2)),$(".statpreview-passive-plus").toggle(t),$("#ba-statpreview-status-passive-level .label").html(e<10?`Lv.${e}`:'<img class="sharp-img" src="images/ui/ImageFont_Max.png" style="height:16px;">')}function updateSummonSourceSkill(){if(statPreviewSelectedChar>0){$("#ba-statpreview-summon").show();const e=student.Summons[statPreviewSelectedChar-1],t=find(student.Skills,"SkillType",e.SourceSkill)[0],a="ex"==e.SourceSkill?5:10;$("#ba-statpreview-summon-range").attr("max",a);const s=$("#ba-statpreview-summon-range").val();s==a?$("#ba-statpreview-summon-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-statpreview-summon-level").html("Lv."+s),$("#ba-statpreview-summon-name").text(getTranslatedString(t,"Name")),$("#ba-statpreview-summon-desc").empty(),$("#ba-statpreview-summon-icon").attr("src",`images/skill/${t.Icon}.png`);for(let t=0;t<e.InheritCasterStat.length;t++)$("#ba-statpreview-summon-desc").append((0==t?"":"\n")+translateUI("summon_inheritance",[`<b>${parseFloat((e.InheritCasterAmount[t][s-1]/100).toPrecision(3))}%</b>`,getTranslatedString(student,"Name"),getStatName(e.InheritCasterStat[t])]))}else $("#ba-statpreview-summon").hide()}function populateItemList(e){let t="",a,s=function(e){return`<div id="item-select-${e}" data-itemid="${e}" class="selection-grid-card ${"compact"==gridItemDisplayStyle?"compact":""} card-items" style="display:none;"></div>`};switch(gridItemDisplayStyle){case"detailed":a=n;break;case"compact":a=l}const i=getItemIdOffset(e);if(data[e].forEach(e=>{e.IsReleased[regionID]&&(t+=s(e.Id+i))}),t+=`<div id="item-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`,$("#item-search-filters-panel >div >div").hide(),$(`#item-search-filters-panel >div >div.show-${e}`).show(),loadedItemList=e,$("#item-select-grid").html(t),updateItemList(!0),loadedItemType==e){$(`#item-select-${loadedItem.Id+getItemIdOffset(e)}`).addClass("selected");let t=$(`#item-select-${loadedItem.Id+getItemIdOffset(e)}`).prop("offsetTop")-100;$("#ba-item-list-container .card-body").scrollTop(void 0===t?0:t)}function n(e){const t=find(data[loadedItemList],"Id",e%1e6)[0],a=getTranslatedString(t,"Name"),s=getSmallTextThreshold(a,label_craft_smalltext_threshold);let i=`<div class="card-img ba-item-${t.Rarity.toLowerCase()}"><img loading="lazy" src="images/${loadedItemList}/${t.Icon}.png"></div>`;return"furniture"==loadedItemList&&t.Interaction[regionID]&&(i+='<div class="card-badge furniture-interaction"><img src="images/ui/Cafe_Icon_Interaction.png"></div>'),"equipment"==loadedItemList&&t.Id>=1e3&&(i+=`<div class="card-badge equipment-tier">T${t.Tier}</div>`),i+=`<div class="card-label"><span class="label-text ${a.length>s?"smalltext":""}">${a}</span></div>`,i}function l(e){const t=find(data[loadedItemList],"Id",e%1e6)[0],a=getTranslatedString(t,"Name");return`<div class="card-compact ba-item-${t.Rarity.toLowerCase()}" title="${getBasicTooltip(getTranslatedString(t,"Name"))}"><img loading="lazy" src="images/${loadedItemList}/${t.Icon}.png"></div>`}loadObserver&&loadObserver.disconnect(),loadObserver=new IntersectionObserver((function(e,t){e.forEach(e=>{e.isIntersecting&&(e.target.innerHTML=a(parseInt(e.target.id.replace("item-select-",""))),"compact"==gridItemDisplayStyle&&$(e.target).children(".card-compact").tooltip({html:!0,placement:"top",delay:{show:200,hide:0},container:$(".card-body")}),loadObserver.unobserve(e.target))})}),{root:$("#ba-item-list-container .card-body")[0]}),$("#item-select-grid div[data-itemid]").each((function(e,t){loadObserver.observe(t)}))}function getItemIdOffset(e){switch(e.toLowerCase()){case"furniture":return 1e6;case"equipment":return 2e6;case"currency":return 3e6;default:return 0}}function populateCraftList(){html=["","",""],html[0]="",html[1]="",html[2]="",html_h1=`<div id="craft-list-grid-header-1" class="w-100 ba-grid-header mb-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","1")}</h3></div>`,html_h2=`<div id="craft-list-grid-header-2" class="w-100 ba-grid-header my-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","2")}</h3></div>`,html_h3=`<div id="craft-list-grid-header-3" class="w-100 ba-grid-header my-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","3")}</h3></div>`,data.crafting.Nodes[regionID].sort((e,t)=>e.Quality-t.Quality),data.crafting.Nodes[regionID].sort((e,t)=>t.Icon.localeCompare(e.Icon));const e=$("#craft-search-text").val();$.each(data.crafting.Nodes[regionID],(function(t,a){a.Weight>0&&(""==e||getTranslatedString(a,"Name").toLowerCase().includes(e.toLowerCase()))&&(html[a.Tier-1]+=getCraftingCardHTML(a,a.Weight/data.crafting.TotalWeight[regionID][a.Tier-1]))})),$("#craft-select-grid").empty();for(let e=0;e<3;e++)""!=html[e]&&$("#craft-select-grid").append(`<div id="craft-list-grid-header-${e+1}" class="w-100 ba-grid-header mb-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier",e+1)}</h3></div>${html[e]}`);0==$("#craft-select-grid").children().length&&$("#craft-select-grid").append(`<div id="craft-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`),html="",data.crafting.Fusion.forEach(t=>{const a=t.ResultId>=1e6?"furniture":"items",s=find(data[a],"Id",t.ResultId%1e6)[0];if(t.Released[regionID]&&s.IsReleased[regionID]){const i=getTranslatedString(s,"Name"),n=getSmallTextThreshold(i,label_craft_smalltext_threshold);(""==e||i.toLowerCase().includes(e.toLowerCase()))&&(html+=`<div id="craft-select-${t.Id+1e5}" data-itemid="${t.Id+1e5}" class="selection-grid-card card-items"><div class="card-img ba-item-${s.Rarity.toLowerCase()}"><img loading="lazy" src="images/${a}/${s.Icon}.png"></div><div class="card-label"><span class="label-text ${i.length>n?"smalltext":""}">${i}</span></div></div>`)}}),""!=html?$("#fusion-select-grid").html(html):$("#fusion-select-grid").html(`<div id="fusion-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`),$("#craft-select-"+loadedCraftId).addClass("selected");let t=$(`#craft-select-${loadedCraftId}`).prop("offsetTop")-100;$("#ba-craft-list-container .card-body").scrollTop(void 0===t?0:t)}function getCraftingCardHTML(e,t=-1){let a=getTranslatedString(e,"Name"),s=label_craft_smalltext_threshold[userLang],i=`<div id="craft-select-${e.Id}" class="selection-grid-card card-craft" onclick="loadCraft(${e.Id})"><div class="card-img ba-node-quality-${e.Quality}"><img loading="lazy" src="images/ui/${e.Icon}.png"></div>`;return t>=0&&(i+=`<span class="card-badge stage-droprate ${showNodeProbability?"":"hidden"}">${getProbabilityText(t)}</span>`),i+='<div class="card-label">',i+=`<span class="label-text ${a.length>s?"smalltext":""}">${a}</span>`,i+="</div></div>",i}function getSmallTextThreshold(e,t){return("En"==userLang||"Th"==userLang)&&e.codePointAt(0)>=12288&&e.codePointAt(0)<=40959?t.Jp:t[userLang]}function populateStageList(e){let t="",a="";switch(e){case"missions":$.each(data.stages.Campaign,(function(e,a){a.Area<=data.common.regions[regionID].campaign_max&&(t+=getStageCardHTML(a))})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-missions").tab("show"),$("#stage-select-grid").html(t);break;case"bounty":$.each(data.stages.WeekDungeon,(function(e,s){if(s.Id<31e3){if(s.Type!=a){let e=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`;t+=e}s.Stage<=data.common.regions[regionID].bounty_max&&(t+=getStageCardHTML(s)),a=s.Type}})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-bounty").tab("show"),$("#stage-select-grid").html(t);break;case"commissions":a="",$.each(data.stages.WeekDungeon,(function(e,s){if(s.Id>=31e3){if(s.Type!=a){let e=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`;t+=e}s.Stage<=data.common.regions[regionID].commission_max&&(t+=getStageCardHTML(s)),a=s.Type}})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-commissions").tab("show"),$("#stage-select-grid").html(t);break;case"schooldungeon":a="",$.each(data.stages.SchoolDungeon,(function(e,s){s.Type!=a&&(t+=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`),s.Stage<=data.common.regions[regionID].schooldungeon_max&&(t+=getStageCardHTML(s)),a=s.Type})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-schooldungeon").tab("show"),$("#stage-select-grid").html(t);break;case"events":data.common.regions[regionID].events.forEach(e=>{e<1e4&&(t+=getEventCardHTML(e))}),$(".stage-list").hide(),$("#event-list").show(),$("#ba-stages-list-tab-events").tab("show"),$("#event-select-grid").html(t)}if(loadedStageList=e,$("#stage-select-"+loadedStage.Id).addClass("selected"),loadedStage.Id<7e6){let e=$(`#stage-select-${loadedStage.Id}`).prop("offsetTop")-100;$("#ba-stages-list-container .card-body").scrollTop(void 0===e?0:e)}}function populateEventStageList(e){if("stages"==loadedModule){e%=1e4;let t=0,a=0,s;s=0!=regionID&&data.common.regions[regionID].events.includes(e)?"Cn"==userLang?"Tw":userLang:"Jp";let i=`<div class="ba-grid-header ba-panel p-2 eventlist-header" style="grid-column: 1/-1;order: 0;"><button id="stages-eventlist-back" type="button" class="btn btn-dark me-2" style="min-width:fit-content;" onclick="populateStageList('events')"><i class="fa-solid fa-chevron-left"></i><span class="d-inline ms-2">${getLocalizedString("StageType","Event")}</span></button><img class="mx-auto mx-lg-1" src="images/eventlogo/Event_${e}_${s}.png"><h4 class="flex-fill text-center px-1 mb-0">${getLocalizedString("EventName",""+e)}</h4></div></div>`;if(conquest_events.includes(e)){$(".stage-list").hide(),$("#conquest-list").show();let t=find(data.stages.ConquestMap,"EventId",e)[0];loadedConquest=t,$("#ba-conquest-header").html(i),$("#ba-conquest-step-n0").tab("show");for(let e=0;e<4;e++)$(`#ba-conquest-step-n${e}`).text(translateUI("conquest_area",[e+1]));changeConquestMap(0,0)}else{let s=find(data.stages.Event,"EventId",e);data.common.regions[regionID].events.includes(e+1e4)&&(s=s.concat(find(data.stages.Event,"EventId",e+1e4))),s.forEach(s=>{if(701!=e||!(1==s.Difficulty&&s.Stage>data.common.regions[regionID].event_701_max||2==s.Difficulty&&s.Stage>data.common.regions[regionID].event_701_challenge_max)){if(s.Difficulty!=t||s.EventId!=a){let e=1==s.Difficulty?"Quest":"Challenge",t;e+=s.EventId>1e4?" (Rerun)":"",i+=`<div class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${e}</h3></div>`}i+=getStageCardHTML(s),t=s.Difficulty,a=s.EventId}}),$(".stage-list").hide(),$("#stage-list").show(),$("#stage-select-grid").html(i),$("#stage-select-"+loadedStage.Id).addClass("selected")}loadedStageList=""+e,$("#ba-stages-list-tab-events").tab("show"),$("#ba-stages-list-container .card-body").scrollTop(0)}else conquest_events.includes(e)?loadModule("stages",find(data.stages.Conquest,"EventId",e%1e4)[0].Id):loadModule("stages",find(data.stages.Event,"EventId",e%1e4)[0].Id)}function populateRaidList(){var e="",e;e="",$.each(data.raids.Raid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a))})),$("#raid-select-grid").html(e),e="",$.each(data.raids.TimeAttack,(function(t,a){a.IsReleased[regionID]&&(e+=getTimeAttackCardHTML(a))})),$("#timeattack-select-grid").html(e),e="",$.each(data.raids.WorldRaid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a,"",a.IconBG))})),$("#worldraid-select-grid").html(e)}function getUsedByStudents(e,t){let a="",s=translateUI("item_usedby"),i="";if("equipment"==t)$.each(data.students,(function(t,s){s.IsReleased[regionID]&&(s.Equipment[0]!=e.Category&&s.Equipment[1]!=e.Category&&s.Equipment[2]!=e.Category||(a+=getStudentIconSmall(s)))}));else if("furniture"==t)s=`<img class="inline-img" src="images/ui/Cafe_Icon_Interaction.png"> ${translateUI("furniture_interaction_list")}`,$.each(data.students,(function(t,s){if(!s.IsReleased[regionID])return;let i=!1;for(let t=0;t<s.FurnitureInteraction[regionID].length;t++)e.Id==s.FurnitureInteraction[regionID][t]&&(i=!0);i&&(a+=getStudentIconSmall(s))}));else if("items"==t)if("Material"==e.Category)s=translateUI("item_usedby_skill"),$.each(data.students,(function(t,s){if(!s.IsReleased[regionID])return;let n=!1;for(let t=0;t<s.SkillExMaterial.length;t++){for(let a=0;a<s.SkillExMaterial[t].length;a++)if(e.Id==s.SkillExMaterial[t][a]){n=!0;break}if(n)break}if(!n)for(let t=0;t<s.SkillMaterial.length;t++){for(let a=0;a<s.SkillMaterial[t].length;a++)if(e.Id==s.SkillMaterial[t][a]){n=!0;break}if(n)break}n&&(a+=getStudentIconSmall(s)),"Released"in s.Gear&&s.Gear.Released[regionID]&&s.Gear.TierUpMaterial.forEach(t=>{t.includes(e.Id)&&(i+=getStudentIconSmall(s))})}));else if("SecretStone"==e.Category){s=translateUI("item_usedby_eleph");let t=find(data.students,"Id",e.Id)[0];a+=getStudentIconSmall(t)}return""!=a?($("#ba-item-usage").show(),a=`<div class="mb-2"><i>${s}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+a+"</div>",""!=i&&(a+=`<div class="mb-2"><i>${translateUI("item_usedby_gear")}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${i}</div>`),a):""}function getEquipmentRecipe(e){let t="",a=translateUI("craft_using");if("Recipe"in e){for(let a=0;a<e.Recipe.length;a++)t+=getDropIconHTML(e.Recipe[a][0]+2e6,e.Recipe[a][1]);t+=getDropIconHTML(3000001,e.RecipeCost)}return""!=t?($("#ba-equipment-recipe").show(),`<div class="mb-2"><i>${a}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+t+"</div>"):""}function getLikedByStudents(e){let t=["",""],a="",s="";return $.each(data.students,(function(a,i){if(!i.IsReleased[regionID])return;let n=i.FavorItemTags;if(n.push(i.FavorItemUniqueTags[0]),n.push(i.FavorItemUniqueTags[0]+"2"),"SSR"==e.Rarity){const a=getFavouriteSSRItems(n);a.forEach((a,s)=>{a.forEach(a=>{e.Id==a&&(t[s]+=getStudentIconSmall(i))})})}else{const a=getFavouriteItems(n);a.forEach((a,s)=>{a.forEach(a=>{e.Id==a&&(t[s]+=getStudentIconSmall(i))})})}"Released"in i.Gear&&i.Gear.Released[regionID]&&i.Gear.TierUpMaterial.forEach(t=>{t.includes(e.Id)&&(s+=getStudentIconSmall(i))})})),t.forEach((s,i)=>{""!=s&&(a+=`<div class="mb-2"><i>${translateUI("item_likedbystudent_list_"+i,[`<img class="inline-img" src="images/ui/Cafe_Interaction_Gift_0${("SSR"==e.Rarity?4:3)-i}.png">`])}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${t[i]}</div>`)}),""!=s&&(a+=`<div class="mb-2"><i>${translateUI("item_usedby_gear")}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${s}</div>`),$("#ba-item-usage").show(),a}function getItemDropStages(e){let t="",a=[];return $.each([data.stages.Campaign,data.stages.SchoolDungeon,data.stages.WeekDungeon],(function(t,s){s.forEach(t=>{if(!stageIsReleased(t))return;let s=!1,i=0,n=!1,l=0,r;if(r=1==regionID&&"RewardsGlobal"in t?t.RewardsGlobal:t.Rewards,"Default"in r)for(let t=0;t<r.Default.length;t++)if(r.Default[t][0]>=4e6){const a=find(data.common.GachaGroup,"Id",r.Default[t][0]-4e6)[0],o=a.ItemList.reduce((e,t)=>e+t[1],0);a.ItemList.forEach(a=>{e==a[0]&&(s=!0,n=!0,r.Default[t][1]>=1?(l=r.Default[t][1],dropCertainChance=a[1]/o):i=r.Default[t][1]*(a[1]/o))})}else if(e==r.Default[t][0]){s=!0,i=r.Default[t][1];break}if(s){if(n&&l>0){let e=1-Math.pow(1-dropCertainChance,l),t=i;i=e+i-e*i}a.push({chance:i,stage:t,box:n})}})})),a=a.sort((e,t)=>t.chance-e.chance),$.each(a,(function(e,a){t+=getStageCardHTML(a.stage,a.chance,a.box)})),""!=t?($("#ba-item-sources").show(),`<div class="mb-2"><i>${translateUI("item_obtainedfrom_stage")}</i></div><div class="selection-grid stage selection-grid-flex">`+t+"</div>"):""}function loadJSON(e,t){let a={},s=Object.entries(e).map((function(e){return $.getJSON(e[1],(function(t){a[e[0]]=t}))}));return Promise.all(s).then((function(){t(a)}))}function find(e,t,a){var s=[];return $.each(e,(function(e,i){i[t]==a&&s.push(i)})),s}function findOrDefault(e,t,a,s){var i=[],n=[];return $.each(e,(function(e,l){l[t]==a&&i.push(l),l[t]==s&&n.push(l)})),0==i.length?n:i}function getAttackTypeText(e){switch(e){case"Normal":return translateUI("attack_type_normal_desc");case"Explosion":return translateUI("attack_type_desc",[`<b class='ba-col-explosion'>${getLocalizedString("ArmorType","LightArmor")}</b>`,`<b class='ba-col-mystic'>${getLocalizedString("ArmorType","Unarmed")}</b>`]);case"Pierce":return translateUI("attack_type_desc",[`<b class='ba-col-pierce'>${getLocalizedString("ArmorType","HeavyArmor")}</b>`,`<b class='ba-col-explosion'>${getLocalizedString("ArmorType","LightArmor")}</b>`]);case"Mystic":return translateUI("attack_type_desc",[`<b class='ba-col-mystic'>${getLocalizedString("ArmorType","Unarmed")}</b>`,`<b class='ba-col-pierce'>${getLocalizedString("ArmorType","HeavyArmor")}</b>`])}return text}function getDefenseTypeText(e){switch(e){case"Normal":return translateUI("defense_type_normal_desc");case"LightArmor":return translateUI("defense_type_desc",[`<b class='ba-col-explosion'>${getLocalizedString("BulletType","Explosion")}</b>`,`<b class='ba-col-pierce'>${getLocalizedString("BulletType","Pierce")}</b>`]);case"HeavyArmor":return translateUI("defense_type_desc",[`<b class='ba-col-pierce'>${getLocalizedString("BulletType","Pierce")}</b>`,`<b class='ba-col-mystic'>${getLocalizedString("BulletType","Mystic")}</b>`]);case"Unarmed":return translateUI("defense_type_desc",[`<b class='ba-col-mystic'>${getLocalizedString("BulletType","Mystic")}</b>`,`<b class='ba-col-explosion'>${getLocalizedString("BulletType","Explosion")}</b>`])}return text}function getSkillText(e,t,a,s,i=[],n=1){let l=e,r;if(r=/[0-9.]+(?:%|s||| )/g,l=l.replace(r,(function(e){return`<strong>${e}</strong>`})),t)for(let e=1;e<=t.length;e++)for(;l.includes(`<?${e}>`);)l="raid"==s?1==a&&t[e-1][a-1]!=t[e-1][a]||a>1&&t[e-1][a-1]!=t[e-1][a-2]?l.replace(`<?${e}>`,`<span class="ba-col-emphasis">${t[e-1][a-1]}</span>`):l.replace(`<?${e}>`,t[e-1][a-1].replace(r,(function(e){return`<strong>${e}</strong>`}))):e==n&&i.length>1?l.replace(`<?${e}>`,`<span class="ba-col-${s.toLowerCase()} skill-hitinfo" data-bs-toggle="tooltip" data-bs-placement="top" title="${getBasicTooltip(getSkillHitsText(i,t[e-1][a-1],s.toLowerCase()))}">${t[e-1][a-1]}</span>`):l.replace(`<?${e}>`,`<span class="ba-col-${s.toLowerCase()}">${t[e-1][a-1]}</span>`);const o=["Buff","Debuff","CC","Special"];return o.forEach(e=>{r=new RegExp(`<${e.slice(0,1).toLowerCase()}:(\\w+)>`,"g"),l=l.replace(r,(function(t,a){const s=e+"_"+a;return`<span class="ba-skill-${e.toLowerCase()}" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/Combat_Icon_${s}.png`,getLocalizedString("BuffNameLong",s),getLocalizedString("BuffType",e),null,getLocalizedString("BuffTooltip",s),30)}"><img class="ba-buff-icon" src="images/buff/Combat_Icon_${s}.png"><span class="ba-buff-icon-spacer"></span>${getLocalizedString("BuffName",s)}</span>`}))}),l}function getSkillHitsText(e,t,a){let s={},i="";return t=parseFloat(t.replace("%","")),e.forEach(e=>{e=parseFloat((e/1e4*t).toFixed(1))+"%",s[e]=s[e]?s[e]+1:1}),Object.keys(s).forEach(e=>{i+=`${""==i?"":"\n"}<span class='ba-col-${a}'>${e}</span> <b>&times;${s[e]}</b>`}),translateUI("skill_hits_tooltip",[`<b>${e.length}</b>`])+`\n<small>${i}</small>`}function getNormalAttackHitsText(e,t,a,s){let i={},n="",l;switch(e.forEach(e=>{e=parseFloat((e/1e4*100).toFixed(1))+"%",i[e]=i[e]?i[e]+1:1}),Object.keys(i).forEach(e=>{n+=`${""==n?"":"\n"}<span class='ba-col-${s}'>${e}</span> <b>&times;${i[e]}</b>`}),a){case"GL":case"RL":case"Cannon":l=translateUI("stat_ammocount_tooltip_area",[`<b>${t}</b>`,`<b>${e.length}</b>`]);break;case"RG":l=translateUI("stat_ammocount_tooltip_line",[`<b>${t}</b>`,`<b>${e.length}</b>`]);break;default:l=translateUI("stat_ammocount_tooltip",[`<b>${t}</b>`,`<b>${e.length}</b>`])}return l+`\n<small>${n}</small>`}function getRichTooltip(e,t,a,s,i,n=50,l=""){var r="<span class='ba-tooltip'>";return r+="<div class='ba-tooltip-header'>",null!=e&&(r+=`<div class='ba-tooltip-img'><img class='${l}' src='${e}' width='${n}' height='${n}'></div>`),r+=`<div class='flex-fill d-flex flex-column'><div class='flex-fill d-flex flex-column justify-content-center'><div class='ba-tooltip-title'>${t.replace("-","&#8209;")}</div></div>`,null==a&&null==s||(r+="<div class='d-flex align-items-center mt-auto'>",r+=null!=a?`<span class='ba-tooltip-subtitle flex-fill'>${a}</span>`:"",r+=null!=s?`<span class='ba-tooltip-rarity text-bold'>${s}</span>`:"",r+="</div>"),r+="</div></div>",null!=i&&""!=i&&(r+=`<div class='ba-tooltip-body'>${i.replace(/\"/g,"&quot;")}</div>`),r+="</span>"}function getBasicTooltip(e){var t="<span class='ba-tooltip'>";return t+="<div class='ba-tooltip-header m-0'>",t+=`<div class='d-flex justify-content-center w-100'><div class='ba-tooltip-title text-center fs-6'>${e}</div></div>`,t+="</div>",t+="</span>"}function abbreviateNumber(e){for(var t=e,a=0,s=["","K","M","B"];t>=1e3;)a++,t/=1e3;return t+s[a]}function toggleDarkTheme(e){darkTheme=e,$("#ba-navbar-themeswitcher button").removeClass("active"),$(`#ba-navbar-themeswitcher-${e}`).addClass("active"),localStorage.setItem("theme",e),"auto"==e?$("body").toggleClass("theme-dark",window.matchMedia("(prefers-color-scheme: dark)").matches):$("body").toggleClass("theme-dark","dark"==e),document.querySelector('meta[name="theme-color"]').setAttribute("content",$("body").hasClass("theme-dark")?"#212529":"#dee2e6")}function toggleHighContrast(e){highContrast=e,$("#ba-navbar-contrast-toggle button").removeClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),localStorage.setItem("high_contrast",highContrast),$("body").toggleClass("high-contrast",highContrast)}function toggleCustomBuffs(e){enableCustomBuffs=e,$("#ba-navbar-custombuffs-toggle button").removeClass("active"),$(`#ba-navbar-custombuffs-toggle-${enableCustomBuffs}`).addClass("active"),localStorage.setItem("enable_custom_buffs",enableCustomBuffs),$("#statpreview-buff-custom").toggle(enableCustomBuffs)}function changeRegion(e){e!=regionID&&($(`#ba-navbar-regionselector-${regionID}`).removeClass("active"),regionID=e,localStorage.setItem("region",regionID),$(`#ba-navbar-regionselector-${regionID}`).addClass("active"),loadModule(loadedModule))}function changeLanguage(e){e!=userLang&&(json_lang_list=getLanguageJSONList(e.toLowerCase()),loadJSON(json_lang_list,e=>{data=Object.assign(data,e)}).then((function(t){setSortedDataLists(),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).removeClass("active"),$("body").removeClass(`font-${userLang.toLowerCase()}`),userLang=e,localStorage.setItem("language",e),$("#ba-navbar-languageselector span").text($(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).text()),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).addClass("active"),loadModule(loadedModule)}),(function(e){console.error(e)})))}function loadLanguage(e){$("body").addClass(`font-${e.toLowerCase()}`),$("*[data-localize-id]").each((function(e,t){let a=$(t).data("localize-id").split(",")[0],s=$(t).data("localize-id").split(",")[1];$(t).html(getLocalizedString(a,s))})),$("*[data-ph-localize-id]").each((function(e,t){let a=$(t).data("ph-localize-id").split(",")[0],s=$(t).data("ph-localize-id").split(",")[1];$(t).attr("placeholder",getLocalizedString(a,s))})),$("*[data-tooltip-id]").each((function(e,t){let a=$(t).data("tooltip-id").split(",")[0],s=$(t).data("tooltip-id").split(",")[1];$(t).tooltip({title:getBasicTooltip(getLocalizedString(a,s)),placement:"top",html:!0})}))}function getRarityStars(e){switch(e){case"N":case"R":case 1:return"<i class='fa-solid fa-star'></i>".repeat(1);case"SR":case 2:return"<i class='fa-solid fa-star'></i>".repeat(2);case"SSR":case 3:return"<i class='fa-solid fa-star'></i>".repeat(3)}}function getRarityTier(e){return`<i class='fa-solid fa-circle me-2 col-item-${e.toLowerCase()}'></i>${e}`}function searchContains(e,t){if("En"!=userLang){if(t.toLowerCase().includes(e))return!0}else{let a=(t=t.replace("&#x27;","").replace("&quot;","").replace("&amp;","&")).toLowerCase().replace(/['"!\?<>\(\)\.\-]/g,""),s=e.toLowerCase().replace(/['"!\?<>\(\)\.\-]/g,"");if(a.startsWith(s))return!0;for(;a.includes(" ");)if(a=a.substring(a.indexOf(" ")+1),a.startsWith(s))return!0}return!1}function allSearch(){let e=$("#ba-navbar-search").val().toLowerCase();if($("#navbar-search-results").scrollTop(0),""==e)return $("#navbar-search-results").html("").hide(),$("#navbar-search").removeClass("has-text"),$("#ba-navbar-search").removeClass("results-open"),$("#navbar-search-clear").hide(),searchResultsCount=0,searchResultsSelection=0,!0;$("#navbar-search-clear").show(),$("#navbar-search").addClass("has-text"),$("#navbar-search-results").html("").show();let t=[],a=25;if($.each(data.students,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/student/icon/"+s.CollectionTexture+".png",type:translateUI("student"),rarity:"",rarity_text:getRarityStars(s.StarGrade),onclick:`loadStudent('${s.PathName}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.raids.Raid,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:`images/raid/Boss_Portrait_${s.PathName}_Lobby.png`,type:getLocalizedString("StageType","Raid"),rarity:"",rarity_text:"",onclick:`loadRaid(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.raids.WorldRaid,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:`images/raid/Boss_Portrait_${s.PathName}_Lobby.png`,type:getLocalizedString("StageType","WorldRaid"),rarity:"",rarity_text:"",onclick:`loadRaid(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.items,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/items/"+s.Icon+".png",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:getRarityTier(s.Rarity),onclick:`loadItem(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.furniture,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/furniture/"+s.Icon+".png",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:getRarityStars(s.Rarity),onclick:`loadItem(${s.Id+1e6})`}),t.length>=25))return!1})),t.length<25&&$.each(data.equipment,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/equipment/"+s.Icon+".png",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:s.Id>=1e3?`T${s.Tier}`:getRarityTier(s.Rarity),onclick:`loadItem(${s.Id+2e6})`}),t.length>=25))return!1})),t.length<25&&$.each(data.crafting.Nodes[regionID],(function(a,s){if(s.Weight>0&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/ui/"+s.Icon+".png",type:getLocalizedString("NodeTier",s.Tier),rarity:`node-${s.Quality}`,rarity_text:getLocalizedString("NodeQuality",s.Quality),onclick:`loadCraft(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.Campaign,(function(a,s){let i=getStageName(s,"Campaign"),n=getStageTitle(s,"Campaign");if(s.Area<=data.common.regions[regionID].campaign_max&&(searchContains(e,i)||searchContains(e,n))&&(t.push({name:n,icon:"images/campaign/"+getStageIcon(s,"Campaign")+".png",type:i,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.WeekDungeon,(function(a,s){let i=getStageName(s,"WeekDungeon"),n=getStageTitle(s,"WeekDungeon");if(stageIsReleased(s)&&(searchContains(e,i)||searchContains(e,n))&&(t.push({name:n,icon:"images/campaign/"+getStageIcon(s,"WeekDungeon")+".png",type:i,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.SchoolDungeon,(function(a,s){let i=getStageName(s,"SchoolDungeon"),n=getStageTitle(s,"SchoolDungeon");if(stageIsReleased(s)&&(searchContains(e,i)||searchContains(e,n))&&(t.push({name:n,icon:"images/campaign/"+getStageIcon(s,"SchoolDungeon")+".png",type:getLocalizedString("StageType",s.Type),rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.Event,(function(a,s){let i=getStageName(s,"Event"),n=i.replace("\n"," "),l=getStageTitle(s,"Event");if(data.common.regions[regionID].events.includes(s.EventId)&&(searchContains(e,n)||searchContains(e,l))&&(t.push({name:l,icon:"images/campaign/"+getStageIcon(s,"Event")+".png",type:i,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length>0){let e="<div>";for(let a=0;a<t.length;a++)e+=`<div id="ba-search-result-item-${a+1}" class="ba-search-result-item" onclick="${t[a].onclick}; $('#navbar-search-clear').trigger('click');">\n            <div class='ba-search-img'><img src='${t[a].icon}' class='ba-item-${t[a].rarity.toLowerCase()}'></div>\n            <div class='flex-fill d-flex flex-column' style="min-width:0;"><div class='flex-fill d-flex flex-column justify-content-center'><div class='ba-search-name'>${t[a].name}</div></div>\n            <div class='d-flex align-items-center mt-auto'>\n            <span class='ba-search-subtitle flex-fill'>${t[a].type}</span>\n            <span class='ba-search-rarity'>${t[a].rarity_text}</span></div></div></div>`;e+="</div>",$("#navbar-search-results").html(e),$("#ba-navbar-search").addClass("results-open"),searchResultsCount=t.length,searchResultsSelection=0}else $("#navbar-search-results").hide(),$("#ba-navbar-search").removeClass("results-open"),searchResultsCount=0,searchResultsSelection=0}function searchNavigate(e){switch(e.code){case"Enter":e.preventDefault(),"keyup"==e.type&&(0==searchResultsSelection&&searchResultsCount>0?$("#ba-search-result-item-1").trigger("onclick"):$("#ba-search-result-item-"+searchResultsSelection).trigger("onclick"));break;case"ArrowDown":e.preventDefault(),"keydown"==e.type&&searchResultsSelection<searchResultsCount&&(searchResultsSelection++,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected"),$(`#ba-search-result-item-${searchResultsSelection}`)[0].scrollIntoView({behavior:"auto",block:"nearest"}));break;case"ArrowUp":e.preventDefault(),"keydown"==e.type&&searchResultsSelection>1&&(searchResultsSelection--,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected"),$(`#ba-search-result-item-${searchResultsSelection}`)[0].scrollIntoView({behavior:"auto",block:"nearest"}));break;case"Escape":e.preventDefault(),$("#navbar-search-clear").trigger("click")}}function getLocalizedString(e,t,a=[]){return data.localization.hasOwnProperty(e)&&data.localization[e].hasOwnProperty(t)?formatString(data.localization[e][t],a):(console.log(`Localization not defined for "${e}, ${t}"`),"undefined!!!")}function translateUI(e,t=[]){return getLocalizedString("ui",e,t)}function getTranslatedString(e,t){return e[t]?e[t]:e[t+userLang]?e[t+userLang]:e[t+"En"]?e[t+"En"]:e[t+"Jp"]?e[t+"Jp"]:(console.log(`No translations defined for "${e}.${t}"`),"")}function getFavouriteItems(e){let t=[[],[]];for(let a=5e3;a<5035;a++){let s=find(data.items,"Id",a)[0].Tags.filter(t=>e.includes(t));1==s.length?t[1].push(a):s.length>1&&t[0].push(a)}return t}function getFavouriteSSRItems(e){let t=[[],[]];for(let a=5100;a<5113;a++){let s=find(data.items,"Id",a)[0].Tags.filter(t=>e.includes(t));1==s.length?t[1].push(a):s.length>1&&t[0].push(a)}return t}function getCacheVerResourceName(e){return e+"?v="+cache_ver}function getPassiveSkillBonus(e,t){let a={};return e.Parameters.forEach((s,i)=>{s[t-1].includes("%")?a[e.Stat[i]+"_Coefficient"]=Math.round(100*parseFloat(s[t-1].replace("%",""))):a[e.Stat[i]+"_Base"]=Math.round(s[t-1])}),"StatFixed"in e&&e.StatFixed.forEach(e=>{e[1].includes("%")?a[e[0]+"_Coefficient"]=Math.round(100*parseFloat(e[1].replace("%",""))):a[e[0]+"_Base"]=Math.round(e[1])}),a}function stageIsReleased(e){return e.Id>8e6?data.common.regions[regionID].events.includes(e.EventId):e.Id>1e6?e.Area<=data.common.regions[regionID].campaign_max:e.Id>6e4?e.Stage<=data.common.regions[regionID].schooldungeon_max:e.Id>31e3?e.Stage<=data.common.regions[regionID].commission_max:e.Id>3e4&&e.Stage<=data.common.regions[regionID].bounty_max}function changeStudentSummon(e,t=!0){if(statPreviewSelectedChar=e,statPreviewViewSupportStats&&statPreviewSelectedChar>0&&toggleStrikerBonus(),compareMode&&(compareMode=!1,updateCompareModeControl()),$(".summon-list .dropdown-item").removeClass("active"),$(`.summon-list .dropdown-item[data-summon-id="${e}"]`).addClass("active"),$(".summon-list .summon-list-active-icon").attr("img"),statPreviewSelectedChar>0){const t=find(data.summons,"Id",student.Summons[e-1].Id)[0],a=find(student.Skills,"SkillType",student.Summons[e-1].SourceSkill)[0];$(".summon-list .summon-list-active-name").text(getTranslatedString(t,"Name")),$(".summon-list .summon-list-active-icon").attr("src",`images/skill/${a.Icon}.png`).addClass(`bg-skill ${student.BulletType.toLowerCase()}`)}else $(".summon-list .summon-list-active-name").html(getTranslatedString(student,"Name")),$(".summon-list .summon-list-active-icon").attr("src",`images/student/icon/${student.CollectionTexture}.png`).removeClass("bg-skill explosion pierce mystic");updateSummonSourceSkill(),t&&recalculateStats()}function updateCompareModeControl(){$(".comparemode-on").toggle(compareMode),$("#ba-student-stat-table").toggleClass("compare",compareMode),$("#ba-statpreview-status-compare").toggleClass("deactivated",!compareMode),compareMode?($("#ba-statpreview-status-title-compare").html(getTranslatedString(studentCompare,"Name")),$("#ba-statpreview-status-title-compare-icon").attr("src",`images/student/icon/${studentCompare.CollectionTexture}.png`).removeClass("bg-skill explosion pierce mystic"),$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_compare_remove")),placement:"top",html:!0})):$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_compare")),placement:"top",html:!0})}function openStudentComparison(){compareMode?(compareMode=!1,updateCompareModeControl(),recalculateStats()):($("#student-select-grid .selection-grid-card.disabled").removeClass("disabled"),$(`#student-select-${student.Id}`).addClass("disabled"),selectCompareMode=!0,studentSelectorModal.show())}function drawHexamap(e,t){$(t).empty();const a=90;let s=99,i=99,n=-99,l=-99,r=999999,o=0,d=50;e.HexaMap.forEach(e=>{s=Math.min(s,e.Pos[0]),i=Math.min(i,e.Pos[1]),l=Math.max(l,e.Pos[0]),n=Math.max(n,e.Pos[1])}),e.HexaMap.forEach(e=>{let t=e.Pos[0]-s,a=e.Pos[1]-i;r=Math.min(r,90*t+90*a*.5),o=Math.max(o,90+90*t+90*a*.5)});let c=new Array(e.HexaMap.length).fill(0),u=0;e.HexaMap.forEach((a,l)=>{let d=a.Pos[0]-s,g=a.Pos[1]-i;const p=90*d+90*g*.5-r,m=g*Math.sqrt(3*Math.pow(45,2))+50,h=[102101,902101,903108];let f="",b="";if(a.Type.startsWith("TileRemoveObject_TargetTile")&&0==c[l]&&0==c[a.Trigger]&&(u++,c[l]=u,c[a.Trigger]=u),"Entity"in a)if(a.Entity>1e8){let t=find(e.Formations,"Id",a.Entity)[0],s;if(f+=`<img class="ba-stage-map-enemy" src="images/enemy/${t.MapIcon}.png" style="z-index:${g}">`,f+='<div class="map-info">',b=` onclick="populateMapEnemyList(${a.Entity});" `,"Guard"==t.MoveType?f+='<span class="move-type guard"><i class="fa-solid fa-triangle-exclamation"></i></span>':"Pursuit"==t.MoveType&&(f+='<span class="move-type pursuit"><i class="fa-solid fa-angles-left"></i></span>'),f+=`<span class="def-type bg-def-${find(data.enemies,"Id",t.EnemyList[0])[0].ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="height:100%;"></span>`,f+="</div>","Grade"==t.UnitGrade.slice(0,5)){let e;f+=`<span class="unit-grade"><span class="grade">RANK<img src="images/ui/Strategy_Icon_EnemyRank_${parseInt(t.UnitGrade.slice(-1))}.png"></span></span>`}else"Boss"==t.UnitGrade&&(f+='<span class="unit-grade boss"></span>')}else if(a.Entity>1e6){let e;f+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(getTranslatedString(find(data.currency,"Id",4)[0],"Name")+" &times;50")}"><i class="fa-solid fa-gift"></i></span>`}else switch(a.Entity){case 101101:f+='<span class="start-tile"></span>';break;case 102101:case 902101:case 903108:f+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_spawn"))}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);"></i></span>`;break;case 103101:case 103102:f+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_drone"))}"><i class="fa-solid fa-eye"></i></span>`;break;case 102201:case 903101:f+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_remove"))}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);font-size: 20px;"></i><i class="fa-solid fa-ban" style="position: absolute;font-size: 38px;"></i></span>`;break;case 104101:case 104102:f+=`<span class="tile-icon group-${a.Entity-104100}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_twoway"))}"><i class="fa-solid fa-up-long"></i><i class="fa-solid fa-down-long"></i></span>`;break;case 105101:case 105201:f+=`<span class="tile-icon group-${(a.Entity-105001)/100+2}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_oneway_entrance"))}"><i class="fa-solid fa-up-long"></i></span>`;break;case 105102:case 105202:f+=`<span class="tile-icon group-${(a.Entity-105002)/100+2}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_oneway_exit"))}"><i class="fa-solid fa-down-long"></i></span>`;break;case 106101:f+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_food"))}"><i class="fa-solid fa-bowl-rice"></i></span>`;break;case 107101:f+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_atk"))}"><i class="fa-solid fa-gun"></i></span>`;break;case 107201:f+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_def"))}"><i class="fa-solid fa-shield"></i></span>`;break;case 109201:case 109202:case 109203:f+=`<span class="tile-icon lowered group-${a.Entity-109200}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_down"))}"><i class="fa-solid fa-chevron-up" style="margin-top: 12px;"></i></span>`;break;case 109204:case 109205:case 109206:f+=`<span class="tile-icon raised group-${a.Entity-109200-3}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_up"))}"><i class="fa-solid fa-chevron-down"></i></span>`;break;case 109301:case 109302:case 109303:f+=`<span class="tile-icon switch-tile lowered group-${a.Entity-109300}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_target_down"))}"></span>`;break;case 109304:case 109305:case 109306:f+=`<span class="tile-icon switch-tile group-${a.Entity-109300-3}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_target_up"))}"></span>`}f=`<div class="ba-stage-map-tile map-tile-${l} ${a.Type.startsWith("TileRemoveObject_TargetTile")&&h.includes(e.HexaMap[a.Trigger].Entity)?"hidden-tile":""} ${a.Type.startsWith("DisposableTileObject")?"cracked-tile":""}" ${b} style="left:${p}px;top:${m.toFixed(0)}px;${""!=b?"cursor:pointer;":""}">${f}</div>`,$(t).css("width",`${o-r}px`),$(t).css("height",`${150+(n-i)*Math.sqrt(3*Math.pow(45,2))}px`),$(t).append(f),$(".tile-icon, .tile-item").tooltip({html:!0})}),c.forEach((e,t)=>{$(`.map-tile-${t}`).addClass(`group-${e}`)})}function makeDraggable(e){$(e).on("mousedown",t=>{$(e).toggleClass("scrolling",!0),scrolling=!0,scrollPosition={left:e.scrollLeft(),top:e.scrollTop(),x:t.clientX,y:t.clientY}}),$(e).on("mouseleave",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mouseup",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mousemove",t=>{t.preventDefault(),scrolling&&($(e).scrollLeft(scrollPosition.left-(t.clientX-scrollPosition.x)),$(e).scrollTop(scrollPosition.top-(t.clientY-scrollPosition.y)))})}function openStageMapModal(){drawHexamap(loadedStage,"#ba-stage-modal-map-canvas"),$("#ba-stage-modal-map .modal-title").text($("#ba-stage-name").text()),stageMapModal.show()}function changeConquestMap(e,t){drawConquestHexamap(loadedConquest,e,t,"#ba-conquest-map-canvas")}function drawConquestHexamap(e,t,a,s){$(s).empty(),filteredTiles=e.Maps[t].Tiles.filter(e=>e.Step==a);const i=90;let n=99,l=99,r=-99,o=-99,d=999999,c=0,u=50;filteredTiles.forEach(e=>{n=Math.min(n,e.Pos[0]),l=Math.min(l,e.Pos[1]),o=Math.max(o,e.Pos[0]),r=Math.max(r,e.Pos[1])}),filteredTiles.forEach(e=>{let t=e.Pos[0]-n,a=e.Pos[1]-l;d=Math.min(d,90*t+90*a*.5),c=Math.max(c,90+90*t+90*a*.5)}),filteredTiles.forEach((e,t)=>{let a=e.Pos[0]-n,i=e.Pos[1]-l;const o=90*a+90*i*.5-d,u=i*Math.sqrt(3*Math.pow(45,2))+50;let g="",p="";"Start"==e.Type&&(g+='<span class="start-tile"></span>');const m=find(data.stages.Conquest,"Id",e.Id);if(m.length>0){const e=m[0],t=e.Formations[0];if(g+=`<img class="ba-stage-map-enemy" src="images/enemy/${t.MapIcon}.png" style="z-index:${i}">`,g+='<div class="map-info">',p=` onclick="loadStage(${e.Id});" `,"None"!=e.Team){const t=e.Team.replace("Team","");g+=`<span class="move-type team-${t}">${t}</span>`}let a;g+=`<span class="def-type bg-def-${find(data.enemies,"Id",t.EnemyList[0])[0].ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="height:100%;"></span>`,g+="</div>","Normal"==e.EnemyType||"Challenge"==e.EnemyType?g+=`<span class="unit-grade"><span class="grade">Lv. ${e.Level}</span></span>`:"Boss"==e.EnemyType?g+='<span class="unit-grade boss"></span>':"MiddleBoss"==e.EnemyType&&(g+='<span class="unit-grade leader"></span>')}g=`<div class="ba-stage-map-tile map-tile-${t} ${e.Type.startsWith("TileRemoveObject_TargetTile")&&spawnTiles.includes(stage.HexaMap[e.Trigger].Entity)?"hidden-tile":""} ${e.Type.startsWith("DisposableTileObject")?"cracked-tile":""}" ${p} style="left:${o}px;top:${u.toFixed(0)}px;${""!=p?"cursor:pointer;":""}">${g}</div>`,$(s).css("width",`${c-d}px`),$(s).css("height",`${150+(r-l)*Math.sqrt(3*Math.pow(45,2))}px`),$(s).append(g),$(".tile-icon, .tile-item").tooltip({html:!0})})}function toggleOwned(){student.Id in studentCollection?(delete studentCollection[student.Id],$("#ba-student-collection-btn").toggleClass("active",!1).html('<i class="fa-solid fa-circle-plus"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_add")),placement:"top",html:!0})):(studentCollectionSave(),$("#ba-student-collection-btn").toggleClass("active",!0).html('<i class="fa-solid fa-circle-check"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_remove")),placement:"top",html:!0})),(search_options.filter.Collection.Owned||search_options.filter.Collection.NotOwned)&&updateStudentList(),localStorage.setItem("student_collection",JSON.stringify(studentCollection)),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0)}function studentCollectionSave(){studentCollection[student.Id]={s:statPreviewStarGrade,l:parseInt($("#ba-statpreview-levelrange").val()),e1:parseInt($("#ba-statpreview-gear1-range").val()),e2:parseInt($("#ba-statpreview-gear2-range").val()),e3:parseInt($("#ba-statpreview-gear3-range").val()),ws:statPreviewWeaponGrade,wl:parseInt($("#ba-statpreview-weapon-range").val()),b:parseInt($("#ba-statpreview-bond-1-range").val()),s3:parseInt($("#ba-statpreview-passiveskill-range").val())};for(let e=2;e<=student_bondalts.length+1;e++)student_bondalts[e-2].Id in studentCollection&&(studentCollection[student_bondalts[e-2].Id].b=parseInt($(`#ba-statpreview-bond-${e}-range`).val()));localStorage.setItem("student_collection",JSON.stringify(studentCollection))}function statPreviewSettingsSave(){let e={StarGrade:statPreviewStarGrade,WeaponGrade:statPreviewWeaponGrade,Level:statPreviewLevel,WeaponLevel:statPreviewWeaponLevel,Equipment:statPreviewEquipment,BondLevel:statPreviewBondLevel,BondAltLevel:statPreviewBondAltLevel,PassiveLevel:statPreviewPassiveLevel,ExLevel:statPreviewExLevel,IncludePassive:statPreviewIncludePassive,IncludeExGear:statPreviewIncludeExGear,IncludeBond:statPreviewIncludeBond,IncludeBondAlts:statPreviewIncludeBondAlts,IncludeEquipment:statPreviewIncludeEquipment,IncludeBuffs:statPreviewIncludeBuffs};localStorage.setItem("student_settings",JSON.stringify(e))}function statPreviewSettingsLoad(){let e={};localStorage.getItem("student_settings")&&(e=JSON.parse(localStorage.getItem("student_settings"))),statPreviewStarGrade=e.StarGrade?e.StarGrade:3,statPreviewWeaponGrade=e.WeaponGrade?e.WeaponGrade:0,statPreviewLevel=e.Level?e.Level:1,statPreviewWeaponLevel=e.WeaponLevel?e.WeaponLevel:1,statPreviewEquipment=e.Equipment?e.Equipment:[99,99,99],statPreviewBondLevel=e.BondLevel?e.BondLevel:20,statPreviewBondAltLevel=e.BondAltLevel?e.BondAltLevel:20,statPreviewPassiveLevel=e.PassiveLevel?e.PassiveLevel:10,statPreviewExLevel=e.ExLevel?e.ExLevel:5,statPreviewIncludePassive=!!e.IncludePassive&&e.IncludePassive,statPreviewIncludeExGear=!!e.IncludeExGear&&e.IncludeExGear,statPreviewIncludeBond=!!e.IncludeBond&&e.IncludeBond,statPreviewIncludeBondAlts=!!e.IncludeBondAlts&&e.IncludeBondAlts,statPreviewIncludeEquipment=!!e.IncludeEquipment&&e.IncludeEquipment,statPreviewIncludeBuffs=!!e.IncludeBuffs&&e.IncludeBuffs}function exportDataString(){$("#collection-export-string").val(btoa(JSON.stringify(studentCollection))),navigator.clipboard.writeText($("#collection-export-string").val()),toastMessage(`<i class="fa-solid fa-circle-exclamation me-2"></i>${translateUI("toast_import_copy")}`,2500,"alert")}function importDataString(){try{let e=JSON.parse(atob($("#collection-import-string").val())),t={};Object.entries(e).forEach(e=>{t[e[0]]={s:e[1].s,l:e[1].l,e1:e[1].e1,e2:e[1].e2,e3:e[1].e3,ws:e[1].ws,wl:e[1].wl,b:e[1].b,s3:e[1].s3}}),localStorage.setItem("student_collection",JSON.stringify(t)),studentCollection=JSON.parse(localStorage.getItem("student_collection")),toastMessage(`<i class="fa-solid fa-circle-check me-2"></i>${translateUI("toast_import_success")}`,2500,"success"),"students"==loadedModule&&(loadStudent(student.PathName),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0),(search_options.filter.Collection.Owned||search_options.filter.Collection.NotOwned)&&updateStudentList())}catch(e){console.log(e),toastMessage(`<i class="fa-solid fa-circle-xmark me-2"></i>${translateUI("toast_import_failure")}`,2500,"failure")}}function importResourcePlannerData(){try{$(".tooltip").tooltip("hide");let e=JSON.parse($("#collection-import-string").val()),t={};e.characters.forEach(e=>{t[e.id]={s:e.current.star,l:e.current.level,e1:Math.max(e.current.gear1,1),e2:Math.max(e.current.gear2,1),e3:Math.max(e.current.gear3,1),ws:e.current.ue,wl:e.current.ue_level,b:e.current.bond,s3:Math.max(e.current.passive,1)}}),localStorage.setItem("student_collection",JSON.stringify(t)),studentCollection=JSON.parse(localStorage.getItem("student_collection")),toastMessage(`<i class="fa-solid fa-circle-check me-2"></i>${translateUI("toast_import_success")}`,2500,"success"),"students"==loadedModule&&(loadStudent(student.PathName),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0),(search_options.filter.Collection.Owned||search_options.filter.Collection.NotOwned)&&updateStudentList())}catch(e){console.log(e),toastMessage(`<i class="fa-solid fa-circle-xmark me-2"></i>${translateUI("toast_import_failure")}`,2500,"failure")}}function toastMessage(e,t,a){toastMessageTimeout&&clearTimeout(toastMessageTimeout),$("#toast-message").removeClass().addClass("p-2 ba-panel show").addClass(a).html(`<p class="m-0">${e}</p>`),toastMessageTimeout=window.setTimeout((function(){$("#toast-message").removeClass("show")}),t)}localStorage.getItem("theme")&&$("body").toggleClass("theme-dark","dark"==localStorage.getItem("theme")),$.when($.ready,loadPromise).then((function(){"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js"),gtag("config","G-XQEWDXR13H",{custom_map:{dimension1:"user_language"}}),statPreviewSettingsLoad(),localStorage.getItem("student_collection")&&(studentCollection=JSON.parse(localStorage.getItem("student_collection"))),loadRegion(regionID),setSortedDataLists(),darkTheme=localStorage.getItem("theme")?localStorage.getItem("theme"):"auto",toggleDarkTheme(darkTheme),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{"auto"==darkTheme&&($("body").toggleClass("theme-dark",e.matches),document.querySelector('meta[name="theme-color"]').setAttribute("content",$("body").hasClass("theme-dark")?"#212529":"#dee2e6"))}),$("body").toggleClass("reduced-motion",!1),highContrast=localStorage.getItem("high_contrast")?"true"==localStorage.getItem("high_contrast"):!CSS.supports("backdrop-filter","blur(1px)")||window.matchMedia("(prefers-contrast: more)").matches,localStorage.getItem("enable_custom_buffs")&&(enableCustomBuffs="true"==localStorage.getItem("enable_custom_buffs")),$("body").toggleClass("high-contrast",highContrast),$("body").on("click",".tooltip-button",e=>{"touch"==e.originalEvent.pointerType&&$(".tooltip").tooltip("hide")}).on("mouseleave",".tooltip-button",e=>{$(".tooltip").tooltip("hide")}),$("#collection-data-import-planner-btn").tooltip({title:getBasicTooltip(translateUI("tooltip_import_planner")),placement:"top",html:!0}),$(`#ba-navbar-regionselector-${regionID}`).addClass("active"),$("#ba-navbar-languageselector span").text($(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).text()),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).addClass("active"),$(`#ba-navbar-themeswitcher-${darkTheme}`).addClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),$(`#ba-navbar-custombuffs-toggle-${enableCustomBuffs}`).addClass("active"),$("#ba-navbar-search").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(allSearch,100)})).on("keydown",searchNavigate).on("keyup",searchNavigate),$("#navbar-search-clear").on("click",(function(){$("#"+this.dataset.target).val("").trigger("blur"),allSearch(),$(this).hide()}));let e="";$.each(data.common.changelog,(function(t,a){e+=`<h5 class="text-emphasis px-2">${a.date}</h5>`,e+='<div class="p-2 mb-3">';for(let t=0;t<a.contents.length;t++)e+=`<div>${a.contents[t]}</div>`;e+="</div>"})),$("#modal-changelog-content").html(e);const t=parseInt(data.common.changelog[0].date.replaceAll("/",""));localStorage.getItem("changelog_seen")?t>parseInt(localStorage.getItem("changelog_seen"))&&($("#modal-changelog").modal("show"),localStorage.setItem("changelog_seen",t)):($("#modal-changelog").modal("show"),localStorage.setItem("changelog_seen",t)),$(document).on("keydown",(function(e){if("Escape"===e.code&&$("input:focus").trigger("blur"),(e.ctrlKey||e.metaKey)&&"KeyK"===e.code&&(t(),e.preventDefault()),!$("input:focus").length)switch(e.code){case"Slash":t(),e.preventDefault();break;case"KeyL":"students"!==loadedModule||$("#ba-student-modal-students").hasClass("show")||$("#ba-student-modal-students").modal("show","shortcut"),e.preventDefault()}function t(){$("#ba-student-modal-students").hasClass("show")?$("#ba-student-search-text").trigger("focus"):$("#ba-navbar-search").trigger("focus")}})),$(window).on("popstate",()=>loadModuleFromURL(!1)),loadModuleFromURL(!0)}));