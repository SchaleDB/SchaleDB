const raid_level=[17,25,35,50,70,80,90],maxbond=[10,10,20,20,50],gear_minlevelreq=[0,15,35],raid_reward_coin=[[40,0],[60,0],[80,0],[100,10],[120,20],[140,40],[160,60]],languages=["En","Jp","Kr","Tw","Cn","Zh","Th"],label_smalltext_threshold={En:8,Jp:5,Kr:5,Tw:5,Cn:5,Zh:5,Th:11,Vi:11},label_craft_smalltext_threshold={En:7,Jp:4,Kr:4,Tw:4,Cn:4,Zh:4,Th:8,Vi:8},label_enemy_smalltext_threshold={En:10,Jp:6,Kr:6,Tw:6,Cn:6,Zh:6,Th:12,Vi:12},label_raid_smalltext_threshold={En:16,Jp:10,Kr:11,Tw:10,Cn:10,Zh:10,Th:20,Vi:20},adaptationAmount={0:"D",1:"C",2:"B",3:"A",4:"S",5:"SS"},terrain_dmg_bonus={D:.8,C:.9,B:1,A:1.1,S:1.2,SS:1.3},terrain_block_bonus={D:0,C:15,B:30,A:45,S:60,SS:75},skill_ex_upgrade_credits=[8e4,5e5,3e6,1e7],skill_upgrade_credits=[5e3,7500,6e4,9e4,3e5,45e4,15e5,24e5,4e6],gear_upgrade_credits=[5e5],enemy_rank={Champion:1,Elite:2,Minion:3},max_gifts=35,max_gifts_ssr=13,conquest_events=[815,822,10815],module_list=["home","students","raids","stages","items","craft"],strikerBonusBase={MaxHP:.1,AttackPower:.1,DefensePower:.05,HealPower:.05},strikerBonusExtended={MaxHP:.05,AttackPower:.05,DefensePower:.05,HealPower:.05},tsaBonusCoefficient={MaxHP:.35,AttackPower:.2,DefensePower:.5,HealPower:.1},gearId={Hat:1e3,Gloves:2e3,Shoes:3e3,Bag:4e3,Badge:5e3,Hairpin:6e3,Charm:7e3,Watch:8e3,Necklace:9e3},timeAttackBG={Shooting:"TimeAttack_SlotBG_02",Defense:"TimeAttack_SlotBG_01",Destruction:"TimeAttack_SlotBG_03",Escort:"TimeAttack_SlotBG_03"},searchDelay=100,searchMaxResults=40,altSprite=[10017,10033,10041,10042,10043,10048,20009,20014,10062,10071,10072,26010],raidDifficultyName=["Normal","Hard","VeryHard","HardCore","Extreme","Insane","Torment"],buffIconKeys={AttackPower:"ATK",DefensePower:"DEF",CriticalPoint:"CriticalChance",CriticalDamageRate:"CriticalDamage",CriticalDamageResistRate:"CriticalDamageRateResist",DodgePoint:"Dodge",HealEffectivenessRate:"HealEffectiveness",AccuracyPoint:"HIT",MaxHP:"MAXHP",DefensePenetration:"Penetration",StabilityPoint:"Stability",StabilityRate:"Stability",RegenCost:"CostRegen"},studentStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","OppressionPower","OppressionResist","HealEffectivenessRate","RegenCost","DefensePenetration","AmmoCount"],studentStatListFull=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","OppressionPower","OppressionResist","HealEffectivenessRate","RegenCost","AttackSpeed","BlockRate","DefensePenetration","AmmoCount"],enemyStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","DefensePenetration","DamagedRatio","OppressionPower","OppressionResist"],raidEnemyStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","DefensePenetration","DamagedRatio","GroggyGauge","GroggyTime"],enemyCalculationStatList=["MaxHP","AttackPower","DefensePower","HealPower","AccuracyPoint","DodgePoint","CriticalPoint","CriticalChanceResistPoint","CriticalDamageRate","CriticalDamageResistRate","StabilityPoint","Range","OppressionPower","OppressionResist","DefensePenetration","DamagedRatio"],staticAssetURL="https://static.schale.gg";let userLang,regionID;if(localStorage.getItem("language")&&languages.includes(localStorage.getItem("language")))userLang=localStorage.getItem("language");else{let e=window.navigator.language;switch(e.split("-")[0]){case"ja":userLang="Jp";break;case"ko":userLang="Kr";break;case"th":userLang="Th";break;case"zh":userLang=e.toLowerCase().startsWith("zh-cn")?"Cn":"Tw";break;default:userLang="En"}}regionID=localStorage.getItem("region")?parseInt(localStorage.getItem("region")):0;let data={},json_list={config:getCacheVerResourceName("./data/config.min.json"),groups:getCacheVerResourceName("./data/groups.min.json")},json_lang_list=getLanguageJSONList(userLang.toLowerCase());function getLanguageJSONList(e){return{localization:getCacheVerResourceName(`./data/${e}/localization.min.json`),students:getCacheVerResourceName(`./data/${e}/students.min.json`),enemies:getCacheVerResourceName(`./data/${e}/enemies.min.json`),items:getCacheVerResourceName(`./data/${e}/items.min.json`),furniture:getCacheVerResourceName(`./data/${e}/furniture.min.json`),equipment:getCacheVerResourceName(`./data/${e}/equipment.min.json`),currency:getCacheVerResourceName(`./data/${e}/currency.min.json`),summons:getCacheVerResourceName(`./data/${e}/summons.min.json`),raids:getCacheVerResourceName(`./data/${e}/raids.min.json`),stages:getCacheVerResourceName(`./data/${e}/stages.min.json`)}}let json_server_list=getServerJSONList(regionID);function getServerJSONList(e){let t;switch(e){case 0:t="jp";break;case 1:t="global";break;case 2:t="cn"}return{crafting:getCacheVerResourceName(`./data/crafting_${t}.min.json`)}}const html_list={craft:getCacheVerResourceName("./html/craft.html"),home:getCacheVerResourceName("./html/home.html"),items:getCacheVerResourceName("./html/items.html"),raids:getCacheVerResourceName("./html/raids.html"),stages:getCacheVerResourceName("./html/stages.html"),students:getCacheVerResourceName("./html/students.html")},sort_functions={Default:(e,t)=>(e.DefaultOrder-t.DefaultOrder)*search_options.sortby_dir,Name:(e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))*search_options.sortby_dir,AttackPower100:(e,t)=>(t.AttackPower100-e.AttackPower100)*search_options.sortby_dir,DefensePower100:(e,t)=>(t.DefensePower100-e.DefensePower100)*search_options.sortby_dir,MaxHP100:(e,t)=>(t.MaxHP100-e.MaxHP100)*search_options.sortby_dir,HealPower100:(e,t)=>(t.HealPower100-e.HealPower100)*search_options.sortby_dir,CriticalPoint:(e,t)=>(t.CriticalPoint-e.CriticalPoint)*search_options.sortby_dir,StabilityPoint:(e,t)=>(t.StabilityPoint-e.StabilityPoint)*search_options.sortby_dir,Range:(e,t)=>(t.Range-e.Range)*search_options.sortby_dir,AccuracyPoint:(e,t)=>(t.AccuracyPoint-e.AccuracyPoint)*search_options.sortby_dir,DodgePoint:(e,t)=>(t.DodgePoint-e.DodgePoint)*search_options.sortby_dir,NormalHits:(e,t)=>(getSkillHits(find(t.Skills,"SkillType","autoattack")[0])-getSkillHits(find(e.Skills,"SkillType","autoattack")[0]))*search_options.sortby_dir,EXCost:(e,t)=>(find(t.Skills,"SkillType","ex")[0].Cost[4]-find(e.Skills,"SkillType","ex")[0].Cost[4])*search_options.sortby_dir,EXHits:(e,t)=>(getSkillHits(find(t.Skills,"SkillType","ex")[0])-getSkillHits(find(e.Skills,"SkillType","ex")[0]))*search_options.sortby_dir,PublicHits:(e,t)=>(getSkillHits(find(t.Skills,"SkillType","Released"in t.Gear&&t.Gear.Released[regionID]?"gearnormal":"normal")[0])-getSkillHits(find(e.Skills,"SkillType","Released"in e.Gear&&e.Gear.Released[regionID]?"gearnormal":"normal")[0]))*search_options.sortby_dir,StreetBattleAdaptation:(e,t)=>(t.StreetBattleAdaptation+("Street"===t.Weapon.AdaptationType?t.Weapon.AdaptationValue-.1:0)-(e.StreetBattleAdaptation+("Street"===e.Weapon.AdaptationType?e.Weapon.AdaptationValue-.1:0)))*search_options.sortby_dir,OutdoorBattleAdaptation:(e,t)=>(t.OutdoorBattleAdaptation+("Outdoor"===t.Weapon.AdaptationType?t.Weapon.AdaptationValue-.1:0)-(e.OutdoorBattleAdaptation+("Outdoor"===e.Weapon.AdaptationType?e.Weapon.AdaptationValue-.1:0)))*search_options.sortby_dir,IndoorBattleAdaptation:(e,t)=>(t.IndoorBattleAdaptation+("Indoor"===t.Weapon.AdaptationType?t.Weapon.AdaptationValue-.1:0)-(e.IndoorBattleAdaptation+("Indoor"===e.Weapon.AdaptationType?e.Weapon.AdaptationValue-.1:0)))*search_options.sortby_dir,CharacterVoice:(e,t)=>getTranslatedString(e,"CharacterVoice").localeCompare(getTranslatedString(t,"CharacterVoice"))*search_options.sortby_dir,BirthDay:(e,t)=>(convertToDate(e.BirthDay)-convertToDate(t.BirthDay))*search_options.sortby_dir,CharacterAge:(e,t)=>(MathHelper.extractNumber(t.CharacterAge)-MathHelper.extractNumber(e.CharacterAge))*search_options.sortby_dir,CharHeightMetric:(e,t)=>(MathHelper.extractNumber(t.CharHeightMetric)-MathHelper.extractNumber(e.CharHeightMetric))*search_options.sortby_dir,Illustrator:(e,t)=>getTranslatedString(e,"Illustrator").localeCompare(getTranslatedString(t,"Illustrator"))*search_options.sortby_dir,Designer:(e,t)=>getTranslatedString(e,"Designer").localeCompare(getTranslatedString(t,"Designer"))*search_options.sortby_dir,Club:(e,t)=>getLocalizedString("Club",e.Club).localeCompare(getLocalizedString("Club",t.Club))*search_options.sortby_dir,School:(e,t)=>getLocalizedString("School",e.School).localeCompare(getLocalizedString("School",t.School))*search_options.sortby_dir,MemoryLobby:(e,t)=>(t.MemoryLobby[regionID]-e.MemoryLobby[regionID])*search_options.sortby_dir,MemoryLobbyBGM:(e,t)=>getTranslatedString(e,"MemoryLobbyBGM").localeCompare(getTranslatedString(t,"MemoryLobbyBGM"))*search_options.sortby_dir,CollectionStars:(e,t)=>((t.Id in studentCollection?studentCollection[t.Id].s+studentCollection[t.Id].ws:0)-(e.Id in studentCollection?studentCollection[e.Id].s+studentCollection[e.Id].ws:0))*search_options.sortby_dir,CollectionLevel:(e,t)=>((t.Id in studentCollection?studentCollection[t.Id].l:0)-(e.Id in studentCollection?studentCollection[e.Id].l:0))*search_options.sortby_dir,CollectionBond:(e,t)=>((t.Id in studentCollection?studentCollection[t.Id].b:0)-(e.Id in studentCollection?studentCollection[e.Id].b:0))*search_options.sortby_dir},itemSortFunctions={Default:(e,t)=>(e.Id-t.Id)*itemSearchOptions.sortby_dir,Name:(e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))*itemSearchOptions.sortby_dir};let loadedModule,student,studentList,studentStatsList=null,sortByCollectionStats=!1,studentCompare,statPreviewStarGrade,statPreviewWeaponGrade,statPreviewLevel,statPreviewWeaponLevel,statPreviewEquipment,statPreviewGearLevel,statPreviewBondLevel=[],statPreviewPotentialLevel={},statPreviewPassiveLevel,statPreviewExLevel,statPreviewIncludePassive,statPreviewIncludeBond=[],statPreviewIncludeEquipment,statPreviewIncludeBuffs,statPreviewIncludePotential,statPreviewViewSupportStats=!1,statPreviewSelectedChar=0,statPreviewTerrain="Street",statPreviewEnemyList=[],statPreviewSelectedEnemyId=7000001,statPreviewSelectedEnemyLevel=1,statPreviewSelectedEnemyGrade=1,statPreviewSelectedEnemyRaid=0,statPreviewSelectedEnemyRaidDifficulty=0,statPreviewSelectedEnemyRaidFloor=0,statPreviewSelectedEnemyLevelFixed=!1,statPreviewSelectedEnemyArmorType=null,statPreviewEnemyBookmarks=[],skillPreviewExSkillLevel=1,skillPreviewOtherSkillLevel=1,skillPreviewShowSummonSkills={},skillInfoCollection=[],raidSkillInfoCollection=[],studentCollection={},lockedAttributes=!1,collectionUpdateTimeout,toastMessageTimeout,searchDelayTimeout,eventRefreshInterval,recalculationLimitTimeout,compareMode=!1,selectCompareMode=!1,showAltSprite=!1,showStudentListInfo=!1,showSkillUpgrades=!1,loadedRaid,loadedItem,loadedItemType,loadedStage,loadedStageVersion,showEventCurrencyBonus=1,loadedConquest,loadedCraftNode,loadedCraftId=0,itemList,furnitureList,equipmentList,loadedStageList=null,loadedItemList=null,loadObserver,region,student_bondalts,darkTheme,pixelMode,highContrast,raid,selectedEnemy=0,raid_difficulty=0,ta_difficulty=0,multiFloorRaidFloor=0,gridItemDisplayStyle="detailed",showNodeProbability=!1,voiceClipVolume=.7,searchResultsCount=0,searchResultsSelection=0,studentSelectorModal,statPreviewModal,stageMapModal,scrolling=!1,scrollPosition={top:0,left:0,x:0,y:0},search_options={groupby:"none",sortby:"Default",sortby_dir:1,filter:{SquadType:{Main:!1,Support:!1},Collection:{Owned:!1,NotOwned:!1},TacticRole:{Tanker:!1,DamageDealer:!1,Healer:!1,Supporter:!1,Vehicle:!1},StarGrade:{3:!1,2:!1,1:!1},BulletType:{Explosion:!1,Pierce:!1,Mystic:!1,Sonic:!1},ArmorType:{LightArmor:!1,HeavyArmor:!1,Unarmed:!1,ElasticArmor:!1},School:{Abydos:!1,Arius:!1,Gehenna:!1,Hyakkiyako:!1,Millennium:!1,RedWinter:!1,Shanhaijing:!1,Trinity:!1,Valkyrie:!1,SRT:!1,Others:!1},WeaponType:{SG:!1,SMG:!1,AR:!1,GL:!1,HG:!1,SR:!1,RG:!1,MG:!1,RL:!1,MT:!1,FT:!1},Position:{Front:!1,Middle:!1,Back:!1},IsLimited:{0:!1,1:!1,2:!1},StreetBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1,5:!1},OutdoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1,5:!1},IndoorBattleAdaptation:{0:!1,1:!1,2:!1,3:!1,4:!1,5:!1},Gear1:{Hat:!1,Gloves:!1,Shoes:!1},Gear2:{Bag:!1,Badge:!1,Hairpin:!1},Gear3:{Charm:!1,Necklace:!1,Watch:!1},BondGear:!1,Cover:{Uses:!1,DoesntUse:!1},HasCC:!1,HasDebuff:!1,TerrainUpgrades:!1},filterSelect:{PassiveBuff:[],WeaponPassiveBuff:[],SubBuff:[],UsesArtifact:[]}},passiveStatList=[],subStatList=[],weaponPassiveStatList=[],studentBuffStatFilters=[],enemyBuffStatFilters=[],itemSearchOptions={sortby:"Default",sortby_dir:1,filter:{ItemCategory:{Material:!1,Coin:!1,Favor:!1,SecretStone:!1,Consumable:!1,Collectible:!1},FurnitureSubCategory:{Wallpaper:!1,Floor:!1,Background:!1,Table:!1,Chair:!1,Closet:!1,FloorDecoration:!1,WallDecoration:!1,Prop:!1,HomeAppliance:!1,Bed:!1,FurnitureEtc:!1},EquipmentCategory:{Exp:!1,WeaponExpGrowth:!1,Hat:!1,Gloves:!1,Shoes:!1,Bag:!1,Badge:!1,Hairpin:!1,Charm:!1,Necklace:!1,Watch:!1},Rarity:{N:!1,R:!1,SR:!1,SSR:!1},FurnitureSet:{0:!1,100:!1,101:!1,102:!1,103:!1,104:!1,105:!1,106:!1,107:!1,108:!1,109:!1,110:!1,111:!1},EquipmentTier:{1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1},FurnitureInteraction:!1,Craftable:!1,StageDrop:!1,Shop:!1,ShowImmediateUse:!1,ShowExpired:!1}};Array.prototype.sum=function(){return this.reduce((e,t)=>e+t,0)},String.prototype.escapeHtml=function(){return document.createElement("div").appendChild(document.createTextNode(this)).parentNode.innerHTML};class CharacterStats{constructor(e,t,a,s=[],i="Standard"){function l(t){if(e[`Stat${region.Name}`]&&void 0!==e[`Stat${region.Name}`][t])return e[`Stat${region.Name}`][t];if(void 0!==e[t])return e[t];switch(t){case"CriticalResistPoint":return 100;case"CriticalDamageResistRate":return 5e3;case"StabilityRate":return 2e3;case"DamageRatio":case"DamagedRatio":return 1e4;case"OppressionPower":case"OppressionResist":return 100;case"MoveSpeed":return 200;case"StreetBattleAdaptation":case"OutdoorBattleAdaptation":case"IndoorBattleAdaptation":return 2;default:return 0}}this.stats={},0==s.length&&(s=[[0,1e3,1200,1400,1700],[0,500,700,900,1400],[0,750,1e3,1200,1500]]);let n=1,r=1,o=1;for(let e=0;e<a;e++)n+=s[0][e]/1e4,r+=s[1][e]/1e4,o+=s[2][e]/1e4;let d=CharacterStats.interpolateStat(l("MaxHP1"),l("MaxHP100"),t,r,i),c=CharacterStats.interpolateStat(l("AttackPower1"),l("AttackPower100"),t,n,i),u=CharacterStats.interpolateStat(l("DefensePower1"),l("DefensePower100"),t,1,i),g=CharacterStats.interpolateStat(l("HealPower1"),l("HealPower100"),t,o,i),p=0;void 0!==l("DefensePenetration100")&&(p=CharacterStats.interpolateStat(l("DefensePenetration1"),l("DefensePenetration100"),t,1,i)),this.level=t,this.terrain={Street:l("StreetBattleAdaptation"),Outdoor:l("OutdoorBattleAdaptation"),Indoor:l("IndoorBattleAdaptation")},this.activeBuffs={},this.bulletType=e.BulletType,this.armorType=e.ArmorType,this.equipment=e.Equipment?e.Equipment:[],this.stats.MaxHP=[d,0,1,0],this.stats.AttackPower=[c,0,1,0],this.stats.DefensePower=[u,0,1,0],this.stats.HealPower=[g,0,1,0],this.stats.AccuracyPoint=[l("AccuracyPoint"),0,1,0],this.stats.DodgePoint=[l("DodgePoint"),0,1,0],this.stats.CriticalPoint=[l("CriticalPoint"),0,1,0],this.stats.CriticalDamageRate=[l("CriticalDamageRate"),0,1,0],this.stats.CriticalChanceResistPoint=[l("CriticalResistPoint"),0,1,0],this.stats.CriticalDamageResistRate=[l("CriticalDamageResistRate"),0,1,0],this.stats.StabilityPoint=[l("StabilityPoint"),0,1,0],this.stats.StabilityRate=[l("StabilityRate"),0,1,0],this.stats.AmmoCount=[l("AmmoCount"),0,1,0],this.stats.AmmoCost=[l("AmmoCost"),0,1,0],this.stats.Range=[l("Range"),0,1,0],this.stats.RegenCost=[l("RegenCost"),0,1,0],this.stats.DamageRatio=[l("DamageRatio"),0,1,0],this.stats.DamagedRatio=[l("DamagedRatio"),0,1,0],this.stats.HealEffectivenessRate=[1e4,0,1,0],this.stats.OppressionPower=[l("OppressionPower"),0,1,0],this.stats.OppressionResist=[l("OppressionResist"),0,1,0],this.stats.AttackSpeed=[1e4,0,1,0],this.stats.BlockRate=[0,0,1,0],this.stats.DefensePenetration=[p,0,1,0],this.stats.MoveSpeed=[l("MoveSpeed"),0,1,0],this.stats.EnhanceExplosionRate=[1e4,0,1,0],this.stats.EnhancePierceRate=[1e4,0,1,0],this.stats.EnhanceMysticRate=[1e4,0,1,0],this.stats.EnhanceSonicRate=[1e4,0,1,0],this.stats.ExtendBuffDuration=[1e4,0,1,0],this.stats.ExtendDebuffDuration=[1e4,0,1,0],this.stats.ExtendCCDuration=[1e4,0,1,0]}addBuff(e,t,a=!1){let s=e.split("_");s.length>1?"Base"==s[1]?a?this.stats[s[0]][3]+=t:this.stats[s[0]][1]+=t:"Coefficient"==s[1]&&(this.stats[s[0]][2]+=t/1e4):this.stats[s[0]][1]+=t}addCharacterStatsAsBuff(e,t,a){this.stats[t][1]+=Math.round(e.getTotal(t)*(a/1e4))}getTotal(e){let t=!0,a=!1;"DamagedRatio"==e&&(t=!1,a=!0);const s=this.stats[e][0],i=this.stats[e][1],l=t?Math.max(this.stats[e][2],.2):this.stats[e][2],n=this.stats[e][3],r=Math.round(((s+i)*l).toFixed(4))+n;return a?r:Math.max(r,0)}getTotalString(e,t=!1){let a=this.getTotal(e),s="";return s="DamagedRatio"==e?((a-1e4)/100).toFixed(0).toLocaleString()+"%":CharacterStats.isRateStat(e)?(a/100).toFixed(0).toLocaleString()+"%":a.toLocaleString(),"DamagedRatio"!=e&&t&&this.stats[e][2]<=.2&&(s=`<span class="stat-cap">${s}</span>`),s}getBaseString(e){let t=this.stats[e][0];return"DamagedRatio"==e?Math.floor((t-1e4)/100).toLocaleString()+"%":CharacterStats.isRateStat(e)?(t/100).toFixed(0).toLocaleString()+"%":t.toLocaleString()}setBase(e,t){this.stats[e][0]=t}getFlatString(e){const t=this.stats[e][1]+this.stats[e][3],a=t>=0?"+":"";return a+t.toLocaleString()}getCoefficientString(e){let t=100*(Math.max(this.stats[e][2],.2)-1);const a=t>=0?"+":"";return t=Math.abs(t)<100?t.toFixed(1):t.toFixed(0),a+parseFloat(t).toLocaleString()+"%"}getStrikerBonus(e,t=2){return t>2?Math.floor(this.getTotal(e)*strikerBonusExtended[e]):Math.floor(this.getTotal(e)*strikerBonusBase[e])}getTSABonus(e){return Math.floor(this.getTotal(e)*tsaBonusCoefficient[e])}getStabilityMinDamageMod(){let e=this.getTotal("StabilityPoint");return MathHelper.clamp(e/(e+1e3)+this.getTotal("StabilityRate")/1e4,0,1)}getStabilityMinDamage(){return MathHelper.toFixedFloat(100*this.getStabilityMinDamageMod(),2)+"%"}getDefenseDamageReductionMod(e=0,t=1e4){let a;return 1e7/(6e3*Math.max((this.getTotal("DefensePower")-e)*(t/1e4),0)+1e7)}getDefenseDamageReduction(){return parseFloat((100*(1-this.getDefenseDamageReductionMod())).toFixed(2))+"%"}getCriticalRate(e){const t=this.getTotal("CriticalPoint");return MathHelper.clamp(1-4e6/(6e3*Math.max(t-e,0)+4e6),0,1)}getCriticalHitChanceString(e){return`${MathHelper.toFixedFloat(100*this.getCriticalRate(e),2)}%`}getHitChance(e){const t=this.getTotal("AccuracyPoint");return MathHelper.clamp(2e3/(3*Math.max(e-t,0)+2e3),0,1)}getHitChanceString(e){const t=this.getTotal("AccuracyPoint");return`${MathHelper.toFixedFloat(100*this.getHitChance(e),2)}%`}addActiveBuffIcon(e,t,a=1){if(0==t)return;let s;s=(e=e.replace("_Coefficient","").replace("_Base","")).startsWith("Special_")?e:`${t>0?"Buff":"Debuff"}_${e in buffIconKeys?buffIconKeys[e]:e}`,s in this.activeBuffs?this.activeBuffs[s]+=a:this.activeBuffs[s]=a}renderActiveBuffs(e,t){let a="",s=0,i=0;for(const e in this.activeBuffs){let l=this.activeBuffs[e];e.includes("Special_DebuffCount")&&(l=1),s++,s<=t?a+=`<div class="active-buff"><img src="images/buff/${e}.webp" width="22" height="26" class="">${l>1?`<span class="stack-count">${l}</span>`:""}</div>`:i++}i&&(a+=`<div class="px-1"><b>+${i}</b></div>`),$(e).toggle(s>0).html(a)}static isRateStat(e){return"Rate"==e.slice(-4)||e.startsWith("AttackSpeed")||e.startsWith("DamagedRatio")}static getTimeAttackLevelScale(e){return e<=1?0:2==e?.0101:e<=24?.0707:25==e?.0808:e<=39?.1919:40==e?.202:e<=64?.4444:65==e?.4545:e<=77?.7172:78==e?.7273:e>=79?((e-1)/99).toFixed(4):void 0}static interpolateStat(e,t,a,s=1,i="Standard"){let l;switch(i){case"TimeAttack":l=CharacterStats.getTimeAttackLevelScale(a);break;case"LateBloom":case"Premature":l=(a-1)/99;break;case"Standard":default:l=((a-1)/99).toFixed(4)}return Math.ceil((Math.round((e+(t-e)*l).toFixed(4))*s).toFixed(4))}static getPotentialStatAmount(e,t,a,s){return Math.round(CharacterStats.interpolateStat(e[`${t}1`],e[`${t}100`],a)*(.002*s))}calculateDamage(e,t,a,s,i,l=1e4){const n=this.getTotal(a),r=this.getTotal("DamageRatio")/1e4,o=(2e4-e.getTotal("DamagedRatio"))/1e4,d=Math.max(Math.min(1-.02*(e.level-this.level),1),.4),c=e.getDefenseDamageReductionMod(this.getTotal("DefensePenetration"),l),u=.8+.1*this.terrain[s],g=this.getEffectiveMod(e.armorType),p=(this.getTotal("CriticalDamageRate")-e.getTotal("CriticalDamageResistRate"))/1e4;return n*u*g*(t/1e4)*c*r*o*d*(1+i*(p-1))}calculateAccumulateDamageLimit(e,t,a,s){const i=this.getTotal(a),l=Math.max(Math.min(1-.02*(e.level-this.level),1),.4),n=.8+.1*this.terrain[s],r=this.getEffectiveMod(e.armorType);return i*n*r*(t/1e4)*l}calculateDamageRange(e,t,a,s,i){const l=this.calculateDamage(e,t,a,s,i),n=l*this.getStabilityMinDamageMod();return`${parseInt(n).toLocaleString()} ~ ${parseInt(l).toLocaleString()}`}calculateExpectedDamage(e,t,a,s){const i=this.getCriticalRate(e.getTotal("CriticalChanceResistPoint")),l=(this.getTotal("CriticalDamageRate")-e.getTotal("CriticalDamageResistRate"))/1e4-1,n=this.calculateDamage(e,t,a,s,0),r=n*l,o=n+r*i,d=o*this.getStabilityMinDamageMod();return parseInt((d+o)/2).toLocaleString()}calculateHealing(e,t=1e4){const a=this.getTotal("HealPower");return parseInt(a*e*(t/1e4))}getEffectiveMod(e){let t=data.config.TypeEffectiveness[this.bulletType][e];if("Structure"==e)return 1;switch(this.bulletType){case"Explosion":"LightArmor"==e&&(t+=this.getTotal("EnhanceExplosionRate")-1e4);break;case"Pierce":"HeavyArmor"==e&&(t+=this.getTotal("EnhancePierceRate")-1e4);break;case"Mystic":"Unarmed"==e&&(t+=this.getTotal("EnhanceMysticRate")-1e4);break;case"Sonic":"ElasticArmor"==e&&(t+=this.getTotal("EnhanceSonicRate")-1e4)}return t/1e4}addEquipmentBonuses(e,t){const a=find(data.equipment,"Id",gearId[e]+t-1)[0];a.StatType.forEach((e,t)=>{this.addBuff(e,a.StatValue[t][1])})}addGearBonuses(e){for(let t=0;t<e.StatType.length;t++)this.addBuff(e.StatType[t],e.StatValue[t][1])}addWeaponBonuses(e,t){let a=(t-1)/99;"Standard"==e.StatLevelUpType&&(a=a.toFixed(4)),this.addBuff("AttackPower_Base",Math.round(e.AttackPower1+(e.AttackPower100-e.AttackPower1)*a)),this.addBuff("MaxHP_Base",Math.round(e.MaxHP1+(e.MaxHP100-e.MaxHP1)*a)),this.addBuff("HealPower_Base",Math.round(e.HealPower1+(e.HealPower100-e.HealPower1)*a))}}let statPreviewCharacterStats=CharacterStats,statPreviewSelectedEnemyStats=CharacterStats;class MathHelper{static clamp(e,t,a){return Math.min(Math.max(e,t),a)}static toFixedFloat(e,t){return parseFloat(e.toFixed(t))}static extractNumber(e){let t=parseInt(e.replace(/[^0-9]/g));return isNaN(t)?0:t}static formatDuration(e){const t=Math.floor(e/60);return`${t}:${`${e%60}`.padStart(2,"0")}`}}class Buffs{buffs=[];addBuff(e){this.buffs.push(e)}removeBuff(e){this.buffs.splice(e,1)}static statValueToString(e,t){return e.endsWith("_Coefficient")?`${parseFloat((t/100).toFixed(1))}%`:t.toLocaleString()}}class ExternalBuffs extends Buffs{elements={controls:null,searchBox:null,searchButton:null,autoAddButton:null,searchResults:null};searchBoxTimeout=null;searchResultsSelection=0;searchResultsCount=0;filterFunc;recalculationFunc;effectTypeFilter;effectStatFilter="all";constructor(e,t,a,s){super(),this.elements=e,this.effectTypeFilter=s,this.filterFunc=t,this.recalculationFunc=a,$(this.elements.controls).on("input",'input[type="range"]',e=>{this.updateBuffLevel(e.currentTarget.dataset.index,e.currentTarget.value)}),$(this.elements.controls).on("click",".stack-toggle",e=>{this.updateStackCount(e.currentTarget.dataset.index)}),$(this.elements.controls).on("click","button.buff-remove",e=>{this.removeBuff(e.currentTarget.dataset.index)}),this.searchResultPopper=new ResultsPopper($(this.elements.searchBox).parent()[0],this.elements.searchResults),$(this.elements.searchResults).find(".search-list-results").on("click","div[data-student-id]",e=>{const t=find(data.students,"Id",e.currentTarget.dataset.studentId)[0],a=find(t.Skills,"SkillType",e.currentTarget.dataset.skillType)[0];this.addBuff(t.Id,a),$(e.currentTarget).toggleClass("disabled",!0),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchResults).find(".search-list-results").on("click","div[data-raid-id]",e=>{const t=find(data.raids.Raid,"Id",e.currentTarget.dataset.raidId)[0],a=find(t.RaidSkill,"Id",e.currentTarget.dataset.skillId)[0];this.addBuffRaid(t.Id,a),$(e.currentTarget).toggleClass("disabled",!0),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchButton).on("click",e=>{$(this.elements.searchResults).is(":visible")?this.searchResultPopper.hide():(this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchResultPopper.show(),this.searchBuffs())}),$(this.elements.autoAddButton).on("click",e=>{$(this.elements.searchResults).is(":visible")&&this.searchResultPopper.hide();const t=student.Id;let a=[t];"Main"==student.SquadType&&statPreviewSupportStats.supportStudents.forEach(e=>{a.push(e.student.Id)}),a.forEach(e=>{const a=find(data.students,"Id",e)[0];a.Skills.forEach(e=>{if(!e.SkillType.endsWith("passive")&&!e.SkillType.endsWith("autoattack")&&"Effects"in e&&this.filterFunc(a.Id,e)){let s=!0;find(this.buffs,"StudentId",a.Id).forEach(t=>{t.Skill.SkillType==e.SkillType&&(s=!1)}),null!=a.Gear.Released&&a.Gear.Released[regionID]?(a.Id==t&&"gearnormal"==e.SkillType&&statPreviewGearLevel<2&&(s=!1),a.Id==t&&"normal"==e.SkillType&&statPreviewGearLevel>=2&&(s=!1)):"gearnormal"==e.SkillType&&(s=!1),s&&this.addBuff(a.Id,e)}})}),data.raids.Raid.forEach(e=>{e.IsReleased[regionID]&&e.RaidSkill.filter(e=>void 0!==e.Effects).forEach(t=>{if(t.MinDifficulty>e.MaxDifficulty[regionID])return;if(!this.filterFunc(0,t))return;let a=!0;if(find(this.buffs,"StudentId",`raid${e.Id}`).forEach(e=>{e.Skill.Id==t.Id&&(a=!1)}),!a)return;let s=!1;t.Effects.forEach(e=>{"BuffTarget"==e.Type&&void 0!==e.RestrictTo&&e.RestrictTo.includes(statPreviewSelectedEnemyId)&&(s=!0)}),s&&this.addBuffRaid(e.Id,t)})})}),$(this.elements.searchBox).on("input",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBoxTimeout=setTimeout(()=>{""!=e.currentTarget.value?(this.searchResultPopper.show(),this.searchBuffs()):this.searchResultPopper.hide()},100)}).on("blur",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),""==e.currentTarget.value&&this.searchResultPopper.hide()}).on("keyup keydown",e=>{switch(e.code){case"Enter":e.preventDefault(),$(this.elements.searchResults).is(":visible")&&"keyup"==e.type&&(0==this.searchResultsSelection&&this.searchResultsCount>0?$(this.elements.searchResults).find('.search-list-item[data-index="1"]').trigger("click"):$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`).trigger("click"));break;case"ArrowDown":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection<this.searchResultsCount){this.searchResultsSelection++,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"ArrowUp":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection>1){this.searchResultsSelection--,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"Escape":e.preventDefault(),$(this.elements.searchBox).val("").trigger("blur")}}),$(this.elements.searchResults).find(".search-list-filter").on("click","a[data-filter-select-value]",e=>{const t=$(e.currentTarget);this.effectStatFilter=t.data("filter-select-value"),$(this.elements.searchResults).find("a[data-filter-select-value]").removeClass("active"),t.addClass("active"),$(this.elements.searchResults).find(".search-list-filter-active").text(t.text()),this.searchBuffs()}),$(this.elements.searchResults).find(".search-list-filter-active").text(translateUI("filter_all"))}addBuff(e,t){const a="ex"==t.SkillType?5:10;let s=1;t.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach(e=>{s=Math.max(s,void 0!==e.StackSame?e.StackSame:e.Value.length)}),super.addBuff({StudentId:e,Skill:t,MaxLevel:a,Level:a,Stacks:1,MaxStacks:s}),this.renderControls(),this.recalculationFunc()}static getEffectValue(e,t){let a;return a="StackSame"in t?t.Value[0][e.Level-1]*e.Stacks:t.Value[Math.min(e.Stacks-1,t.Value.length-1)][e.Level-1],a}addBuffRaid(e,t){const a=1;let s=1;t.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach(e=>{s=Math.max(s,void 0!==e.StackSame?e.StackSame:e.Value.length)}),super.addBuff({StudentId:`raid${e}`,RaidId:e,Skill:t,MaxLevel:1,Level:1,Stacks:1,MaxStacks:s}),this.renderControls(),this.recalculationFunc()}removeBuff(e,t=!0){super.removeBuff(e),t&&(this.renderControls(),this.recalculationFunc())}changeStudent(e){for(let e=0;e<this.buffs.length;e++){const t=this.buffs[e];this.filterFunc(t.StudentId,t.Skill)||this.removeBuff(e--,!1)}this.renderControls(),$(this.elements.searchBox).val("").trigger("blur")}toggleUpgrades(e){if(null!=student.Gear.Released&&student.Gear.Released[regionID]){for(let t=0;t<this.buffs.length;t++){const a=this.buffs[t];if(a.StudentId==student.Id&&a.Skill.SkillType.endsWith("normal")){const t=e?"gearnormal":"normal",s=student.Skills.find(e=>e.SkillType==t);a.Skill=s}}this.renderControls()}}updateBuffLevel(e,t){const a=this.buffs[e];a.Level=t,$(this.elements.controls).find(`div[data-index='${e}'] .ba-slider-label.skill-level`).html(t==a.MaxLevel?'<img src="images/ui/ImageFont_Max.png">':`Lv.${t}`),$(this.elements.controls).find(`div[data-index='${e}'] .buff-description`).html(this.getBuffAmountText(a)),this.recalculationFunc()}updateStackCount(e){const t=this.buffs[e];++t.Stacks>t.MaxStacks&&(t.Stacks=1),$(this.elements.controls).find(`div[data-index='${e}'] .ba-slider-label.stack-toggle .label`).html(this.getBuffStackLabel(t)),$(this.elements.controls).find(`div[data-index='${e}'] .buff-description`).html(this.getBuffAmountText(t)),this.recalculationFunc()}getBuffStackLabel(e){if(e.Skill.EffectStackLabel){let t="",a="";if(void 0!==e.Skill.EffectStackLabel.Label&&(a=e.Skill.EffectStackLabel.Label[Math.min(e.Skill.EffectStackLabel.Label.length-1,e.Stacks-1)]),void 0!==e.Skill.EffectStackLabel.Icon){const a=e.Skill.EffectStackLabel.Icon[Math.min(e.Skill.EffectStackLabel.Icon.length-1,e.Stacks-1)];t=`<img class="stack-icon ${a.startsWith("skill")?"invert-light":""}" src="images/${a}">`}return""!=a&&(a=`<span class="label ${""==t?"":"ps-1"}">${a}</span>`),t+a}return`&times;${e.Stacks}`}renderControls(){let e="";this.buffs.forEach((t,a)=>{if(t.RaidId){const s=find(data.raids.Raid,"Id",t.RaidId)[0];let i,l;t.Skill.Icon.startsWith("COMMON_")?(i=`images/skill/${t.Skill.Icon}.webp`,l=`skill-icon bg-atk-${s.BulletType.toLowerCase()}`):(i=`images/raid/skill/${t.Skill.Icon}.png`,l="raid-skill-icon"),e+=`<div data-index="${a}" class="ba-panel p-2"><div class="mb-1 d-flex flex-row align-items-center gap-2"><div class="transferable-skill-icon align-self-start"><img class="student-icon" src="images/raid/icon/Icon_${t.Skill.MinDifficulty>=5?s.PathName+"_Insane":s.PathName}.png"><img class="${l}" src="${i}"></div><div class="flex-fill"><h5>${getTranslatedString(t.Skill,"Name")} <small>(${translateUI(`student_skill_${t.Skill.SkillType.toLowerCase()}`)})</small></h5><p class="mb-0 buff-description" style="font-size: 0.875rem; line-height: 1rem;">${this.getBuffAmountText(t)}</p></div><button class="btn btn-sm btn-dark stat-panel-btn-sm buff-remove no-wrap align-self-start" type="button" data-index="${a}"><i class="fa-solid fa-xmark"></i></button></div><div class="d-flex flex-row align-items-center gap-2">${t.MaxStacks>1?`<span class="ba-slider-label stack-toggle" data-index="${a}"><span class="label">${this.getBuffStackLabel(t)}</span></span>`:""}</div></div>`}else{const s=find(data.students,"Id",t.StudentId)[0];e+=`<div data-index="${a}" class="ba-panel p-2"><div class="mb-1 d-flex flex-row align-items-center gap-2"><div class="transferable-skill-icon align-self-start"><img class="student-icon" src="images/student/icon/${s.Id}.webp"><img class="skill-icon bg-atk-${s.BulletType.toLowerCase()}" src="images/skill/${t.Skill.Icon}.webp"></div><div class="flex-fill"><h5>${getTranslatedString(t.Skill,"Name")} <small>(${translateUI(`student_skill_${t.Skill.SkillType}`)})</small></h5><p class="mb-0 buff-description" style="font-size: 0.875rem; line-height: 1rem;">${this.getBuffAmountText(t)}</p></div><button class="btn btn-sm btn-dark stat-panel-btn-sm buff-remove no-wrap align-self-start" type="button" data-index="${a}"><i class="fa-solid fa-xmark"></i></button></div><div class="d-flex flex-row align-items-center gap-2">${t.MaxStacks>1?`<span class="ba-slider-label stack-toggle" data-index="${a}"><img class="stack-icon invert-light" src="images/skill/${t.Skill.Icon}.webp"><span class="label">&times;${t.Stacks}</span></span>`:""}<input type="range" data-index="${a}" class="form-range flex-fill" value="${t.Level}" min="1" max="${t.MaxLevel}"><span class="ba-slider-label skill-level">${t.Level==t.MaxLevel?'<img src="images/ui/ImageFont_Max.png">':`Lv.${t.Level}`}</span></div></div>`}}),$("#ba-statpreview-status-buffs").toggleClass("disabled",0==this.buffs.length),$("#ba-statpreview-status-buffs-count").text(`(${this.buffs.length})`),$(this.elements.controls).html(e)}searchBuffs(){let e="",t="",a=0;const s=student.Id,i=this.elements.searchBox.value.toLowerCase();data.students.forEach(l=>{l.IsReleased[regionID]&&l.Skills.forEach(n=>{if(!n.SkillType.endsWith("passive")&&!n.SkillType.endsWith("autoattack")&&"Effects"in n&&(searchContains(i,getTranslatedString(l,"Name"))||searchContains(i,getTranslatedString(n,"Name")))){let i=this.filterFunc(l.Id,n);if(find(this.buffs,"StudentId",l.Id).forEach(e=>{e.Skill.SkillType==n.SkillType&&(i=!1)}),null!=l.Gear.Released&&l.Gear.Released[regionID]?(l.Id==s&&"gearnormal"==n.SkillType&&statPreviewGearLevel<2&&(i=!1),l.Id==s&&"normal"==n.SkillType&&statPreviewGearLevel>=2&&(i=!1)):"gearnormal"==n.SkillType&&(i=!1),"all"!=this.effectStatFilter&&-1==n.Effects.findIndex(e=>this.effectTypeFilter.includes(e.Type)&&e.Stat.startsWith(this.effectStatFilter))&&(i=!1),i){let i="";const r="ex"==n.SkillType?4:9;n.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach(e=>{let t;""!=i&&(i+=", "),i+=`${getStatName(e.Stat)} <b>${e.Value[0][0]<0?"":"+"}${ExternalBuffs.statValueToString(e.Stat,e.Value[0][0])}`,t="StackSame"in e?e.Value[0][r]*e.StackSame:e.Value[e.Value.length-1][r],e.Value[0][0]!=t&&(i+=`~${ExternalBuffs.statValueToString(e.Stat,t)}`),i+="</b>"});let o=ExternalBuffs.getSearchResultListItemHtml(l,n,i,++a);l.Id==s?t+=o:e+=o}}})}),data.raids.Raid.forEach(s=>{s.IsReleased[regionID]&&s.RaidSkill.filter(e=>!e.SkillType.endsWith("autoattack")).forEach(l=>{if(!(l.MinDifficulty>s.MaxDifficulty[regionID])&&void 0!==l.Effects&&(searchContains(i,getTranslatedString(s,"Name"))||searchContains(i,getTranslatedString(l,"Name")))){let i=this.filterFunc(student.Id,l),n=!1;if(find(this.buffs,"StudentId",`raid${s.Id}`).forEach(e=>{e.Skill.Id==l.Id&&(i=!1)}),"all"!=this.effectStatFilter&&-1==l.Effects.findIndex(e=>this.effectTypeFilter.includes(e.Type)&&e.Stat.startsWith(this.effectStatFilter))&&(i=!1),i){let e=!1;l.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach(t=>{"BuffTarget"==t.Type?void 0!==t.RestrictTo&&t.RestrictTo.includes(statPreviewSelectedEnemyId)&&(e=!0,n=!0):e=!0}),i=e}if(i){let i="";const r=0;l.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach(e=>{let t;""!=i&&(i+=", "),i+=`${getStatName(e.Stat)} <b>${e.Value[0][0]<0?"":"+"}${ExternalBuffs.statValueToString(e.Stat,e.Value[0][0])}`,t="StackSame"in e?e.Value[0][r]*e.StackSame:e.Value[e.Value.length-1][r],e.Value[0][0]!=t&&(i+=`~${ExternalBuffs.statValueToString(e.Stat,t)}`),i+="</b>"});let o=ExternalBuffs.getSearchResultListItemHtmlRaid(s,l,i,++a);n?t+=o:e+=o}}})}),this.searchResultsSelection=0,this.searchResultsCount=a,""==e&&""==t&&(e+=`<div class="text-center p-2">${translateUI("no_results")}</div>`),$(this.elements.searchResults).find(".search-list-results").html(t+e)}toggleDisabled(e){$(this.elements.searchBox).add(this.elements.searchButton).add(this.elements.autoAddButton).attr("disabled",e),$(this.elements.controls).toggleClass("disabled",e)}getBuffAmountText(e){let t="";return e.Skill.Effects.filter(e=>this.effectTypeFilter.includes(e.Type)).forEach((a,s)=>{if(a.Type.startsWith("Buff")){let i;""!=t&&(t+=", "),i="StackSame"in a?a.Value[0][e.Level-1]*e.Stacks:a.Value[Math.min(e.Stacks-1,a.Value.length-1)][e.Level-1],t+=`<span data-effect='${s}'>${getStatName(a.Stat)} <b>${i<0?"":"+"}${ExternalBuffs.statValueToString(a.Stat,i)}</b></span>`}}),t}static getSearchResultListItemHtml(e,t,a,s){return`<div class="search-list-item" data-index="${s}" data-student-id="${e.Id}" data-skill-type="${t.SkillType}"><div class="transferable-skill-icon me-2"><img class="student-icon" src="images/student/icon/${e.Id}.webp"><img class="skill-icon bg-atk-${e.BulletType.toLowerCase()}" src="images/skill/${t.Icon}.webp"></div><div class="search-list-item-detail"><span class="skill-name">${getTranslatedString(t,"Name")} <small>(${translateUI(`student_skill_${t.SkillType}`)})</small></span><span class="skill-details">${a}</span></div></div>`}static getSearchResultListItemHtmlRaid(e,t,a,s){let i,l;return t.Icon.startsWith("COMMON_")?(i=`images/skill/${t.Icon}.webp`,l=`skill-icon bg-atk-${e.BulletType.toLowerCase()}`):(i=`images/raid/skill/${t.Icon}.png`,l="raid-skill-icon"),`<div class="search-list-item" data-index="${s}" data-raid-id="${e.Id}" data-skill-id="${t.Id}"><div class="transferable-skill-icon me-2"><img class="student-icon" src="images/raid/icon/Icon_${e.PathName}${t.MinDifficulty>=5?"_Insane":""}.png"><img class="${l}" src="${i}"></div><div class="search-list-item-detail"><span class="skill-name">${getTranslatedString(t,"Name")} <small>(${translateUI(`student_skill_${t.SkillType.toLowerCase()}`)})</small></span><span class="skill-details">${a}</span></div></div>`}static checkRestrictions(e,t,a={}){let s=!0;return"Restrictions"in t&&t.Restrictions.forEach(({Property:t,Operand:i,Value:l})=>{let n=e[t];switch(t in a&&(n=a[t]),i){case"Equal":s=s&&n==l;break;case"NotEqual":s=s&&n!=l;break;case"Contains":s=s&&n.some(e=>e==l)}}),s}}let statPreviewExternalBuffs=ExternalBuffs,statPreviewEnemyBuffs=ExternalBuffs;class CustomBuffs extends Buffs{container;elements={controls:null,inputForm:null};isCoefficient=!1;statList;constructor(e,t,a){super(),this.container=e,this.statList=t,this.recalculationFunc=a,$(this.container).find("button.add-base").on("click",e=>{this.addBuff(!1)}),$(this.container).find("button.add-coefficient").on("click",e=>{this.addBuff(!0)}),$(this.container).on("click","button.buff-remove",e=>{this.removeBuff(e.currentTarget.dataset.index)}),this.renderForm()}renderForm(){let e;this.statList.forEach(t=>{e+=`<option value="${t}">${getLocalizedString("Stat",t)}</option>`}),$(this.container).find(".stat-select").html(e)}renderControls(){let e="";this.buffs.forEach((t,a)=>{e+=`<div data-index="${a}" class="ba-panel p-2">\n            <div class="d-flex flex-row align-items-center gap-2">\n                <div class="flex-fill">\n                    ${""!=t.Name?`<h5 class="px-1">${t.Name}</h5>`:""}\n                    <div class="d-flex">\n                        <span class="stat-icon"><img class="invert-light" src="images/staticon/Stat_${t.Stat.split("_")[0]}.png"></span>\n                        <p class="mb-0">${getStatName(t.Stat)} <b>${t.Amount>=0?"+":""}${Buffs.statValueToString(t.Stat,t.Amount)}</b></p>\n                    </div>\n                </div>\n                <button class="btn btn-sm btn-dark buff-remove stat-panel-btn-sm no-wrap align-self-start" type="button" data-index="${a}">\n                    <i class="fa-solid fa-xmark"></i>\n                </button>\n            </div>\n        </div>`}),$(this.container).find(".controls").html(e)}addBuff(e){const t=$(this.container).find(".stat-select").val(),a=$(this.container).find(".amount-input").val(),s=$(this.container).find(".name-input").val();isNaN(parseInt(a))?toastMessage(`<i class="fa-solid fa-circle-xmark me-2"></i>${translateUI("toast_amount_invalid")}`,2500,"failure"):(e?super.addBuff({Name:s,Stat:t+"_Coefficient",Amount:parseInt(100*a)}):super.addBuff({Name:s,Stat:t+"_Base",Amount:parseInt(a)}),this.renderControls(),this.recalculationFunc())}removeBuff(e){super.removeBuff(e),this.renderControls(),this.recalculationFunc()}}let statPreviewCustomBuffs=CustomBuffs,statPreviewEnemyCustomBuffs=CustomBuffs;class ResultsPopper{popperInstance=null;reference=null;popup=null;constructor(e,t){this.reference=e,this.popup=t,this.popperInstance=Popper.createPopper(e,t,{placement:"bottom-start",modifiers:[{name:"offset",options:{offset:[0,8]}},{name:"flip",options:{fallbackPlacements:["bottom-start","top-start"]}},{name:"preventOverflow",options:{boundary:$("ba-info-statpreview-panel .panel-sliders")[0]}},{name:"updateWidth",enabled:!0,phase:"main",fn:({state:e})=>{e.elements.popper.style.width=`${e.elements.reference.offsetWidth}px`}}]}),this.hide()}show(){$(this.popup).show(),this.popperInstance.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!0}]}))}hide(){$(this.popup).hide(),this.popperInstance.setOptions(e=>({...e,modifiers:[...e.modifiers.filter(e=>"eventListeners"!=e.name),{name:"eventListeners",enabled:!1}]}))}}class SupportStats{elements={controls:null,searchBox:null,searchButton:null,searchResults:null};supportStudents=[];searchBoxTimeout=null;searchResultsSelection=0;searchResultsCount=0;constructor(e){this.elements=e,this.searchResultPopper=new ResultsPopper($(this.elements.searchBox).parent()[0],this.elements.searchResults),$(this.elements.searchResults).find(".search-list > div").on("click","div[data-student-id]",e=>{this.addSupportStudent(e.currentTarget.dataset.studentId),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchButton).on("click",e=>{$(this.elements.searchResults).is(":visible")?this.searchResultPopper.hide():(this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchResultPopper.show(),this.searchStudents())}),$(this.elements.searchBox).on("input",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBoxTimeout=setTimeout(()=>{""!=e.currentTarget.value?(this.searchResultPopper.show(),this.searchStudents()):this.searchResultPopper.hide()},100)}).on("blur",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),""==e.currentTarget.value&&this.searchResultPopper.hide()}).on("keyup keydown",e=>{switch(e.code){case"Enter":e.preventDefault(),$(this.elements.searchResults).is(":visible")&&"keyup"==e.type&&(0==this.searchResultsSelection&&this.searchResultsCount>0?$(this.elements.searchResults).find('.search-list-item[data-index="1"]').trigger("click"):$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`).trigger("click"));break;case"ArrowDown":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection<this.searchResultsCount){this.searchResultsSelection++,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"ArrowUp":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection>1){this.searchResultsSelection--,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"Escape":e.preventDefault(),$(this.elements.searchBox).val("").trigger("blur")}}),$(this.elements.controls).on("input",".support-level input",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.supportStudents[t].level=e.currentTarget.value;const a=$(`#supportstats-controls-${t}`),s=this.supportStudents[t];$(`#supportstats-controls-${t} .support-level .ba-slider-label`).text(`Lv.${s.level}`),recalculateStatsWithDelay()}),$(this.elements.controls).on("click",".ba-statpreview-star",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=parseInt(e.currentTarget.dataset.val);this.supportStudents[t].starGrade=a,this.supportStudents[t].weaponStarGrade=0,this.updateControlValues(t)}),$(this.elements.controls).on("click",".ba-weaponpreview-star",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=parseInt(e.currentTarget.dataset.val);this.supportStudents[t].starGrade=5,this.supportStudents[t].weaponStarGrade=a,this.supportStudents[t].weaponLevel=20+10*a,this.updateControlValues(t)}),$(this.elements.controls).on("change",".support-bond",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=e.currentTarget.dataset.bond,s=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.supportStudents[t].bond[a]=s,this.updateControlValues(t)}).on("click",".support-bond",e=>{e.currentTarget.select()}),$(this.elements.controls).on("change",".support-potential",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=e.currentTarget.dataset.stat,s=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.supportStudents[t].potential[a]=s,this.updateControlValues(t)}).on("click",".support-potential",e=>{e.currentTarget.select()}),$(this.elements.controls).on("change",".support-stat-weapon-level",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.supportStudents[t].weaponLevel=a,this.updateControlValues(t)}),$(this.elements.controls).on("click",".support-gear .dropdown-item",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index"),a=$(e.currentTarget).closest("[data-slot]").data("slot");this.supportStudents[t].equipment[a-1]=parseInt(e.currentTarget.dataset.tier),this.updateControlValues(t)}),$(this.elements.controls).on("click",".support-ex-gear",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.supportStudents[t].gear=!this.supportStudents[t].gear,$(e.currentTarget).toggleClass("deactivated",!this.supportStudents[t].gear),this.updateControlValues(t)}),$(this.elements.controls).on("click",".student-remove",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");this.removeSupportStudent(t)}),$(this.elements.controls).on("click","button.panel-collapse",e=>{const t=$(e.currentTarget).closest("[data-index]").data("index");$(`#supportstats-controls-${t}`).hasClass("collapsing")||(this.supportStudents[t].panelOpen=!this.supportStudents[t].panelOpen,$(e.currentTarget).toggleClass("active",this.supportStudents[t].panelOpen),$(`#supportstats-controls-${t}`).collapse(this.supportStudents[t].panelOpen?"show":"hide"))})}addSupportStudent(e){const t=find(data.students,"Id",e)[0],a={student:t};if(e in studentCollection){const t=studentCollection[e];a.level=Math.min(parseInt(t.l),region.StudentMaxLevel),a.starGrade=parseInt(t.s),a.weaponStarGrade=region.WeaponMaxLevel>0?parseInt(t.ws):0,a.weaponLevel=Math.min(parseInt(t.wl),region.WeaponMaxLevel),a.equipment=[Math.min(parseInt(t.e1),region.EquipmentMaxLevel[0]),Math.min(parseInt(t.e2),region.EquipmentMaxLevel[1]),Math.min(parseInt(t.e3),region.EquipmentMaxLevel[2])],a.gear=!1,a.bond=[Math.min(parseInt(t.b),region.BondMaxLevel)]}else a.level=region.StudentMaxLevel,a.starGrade=5,a.weaponStarGrade=region.WeaponMaxLevel>0?3:0,a.weaponLevel=region.WeaponMaxLevel,a.equipment=region.EquipmentMaxLevel,a.gear=!1,a.bond=[20];a.potential={MaxHP:0,AttackPower:0,HealPower:0},t.FavorAlts.forEach(e=>{a.bond.push(e in studentCollection?studentCollection[e].b:1)}),a.panelOpen=!1,this.supportStudents.push(a),this.renderControls()}removeSupportStudent(e){this.supportStudents.splice(e,1),this.renderControls()}searchStudents(){let e="",t=0;const a=this.elements.searchBox.value.toLowerCase();data.students.forEach(s=>{"Support"==s.SquadType&&s.IsReleased[regionID]&&!this.supportStudents.find(e=>e.student.Id==s.Id)&&searchContains(a,getTranslatedString(s,"Name"))&&(e+=SupportStats.getSearchResultListItemHtml(s,++t))}),this.searchResultsSelection=0,this.searchResultsCount=t,""!=e?this.searchResultPopper.show():this.searchResultPopper.hide(),$(this.elements.searchResults).find(".search-list > div").html(e)}static getSearchResultListItemHtml(e,t){return`<div class="search-list-item" data-index="${t}" data-student-id="${e.Id}"><div class="search-list-item-icon"><img class="student-icon" src="images/student/icon/${e.Id}.webp"></div><div class="search-list-item-detail"><span>${getTranslatedString(e,"Name")}</span>${e.Id in studentCollection?`<span class="text-small"><i class="me-1 fa-solid fa-circle-check"></i><span>${translateUI("collection_owned")}</span></span>`:`<span class="text-small text-muted"><i class="me-1 fa-solid fa-circle-xmark"></i><span>${translateUI("collection_notowned")}</span></span>`}</div></div>`}renderControls(){let e="";this.supportStudents.forEach((t,a)=>{if(e+=`\n            <div data-index="${a}" class="ba-panel p-2">\n                <div class="d-flex flex-row align-items-center gap-2">\n                    <div class="support-stats">\n                        <img src="images/student/icon/${t.student.Id}.webp">\n                    </div>\n                    <div class="flex-fill">\n                        <h5 class="support-stats-name">${t.student.Name}</h5>\n                        <p class="support-stats-desc mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p>\n                    </div>\n                    <div class="d-flex flex-column justify-content-between align-self-stretch">\n                        <button class="btn btn-sm btn-dark stat-panel-btn-sm no-wrap student-remove" type="button"><i class="fa-solid fa-xmark"></i></button>\n                        <button class="btn btn-sm btn-dark stat-panel-btn-sm no-wrap panel-collapse ${t.panelOpen?" active":""}"><i class="fa-solid fa-gear"></i></button>\n                    </div>\n                </div>\n                <div class="collapse${t.panelOpen?" show":""}" id="supportstats-controls-${a}">\n                    <div class="d-flex flex-column gap-2 pt-3">\n                        <div class="d-flex flex-row align-items-center gap-2 support-level">\n                            <input type="range" class="form-range flex-fill" value="${t.level}" min="1" max="${region.StudentMaxLevel}">\n                            <span class="ba-slider-label">Lv.${t.level}</span>\n                        </div>  \n                        <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2">\n                            <div class="d-inline-block ba-panel statpreview-stars px-2 d-flex align-items-center">\n                                <span class="ba-statpreview-star" data-val="1"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="4"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-statpreview-star" data-val="5"><i class="fa-solid fa-star"></i></span>\n                                ${region.WeaponMaxLevel>0?'<span class="ba-weaponpreview-star ms-2" data-val="1"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-weaponpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                                <span class="ba-weaponpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>':""}\n                            </div>\n                            ${SupportStats.renderBondControls(t.student)}\n                            <input style="display:none;" type="number" class="support-stat-weapon-level form-control" value="${t.weaponLevel}" min="1" step="1" max="50"></span>\n                            \n\n                            \n                        </div>\n                        <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2 text-bold">\n                            ${SupportStats.renderGearDropdown(1,t.student.Equipment[0])}\n                            ${SupportStats.renderGearDropdown(2,t.student.Equipment[1])}\n                            ${SupportStats.renderGearDropdown(3,t.student.Equipment[2])}`,"Released"in t.student.Gear&&t.student.Gear.Released[regionID]&&(e+=`\n                <button class="btn-pill support-ex-gear ${t.gear?"":"deactivated"}">\n                    <div class="icon"><img class="ba-item-n" src="images/gear/icon/${t.student.Id}.webp" width="28" height="28"></div>\n                    <i class="fa-regular fa-square off mx-2"></i>\n                    <i class="fa-solid fa-square-check on mx-2"></i>\n                </button>\n                `),region.PotentialMax>0){e+='<div class="d-flex align-items-center justify-content-center gap-2">';for(const t of["MaxHP","AttackPower","HealPower"])e+=`<div class="input-small"><div class="icon icon-potential"><img src="images/staticon/Stat_${t}.png"></div><input data-stat="${t}" class="form-control support-potential" type="number" value="0" min="0" max="${region.PotentialMax}"></div>`;e+="</div>"}e+="  </div>\n                    </div>\n                </div>\n            </div>\n            "}),$(this.elements.controls).html(e),this.supportStudents.forEach((e,t)=>this.updateControlValues(t,!1)),$(this.elements.searchBox).add(this.elements.searchButton).attr("disabled",this.supportStudents.length>=4),recalculateStats()}updateControlValues(e,t=!0){const a=$(`#supportstats-controls-${e}`),s=this.supportStudents[e];a.find(".support-level .ba-slider-label").text(`Lv.${s.level}`);for(let e=1;e<=5;e++)a.find(`.ba-statpreview-star[data-val="${e}"]`).toggleClass("active",e<=s.starGrade);for(let e=1;e<=3;e++)a.find(`.ba-weaponpreview-star[data-val="${e}"]`).toggleClass("active",e<=s.weaponStarGrade);for(let e=0;e<s.bond.length;e++)a.find(`.support-bond[data-bond="${e}"]`).val(s.bond[e]);for(const e of["MaxHP","AttackPower","HealPower"])a.find(`.support-potential[data-stat="${e}"]`).val(s.potential[e]);a.find(".support-stat-weapon-level").attr("max",20+10*s.weaponStarGrade).val(s.weaponLevel).attr("disabled",0==s.weaponStarGrade),a.find(".support-gear .dropdown-item.active").removeClass("active");for(let e=1;e<=3;e++)a.find(`.support-gear[data-slot="${e}"] .dropdown-item[data-tier="${s.equipment[e-1]}"]`).addClass("active"),a.find(`.support-gear[data-slot="${e}"] .support-gear-icon`).attr("src",`images/equipment/icon/equipment_icon_${s.student.Equipment[e-1].toLowerCase()}_tier${s.equipment[e-1]}.webp`),a.find(`.support-gear[data-slot="${e}"] .support-gear-label`).text(`T${s.equipment[e-1]}`);t&&recalculateStats()}static renderGearDropdown(e,t){let a=`<div class="support-gear" data-slot="${e}">\n        <button class="btn-pill" data-bs-toggle="dropdown">\n            <div class="icon"><img class="support-gear-icon ba-item-n" src="" width="28" height="28"></div>\n            <span class="support-gear-label label"></span>\n            <i class="caret fa-solid fa-caret-down me-2"></i>\n        </button>\n        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-start">`;for(let s=1;s<=region.EquipmentMaxLevel[e-1];s++)a+=`<li><a class="dropdown-item dropdown-item-icon" data-tier="${s}" href="javascript:;"><div class="icon"><img class="ba-item-n" src="images/equipment/icon/equipment_icon_${t.toLowerCase()}_tier${s}.webp"></div><span>T${s}</span></a></li>`;return a+="</ul></div>",a}static renderBondControls(e){let t=`<div class="d-flex align-items-center justify-content-center gap-2"><div class="input-small"><div class="icon bond-small"><img src="images/student/icon/${e.Id}.webp"></div><input data-bond="0" class="form-control support-bond" type="number" value="1" min="1" max="${region.BondMaxLevel}"></div>`;return e.FavorAlts.forEach((e,a)=>{const s=find(data.students,"Id",e)[0];s.IsReleased[regionID]&&(t+=`<div class="input-small"><div class="icon bond-small"><img src="images/student/icon/${s.Id}.webp"></div><input data-bond="${a+1}" class="form-control support-bond" type="number" value="1" min="1" max="${region.BondMaxLevel}"></div>`)}),t+="</div>",t}}let statPreviewSupportStats=SupportStats;class TSAStats{elements={controls:null};tsaStudent=null;enabled=!1;constructor(e){this.elements=e,$(this.elements.controls).on("input",".support-level input",e=>{this.tsaStudent.level=e.currentTarget.value,$("#tsastats-controls .support-level .ba-slider-label").text(`Lv.${this.tsaStudent.level}`),recalculateStatsWithDelay()}),$(this.elements.controls).on("click",".ba-statpreview-star",e=>{const t=parseInt(e.currentTarget.dataset.val);this.tsaStudent.starGrade=t,this.tsaStudent.weaponStarGrade=0,this.updateControlValues()}),$(this.elements.controls).on("click",".ba-weaponpreview-star",e=>{const t=parseInt(e.currentTarget.dataset.val);this.tsaStudent.starGrade=5,this.tsaStudent.weaponStarGrade=t,this.tsaStudent.weaponLevel=20+10*t,this.updateControlValues()}),$(this.elements.controls).on("change",".support-bond",e=>{const t=e.currentTarget.dataset.bond,a=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.tsaStudent.bond[t]=a,this.updateControlValues()}).on("click",".support-bond",e=>{e.currentTarget.select()}),$(this.elements.controls).on("change",".support-stat-weapon-level",e=>{const t=Math.min(Math.max(parseInt(e.currentTarget.value),1),parseInt(e.currentTarget.max));this.tsaStudent.weaponLevel=t,this.updateControlValues()}),$(this.elements.controls).on("click",".support-gear .dropdown-item",e=>{const t=$(e.currentTarget).closest("[data-slot]").data("slot");this.tsaStudent.equipment[t-1]=parseInt(e.currentTarget.dataset.tier),this.updateControlValues()}),$(this.elements.controls).on("click",".support-ex-gear",e=>{this.tsaStudent.gear=!this.tsaStudent.gear,$(e.currentTarget).toggleClass("deactivated",!this.tsaStudent.gear),this.updateControlValues()}),$(this.elements.controls).on("click","button.panel-collapse",e=>{$("#tsastats-controls").hasClass("collapsing")||(this.tsaStudent.panelOpen=!this.tsaStudent.panelOpen,$(e.currentTarget).toggleClass("active",this.tsaStudent.panelOpen),$("#tsastats-controls").collapse(this.tsaStudent.panelOpen?"show":"hide"))})}setStudent(e){const t=find(data.students,"Id",e)[0],a={student:t};if(e in studentCollection){const t=studentCollection[e];a.level=Math.min(parseInt(t.l),region.StudentMaxLevel),a.starGrade=parseInt(t.s),a.weaponStarGrade=region.WeaponMaxLevel>0?parseInt(t.ws):0,a.weaponLevel=Math.min(parseInt(t.wl),region.WeaponMaxLevel),a.equipment=[Math.min(parseInt(t.e1),region.EquipmentMaxLevel[0]),Math.min(parseInt(t.e2),region.EquipmentMaxLevel[1]),Math.min(parseInt(t.e3),region.EquipmentMaxLevel[2])],a.gear=!1,a.bond=[Math.min(parseInt(t.b),region.BondMaxLevel)]}else a.level=region.StudentMaxLevel,a.starGrade=5,a.weaponStarGrade=region.WeaponMaxLevel>0?3:0,a.weaponLevel=region.WeaponMaxLevel,a.equipment=region.EquipmentMaxLevel,a.gear=!1,a.bond=[20];t.FavorAlts.forEach(e=>{a.bond.push(e in studentCollection?studentCollection[e].b:1)}),a.panelOpen=!1,this.tsaStudent=a,this.renderControls()}renderControls(){let e=`\n        <div class="ba-panel p-2${this.enabled?"":" disabled"}">\n            <div class="d-flex flex-row align-items-center gap-2">\n                <div class="tsa-stats">\n                    <img src="images/student/icon/${this.tsaStudent.student.Id}.webp">\n                </div>\n                <div class="flex-fill">\n                    <h5 class="support-stats-name">${this.tsaStudent.student.Name}</h5>\n                    <p class="support-stats-desc mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p>\n                </div>\n                <div class="d-flex flex-column justify-content-between align-self-stretch">\n                    <button class="btn btn-sm btn-dark stat-panel-btn-sm no-wrap panel-collapse ${this.tsaStudent.panelOpen?" active":""}"><i class="fa-solid fa-gear"></i></button>\n                </div>\n            </div>\n            <div class="collapse${this.tsaStudent.panelOpen?" show":""}" id="tsastats-controls">\n                <div class="d-flex flex-column gap-2 pt-3">\n                    <div class="d-flex flex-row align-items-center gap-2 support-level">\n                        <input type="range" class="form-range flex-fill" value="${this.tsaStudent.level}" min="1" max="${region.StudentMaxLevel}">\n                        <span class="ba-slider-label">Lv.${this.tsaStudent.level}</span>\n                    </div>  \n                    <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2">\n                        <div class="d-inline-block ba-panel statpreview-stars px-2 d-flex align-items-center">\n                            <span class="ba-statpreview-star" data-val="1"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-statpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-statpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-statpreview-star" data-val="4"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-statpreview-star" data-val="5"><i class="fa-solid fa-star"></i></span>\n                            ${region.WeaponMaxLevel>0?'<span class="ba-weaponpreview-star ms-2" data-val="1"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-weaponpreview-star" data-val="2"><i class="fa-solid fa-star"></i></span>\n                            <span class="ba-weaponpreview-star" data-val="3"><i class="fa-solid fa-star"></i></span>':""}\n                        </div>\n                        ${SupportStats.renderBondControls(this.tsaStudent.student)}\n                        <input style="display:none;" type="number" class="support-stat-weapon-level form-control" value="${this.tsaStudent.weaponLevel}" min="1" step="1" max="50"></span>\n                        \n\n                        \n                    </div>\n                    <div class="d-flex flex-row flex-wrap align-items-center justify-content-center gap-2 text-bold">\n                        ${SupportStats.renderGearDropdown(1,this.tsaStudent.student.Equipment[0])}\n                        ${SupportStats.renderGearDropdown(2,this.tsaStudent.student.Equipment[1])}\n                        ${SupportStats.renderGearDropdown(3,this.tsaStudent.student.Equipment[2])}`;"Released"in this.tsaStudent.student.Gear&&this.tsaStudent.student.Gear.Released[regionID]&&(e+=`\n            <button class="btn-pill support-ex-gear ${this.tsaStudent.gear?"":"deactivated"}">\n                <div class="icon"><img class="ba-item-n" src="images/gear/icon/${this.tsaStudent.student.Id}.webp" width="28" height="28"></div>\n                <i class="fa-regular fa-square off mx-2"></i>\n                <i class="fa-solid fa-square-check on mx-2"></i>\n            </button>\n            `),e+="  </div>\n                </div>\n            </div>\n        </div>\n        ",$(this.elements.controls).html(e),this.updateControlValues(!1)}updateControlValues(e=!0){const t=$("#tsastats-controls"),a=this.tsaStudent;t.find(".support-level .ba-slider-label").text(`Lv.${a.level}`);for(let e=1;e<=5;e++)t.find(`.ba-statpreview-star[data-val="${e}"]`).toggleClass("active",e<=a.starGrade);for(let e=1;e<=3;e++)t.find(`.ba-weaponpreview-star[data-val="${e}"]`).toggleClass("active",e<=a.weaponStarGrade);for(let e=0;e<a.bond.length;e++)t.find(`.support-bond[data-bond="${e}"]`).val(a.bond[e]);t.find(".support-stat-weapon-level").attr("max",20+10*a.weaponStarGrade).val(a.weaponLevel).attr("disabled",0==a.weaponStarGrade),t.find(".support-gear .dropdown-item.active").removeClass("active");for(let e=1;e<=3;e++)t.find(`.support-gear[data-slot="${e}"] .dropdown-item[data-tier="${a.equipment[e-1]}"]`).addClass("active"),t.find(`.support-gear[data-slot="${e}"] .support-gear-icon`).attr("src",`images/equipment/icon/equipment_icon_${a.student.Equipment[e-1].toLowerCase()}_tier${a.equipment[e-1]}.webp`),t.find(`.support-gear[data-slot="${e}"] .support-gear-label`).text(`T${a.equipment[e-1]}`);e&&recalculateStats()}}let statPreviewTSAStats=TSAStats;class EnemyFinder{armorTypes=["Normal","LightArmor","HeavyArmor","Unarmed","ElasticArmor"];enemyList=[];elements={controls:null,searchBox:null,searchButton:null,searchResults:null};searchBoxTimeout=null;searchTypeFilter="all";searchBookmarksFilter=!1;searchResultsSelection=0;searchResultsCount=0;constructor(e){this.elements=e,this.searchResultPopper=new ResultsPopper($(this.elements.searchBox).parent()[0],this.elements.searchResults),$(this.elements.searchResults).find(".search-list-results").on("click","div[data-enemy-list-index]",e=>{const t=$(e.currentTarget);this.setEnemyByIndex(t.data("enemy-list-index")),this.searchResultPopper.hide(),$(this.elements.searchBox).val("")}),$(this.elements.searchResults).find(".search-list-filter").on("click","a[data-filter-key]",e=>{const t=$(e.currentTarget);this.searchTypeFilter=t.data("filter-key"),$(this.elements.searchResults).find("a[data-filter-key]").removeClass("active"),t.addClass("active"),$(this.elements.searchResults).find(".search-list-filter-active").text(t.text()),this.search()}),$(this.elements.searchResults).find(".search-list-filter-active").text(translateUI("filter_all")),$(this.elements.searchResults).find(".search-list-bookmark").on("click",e=>{const t=$(e.currentTarget);this.searchBookmarksFilter=!this.searchBookmarksFilter,t.toggleClass("active",this.searchBookmarksFilter),this.search()}),$("#statpreview-enemy-bookmark").on("click",e=>{const t=$(e.currentTarget);let a;a=statPreviewSelectedEnemyLevelFixed?`${statPreviewSelectedEnemyId}_${statPreviewSelectedEnemyLevel}_${statPreviewSelectedEnemyGrade}`:`${statPreviewSelectedEnemyId}_-1_${statPreviewSelectedEnemyGrade}`,-1==statPreviewEnemyBookmarks.indexOf(a)?(statPreviewEnemyBookmarks.push(a),t.toggleClass("active",!0)):(statPreviewEnemyBookmarks.splice(statPreviewEnemyBookmarks.indexOf(a),1),t.toggleClass("active",!1)),localStorage.setItem("enemy_bookmarks",JSON.stringify(statPreviewEnemyBookmarks))}),localStorage.getItem("selected_enemy")?this.setEnemyByUniqueKey(localStorage.getItem("selected_enemy")):this.setEnemyByIndex(0),$(this.elements.searchButton).on("click",e=>{$(this.elements.searchResults).is(":visible")?this.searchResultPopper.hide():(this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchResultPopper.show(),this.search())}),$(this.elements.searchBox).on("input",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),this.searchBoxTimeout=setTimeout(()=>{""!=e.currentTarget.value?(this.searchResultPopper.show(),this.search()):this.searchResultPopper.hide()},100)}).on("blur",e=>{this.searchBoxTimeout&&clearTimeout(this.searchBoxTimeout),""==e.currentTarget.value&&this.searchResultPopper.hide()}).on("keyup keydown",e=>{switch(e.code){case"Enter":e.preventDefault(),$(this.elements.searchResults).is(":visible")&&"keyup"==e.type&&(0==this.searchResultsSelection&&this.searchResultsCount>0?$(this.elements.searchResults).find('.search-list-item[data-index="1"]').trigger("click"):$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`).trigger("click"));break;case"ArrowDown":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection<this.searchResultsCount){this.searchResultsSelection++,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"ArrowUp":if(e.preventDefault(),"keydown"==e.type&&this.searchResultsSelection>1){this.searchResultsSelection--,$(this.elements.searchResults).find(".search-list-item").removeClass("selected");const e=$(this.elements.searchResults).find(`.search-list-item[data-index="${this.searchResultsSelection}"]`);e.addClass("selected"),e[0].scrollIntoView({behavior:"auto",block:"nearest"})}break;case"Escape":e.preventDefault(),$(this.elements.searchBox).val("").trigger("blur")}}),$("#statpreview-enemy-defensetype-list").on("click",".dropdown-item",e=>{this.toggleEnemyArmorType(e.currentTarget.dataset.value)})}static generateEnemyList(){statPreviewEnemyList=[],data.raids.Raid.forEach(e=>{e.EnemyList.forEach((t,a)=>{!e.IsReleased[regionID]||a>e.MaxDifficulty[regionID]||t.forEach(t=>{const s=find(data.enemies,"Id",t)[0];if(!("Main"!=s.SquadType||s.DevName.includes("Resort_")||s.DevName.includes("AAGun_")||s.DevName.includes("_HolyRelic_")||s.DevName.includes("_HolyRelic02_"))){const t=void 0!==s.Icon&&""!=s.Icon?`images/enemy/${s.Icon}.webp`:`images/raid/icon/Icon_${e.PathName}${a>4?"_Insane":""}.png`;statPreviewEnemyList.push({id:s.Id,name:`${s.Name}`,searchTerms:[getTranslatedString(e,"Name")+" "+getLocalizedString("RaidDifficulty",raidDifficultyName[a])],source:"raid",sourceName:`${getLocalizedString("StageType","Raid")} / ${getLocalizedString("RaidDifficulty",raidDifficultyName[a])}`,rank:s.Rank,icon:t,level:raid_level[a],grade:1,raidId:e.Id,raidDifficulty:a})}})})}),data.raids.TimeAttack.forEach(e=>{if(!e.IsReleased[regionID])return;const t=getServerProperty(e,"Formations");t.forEach((e,t)=>{e.EnemyList.forEach(a=>{const s=find(data.enemies,"Id",a)[0];"Main"==s.SquadType&&"Summoned"!=s.Rank&&-1==statPreviewEnemyList.findIndex(e=>e.id==s.Id)&&statPreviewEnemyList.push({id:s.Id,name:`${s.Name}`,searchTerms:[getLocalizedString("StageType","TimeAttack")],source:"timeattack",sourceName:`${getLocalizedString("StageType","TimeAttack")} / ${translateUI("ta_phase")+(t+1)}`,rank:s.Rank,icon:`images/enemy/${s.Icon}.webp`,level:e.Level[enemy_rank[s.Rank]],grade:e.Grade[enemy_rank[s.Rank]]})})})}),data.raids.WorldRaid.forEach(e=>{e.EnemyList.forEach((t,a)=>{!e.IsReleased[regionID]||a>e.MaxDifficulty[regionID]||t.forEach(t=>{const s=find(data.enemies,"Id",t)[0];if("Main"==s.SquadType&&!s.DevName.includes("_Resort_")&&!s.DevName.includes("_HolyRelic_")&&!s.DevName.includes("_HolyRelic02_")){const t=void 0!==s.Icon&&""!=s.Icon?`images/enemy/${s.Icon}.webp`:`images/raid/icon/Icon_${e.PathName}.png`;statPreviewEnemyList.push({id:s.Id,name:s.Name,searchTerms:[getTranslatedString(e,"Name")+" "+getLocalizedString("RaidDifficulty",e.DifficultyName[a])],source:"worldraid",sourceName:`${getLocalizedString("StageType","WorldRaid")} / ${getLocalizedString("RaidDifficulty",e.DifficultyName[a])}`,rank:s.Rank,icon:t,level:e.Level[a],grade:1,raidId:e.Id,raidDifficulty:a})}})})}),data.raids.MultiFloorRaid.forEach(e=>{e.EnemyList.forEach((t,a)=>{!e.IsReleased[regionID]||a>e.MaxDifficulty[regionID]||t.forEach(t=>{const s=find(data.enemies,"Id",t)[0];if("Main"==s.SquadType&&!s.IsNPC){const t=void 0!==s.Icon&&""!=s.Icon?`images/enemy/${s.Icon}.webp`:`images/raid/icon/Icon_${e.PathName}.png`;statPreviewEnemyList.push({id:s.Id,name:s.Name,searchTerms:[getTranslatedString(e,"Name")],source:"multifloorraid",sourceName:`${getLocalizedString("StageType","MultiFloorRaid")} (${getLocalizedString("ArmorType",e.ArmorType)}) / ${e.DifficultyStartFloor[a]} ~ ${e.DifficultyStartFloor[a+1]-1}`,rank:s.Rank,icon:t,level:-1,grade:1,raidId:e.Id,raidDifficulty:a})}})})}),data.stages.Event.forEach(e=>{if(2!=e.Difficulty||!region.Events.includes(e.EventId))return;let t=e.Field?"Field":"Event";const a=getServerProperty(e,"Formations");a.forEach(a=>{a.EnemyList.forEach(s=>{const i=find(data.enemies,"Id",s)[0];i.Id>=801e4&&"Main"==i.SquadType&&"Main"==i.SquadType&&"Summoned"!=i.Rank&&statPreviewEnemyList.push({id:i.Id,name:`${i.Name}`,searchTerms:[getStageName(e,t),i.Name+" challenge"],source:"event",sourceName:getStageName(e,t),rank:i.Rank,icon:`images/enemy/${i.Icon}.webp`,level:a.Level[enemy_rank[i.Rank]],grade:a.Grade[enemy_rank[i.Rank]]})})})}),data.stages.ConquestMap.forEach(e=>{if(!region.Events.includes(e.EventId))return;const t=getLocalizedString("ConquestMap",""+e.EventId%1e4);e.Maps.filter(e=>"VeryHard"==e.Difficulty).forEach(e=>{e.Tiles.filter(e=>"Battle"==e.Type).forEach(e=>{const a=find(data.stages.Conquest,"Id",e.StageId)[0],s=getServerProperty(a,"Formations");s.forEach(e=>{e.EnemyList.forEach(a=>{const s=find(data.enemies,"Id",a)[0];s.Id>=801e4&&"Main"==s.SquadType&&"Main"==s.SquadType&&"Summoned"!=s.Rank&&statPreviewEnemyList.push({id:s.Id,name:s.Name,searchTerms:[t,s.Name+" "+getLocalizedString("StageType","Conquest")],source:"event",sourceName:t,rank:s.Rank,icon:`images/enemy/${s.Icon}.webp`,level:e.Level[enemy_rank[s.Rank]],grade:e.Grade[enemy_rank[s.Rank]]})})})})})}),data.stages.SchoolDungeon.forEach(e=>{if(e.Stage>region.SchoolDungeonMax)return;const t=getServerProperty(e,"Formations")[0];t.EnemyList.forEach(a=>{const s=find(data.enemies,"Id",a)[0];"Main"==s.SquadType&&statPreviewEnemyList.push({id:s.Id,name:s.Name,searchTerms:[getStageTitle(e,"SchoolDungeon"),getLocalizedString("StageType","SchoolDungeon"),s.Name+" "+getStageTitle(e,"SchoolDungeon")],source:"schooldungeon",sourceName:`${getLocalizedString("StageType","SchoolDungeon")} / ${getStageTitle(e,"SchoolDungeon")}`,rank:s.Rank,icon:`images/enemy/${s.Icon}.webp`,level:t.Level[enemy_rank[s.Rank]],grade:t.Grade[enemy_rank[s.Rank]]})})}),data.enemies.forEach(e=>{"Main"==e.SquadType&&"Summoned"!=e.Rank&&e.Id>=7e6&&e.Id<72e5&&e.Id<=7199999&&statPreviewEnemyList.push({id:e.Id,name:e.Name,searchTerms:[],source:"campaign",sourceName:getLocalizedString("StageType",EnemyFinder.getModeFromEnemyId(e.Id)),rank:e.Rank,icon:`images/enemy/${e.Icon}.webp`,level:-1,grade:1})})}setEnemyByIndex(e){const t=statPreviewEnemyList[e],a=find(data.enemies,"Id",t.id)[0];statPreviewSelectedEnemyId=t.id,statPreviewSelectedEnemyGrade=t.grade,statPreviewSelectedEnemyRaid=void 0===t.raidId?0:t.raidId,statPreviewSelectedEnemyRaidDifficulty=t.raidDifficulty;const s=`${t.id}_${t.level}_${t.grade}`;localStorage.setItem("selected_enemy",s);let i="icon-enemy";t.icon.startsWith("images/raid/icon")&&(i+="-raid"),$("#statpreview-enemy-name").html(t.name),$("#statpreview-enemy-desc").html(t.sourceName),$("#statpreview-enemy-icon").html(`<div class="${i}"><img src="${t.icon}"></div>`),$("#statpreview-enemy-icon").removeClass("elite champion boss").addClass(t.rank.toLowerCase()),$("#statpreview-enemy-size").toggle(null!=a.Size),$("#statpreview-enemy-size .label").text(null!=a.Size?getLocalizedString("CharacterSize",a.Size):""),setAttackTypeClass($("#statpreview-enemy-attacktype .icon-type"),a.BulletType),setDefenseTypeClass($("#statpreview-enemy-defensetype .icon-type"),a.ArmorType),$("#statpreview-enemy-attacktype .label").text(getLocalizedString("BulletType",a.BulletType)),$("#statpreview-enemy-defensetype .label").text(getLocalizedString("ArmorType",a.ArmorType));let l="";for(let e of this.armorTypes)l+=`<li><a class="dropdown-item dropdown-item-icon${a.ArmorType==e?" active":""}" href="javascript:;" data-value="${e}" class="btn btn-dark"><span>${getLocalizedString("ArmorType",e)}</span></a></li>`;if($("#statpreview-enemy-defensetype-list").html(l),statPreviewSelectedEnemyArmorType=a.ArmorType,-1!=t.level?($("#calculation-enemy-level").toggleClass("disabled",!0),$("#calculation-enemy-level input").val(t.level),statPreviewSelectedEnemyLevel=t.level,statPreviewSelectedEnemyLevelFixed=!0):($("#calculation-enemy-level").toggleClass("disabled",!1),statPreviewSelectedEnemyLevelFixed=!1),"multifloorraid"==t.source){const e=find(data.raids.MultiFloorRaid,"Id",t.raidId)[0];$("#calculation-enemy-floor").show(),$("#calculation-enemy-floor input").val(0).attr("max",e.DifficultyStartFloor[t.raidDifficulty+1]-e.DifficultyStartFloor[t.raidDifficulty]-1).off("input").on("input",(function(a){statPreviewSelectedEnemyRaidFloor=e.DifficultyStartFloor[t.raidDifficulty]-1+parseInt(this.value),$("#calculation-enemy-floor .ba-slider-label").text(`${statPreviewSelectedEnemyRaidFloor+1}`),calculateEnemyStats()})),statPreviewSelectedEnemyRaidFloor=e.DifficultyStartFloor[t.raidDifficulty]-1,$("#calculation-enemy-floor .ba-slider-label").text(`${statPreviewSelectedEnemyRaidFloor+1}`),$("#calculation-enemy-level").toggleClass("disabled",!0)}else $("#calculation-enemy-floor").hide();$("#statpreview-enemy-bookmark").toggleClass("active",-1!=statPreviewEnemyBookmarks.indexOf(s)),initRaidSkillInfo(t.raidId,t.id,t.raidDifficulty),calculateEnemyStats()}toggleEnemyArmorType(e){statPreviewSelectedEnemyArmorType=e,$("#statpreview-enemy-defensetype-list .dropdown-item").removeClass("active"),$(`#statpreview-enemy-defensetype-list .dropdown-item[data-value="${e}"]`).addClass("active"),setDefenseTypeClass($("#statpreview-enemy-defensetype .icon-type"),statPreviewSelectedEnemyArmorType),$("#statpreview-enemy-defensetype .label").text(getLocalizedString("ArmorType",statPreviewSelectedEnemyArmorType)),calculateEnemyStats()}setEnemyByUniqueKey(e){let t,a,s;[t,a,s]=e.split("_");const i=statPreviewEnemyList.findIndex(e=>e.id==t&&e.level==a&&e.grade==s);-1!=i?this.setEnemyByIndex(i):this.setEnemyByIndex(0)}search(){let e="",t=0;const a=this.elements.searchBox.value.toLowerCase();for(let s=0;s<statPreviewEnemyList.length&&!(t>=50);s++){const i=statPreviewEnemyList[s];if(("all"==this.searchTypeFilter||this.searchTypeFilter==i.source)&&(!this.searchBookmarksFilter||statPreviewEnemyBookmarks.includes(`${i.id}_${i.level}_${i.grade}`))&&(searchContains(a,i.name)||searchContains(a,i.id.toString())||i.searchTerms.some(e=>searchContains(a,e)))){let a="icon-enemy";i.icon.startsWith("images/raid/icon")&&(a+="-raid"),e+=`<div class="search-list-item" data-index="${++t}" data-enemy-list-index="${s}"><div class="search-list-item-icon enemy-select-icon small me-3 ${i.rank.toLowerCase()}"><div class="${a}"><img src="${i.icon}" loading="lazy"></div></div><div class="search-list-item-detail"><span class="enemy-name">${i.name}</span><span class="enemy-details"><i>${i.sourceName}</i>${-1!=i.level?`<b>Lv.${i.level}</b>`:""}</span></div></div>`}}this.searchResultsSelection=0,this.searchResultsCount=t,""==e&&(e+=`<div class="text-center p-2">${translateUI("no_results")}</div>`),$(this.elements.searchResults).find(".search-list-results").html(e)}static getModeFromEnemyId(e){return e<71e5?"Campaign":e<7110753?"Bounty":e<72e5?"WeekDungeon":e<731e4?"Raid":e<732e4?"WorldRaid":e<764e4?"SchoolDungeon":e<772e4?"Event701":e<79e5?"TimeAttack":e>6e8?"Raid":"Event"}}class SkillDamageInfo{rows;element;character;tsa;constructor(e,t,a,s=null){if(this.skill=e,this.container=t,this.character=a,this.tsa=s,e.IsRaidSkill)this.maxLevel=1;else if(e.IsSummonSkill)switch(this.maxLevel=5,e.SkillType){case"autoattack":this.maxLevel=1;break;default:this.maxLevel=5}else switch(e.SkillType){case"ex":this.maxLevel=5;break;case"autoattack":this.maxLevel=1;break;default:this.maxLevel=10}this.skillLevel=this.maxLevel,this.stackCount=1,void 0!==e.EffectCombine?(this.stackTypes=e.EffectCombine,this.stackMax=0,this.stackEffectIndex={},e.Effects.forEach((t,s)=>{if(this.stackTypes.includes(t.Type)&&(!e.IsRaidSkill||t.RestrictTo.includes(a.Id))){let e=t.Type+(void 0!==t.CombineGroup?`_${t.CombineGroup}`:"");null==this.stackEffectIndex[e]&&(this.stackEffectIndex[e]=[]),this.stackEffectIndex[e].push(s),this.stackMax=Math.max(this.stackMax,this.stackEffectIndex[e].length)}})):(this.stackMax=1,this.stackTypes=[],this.stackEffectIndex={}),this.render()}update(e,t,a){this.rows.forEach(e=>{this.element.find(`.row-value[data-key="${e.effectId}-${e.key}"]`).text(e.valueFunc(this.skill.Effects[e.effectId]))}),this.skill.Effects.forEach((s,i)=>{if(this.stackTypes.includes(s.Type)){let e=s.Type+(void 0!==s.CombineGroup?`_${s.CombineGroup}`:"");this.stackEffectIndex[e][this.stackCount-1]!=i?this.element.find(`div[data-effect-index="${i}"]`).hide():this.element.find(`div[data-effect-index="${i}"]`).show()}if(s.Type.startsWith("DMG")||"FormChange"==s.Type){let l,n,r=!1,o=s.Scale;switch(void 0!==s.SubstituteCondition&&this.checkSubstitutionCondition(s.SubstituteCondition,e,t)&&(o=s.SubstituteScale),s.Type){case"FormChange":l=void 0===o?s.Hits.reduce((e,t)=>e+t,0):o[this.skillLevel-1],n=s.Hits.length;break;case"DMGMulti":l=o[this.skillLevel-1],n=s.Hits.length,void 0!==s.Hits.find(e=>1e4==e)&&(r=!0);break;case"DMGZone":l=o[this.skillLevel-1],r=!0,s.ZoneDuration?(n=Math.ceil(s.ZoneDuration/s.ZoneHitInterval),s.Hits&&(n*=s.Hits.length)):n=s.HitFrames.length;break;default:l=o[this.skillLevel-1],n=1}const d=r?1:n,c=r?n:1,u=void 0!==s.SourceStat?s.SourceStat:"AttackPower",g="Never"==s.CriticalCheck?0:e.getCriticalRate(t.getTotal("CriticalChanceResistPoint")),p=(e.getTotal("CriticalDamageRate")-t.getTotal("CriticalDamageResistRate"))/1e4-1,m=!1===s.ApplyStability?1:e.getStabilityMinDamageMod();let f,h,v,b,$,S,y;if(v=this.skill.IsRaidSkill&&!1===s.CanEvade?1:e.getHitChance(t.getTotal("DodgePoint")),b="DMGDot"==s.Type?" / "+translateUI("time_seconds",[s.Period/1e3]):"",s.ExtraDamageSource){let i,n;switch(s.ExtraDamageSource.Side){case"Self":i=e;break;case"Target":i=t;break;default:throw new Error("Unrecognised damage source target side")}switch(s.ExtraDamageSource.Stat){case"CurrentHP":n=i.getTotal("MaxHP");break;default:throw new Error("Unrecognised damage source stat")}if(s.ExtraDamageSource.SimulatePerHit){let i=n*this.optionValue;f=0,h=0,y=0;for(let r=0;r<s.Hits.length;r++){let o=Math.max(i-y,0),d=s.ExtraDamageSource.Multiplier[0]+(s.ExtraDamageSource.Multiplier[1]-s.ExtraDamageSource.Multiplier[0])*(o/n),c=e.calculateDamage(t,l*(s.Hits[r]/1e4)*d,u,a,0,"IgnoreDef"in s?s.IgnoreDef[this.skillLevel-1]:1e4),b=c*p,$;h+=b,f+=c,"Always"==s.CriticalCheck?c+=b:c+=b*g,y+=(c*m+c)*v/2}f/=s.Hits.length,h/=s.Hits.length}}else f=e.calculateDamage(t,l/d,u,a,0,"IgnoreDef"in s?s.IgnoreDef[this.skillLevel-1]:1e4),h=f*p,$="Always"==s.CriticalCheck?(f+h)*d*c:(f+h*g)*d*c,S=$*m,y=(S+$)*v/2;let w=`${parseFloat((l/100).toFixed(2)).toLocaleString()}%`;if(c>1&&(w+=` &times; ${c}`),d>1&&(w+=` / ${translateUI("dmginfo_numhits",[d])}`),this.element.find(`.row-value[data-key="${i}-scaling"]`).html(w),"Always"!=s.CriticalCheck&&this.element.find(`.row-value[data-key="${i}-dmg-range"]`).text(`${parseInt(f*m).toLocaleString()} ~ ${parseInt(f).toLocaleString()}${b}`),this.element.find(`.row-value[data-key="${i}-dmg-range-crit"]`).text(`${parseInt((f+h)*m).toLocaleString()} ~ ${parseInt(f+h).toLocaleString()}`),this.skill.IsRaidSkill){let a=!1===s.CanEvade?translateUI("hit_chance_certain"):e.getHitChanceString(t.getTotal("DodgePoint"));this.element.find(`.row-value[data-key="${i}-hitrate"]`).html(a),a+=` / <span class="text-crit">${"Always"!=s.CriticalCheck?e.getCriticalHitChanceString(t.getTotal("CriticalChanceResistPoint")):"100%"}</span>`,this.element.find(`.row-value[data-key="${i}-hitcritrate"]`).html(a);const l=t.getTotal("MaxHP");this.element.find(`.row-value[data-key="${i}-dmg-final-avg"]`).html((f*d*c>=l?'<i class="me-2 fa-solid fa-skull"></i>':"")+parseInt(y).toLocaleString())}else this.element.find(`.row-value[data-key="${i}-dmg-final-avg"]`).text(parseInt(y).toLocaleString());if("autoattack"==this.skill.SkillType||"FormChange"==s.Type){const t=1e4/e.getTotal("AttackSpeed"),a=Math.ceil(s.Frames.AttackIngDuration*t),l=Math.ceil(s.Frames.AttackBurstRoundOverDelay*t),n=Math.ceil(s.Frames.AttackReloadDuration*t),r=Math.ceil(s.Frames.AttackStartDuration*t),o=Math.ceil(s.Frames.AttackEndDuration*t),d=e.getTotal("AmmoCount")/this.character.AmmoCost,c=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(a/30,2),a])}</b>`,u=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(l/30,2),l])}</b>`,g=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(r/30,2),r])}</b>`,p=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(n/30,2),n])}</b>`,m=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(o/30,2),o])}</b>`,f=void 0!==s.IgnoreDelay?s.IgnoreDelay[this.skillLevel-1]+1:1;let h;if(this.element.find(`.row-value[data-key="${i}-auto-duration"]`).text(`${translateUI("time_seconds",[MathHelper.toFixedFloat((a+l)/30,2)])} / ${translateUI("normalattack_burst")}`).tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("dmginfo_rate_of_fire_tooltip",[c,u])),placement:"top",html:!0}),10004==this.character.Id){const e=85;h=f*(e+a*d)+l*Math.ceil(d-1),this.element.find(`.row-value[data-key="${i}-auto-reload"]`).text(translateUI("time_seconds",[MathHelper.toFixedFloat(e/30,2)])).tooltip("dispose").tooltip({title:getBasicTooltip(`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(e/30,2),e])}</b>`),placement:"top",html:!0})}else h=f*(r+n+o+a*d)+l*Math.ceil(d-1),this.element.find(`.row-value[data-key="${i}-auto-reload"]`).text(translateUI("time_seconds",[MathHelper.toFixedFloat((r+n+o)/30,2)])).tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("dmginfo_reload_time_tooltip",[p,g,m])),placement:"top",html:!0});this.element.find(`.row-value[data-key="${i}-auto-dps"]`).text(parseFloat(((S+$)/2*d*f/(h/30)).toFixed(2)).toLocaleString())}}else if(s.Type.startsWith("Heal")){const t=e.calculateHealing(s.Scale[this.skillLevel-1]/1e4),a=e.calculateHealing(s.Scale[this.skillLevel-1]/1e4,e.getTotal("HealEffectivenessRate")),l="HealDot"==s.Type?" / "+translateUI("time_seconds",[s.Period/1e3]):"";let n=`${parseFloat((s.Scale[this.skillLevel-1]/100).toFixed(2)).toLocaleString()}%`;"HealZone"==s.Type&&(n+=` &times; ${s.HitFrames.length}`),this.element.find(`.row-value[data-key="${i}-scaling"]`).html(n),this.element.find(`.row-value[data-key="${i}-heal-total"]`).html(`<span class="text-heal">${t.toLocaleString()+(a>t?` (<img src="images/buff/Buff_HealEffectiveness.webp" style="height: 22px;">${a.toLocaleString()})`:"")}</span>`+l)}else if("Shield"==s.Type){const t=e.calculateHealing(s.Scale[this.skillLevel-1]/1e4);this.element.find(`.row-value[data-key="${i}-scaling"]`).text(`${parseFloat((s.Scale[this.skillLevel-1]/100).toFixed(2)).toLocaleString()}%`),this.element.find(`.row-value[data-key="${i}-heal-total"]`).text(t.toLocaleString())}else if(s.Type.startsWith("CrowdControl")){const a=parseFloat((s.Scale[this.skillLevel-1]/1e3).toFixed(2)),l=parseFloat((s.Scale[this.skillLevel-1]*((100+e.getTotal("OppressionPower")-t.getTotal("OppressionResist"))/100)/1e3).toFixed(2)),n=Math.min(Math.max(parseFloat((s.Chance*(1+e.getTotal("OppressionPower")/100-t.getTotal("OppressionResist")/100)/100).toFixed(2)),0),100);this.element.find(`.row-value[data-key="${i}-cc-chance"]`).text(`${n}%`);let r=translateUI("time_seconds",[a]);this.skill.IsRaidSkill||(r+=` (${translateUI("time_seconds",[l])})`),this.element.find(`.row-value[data-key="${i}-cc-duration"]`).text(r)}else if(s.Type.startsWith("Accumulation")){const l=e.calculateAccumulateDamageLimit(t,s.Scale[this.skillLevel-1],"AttackPower",a);this.element.find(`.row-value[data-key="${i}-accumulation-scaling"]`).text(`${MathHelper.toFixedFloat(s.Scale[this.skillLevel-1]/100,2).toLocaleString()}%`),this.element.find(`.row-value[data-key="${i}-accumulation-limit"]`).text(`${parseInt(l).toLocaleString()}`)}})}changeSkillLevel(e){this.skillLevel=parseInt(e),"ex"==this.skill.SkillType&&this.element.find(".skill-cost").text(this.skill.Cost[this.skillLevel-1]),this.element.find(".ba-slider-label.skill-level").html(this.skillLevel==this.maxLevel?'<img src="images/ui/ImageFont_Max.png">':`Lv.${this.skillLevel}`),this.element.find(".skill-description").html(getSkillText(this.skill,this.skillLevel,{renderBuffs:!1,renderSkillHits:!1,bulletType:this.character.BulletType})),this.update(statPreviewCharacterStats,statPreviewSelectedEnemyStats,statPreviewTerrain)}changeOptionValue(e,t){const a=this.skill.Effects[t].ExtraDamageSource;this.optionValue=e;const s=MathHelper.toFixedFloat(a.SliderLabel[0]+(a.SliderLabel[1]-a.SliderLabel[0])*e,2);this.element.find(".skill-option-label").text(s+a.SliderLabelSuffix),this.update(statPreviewCharacterStats,statPreviewSelectedEnemyStats,statPreviewTerrain)}toggleStackCount(e){if(void 0!==e?this.stackCount=e:++this.stackCount>this.stackMax&&(this.stackCount=1),void 0!==this.skill.EffectCombineLabel){let e="",t=`&times;${this.stackCount}`;if(void 0!==this.skill.EffectCombineLabel.Icon){const t=this.skill.EffectCombineLabel.Icon[Math.min(this.skill.EffectCombineLabel.Icon.length-1,this.stackCount-1)];e=`<img class="stack-icon ${t.startsWith("skill")?"invert-light":""}" src="images/${t}">`}void 0!==this.skill.EffectCombineLabel.StackLabelTranslated?t=translateUI(this.skill.EffectCombineLabel.StackLabelTranslated[this.stackCount-1]):void 0!==this.skill.EffectCombineLabel.StackLabel?t=this.skill.EffectCombineLabel.StackLabel[this.stackCount-1]:void 0!==this.skill.EffectCombineLabel.StackStartAt&&(t=`&times;${this.skill.EffectCombineLabel.StackStartAt+this.stackCount-1}`),this.skill.EffectCombineLabel.DisableFirst&&this.element.find(".ba-slider-label.stack-toggle").toggleClass("deactivated",1==this.stackCount),this.element.find(".ba-slider-label.stack-toggle").html(e+`<span class="label ${""==e?"":"ps-1"}">${t}</span>`)}else this.element.find(".ba-slider-label.stack-toggle .label").html(`&times;${this.stackCount}`);this.skill.Effects.forEach((e,t)=>{if(this.stackTypes.includes(e.Type)){let a=e.Type+(void 0!==e.CombineGroup?`_${e.CombineGroup}`:"");if(this.stackEffectIndex[a][this.stackCount-1]!=t)return void this.element.find(`div[data-effect-index="${t}"]`).hide();this.element.find(`div[data-effect-index="${t}"]`).show()}})}render(){this.rows=[];let e="",t="",a=this.skill.Id?this.skill.Id:`${this.character.DevName}${this.skill.SkillType}`,s,i;!this.skill.IsRaidSkill||this.skill.Icon.startsWith("COMMON_")?(s=`images/skill/${this.skill.Icon}.webp`,i=`bg-atk-${this.character.BulletType.toLowerCase()}`):(s=`images/raid/skill/${this.skill.Icon}.png`,i=""),e+=`\n        <div class="p-2 ba-panel mb-2 skill-info-${this.skill.SkillType}${this.tsa?" skill-info-tsa":""}" data-skill-key="${a}">\n        <div class="d-flex flex-column">\n            <div class="d-flex flex-row align-items-start mb-1 gap-3">\n                <div class="skill-icon ${i} small ${"gearnormal"==this.skill.SkillType?"plus":""}">\n                    <img src="${s}">\n                </div>\n                <div class="flex-fill">\n                    <h5 class="mb-0 me-2">${this.skill.Name}</h5>`,"ex"==this.skill.SkillType?e+=`<small class="text-italic">${translateUI("student_skill_ex")}・ COST: <span class="skill-cost text-bold">${this.skill.Cost[this.skillLevel-1]}</span></small>`:"autoattack"==this.skill.SkillType||this.skill.IsRaidSkill||(e+=`<small class="text-italic">${translateUI(`student_skill_${this.skill.SkillType.toLowerCase()}`)}</small>`),this.skill.IsRaidSkill?e+=`<p class="mb-0 mt-1 skill-description" style="font-size: 0.875rem; line-height: 1rem;">${getSkillText(this.skill,this.skill.RaidDifficulty+1,{renderBuffs:!1,renderSkillHits:!1,bulletType:null})}</p>`:e+=`<p class="mb-0 mt-1 skill-description" style="font-size: 0.875rem; line-height: 1rem;">${getSkillText(this.skill,this.skillLevel,{renderBuffs:!1,renderSkillHits:!1,bulletType:this.character.BulletType})}</p>`,e+='\n                </div>\n            </div>\n            <div class="skill-calculation mb-2">',this.skill.Effects.forEach((a,s)=>{if(void 0===a.RestrictTo||a.RestrictTo.includes(this.character.Id)){if(e+=`<div data-effect-index="${s}">`,a.Type.startsWith("DMG")||"FormChange"==a.Type){e+=this.addSeparator();const i="FormChange"!=a.Type||a.HideFormChangeIcon?"":getBuffTag("Special","FormChange",{tooltip:!1,overrideName:getLocalizedString("BuffNameLong","Special_FormChange")})+" ";if("DMGDot"!=a.Type&&"DMGByHit"!=a.Type){const t=void 0!==a.SourceStat?a.SourceStat:"AttackPower";e+=this.addStaticRow(s,`${i} ${getLocalizedString("Stat",t)} %`,"","scaling"),"IgnoreDef"in a&&(e+=this.addDynamicRow(s,translateUI("dmginfo_ignore_def"),e=>`${(1e4-e.IgnoreDef[this.skillLevel-1])/100}%`,"ignore-def")),"DMGMulti"==a.Type||"DMGZone"==a.Type||"FormChange"==a.Type&&a.Hits.length>0?("Always"!=a.CriticalCheck&&(e+=this.addStaticRow(s,translateUI("dmginfo_hit_avg"),"","dmg-range")),"Never"!=a.CriticalCheck&&(e+=this.addStaticRow(s,translateUI("dmginfo_hit_avg")+translateUI("dmginfo_crit"),"","dmg-range-crit","text-crit")),e+=this.addSeparator(),this.skill.IsRaidSkill&&("Never"==a.CriticalCheck?e+=this.addStaticRow(s,translateUI("hit_chance"),"","hitrate"):e+=this.addStaticRow(s,translateUI("hit_crit_chance"),"","hitcritrate")),e+=this.addStaticRow(s,translateUI("dmginfo_total_avg"),"","dmg-final-avg")):("Always"!=a.CriticalCheck&&(e+=this.addStaticRow(s,translateUI("dmginfo_dmg"),"","dmg-range")),"Never"!=a.CriticalCheck&&(e+=this.addStaticRow(s,translateUI("dmginfo_dmg")+translateUI("dmginfo_crit"),"","dmg-range-crit","text-crit")),e+=this.addSeparator(),this.skill.IsRaidSkill&&("Never"==a.CriticalCheck?e+=this.addStaticRow(s,translateUI("hit_chance"),"","hitrate"):e+=this.addStaticRow(s,translateUI("hit_crit_chance"),"","hitcritrate")),e+=this.addStaticRow(s,translateUI("dmginfo_dmg_avg"),"","dmg-final-avg"))}else{const t=getBuffTag("Debuff",a.Icon,{tooltip:!1});e+=this.addStaticRow(s,`${t} ${getLocalizedString("Stat","AttackPower")} %`,"","scaling"),e+=this.addStaticRow(s,`${t} ${translateUI("dmginfo_dmg")}`,"","dmg-range")}if(("autoattack"==this.skill.SkillType&&0!=this.skill.Effects[0].Frames.AttackIngDuration||"FormChange"==a.Type)&&(e+=this.addSeparator(),e+=this.addStaticRow(s,i+translateUI("dmginfo_rate_of_fire"),"","auto-duration","has-tooltip"),e+=this.addStaticRow(s,i+translateUI("dmginfo_reload_time"),"","auto-reload","has-tooltip"),e+=this.addStaticRow(s,i+translateUI("dmginfo_avg_dps"),"","auto-dps")),a.ExtraDamageSource){const e=a.ExtraDamageSource;t+='<div class="d-flex flex-row align-items-center mt-2 gap-2">',t+=`<span class="skill-option-name">${getLocalizedString(e.SliderTranslation.split(",")[0],e.SliderTranslation.split(",")[1])}</span>`,t+=`<input type="range" class="skill-option-range form-range flex-fill" value="1" min="0" max="1" step="${e.SliderStep}" data-effect-id="${s}"><span class="ba-slider-label skill-option-label">${e.SliderLabel[1]+e.SliderLabelSuffix}</span>`,t+="</div>",this.optionValue=1}}else if(a.Type.startsWith("Heal"))if(e+=this.addSeparator(),"HealDot"==a.Type){const t=getBuffTag("Buff","DotHeal",{tooltip:!1});e+=this.addStaticRow(s,`${t} ${getLocalizedString("Stat","HealPower")} %`,"","scaling"),e+=this.addStaticRow(s,`${t} ${translateUI("dmginfo_heal")}`,"","heal-total")}else e+=this.addStaticRow(s,`${getLocalizedString("Stat","HealPower")} %`,"","scaling"),e+=this.addStaticRow(s,translateUI("dmginfo_heal_amount"),"","heal-total","");else if(a.Type.startsWith("Shield")){const t=getBuffTag("Buff","Shield",{tooltip:!1});e+=this.addSeparator(),e+=this.addStaticRow(s,`${t} ${getLocalizedString("Stat","HealPower")} %`,"","scaling"),e+=this.addStaticRow(s,translateUI("dmginfo_shield_amount",[t]),"","heal-total","text-shield")}else if(a.Type.startsWith("CrowdControl")){const t=getBuffTag("CC",a.Icon,{tooltip:!1});e+=this.addSeparator(),e+=this.addStaticRow(s,translateUI("dmginfo_cc_effect_chance",[t]),"","cc-chance");let i=translateUI("dmginfo_cc_effect_duration",[t]);this.skill.IsRaidSkill||(i+=translateUI("dmginfo_cc_effect_gaugefill")),e+=this.addStaticRow(s,i,"","cc-duration")}else if(a.Type.startsWith("Accumulation")){const t=getBuffTag("Special","Accumulation",{tooltip:!1});e+=this.addSeparator(),e+=this.addStaticRow(s,t+` ${getLocalizedString("Stat","AttackPower")} %`,"","accumulation-scaling"),e+=this.addStaticRow(s,translateUI("dmginfo_accumulation_limit",[t]),"","accumulation-limit")}e+="</div>"}}),e+="</div>",(this.maxLevel>1||this.stackMax>1)&&(e+='<div class="d-flex flex-row align-items-center gap-2">',this.stackMax>1&&(e+=`<span class="ba-slider-label stack-toggle ${this.skill.EffectCombineLabel&&this.skill.EffectCombineLabel.Icon?"wide":""}"><span class="label">&times;${this.stackCount}</span></span>`),this.maxLevel>1&&(e+=`<input type="range" class="skill-level-range form-range flex-fill" value="${this.skillLevel}" min="1" max="${this.maxLevel}"><span class="ba-slider-label skill-level"><img src="images/ui/ImageFont_Max.png"></span>`),e+="</div>"),$(this.container).append(e+t),this.element=$(this.container).find(`[data-skill-key="${a}"]`),this.element.find(".skill-level-range").on("input",e=>{this.changeSkillLevel(e.currentTarget.value)}),this.element.find(".stack-toggle").on("click",e=>{this.toggleStackCount()}),""!=t&&this.element.find(".skill-option-range").on("input",e=>{this.changeOptionValue(e.currentTarget.value,e.currentTarget.dataset.effectId)}),this.stackMax>1&&this.toggleStackCount(1)}addDynamicRow(e,t,a,s,i=""){return this.rows.push({effectId:e,key:s,valueFunc:a}),`<div class="d-flex"><span class="row-name">${t}</span><span class="flex-fill"></span><span class="row-value ${i}" data-key="${e+"-"+s}"></span></div>`}addStaticRow(e,t,a,s,i=""){return`<div class="d-flex"><span class="row-name">${t}</span><span class="flex-fill"></span><span class="row-value ${i}" data-key="${e+"-"+s}">${a}</span></div>`}addSeparator(){return'<div class="ba-panel-separator my-2"></div>'}checkSubstitutionCondition(e,t,a){switch(e){case"GearPublic":return statPreviewGearLevel>=2&&void 0!==this.character.Gear.Released&&this.character.Gear.Released[regionID];case"TargetIsStructure":return"Structure"==a.armorType;default:return console.log(`Unknown substitution condition ${effect.SubstituteCondition}`),!1}}}let loadPromise=loadJSON(Object.assign(json_list,json_lang_list,json_server_list),e=>{data=e});function loadModuleFromURL(e){var t=new URL(window.location.href).searchParams;t.get("chara")?loadStudent(t.get("chara")):t.get("charaid")?loadStudentById(t.get("charaid")):t.get("item")?loadItem(t.get("item")):t.get("raid")?loadRaid(t.get("raid")):t.get("stage")?loadStage(t.get("stage")):t.get("craftnode")?loadCraft(t.get("craftnode")):e?loadLastModule():loadModule("home")}function loadLastModule(){localStorage.getItem("module")&&module_list.includes(localStorage.getItem("module"))?loadModule(localStorage.getItem("module")):loadModule("home")}function loadModule(e,t=null){if(loadObserver&&loadObserver.disconnect(),$(".modal").not("#modal-changelog").modal("hide"),clearInterval(eventRefreshInterval),"students"==e)loadedModule="students",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-students").addClass("active"),$("#loaded-module").load(html_list.students,(function(){loadRegion(regionID),loadLanguage(userLang),studentSelectorModal=new bootstrap.Modal(document.getElementById("ba-student-modal-students"),{}),document.getElementById("ba-student-modal-students").addEventListener("hidden.bs.modal",(function(e){selectCompareMode=!1})),generateStatTable("#ba-student-stat-table",studentStatList,6),generateStatTable("#ba-student-stat-modal-table",studentStatListFull,12,1),generateStatTable("#ba-weapon-stat-table",["AttackPower","MaxHP","HealPower"],6),generateStatTable("#calculation-enemy-stat-table",enemyCalculationStatList,6),statPreviewViewSupportStats=!1,compareMode=!1,updateCompareModeControl(),selectCompareMode=!1,$("#ba-statpreview-levelrange").val(statPreviewLevel),changeStatPreviewLevel(document.getElementById("ba-statpreview-levelrange"),!1),$("#ba-statpreview-weapon-range").val(statPreviewWeaponLevel),$("#ba-statpreview-gear1-range").val(statPreviewEquipment[0]),$("#ba-statpreview-gear2-range").val(statPreviewEquipment[1]),$("#ba-statpreview-gear3-range").val(statPreviewEquipment[2]),$("#ba-statpreview-gear4-range").val(statPreviewGearLevel);for(const e in statPreviewPotentialLevel)$(`#ba-statpreview-potential-${e.toLowerCase()}-range`).val(statPreviewPotentialLevel[e]);$("#ba-statpreview-passiveskill-range").val(statPreviewPassiveLevel),$("#ba-statpreview-summon-range").val(statPreviewExLevel),$("#calculation-enemy-level input").val(statPreviewSelectedEnemyLevel),$("#calculation-enemy-level input").on("change",(function(e){const t=parseInt(this.value);statPreviewSelectedEnemyLevel=isNaN(t)?1:MathHelper.clamp(t,parseInt(this.min),parseInt(this.max)),this.value=statPreviewSelectedEnemyLevel,calculateEnemyStats()})).on("click",e=>{e.currentTarget.select()}),$("#calculation-enemy-level").toggleClass("disabled",statPreviewSelectedEnemyLevelFixed),$("#calculation-enemy-floor input").on("change",(function(e){})),$("#skill-calculation-tab-student").on("click",calculateSkills),$("#skill-calculation-tab-enemy").on("click",calculateRaidSkills),$("#ba-skillpreview-exrange").val(skillPreviewExSkillLevel),$("#ba-skillpreview-range").val(skillPreviewOtherSkillLevel),$("#skills-show-upgrades").toggleClass("deactivated",!showSkillUpgrades).on("click",(function(e){showSkillUpgrades=!showSkillUpgrades,$(this).toggleClass("deactivated",!showSkillUpgrades),recalculateSkillPreview()})),$(".extra-skills.collapse").on("show.bs.collapse",(function(){$(`[data-bs-target="#${this.id}"] .fa-angle-down`).toggleClass("fa-rotate-180",!0),skillPreviewShowSummonSkills[this.dataset.type]=!0,localStorage.setItem("student_skill_show_summons",JSON.stringify(skillPreviewShowSummonSkills))})).on("hide.bs.collapse",(function(){$(`[data-bs-target="#${this.id}"] .fa-angle-down`).toggleClass("fa-rotate-180",!1),skillPreviewShowSummonSkills[this.dataset.type]=!1,localStorage.setItem("student_skill_show_summons",JSON.stringify(skillPreviewShowSummonSkills))}));for(const e in skillPreviewShowSummonSkills)$(`#skill-${e}-extra-skills`).toggleClass("show",skillPreviewShowSummonSkills[e]);$("#skill-show-details").on("click",(function(e){$("#student-stat-modal-skill-calc-toggle").toggleClass("deactivated",!1),$("#ba-student-stat-modal-table").hide(),$("#student-stat-modal-skill-calculations").show(),$("#statpreview-tab-calculations").tab("show"),$("#ba-student-modal-statpreview").modal("show")})),$("#ba-statpreview-status-options").on("click",(function(e){$("#student-stat-modal-skill-calc-toggle").toggleClass("deactivated",!0),$("#ba-student-stat-modal-table").show(),$("#student-stat-modal-skill-calculations").hide(),$("#statpreview-tab-attributes").tab("show"),$("#ba-student-modal-statpreview").modal("show")})),$(".btn-max-attributes").on("click",maxStudentAttributes),$(".btn-lock-attributes").on("click",(function(e){student.Id in studentCollection&&(lockedAttributes=!lockedAttributes,$(".btn-lock-attributes").toggleClass("deactivated",!lockedAttributes),$(".btn-lock-attributes i").toggleClass("fa-lock",lockedAttributes).toggleClass("fa-lock-open",!lockedAttributes),studentCollectionSave())})),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0),$(".tooltip").tooltip("hide"),$("#student-voice-btn").on("click",(function(e){data.voice?$("#student-modal-voice").modal("show"):loadJSON({voice:getCacheVerResourceName(`./data/${userLang.toLowerCase()}/voice.min.json`)},e=>{data=Object.assign(data,e)}).then((function(e){$("#student-modal-voice").modal("show")}),(function(e){console.error(e)}))})),$("#student-modal-voice").on("show.bs.modal",(function(e){for(group in $("#student-voicegallery-tab-normal").tab("show"),data.voice[student.Id]){let e="";data.voice[student.Id][group].forEach(t=>{if(t.EventId&&!region.Events.includes(t.EventId))return;if("WeaponGetIdle1"==t.Group&&0==region.WeaponMaxLevel)return;const a=t.Group.match(/([0-9])$/),s=a&&a.length?a[1]:1,i=t.Group.replace(/[0-9]$/,"");e+=`<div class="d-flex flex-row align-items-center gap-2"><h6 class="m-0">${getLocalizedString("VoiceClip",i,[s])}</h6><div class="flex-fill"></div><audio preload="none" controls><source src="${staticAssetURL}/voice/${t.AudioClip}" type="audio/mpeg"></audio></div>`,t.Transcription&&(e+=`<div class="ba-panel p-2"><p class="m-0">${t.Transcription}</p></div>`)}),$(`#student-voicegallery-list-${group.toLowerCase()}`).html(e),$(`#student-voicegallery-tab-${group.toLowerCase()}`).toggleClass("disabled",""==e),$(`#student-voicegallery-list-${group.toLowerCase()} audio`).prop("volume",voiceClipVolume),$("#student-voice-icon img").attr("src",`images/student/icon/${student.Id}.webp`),$("#student-voice-name").text(getTranslatedString(student,"Name")),$("#student-voice-cv").text(getTranslatedString(student,"CharacterVoice"))}})),$("#btn-midokuni-link").on("click",()=>{window.open(`https://hina.loves.midokuni.com/StudentInsights/${student.Id}`,"_blank"),$("#btn-midokuni-link").blur()}),statPreviewExternalBuffs=new ExternalBuffs({controls:$("#statpreview-buff-transferable-controls")[0],searchBox:$("#statpreview-buff-transferable-search-text")[0],searchButton:$("#statpreview-buff-transferable-search-btn")[0],autoAddButton:$("#statpreview-buff-transferable-autoadd-btn")[0],searchResults:$("#statpreview-buff-transferable-search .search-list-container")[0]},(e,t)=>student.Id==e&&t.Effects.some(e=>"BuffSelf"==e.Type)||t.Effects.some(e=>"BuffAlly"==e.Type),recalculateStats,["BuffSelf","BuffAlly"]),statPreviewCustomBuffs=new CustomBuffs($("#statpreview-buff-custom")[0],studentStatListFull,recalculateStats),statPreviewEnemyBuffs=new ExternalBuffs({controls:$("#statpreview-enemy-buff-transferable-controls")[0],searchBox:$("#statpreview-enemy-buff-transferable-search-text")[0],searchButton:$("#statpreview-enemy-buff-transferable-search-btn")[0],autoAddButton:$("#statpreview-enemy-buff-transferable-autoadd-btn")[0],searchResults:$("#statpreview-enemy-buff-transferable-search .search-list-container")[0]},(e,t)=>t.Effects.some(e=>"BuffTarget"==e.Type),calculateEnemyStats,["BuffTarget"]),statPreviewEnemyCustomBuffs=new CustomBuffs($("#statpreview-enemy-buff-custom")[0],enemyCalculationStatList,calculateEnemyStats),statPreviewSupportStats=new SupportStats({controls:$("#statpreview-supportstats-controls")[0],searchBox:$("#statpreview-supportstats-search-text")[0],searchButton:$("#statpreview-supportstats-search-btn")[0],searchResults:$("#statpreview-supportstats-search-list")[0]}),statPreviewTSAStats=new TSAStats({controls:$("#statpreview-tsastats-controls")[0]}),statPreviewEnemyFinder=new EnemyFinder({controls:$("#statpreview-enemysearch-controls")[0],searchBox:$("#statpreview-enemysearch-search-text")[0],searchButton:$("#statpreview-enemysearch-search-btn")[0],searchResults:$("#statpreview-enemysearch-search-list")[0]});var e=new URL(window.location.href).searchParams;null!=t?loadStudent(t):e.has("chara")?loadStudent(e.get("chara")):e.has("charaid")?loadStudentById(e.get("charaid")):localStorage.getItem("chara")?loadStudent(localStorage.getItem("chara")):loadStudent("Aru"),populateStudentList(),localStorage.getItem("chara_groupby")?searchOptionSet("groupby",localStorage.getItem("chara_groupby"),!1):searchOptionSet("groupby","none",!1),localStorage.getItem("chara_sortby_dir")&&(search_options.sortby_dir=parseInt(localStorage.getItem("chara_sortby_dir"))),localStorage.getItem("chara_sortby")?searchSetOrder(localStorage.getItem("chara_sortby"),!1,!1):searchSetOrder("Default",!1,!1),localStorage.getItem("chara_sortby_collectionstats")&&(sortByCollectionStats="true"==localStorage.getItem("chara_sortby_collectionstats")),$("#ba-student-search-sortby-usecollectionstats .item-toggle-icon").html(`<i class="fa-solid fa-toggle-${sortByCollectionStats?"on":"off"}"></i>`),localStorage.getItem("show_student_list_info")&&(showStudentListInfo="true"==localStorage.getItem("show_student_list_info")),Object.entries(search_options.filter).forEach(e=>{"boolean"==typeof e[1]?$(`#ba-student-search-filter-${e[0].toLowerCase()}`).toggleClass("active",e[1]):Object.entries(e[1]).forEach(t=>{$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",t[1])})}),activeFilters=getNumActiveFilters(),passiveStatList.forEach(e=>{const t=`Buff_${e in buffIconKeys?buffIconKeys[e]:e}`,a=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-filter-select-prop="PassiveBuff" data-filter-select-value="${e}" class="btn btn-dark"><div class="icon"><img src="images/buff/${t}.webp"></div><span>${getLocalizedString("BuffName",t)}</span></a></li>`;$("#ba-student-search-select-passivebuff-list").append(a)}),weaponPassiveStatList.forEach(e=>{const t=`Buff_${e in buffIconKeys?buffIconKeys[e]:e}`,a=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-filter-select-prop="WeaponPassiveBuff" data-filter-select-value="${e}" class="btn btn-dark"><div class="icon"><img src="images/buff/${t}.webp"></div><span>${getLocalizedString("BuffName",t)}</span></a></li>`;$("#ba-student-search-select-weaponpassivebuff-list").append(a)}),subStatList.forEach(e=>{const t=`Buff_${e in buffIconKeys?buffIconKeys[e]:e}`,a=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-filter-select-prop="SubBuff" data-filter-select-value="${e}" class="btn btn-dark"><div class="icon"><img src="images/buff/${t}.webp"></div><span>${getLocalizedString("BuffName",t)}</span></a></li>`;$("#ba-student-search-select-subbuff-list").append(a)}),studentBuffStatFilters.forEach(e=>{const t=`<li><a class="dropdown-item" href="javascript:;" data-filter-select-value="${e}">${getLocalizedString("Stat",e)}</a></li>`;$("#statpreview-buff-transferable-search ul.dropdown-menu").append(t)}),enemyBuffStatFilters.forEach(e=>{const t=`<li><a class="dropdown-item" href="javascript:;" data-filter-select-value="${e}">${getLocalizedString("Stat",e)}</a></li>`;$("#statpreview-enemy-buff-transferable-search ul.dropdown-menu").append(t)}),data.items.filter(e=>e.Id>=100&&e.Id<1e3&&"SSR"==e.Rarity&&e.IsReleased[regionID]).forEach(e=>{const t=Math.floor(e.Id/10),a=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-filter-select-prop="UsesArtifact" data-filter-select-value="${t}" class="btn btn-dark"><div class="icon"><img src="images/item/icon/${e.Icon}.webp"></div><span>${getLocalizedString("ArtifactClass",t)}</span></a></li>`;$("#ba-student-search-select-usesartifact-list").append(a)}),$("a[data-filter-select-prop]").on("click",(function(e){const t=$(this).data("filter-select-prop"),a=$(this).data("filter-select-value");searchSetFilterSelect(t,a)})),$("#ba-student-search-filter-amount").text(0==activeFilters?"":` (${activeFilters})`),$("#ba-student-search-reset").toggle(activeFilters>0||""!=$("#ba-student-search-text").val()),$("#ba-student-search-filters-panel").on("show.bs.collapse",(function(){$("#student-search-filters-btn").toggleClass("active",!0)})).on("hide.bs.collapse",(function(){$("#student-search-filters-btn").toggleClass("active",!1)})),$(".summon-list").on("click",".dropdown-item",(function(){changeStudentSummon($(this).data("summon-id"))})),$(".terrain-list").on("click",".dropdown-item",(function(){changeSkillPreviewTerrain($(this).data("terrain"))})),updateStudentList(updateSortMethod=!0),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),$("#ba-student, #ba-student-list-btn").show(),$("#ba-student-list-btn").on("click",(function(){(search_options.sortby.startsWith("Collection")||isAttributeSort(search_options.sortby))&&(studentStatsList=null,updateStudentList(updateSortMethod=!0)),$(".card-student.disabled").removeClass("disabled"),$("#ba-student-modal-students").modal("show")})),$("#ba-statpreview-status-equipment").tooltip({title:getBasicTooltip(translateUI("tooltip_equipment_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-buffs").tooltip({title:getBasicTooltip(translateUI("tooltip_buffs_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-passive-level").tooltip({title:getBasicTooltip(translateUI("tooltip_passiveskill_bonus")),placement:"top",html:!0}),$("#ba-statpreview-status-strikerbonus").tooltip({title:getBasicTooltip(translateUI("tooltip_supportstats")),placement:"top",html:!0}),$("#ba-student-modal-students").on("shown.bs.modal",(function(e){"shortcut"===e.relatedTarget&&$("#ba-student-search-text").trigger("focus")})),$("#ba-student-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(updateStudentList,100)})),$("#ba-student-toggle-sprite-btn").on("click",e=>{showAltSprite=!showAltSprite,$("#ba-student-img").attr("src",`images/student/portrait/${student.Id}${showAltSprite?"_2":""}.webp`)}),$("#ba-student-search-showinfo").tooltip({title:getBasicTooltip(translateUI("student_search_info")),html:!0,placement:"top"}),$("#ba-student-search-showinfo").toggleClass("active",showStudentListInfo),$("#ba-student-search-showinfo").on("click",(function(){showStudentListInfo=!showStudentListInfo,localStorage.setItem("show_student_list_info",showStudentListInfo),$(this).toggleClass("active",showStudentListInfo).tooltip("hide"),$("#student-select-grid").toggleClass("show-info",showStudentListInfo)})),$("#student-select-grid").toggleClass("show-info",showStudentListInfo),$("#student-stat-modal-skill-calc-toggle").on("click",(function(){const e=$(this).hasClass("deactivated");$(this).toggleClass("deactivated",!e),$("#ba-student-stat-modal-table").toggle(!e),$("#student-stat-modal-skill-calculations").toggle(e),e?(calculateSkills(),calculateRaidSkills()):recalculateStats()})),$("#ba-student-modal-statpreview").on("shown.bs.modal hidden.bs.modal",recalculateStats),window.scrollTo({top:0,left:0,behavior:"instant"})}));else if("items"==e){var a;loadedModule="items",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-items").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src=`images/background/${pixelMode?"pixel/BG_GameDevRoom.png":"BG_MainOffice_Night.jpg"}`,$("#loaded-module").load(html_list.items,(function(){equipmentFilters=$("#item-search-filter-equipmenttier .search-filter-group");for(let e=1;e<=region.EquipmentMaxLevel[0];e++)equipmentFilters.append(`<button id="item-search-filter-equipmenttier-${e}" class="btn-pill" onclick="searchSetFilterItems('EquipmentTier','${e}')"><span class="label">T${e}</span></button>`);loadRegion(regionID),loadLanguage(userLang),loadedItemList=null,$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;switch(localStorage.getItem("item_sortby_dir")&&(itemSearchOptions.sortby_dir=parseInt(localStorage.getItem("item_sortby_dir"))),localStorage.getItem("item_sortby")?searchSetOrderItems(localStorage.getItem("item_sortby"),!1,!1):searchSetOrderItems("Default",!1,!1),localStorage.getItem("grid_item_display_style")&&(gridItemDisplayStyle=localStorage.getItem("grid_item_display_style")),$("#item-search-displaytype-"+gridItemDisplayStyle).addClass("active"),gridItemDisplayStyle){case"detailed":$("#item-select-grid").addClass("items");break;case"compact":$("#item-select-grid").addClass("items-compact")}$("#item-select-grid").on("click","div[data-itemid]",(function(e){loadItem($(this).data("itemid"))})),$("#ba-item-craftnodes").on("click","div[data-itemid]",(function(e){loadCraft($(this).data("itemid"))})),Object.entries(itemSearchOptions.filter).forEach(e=>{"boolean"==typeof e[1]?$(`#item-search-filter-${e[0].toLowerCase()}`).toggleClass("active",e[1]):Object.entries(e[1]).forEach(t=>{$(`#item-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",t[1])})}),null!=t?loadItem(t):e.has("item")?loadItem(e.get("item")):localStorage.getItem("item")?loadItem(localStorage.getItem("item")):loadItem(1),$("#item-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(updateItemList,100)})),$("#item-search-filters-panel").on("show.bs.collapse",(function(){$("#item-search-filters-btn").toggleClass("active",!0)})).on("hide.bs.collapse",(function(){$("#item-search-filters-btn").toggleClass("active",!1)})),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("raids"==e){loadedModule="raids",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-raids").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src=`images/background/${pixelMode?"pixel/BG_Raid.png":"BG_Raid.jpg"}`,$("#loaded-module").load(html_list.raids,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");let e=new URL(window.location.href).searchParams;generateStatTable("#ba-raid-enemy-stats",raidEnemyStatList,6),generateStatTable("#ba-stage-enemy-stat-table",enemyStatList,6),$("#raid-enemy-list").on("click",".dropdown-item",(function(){changeRaidEnemy($(this).data("enemy-index"))})),$("#ba-raid-season-list").on("click",".dropdown-item",(function(){loadRaidSeasonRewards($(this).data("season"))})),populateRaidList(),null!=t?loadRaid(t):e.has("raid")?loadRaid(e.get("raid")):localStorage.getItem("raid")?loadRaid(localStorage.getItem("raid")):loadRaid(1),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("stages"==e){loadedModule="stages",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-stages").addClass("active");let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src=`images/background/${pixelMode?"pixel/BG_HQ.png":"BG_HQ.jpg"}`,$("#loaded-module").load(html_list.stages,(function(){loadLanguage(userLang),loadedStageList=null,stageMapModal=new bootstrap.Modal(document.getElementById("ba-stage-modal-map"),{}),0==region.WeaponMaxLevel&&$("#ba-stages-list-tab-schooldungeon").hide(),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;localStorage.getItem("show_event_currency_bonus")&&(showEventCurrencyBonus=parseInt(localStorage.getItem("show_event_currency_bonus"))),generateStatTable("#ba-stage-enemy-stat-table",enemyStatList,6),$("#stage-version-list").on("click",".dropdown-item",(function(e){changeStageVersion($(this).data("version"))})),$("#stage-include-bonus-list").on("click",".dropdown-item",(function(e){showEventCurrencyBonus=parseInt($(this).data("option")),localStorage.setItem("show_event_currency_bonus",showEventCurrencyBonus),loadStage(loadedStage.Id)})),null!=t?loadStage(t):e.has("stage")?loadStage(e.get("stage")):localStorage.getItem("stage")?loadStage(localStorage.getItem("stage")):loadStage(1011101),makeDraggable($("#ba-stage-map")),makeDraggable($("#ba-conquest-map")),makeDraggable($("#ba-stage-modal-map-container")),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else if("craft"==e){var a;loadedModule="craft",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-craft").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src=`images/background/${pixelMode?"pixel/BG_CraftChamber_Night.png":"BG_CraftChamber_Night.jpg"}`,$("#loaded-module").load(html_list.craft,(function(){loadLanguage(userLang),$(".tooltip").tooltip("hide");var e=new URL(window.location.href).searchParams;localStorage.getItem("show_node_probability")&&(showNodeProbability="true"==localStorage.getItem("show_node_probability")),null!=t?loadCraft(t):e.has("craftnode")?loadCraft(e.get("craftnode")):localStorage.getItem("craftnode")?loadCraft(localStorage.getItem("craftnode")):loadCraft(1),populateCraftList(),loadedCraftId>=1e5?$("#ba-item-list-tab-fusion").tab("show"):$("#ba-item-list-tab-synthesis").tab("show"),$("#fusion-select-grid").on("click","div[data-itemid]",(function(e){loadCraft($(this).data("itemid"))})),$("#craft-toggle-chance").toggleClass("active",showNodeProbability),$("#craft-toggle-chance").on("click",(function(){showNodeProbability=!showNodeProbability,localStorage.setItem("show_node_probability",showNodeProbability),$(this).toggleClass("active",showNodeProbability),$("#craft-select-grid .stage-droprate").toggleClass("hidden",!showNodeProbability)})),$("#craft-select-grid .stage-droprate").toggleClass("hidden",!showNodeProbability),$("#craft-search-text").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(populateCraftList,100)})),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50),window.scrollTo({top:0,left:0,behavior:"instant"})}))}else{var a;loadedModule="home",$(".navbar-nav .nav-link").removeClass("active"),$("#ba-navbar-link-home").addClass("active"),(a=new Image).onload=function(){$("#ba-background").css("background-image",`url('${a.src}')`)},a.src=`images/background/${pixelMode?"pixel/BG_GameDevRoom.png":"BG_ReceptionRoom.jpg"}`,$("#loaded-module").load(html_list.home,(function(){if(loadLanguage(userLang),loadRegion(regionID),populateEvents(),pixelMode)switch(Math.floor(3*Math.random())){case 0:$("#home-character-img").attr("src","images/ui/aris_pixel.png");break;case 1:$("#home-character-img").attr("src","images/ui/momoi_pixel.png");break;case 2:$("#home-character-img").attr("src","images/ui/midori_pixel.png")}eventRefreshInterval=window.setInterval(updateEventTimers,6e4),$("#ba-home-server-info").text(translateUI("current_events",[getLocalizedString("ServerName",regionID)])),window.setTimeout((function(){$("#loading-cover").fadeOut()}),50);let e=new URL(window.location.href);""!=e.searchParams.toString()&&(e.searchParams.forEach((t,a)=>e.searchParams.delete(a)),history.pushState(null,"",e)),$("title").html(`${translateUI("navbar_home")} | Schale DB`),$("#ba-navbar-content").collapse("hide"),window.scrollTo({top:0,left:0,behavior:"instant"})}))}localStorage.setItem("module",loadedModule)}function populateEvents(){let e=translateUI("gacha_pickup")+"\n",t="",a=(new Date).getTime()/1e3,s={month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",timeZoneName:"short"},i=!1;$("#events-row-1").hide(),$.each(region.CurrentGacha,(function(l,n){if((a>=n.start&&a<n.end||a<=n.start)&&!i){for(let e=0;e<n.characters.length;e++){var r=find(data.students,"Id",n.characters[e])[0];t+=getStudentListCardHTML(r)}$("#events-row-1").show(),e+=new Date(1e3*n.start).toLocaleString([],s)+" - "+new Date(1e3*n.end).toLocaleString([],s),e+=`\n<span id="ba-home-gacha-timer" class="home-timer" data-start="${n.start}" data-end="${n.end}"></span>`,i=!0}})),$("#ba-home-gacha-text").html(e),$("#ba-home-gacha-list").html(t);let l="",n="";$("#events-row-2").hide(),$("#ba-home-raid").hide(),i=!1;let r=!1;$.each(region.CurrentRaid,(function(e,t){if((a>=t.start&&a<t.end||a<=t.start)&&!i){if(t.raid>=1e3){l=getLocalizedString("StageType","TimeAttack")+"\n";let e=find(data.raids.TimeAttack,"Id",t.raid)[0];n+=getTimeAttackCardHTML(e,e.Terrain)}else{l=getLocalizedString("StageType",t.type)+"\n";let e=find(data.raids.Raid,"Id",t.raid)[0];const a=find(data.raids.RaidSeasons[regionID][`${"EliminateRaid"==t.type?"Eliminate":""}Seasons`],"SeasonId",t.season)[0];n+=getRaidCardHTML(e,a)}$("#events-row-2").show(),$("#ba-home-raid").show(),l+=new Date(1e3*t.start).toLocaleString([],s)+" - "+new Date(1e3*t.end).toLocaleString([],s),l+=`\n<span id="ba-home-raid-timer" class="home-timer" data-start="${t.start}" data-end="${t.end}"></span>`,i=!0,r=!0}})),$("#ba-home-raid-text").html(l),$("#ba-home-raid-list").html(n);let o="",d="";$("#ba-home-event").hide(),i=!1,$.each(region.CurrentEvents,(function(e,t){(a>=t.start&&a<t.end||a<=t.start)&&!i&&(o=getLocalizedString("StageType","Event")+"\n",d+=getEventCardHTML(t.event),$("#events-row-2").show(),$("#ba-home-event").show(),o+=new Date(1e3*t.start).toLocaleString([],s)+" - "+new Date(1e3*t.end).toLocaleString([],s),o+=`\n<span id="ba-home-event-timer" class="home-timer" data-start="${t.start}" data-end="${t.end}"></span>`,i=!0,$("#ba-home-event").toggleClass("col-md-12",!r))})),$("#ba-home-event-text").html(o),$("#ba-home-event-list").html(d);var c="",u=new Date;u.setHours(0,0,0,0);var g=new Date;if(g.setHours(0,0,0,0),g.setDate(u.getDate()+7),birthdayStudents=[],data.students.forEach(e=>{if(e.IsReleased[regionID]&&!e.Name.includes("（")&&!e.Name.includes("(")){var t=getNextBirthdayDate(e.BirthDay);t.getTime()<g.getTime()&&t.getTime()>=u.getTime()&&birthdayStudents.push(e)}}),birthdayStudents.length>0){birthdayStudents.sort((e,t)=>getNextBirthdayDate(e.BirthDay).getTime()-getNextBirthdayDate(t.BirthDay).getTime());for(let e=0;e<birthdayStudents.length;e++)c+='<div class="d-flex flex-column mx-1 mb-1">'+getStudentIconSmall(birthdayStudents[e])+'<div class="ba-panel mt-1 mx-1 p-1 text-center">'+getNextBirthdayDate(birthdayStudents[e].BirthDay).toLocaleDateString([],{month:"numeric",day:"numeric"})+"</div></div>";$("#ba-home-birthdays-list").html(c)}else $("#ba-home-birthdays").hide();$(".ba-item-student").tooltip({html:!0}),updateEventTimers()}function updateEventTimers(){const e=(new Date).getTime()/1e3;$(".home-timer").each((function(t){const a=$(this).data("start"),s=$(this).data("end");$(this).html(e>=a?translateUI("event_ends",duration(s-e)):translateUI("event_starts",duration(a-e)))}))}function finalizeLoad(e,t,a,s=null,i=null){var l=new URL(window.location.href);l.searchParams.get(t)!=a&&(l.searchParams.forEach((e,t)=>l.searchParams.delete(t)),l.searchParams.set(t,a),history.pushState(null,"",l)),$("title").html(`${e} | Schale DB`),$("#ba-navbar-content").collapse("hide"),localStorage.setItem(t,a),s&&window.setTimeout((function(){gtag("event",s,{event_label:i,user_language:userLang})}),500)}function getNextBirthdayDate(e){var t=new Date;t.setHours(0,0,0,0);var a=new Date;return a.setHours(0,0,0,0),a.setMonth(parseInt(e.split("/")[0])-1,parseInt(e.split("/")[1])),a.setFullYear(a.getMonth()<t.getMonth()?t.getFullYear()+1:t.getFullYear()),a}function convertToDate(e){const[t,a]=e.split("/");return isNaN(t)||isNaN(a)?null:new Date(0,t-1,a)}function duration(e){if(e<0)return[0,0,0];let t=e,a=Math.floor(t/86400);t-=86400*a;let s=Math.floor(t/3600),i;return t-=3600*s,[a,s,Math.floor(t/60)]}function durationStringShort(e){if(e<0)return"";let t=e,a=Math.floor(t/86400);if(a>0)return translateUI("duration_days",[a]);t-=86400*a;let s=Math.floor(t/3600),i;return s>0?translateUI("duration_hours",[s]):(t-=3600*s,translateUI("duration_minutes",[Math.floor(t/60)]))}function setSortedDataLists(){data.students.sort((e,t)=>getTranslatedString(e,"Name").localeCompare(getTranslatedString(t,"Name"))),studentList=data.students.map(e=>e),itemList=data.items.map(e=>e),furnitureList=data.furniture.map(e=>e),equipmentList=data.equipment.map(e=>e)}function populateStudentList(){let e="";data.students.forEach(t=>{t.IsReleased[regionID]&&(e+=getStudentListCardHTML(t))}),e+=`<div id="student-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`,$("#student-select-grid").html(e)}function updateStudentList(e=!1){let t=$("#ba-student-search-text").val(),a=sort_functions[search_options.sortby];const s=buildFilterList(search_options.filter),i=[];for(prop in search_options.filterSelect)search_options.filterSelect[prop].length>0&&i.push(prop);e&&(studentList.sort(sort_functions.Default),"Default"!=sort_functions[search_options.sortby]&&(isAttributeSort(search_options.sortby)?(null==studentStatsList&&(studentStatsList={},studentList.forEach(e=>{if(sortByCollectionStats&&!(e.Id in studentCollection))return void(studentStatsList[e.Id]=null);const t=sortByCollectionStats?studentCollection[e.Id].l:region.StudentMaxLevel,a=sortByCollectionStats?studentCollection[e.Id].s:5,s=sortByCollectionStats?[studentCollection[e.Id].e1,studentCollection[e.Id].e2,studentCollection[e.Id].e3]:region.EquipmentMaxLevel,i=sortByCollectionStats?studentCollection[e.Id].wl:region.WeaponMaxLevel,l=sortByCollectionStats?studentCollection[e.Id].b:region.BondMaxLevel,n=1,r=new CharacterStats(e,t,a),o=getBondStats(e,l);for(let e in o)r.addBuff(e,o[e]);for(let t of e.FavorAlts){if(sortByCollectionStats&&!(t in studentCollection))continue;const e=find(data.students,"Id",t)[0];if(!e.IsReleased[regionID])continue;const a=sortByCollectionStats?studentCollection[t].b:region.BondMaxLevel,s=getBondStats(e,a);for(let e in s)r.addBuff(e,s[e])}r.addEquipmentBonuses(e.Equipment[0],s[0]),r.addEquipmentBonuses(e.Equipment[1],s[1]),r.addEquipmentBonuses(e.Equipment[2],s[2]),"Released"in e.Gear&&e.Gear.Released[regionID]&&r.addGearBonuses(e.Gear,1),i>0&&r.addWeaponBonuses(e.Weapon,i),studentStatsList[e.Id]=r})),studentList.sort((function(e,t){const a=search_options.sortby.replace("100",""),s=null!=studentStatsList[e.Id]?studentStatsList[e.Id].getTotal(a):0,i=null!=studentStatsList[t.Id]?studentStatsList[t.Id].getTotal(a):0;return(i-s)*search_options.sortby_dir}))):studentList.sort(a)));let l=0;$.each(studentList,(function(a,n){if(n.IsReleased[regionID]){if(e)if($("#student-select-"+n.Id).css("order",a),"Default"==search_options.sortby||"Name"==search_options.sortby){let e=getTranslatedString(n,"Name");$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",getTranslatedString(n,"Name").length>label_smalltext_threshold[userLang]).toggleClass("unhover",!1),$("#student-select-"+n.Id+" .label-text.hover").hide()}else if("EXCost"==search_options.sortby){const e=find(n.Skills,"SkillType","ex")[0].Cost;e[0]==e[4]?$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e[0]).toggleClass("smalltext",!1).toggleClass("unhover",!0):$("#student-select-"+n.Id+" .label-text:not(.hover)").text(`${e[0]} → ${e[4]}`).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("EXHits"==search_options.sortby){const e=getSkillHits(find(n.Skills,"SkillType","ex")[0]);$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("NormalHits"==search_options.sortby){const e=getSkillHits(find(n.Skills,"SkillType","autoattack")[0]);$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("PublicHits"==search_options.sortby){let e=getSkillHits(find(n.Skills,"SkillType","normal")[0]);if("Released"in n.Gear&&n.Gear.Released[regionID]){const t=getSkillHits(find(n.Skills,"SkillType","gearnormal")[0]);t>e&&(e+=" → "+t)}$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if(search_options.sortby.endsWith("BattleAdaptation")){const e=search_options.sortby.replace("BattleAdaptation","");let t,a=n[search_options.sortby];t=n.Weapon.AdaptationType===e?`${adaptationAmount[a]} → ${adaptationAmount[a+n.Weapon.AdaptationValue]}`:adaptationAmount[a],$("#student-select-"+n.Id+" .label-text:not(.hover)").html(t).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("CharacterAge"==search_options.sortby){const e=MathHelper.extractNumber(n[search_options.sortby]);$("#student-select-"+n.Id+" .label-text:not(.hover)").text(0==e?"??":e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("BirthDay"==search_options.sortby){const e=convertToDate(n.BirthDay);$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e?e.toLocaleDateString([],{month:"numeric",day:"numeric"}):"-").toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("CollectionStars"==search_options.sortby){const e=n.Id in studentCollection?studentCollection[n.Id].s:0,t=n.Id in studentCollection?studentCollection[n.Id].ws:0;let a;e>0?(a=`<i class="fa fa-star col-star"></i> ${e}`,t>0&&(a+=` <i class="fa fa-star col-weaponstar"></i> ${t}`)):a=translateUI("collection_notowned"),$("#student-select-"+n.Id+" .label-text:not(.hover)").html(a).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("CollectionLevel"==search_options.sortby){const e=n.Id in studentCollection?studentCollection[n.Id].l:0;let t;t=e>0?`Lv. ${e}`:translateUI("collection_notowned"),$("#student-select-"+n.Id+" .label-text:not(.hover)").html(t).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("CollectionBond"==search_options.sortby){const e=n.Id in studentCollection?studentCollection[n.Id].b:0;let t;t=e>0?`<i class="fa fa-heart"></i> ${e}`:translateUI("collection_notowned"),$("#student-select-"+n.Id+" .label-text:not(.hover)").html(t).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("Club"==search_options.sortby||"School"==search_options.sortby){const e=getLocalizedString(search_options.sortby,n[search_options.sortby]);$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",e.length>label_smalltext_threshold[userLang]).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if("MemoryLobby"==search_options.sortby)$("#student-select-"+n.Id+" .label-text:not(.hover)").html(`<i class="fa fa-heart"></i> ${n.MemoryLobby[regionID]}`).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show();else if("MemoryLobbyBGM"==search_options.sortby||"Illustrator"==search_options.sortby||"Designer"==search_options.sortby||"CharacterVoice"==search_options.sortby){const e=n[search_options.sortby];$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",e.length>label_smalltext_threshold.Jp).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else if(isAttributeSort(search_options.sortby)){let e;e=null!=studentStatsList[n.Id]?studentStatsList[n.Id].getTotalString(search_options.sortby.replace("100","")):translateUI("collection_notowned"),$("#student-select-"+n.Id+" .label-text:not(.hover)").text(e).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show()}else $("#student-select-"+n.Id+" .label-text:not(.hover)").text(n[search_options.sortby].toLocaleString()).toggleClass("smalltext",!1).toggleClass("unhover",!0),$("#student-select-"+n.Id+" .label-text.hover").show();checkFilters(n,s,i,t)?(l++,$("#student-select-"+n.Id).show()):$("#student-select-"+n.Id).hide()}})),$("#student-select-noresult").toggle(0==l);const n=getNumActiveFilters();$("#ba-student-search-filter-amount").text(0==n?"":` (${n})`),$("#ba-student-search-reset").toggle(n>0||""!=$("#ba-student-search-text").val())}function isAttributeSort(e){switch(e){case"AttackPower100":case"DefensePower100":case"MaxHP100":case"HealPower100":case"CriticalPoint":case"StabilityPoint":case"Range":case"AccuracyPoint":case"DodgePoint":return!0;default:return!1}}function buildFilterList(e){let t=[];return $.each(e,(function(e,a){if("boolean"==typeof a)a&&t.push(e);else{let s=!0,i=!0;$.each(a,(function(e,t){s=s&&!t,i=i&&t})),s||i||t.push(e)}})),t}function updateItemList(e=!1){let t=$("#item-search-text").val(),a=itemSortFunctions[itemSearchOptions.sortby];const s=buildFilterList(itemSearchOptions.filter);let i,l;switch(loadedItemList){case"items":i=itemList,l=0;break;case"furniture":i=furnitureList,l=1e6;break;case"equipment":i=equipmentList,l=2e6}e&&i.sort(a);let n=0;$.each(i,(function(a,i){i.IsReleased[regionID]&&(e&&$(`#item-select-${i.Id+l}`).css("order",a),itemCheckFilters(i,s,t)?(n++,$(`#item-select-${i.Id+l}`).show()):$(`#item-select-${i.Id+l}`).hide())})),$("#item-select-noresult").toggle(0==n)}function checkFilters(e,t,a,s){if(!e.IsReleased[regionID])return!1;for(let a=0;a<t.length;a++)if("TerrainUpgrades"!=t[a])if("Collection"==t[a]){if(!search_options.filter.Collection[e.Id in studentCollection?"Owned":"NotOwned"])return!1}else if(t[a].startsWith("Gear")){const s=parseInt(t[a].replace("Gear",""));if(!search_options.filter[t[a]][e.Equipment[s-1]])return!1}else if("BondGear"==t[a]){if(search_options.filter[t[a]]&&!("Released"in e.Gear&&e.Gear.Released[regionID]))return!1}else if("Cover"==t[a]){if(!search_options.filter.Cover[e.Cover?"Uses":"DoesntUse"])return!1}else if("HasCC"==t[a]){if(search_options.filter[t[a]]&&void 0===getStudentAndSummonSkills(e).find(e=>void 0!==e.Effects&&e.Effects.find(e=>"CrowdControl"==e.Type)))return!1}else if("HasDebuff"==t[a]){if(search_options.filter[t[a]]&&void 0===getStudentAndSummonSkills(e).find(e=>void 0!==e.Effects&&e.Effects.find(e=>"BuffTarget"==e.Type||"DMGDot"==e.Type)))return!1}else if(t[a].endsWith("Adaptation")&&search_options.filter.TerrainUpgrades&&t[a].startsWith(e.Weapon.AdaptationType)){if(!search_options.filter[t[a]][e[t[a]]]&&!search_options.filter[t[a]][e[t[a]]+e.Weapon.AdaptationValue])return!1}else if(!search_options.filter[t[a]][e[t[a]]])return!1;for(let t=0;t<a.length;t++){const s=search_options.filterSelect[a[t]];switch(a[t]){case"PassiveBuff":if(void 0===e.Skills.find(e=>"passive"==e.SkillType&&void 0!==e.Effects.find(e=>s.includes(e.Stat.split("_")[0]))))return!1;break;case"WeaponPassiveBuff":if(void 0===e.Skills.find(e=>"weaponpassive"==e.SkillType&&void 0!==e.Effects.find(e=>s.includes(e.Stat.split("_")[0]))))return!1;break;case"SubBuff":if("Main"==e.SquadType||void 0===e.Skills.find(e=>"sub"==e.SkillType&&void 0!==e.Effects.find(e=>s.includes(e.Stat.split("_")[0]))))return!1;break;case"UsesArtifact":if(void 0===e.SkillExMaterial.find(e=>void 0!==e.find(e=>e<1e3&&s.includes(Math.floor(e/10)))))return!1}}return""==s||getTranslatedString(e,"Name").toLowerCase().includes(s.toLowerCase())}function getStudentAndSummonSkills(e){const t=[...e.Skills];return e.Summons.forEach(e=>{const a=find(data.summons,"Id",e.Id)[0];a.Skills&&t.push(...a.Skills)}),t}function itemCheckFilters(e,t,a){const s=(new Date).getTime()/1e3;if(!e.IsReleased[regionID])return!1;if(e.ImmediateUse&&!itemSearchOptions.filter.ShowImmediateUse)return!1;if(e.ExpiryTime&&e.ExpiryTime[regionID]&&e.ExpiryTime[regionID]<=s&&!itemSearchOptions.filter.ShowExpired)return!1;if(0==t.length);else for(let a=0;a<t.length;a++)switch(t[a]){case"ItemCategory":if("items"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.Category])return!1;break;case"EquipmentCategory":if("equipment"==loadedItemList)if(e.Category.startsWith("WeaponExpGrowth")){if(!itemSearchOptions.filter[t[a]].WeaponExpGrowth)return!1}else if(!itemSearchOptions.filter[t[a]][e.Category])return!1;break;case"FurnitureSubCategory":if("furniture"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.SubCategory])return!1;break;case"FurnitureSet":if("furniture"==loadedItemList&&!itemSearchOptions.filter[t[a]][String(e.SetGroupId)])return!1;break;case"Rarity":if("equipment"!=loadedItemList&&!itemSearchOptions.filter[t[a]][e[t[a]]])return!1;break;case"FurnitureInteraction":if("furniture"==loadedItemList&&!e.Interaction[regionID])return!1;break;case"EquipmentTier":if("equipment"==loadedItemList&&!itemSearchOptions.filter[t[a]][e.Tier])return!1;break;case"Craftable":if(("items"==loadedItemList||"furniture"==loadedItemList)&&!e[t[a]][regionID])return!1;break;case"StageDrop":if("items"==loadedItemList&&!e[t[a]][regionID])return!1;break;case"Shop":if("items"==loadedItemList&&!e.Shops.some(e=>e.Released[regionID]))return!1;break;case"ShowImmediateUse":case"ShowExpired":break;default:if(!itemSearchOptions.filter[t[a]][e[t[a]]])return!1}return""==a||getTranslatedString(e,"Name").toLowerCase().includes(a.toLowerCase())}function searchOptionSet(e,t,a=!0){$(`#ba-student-search-${e} a`).removeClass("active"),$(`#ba-student-search-${e} button`).removeClass("active"),$(`#ba-student-search-${e}-${t}`).addClass("active"),$("#ba-student-search-sortby-stat .label").text(translateUI("stat")+" "),"sortby"==e&&"default"!=t&&"name"!=t&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat .label").text($(`#ba-student-search-sortby-${t}`).text()+" ")),search_options[e]=t,localStorage.setItem(`chara_${e}`,t),a&&updateStudentList()}function getNumActiveFilters(){let e=0;for(filter in $.each(search_options.filter,(function(t,a){"boolean"==typeof a?a&&(e+=1):$.each(a,(function(t,a){!0===a&&(e+=1)}))})),search_options.filterSelect)search_options.filterSelect[filter].length>0&&(e+=1);return e}function searchToggleUseCollectionStats(){sortByCollectionStats=!sortByCollectionStats,$("#ba-student-search-sortby-usecollectionstats .item-toggle-icon").html(`<i class="fa-solid fa-toggle-${sortByCollectionStats?"on":"off"}"></i>`),studentStatsList=null,localStorage.setItem("chara_sortby_collectionstats",sortByCollectionStats),updateStudentList(!0)}function searchSetOrder(e,t=!0,a=!0){a&&(e==search_options.sortby?search_options.sortby_dir=-search_options.sortby_dir:search_options.sortby_dir=1),e in sort_functions||(e="Default"),$("#ba-student-search-sortby a").removeClass("active"),$("#ba-student-search-sortby .btn-pill").removeClass("active"),$(`#ba-student-search-sortby-${e.toLowerCase()}`).addClass("active"),$("#ba-student-search-sortby-stat .label").text(translateUI("others")),$(".sort-direction-label").text(""),$(`#ba-student-search-sortby-${e.toLowerCase()} .sort-direction-label`).html(1==search_options.sortby_dir!=("Name"==e||"Default"==e||"BirthDay"==e||"Illustrator"==e||"Designer"==e||"MemoryLobbyBGM"==e)?'<i class="fa-solid fa-arrow-down-long ms-2"></i>':'<i class="fa-solid fa-arrow-up-long ms-2"></i>'),"Default"!=e&&"Name"!=e&&($("#ba-student-search-sortby-stat").addClass("active"),$("#ba-student-search-sortby-stat .label").html($(`#ba-student-search-sortby-${e.toLowerCase()}`).html())),search_options.sortby=e,localStorage.setItem("chara_sortby",e),localStorage.setItem("chara_sortby_dir",search_options.sortby_dir),t&&updateStudentList(updateSortMethod=!0),$("#ba-student-search-sortby-stat").dropdown("hide")}function searchSetOrderItems(e,t=!0,a=!0){a&&(e==itemSearchOptions.sortby?itemSearchOptions.sortby_dir=-itemSearchOptions.sortby_dir:itemSearchOptions.sortby_dir=1),$("#item-search-sortby a").removeClass("active"),$("#item-search-sortby button").removeClass("active"),$(`#item-search-sortby-${e.toLowerCase()}`).addClass("active"),$(".sort-direction-label").text(""),$(`#item-search-sortby-${e.toLowerCase()} .sort-direction-label`).html(1==itemSearchOptions.sortby_dir?'<i class="fa-solid fa-arrow-up-long ms-2"></i>':'<i class="fa-solid fa-arrow-down-long ms-2"></i>'),itemSearchOptions.sortby=e,localStorage.setItem("item_sortby",e),localStorage.setItem("item_sortby_dir",itemSearchOptions.sortby_dir),t&&updateItemList(updateSortMethod=!0)}function searchSetFilter(e,t,a=!0){if(null!=t){if(search_options.filter[e][t]=!search_options.filter[e][t],$(`#ba-student-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).hasClass("mutually-exclusive"))for(option in $(`[id^="ba-student-search-filter-${e.toLowerCase()}"].btn-pill`).toggleClass("active",!1),search_options.filter[e])option!=t&&(search_options.filter[e][option]=!1);$(`#ba-student-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).toggleClass("active",search_options.filter[e][t])}else search_options.filter[e]=!search_options.filter[e],$(`#ba-student-search-filter-${e.toLowerCase()}`).toggleClass("active",search_options.filter[e]);a&&updateStudentList()}function searchSetFilterSelect(e,t,a=!0){const s=search_options.filterSelect[e].indexOf(t);-1==s?(search_options.filterSelect[e].push(t),$(`a[data-filter-select-prop="${e}"][data-filter-select-value="${t}"]`).toggleClass("active",!0)):(search_options.filterSelect[e].splice(s,1),$(`a[data-filter-select-prop="${e}"][data-filter-select-value="${t}"]`).toggleClass("active",!1)),$(`#ba-student-search-select-${e.toLowerCase()}`).toggleClass("active",search_options.filterSelect[e].length>0),a&&updateStudentList()}function searchSetFilterItems(e,t,a=!0){null!=t?(itemSearchOptions.filter[e][t]=!itemSearchOptions.filter[e][t],$(`#item-search-filter-${e.toLowerCase()}-${String(t).toLowerCase()}`).toggleClass("active",itemSearchOptions.filter[e][t])):(itemSearchOptions.filter[e]=!itemSearchOptions.filter[e],$(`#item-search-filter-${e.toLowerCase()}`).toggleClass("active",itemSearchOptions.filter[e])),a&&updateItemList()}function searchResetFilter(){for(prop in $("#ba-student-search-text").val(""),Object.entries(search_options.filter).forEach(e=>{"boolean"==typeof e[1]?(search_options.filter[e[0]]=!1,$(`#ba-student-search-filter-${e[0].toLowerCase()}`).toggleClass("active",!1)):Object.entries(e[1]).forEach(t=>{search_options.filter[e[0]][t[0]]=!1,$(`#ba-student-search-filter-${e[0].toLowerCase()}-${String(t[0]).toLowerCase()}`).toggleClass("active",!1)})}),search_options.filterSelect)search_options.filterSelect[prop]=[],$(`#ba-student-search-select-${prop.toLowerCase()}`).toggleClass("active",!1),$(`a[data-filter-select-prop="${prop}"][data-filter-select-value]`).toggleClass("active",!1);$("#ba-student-search-reset").hide(),$("#ba-student-search-filter-amount").text(""),document.getElementById("ba-student-search-reset").blur(),updateStudentList()}function setGridItemDisplayStyle(e){if(gridItemDisplayStyle!=e){switch(gridItemDisplayStyle=e,localStorage.setItem("grid_item_display_style",gridItemDisplayStyle),$("#item-search-displaytype button").removeClass("active"),$("#item-search-displaytype-"+e).addClass("active"),e){case"detailed":$("#item-select-grid").removeClass("items-compact").addClass("items");break;case"compact":$("#item-select-grid").removeClass("items").addClass("items-compact")}populateItemList(loadedItemList)}}function renderStudent(){showAltSprite=!1,$("#ba-student-img").attr("src",`images/student/portrait/${student.Id}.webp`);let e=new Image;e.onload=function(){$("#ba-background").css("background-image",`url('${e.src}')`)},e.src=`images/background/${pixelMode?"pixel/"+student.CollectionBG+".png":student.CollectionBG+".jpg"}`,$("#ba-student-name").html(getTranslatedString(student,"Name").replace(/([(（].+[)）])/,"<small>$1</small>")),$("#ba-student-class").removeClass("ba-class-main ba-class-support").addClass(`ba-class-${student.SquadType.toLowerCase()}`).find(".label").text(getLocalizedString("SquadType",student.SquadType)),$("#ba-student-stargrade .label").html('<i class="fa-solid fa-star"></i>'.repeat(student.StarGrade)),student.IsLimited>0&&$("#ba-student-stargrade .label").append(`<span class="ms-1">(${getLocalizedString("IsLimited",""+student.IsLimited)})</span>`),$(".summon-list").toggleClass("disabled",0==student.Summons.length);let t="",a;t+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-summon-id="0" class="btn btn-dark"><div class="icon"><img src="images/student/icon/${student.Id}.webp"></div><span>${getTranslatedString(student,"Name")}</span></a></li>`,student.Summons.forEach((e,a)=>{const s=find(data.summons,"Id",e.Id)[0],i=find(student.Skills,"SkillType",e.SourceSkill)[0];t+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-summon-id="${a+1}" class="btn btn-dark"><div class="icon"><img class="bg-atk-${student.BulletType.toLowerCase()}" src="images/skill/${i.Icon}.webp"></div><span>${getTranslatedString(s,"Name")}</span></a></li>`}),$(".summon-list .dropdown-menu").html(t),skillInfoCollection=[],changeStudentSummon(0,!1),$("#ba-student-role-label").text(getLocalizedString("TacticRole",student.TacticRole)),$("#ba-student-role-icon").attr("src",`images/ui/Role_${student.TacticRole}.png`),setAttackTypeClass($("#ba-student-attacktype"),student.BulletType),setDefenseTypeClass($("#ba-student-defensetype"),student.ArmorType),$("#ba-student-academy-label").text(`${getLocalizedString("School",student.School)} / ${getLocalizedString("Club",student.Club)}`),$("#ba-student-school-img, #ba-student-academy-icon").attr("src",`images/schoolicon/School_Icon_${student.School.replace("Sakugawa","Etc").toUpperCase()}_W.png`),$("#ba-student-position-label").text(student.Position.toUpperCase()),$("#ba-student-attacktype-label").text(getLocalizedString("BulletType",student.BulletType)),$("#ba-student-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",student.BulletType)}`,translateUI("attacktype"),null,getAttackTypeText(student.BulletType),32),placement:"top",html:!0}),$("#ba-student-defensetype-label").text(getLocalizedString("ArmorType",student.ArmorType)),$("#ba-student-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorTypeLong",student.ArmorType)}`,translateUI("defensetype"),null,getDefenseTypeText(student.ArmorType),32),placement:"top",html:!0}),$("#ba-student-usescover-icon").toggle(student.Cover),$("#ba-student-weapontype-label").text(student.WeaponType),$(".ba-type-weapon").css("background-image",`url('images/weapon/${student.WeaponImg}.webp')`),student.Skills.filter(e=>"autoattack"!=e.SkillType).forEach(e=>{$(`#ba-skill-${e.SkillType}-name`).html(getTranslatedString(e,"Name")),$(`#ba-skill-${e.SkillType}-icon img`).attr("src",`images/skill/${e.Icon}.webp`),"passive"==e.SkillType&&$("#ba-statpreview-passiveskill-icon img, #ba-statpreview-status-passive-icon").attr("src",`images/skill/${e.Icon}.webp`),"ex"==e.SkillType&&($("#ba-skill-ex-cost").removeClass("ba-col-explosion ba-col-pierce ba-col-mystic ba-col-sonic"),e.Cost[0]!=e.Cost[4]&&$("#ba-skill-ex-cost").addClass(`ba-col-${student.BulletType.toLowerCase()}`))}),initCharacterSkillInfo(),$(".bg-skill").removeClass("explosion pierce mystic sonic").addClass(`${student.BulletType.toLowerCase()}`);for(let e=2;e<=5;e++)a="",$.each(student.SkillExMaterial[e-2],(function(t,s){a+=getMaterialIconHTML(s,student.SkillExMaterialAmount[e-2][t])})),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_ex_upgrade_credits[e-2])),$("#ba-skill-ex-materials-"+e).html(a),$("#ba-skill-ex-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));for(let e=2;e<=9;e++)a="",$.each(student.SkillMaterial[e-2],(function(t,s){a+=getMaterialIconHTML(s,student.SkillMaterialAmount[e-2][t])})),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[e-2])),$("#ba-skill-materials-"+e).html(a),$("#ba-skill-materials-"+e+" div").each((function(e,t){$(t).tooltip({html:!0})}));a="",a+=getMaterialIconHTML(9999,1),a+=getMaterialIconHTML(3000001,abbreviateNumber(skill_upgrade_credits[8])),$("#ba-skill-materials-10").html(a),$("#ba-skill-materials-10 div").each((function(e,t){$(t).tooltip({html:!0})})),$("#ba-student-weapon-name, #ba-statpreview-weapon-name").text(getTranslatedString(student.Weapon,"Name")),$("#ba-weapon-description").text(getTranslatedString(student.Weapon,"Desc").replace("\n\n","\n")),$("#ba-student-weapon-type").text(student.WeaponType),$("#ba-student-weapon-img, #ba-statpreview-weapon-img").attr("src",`images/weapon/${student.WeaponImg}.webp`),$("#ba-weapon-bonus-terrain-type").attr("src",`images/ui/Terrain_${student.Weapon.AdaptationType}.png`);let s=adaptationAmount[student[student.Weapon.AdaptationType+"BattleAdaptation"]],i=adaptationAmount[student[student.Weapon.AdaptationType+"BattleAdaptation"]+student.Weapon.AdaptationValue];if($("#ba-weapon-bonus-terrain-adaption").attr("src",`images/ui/Ingame_Emo_Adaptresult${i}.png`),$("#ba-weapon-bonus-terrain-adaption-description").html(`${translateUI("terrain_adaption",[getLocalizedString("AdaptationType",student.Weapon.AdaptationType)])} ${s} → <b>${i}</b><br>(${getAdaptationText(student.Weapon.AdaptationType,i)})`),$("#ba-weapon-stat-table .stat-HealPower").parent().toggle(student.Weapon.HealPower1>0),"Released"in student.Gear&&student.Gear.Released[regionID]){$("#ba-student-tab-gear, #ba-statpreview-ex-gear-container").show(),$("#ba-student-gear-name, #ba-statpreview-gear4-name").html(student.Gear.Name),$("#ba-student-gear-description").html(`${student.Gear.Desc}\n\n<i>${translateUI("bond_req_equip",[region.GearBondReq[0],student.Name])}`),$("#ba-student-gear-icon").attr("src",`images/gear/full/${student.Id}.webp`),$("#ba-statpreview-gear4-icon, #ba-student-gear-4-icon").attr("src",`images/gear/icon/${student.Id}.webp`),$("#ba-student-gear-4-icon").tooltip("dispose").tooltip({title:getRichTooltip(`images/gear/icon/${student.Id}.webp`,getTranslatedString(student.Gear,"Name").escapeHtml(),translateUI("student_ex_gear"),null,getTranslatedString(student.Gear,"Desc").escapeHtml()+`\n\n<b>${translateUI("stat_info")}:</b>\n`+getGearStatsText(student.Gear,"\n"),50,"img-scale-larger"),placement:"top",html:!0}).toggleClass("gear-disabled",0==statPreviewGearLevel);let e="";for(let t=0;t<student.Gear.TierUpMaterial[0].length;t++)e+=getMaterialIconHTML(student.Gear.TierUpMaterial[0][t],student.Gear.TierUpMaterialAmount[0][t]);let t=student.Gear.StatType.map(e=>e.split("_")[0]);generateStatTable("#ba-gear-stat-table",t,6);for(let e=0;e<student.Gear.StatValue.length;e++){let a=student.Gear.StatValue[e][1];"Coefficient"==student.Gear.StatType[e].split("_")[1]&&(a=parseFloat((a/100).toFixed(2))+"%"),$(`#ba-gear-stat-table .stat-${t[e]} .stat-value`).text("+"+a)}e+=getMaterialIconHTML(3000001,abbreviateNumber(gear_upgrade_credits[0])),$("#ba-statpreview-gear4-description").html(getGearStatsText(student.Gear,", ")),$("#ba-student-gear-materials-t2").html(e),$("#ba-student-gear-materials-t2>div").tooltip({html:!0}),$("#ba-student-bondreq-t2").html(translateUI("bond_req_upgrade",[region.GearBondReq[1],student.Name]))}else $("#ba-student-tab-gear, #ba-statpreview-ex-gear-container").hide(),$("#ba-student-tab-gear").hasClass("active")&&$("#ba-student-tab-stats").tab("show"),$("#ba-student-gear-4-icon").attr("src","images/gear/empty.png").tooltip("dispose").toggleClass("gear-disabled",!0);"Jp"!=userLang?$("#ba-student-fullname").text(getTranslatedString(student,"FamilyName")+" "+getTranslatedString(student,"PersonalName")):$("#ba-student-fullname").html(`<ruby>${getTranslatedString(student,"FamilyName")}<rp>(</rp><rt>${getTranslatedString(student,"FamilyNameRuby")}</rt><rp>)</rp></ruby> `+(""==getTranslatedString(student,"PersonalNameRuby")?getTranslatedString(student,"PersonalName"):`<ruby>${getTranslatedString(student,"PersonalName")}<rp>(</rp><rt>${getTranslatedString(student,"PersonalNameRuby")}</rt><rp>)</rp></ruby> `)),$("#ba-profile-school-label").text(getLocalizedString("SchoolLong",student.School)),$("#ba-profile-club-label").text(getLocalizedString("Club",student.Club)),$("#ba-profile-schoolyear-label").text(getTranslatedString(student,"SchoolYear")).toggle(""!=getTranslatedString(student,"SchoolYear")),$("#ba-profile-portrait-img").attr("src",`images/student/collection/${student.Id}.webp`);var l="";l+=student.ProfileIntroduction.escapeHtml(),3==student.StarGrade&&(l+=`\n\n<i class="text-bold">"${getTranslatedString(student,"CharacterSSRNew")}"</i>`),$("#ba-student-profile-text").html(l),student.MemoryLobby[regionID]>0?($(".ba-student-lobby").show(),$("#ba-student-lobby-img").attr("src",`images/student/lobby/${student.Id}.webp`),$("#ba-student-lobby-unlock").text(student.MemoryLobby[regionID]),$(".ba-student-lobby").tooltip("dispose").tooltip({title:getRichTooltip(null,translateUI("memory_lobby_student",[getTranslatedString(student,"Name")]),null,null,`${translateUI("memory_lobby_unlock",[student.MemoryLobby[regionID],getTranslatedString(student,"Name")])}\n${translateUI("memory_lobby_bgm",[student.MemoryLobbyBGM])}`),placement:"top",html:!0})):$(".ba-student-lobby").hide(),$("#ba-student-profile-age").html(getTranslatedString(student,"CharacterAge")),$("#ba-student-profile-birthday").html(getTranslatedString(student,"Birthday")),$("#ba-student-profile-hobbies").html(getTranslatedString(student,"Hobby")),$("#ba-student-profile-height").html(student.CharHeightMetric),$("#ba-student-profile-cv").html(getTranslatedString(student,"CharacterVoice")),$("#ba-student-profile-designer").html(student.Designer),$("#ba-student-profile-illustrator").html(student.Illustrator),$("#ba-student-toggle-sprite-btn").toggle(altSprite.includes(student.Id)),$("#style-switch-btn").toggle(Boolean(student.LinkedCharacterId||student.SubCharacterId)),$("#style-switch-btn-bg").css("background-image",`url('images/combatstyle/${student.Id}.png')`);let n=student.FavorItemTags;n.push(student.FavorItemUniqueTags[0]),n.push(student.FavorItemUniqueTags[0]+"2");const r=data.config.CommonFavorItemTags,o=data.items.filter(e=>"Favor"==e.Category&&e.IsReleased[regionID]).sort((e,t)=>t.ExpValue-e.ExpValue);let d=["","",""];for(const e of o){const t=[...student.FavorItemTags,...student.FavorItemUniqueTags,...r],a=e.Tags.filter(e=>r.includes(e)).length,s=e.Tags.filter(e=>t.includes(e)),i=Math.min(s.length,3);i-a>0&&(d[i-1]+=getFavourIconHTML(e,i))}""==d.join("")?$("#ba-student-favoured-items").empty().html(`<span class="text-center">${translateUI("favoritem_none")}</span>`):$("#ba-student-favoured-items").empty().html(d.reverse().join(""));let c="";$(student.FurnitureInteraction[regionID]).each((function(e,t){let a=find(data.furniture,"Id",t[0])[0];a.IsReleased[regionID]&&(c+=getFurnitureIconHTML(a))})),$("#ba-student-favoured-furniture").empty().html(c),""==c?$("#ba-student-favoured-furniture").empty().html(`<span class="pb-2 text-center">${translateUI("furniture_none")}</span>`):$("#ba-student-favoured-furniture").empty().html(c),$(".ba-favor-item").tooltip({html:!0}),generateStatTable("#ba-bond-stat-table",student.FavorStatType,6),"Main"==student.SquadType?($("#ba-student-stat-table").removeClass("striker-bonus"),$("#ba-statpreview-status-strikerbonus").hide(),$("#statpreview-supportstats").show(),statPreviewViewSupportStats=!1):($("#ba-statpreview-status-strikerbonus").show(),$("#statpreview-supportstats").hide()),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewViewSupportStats),student.TSAId&&find(data.students,"Id",student.TSAId)[0].IsReleased[regionID]&&(statPreviewTSAStats.setStudent(student.TSAId),$("#statpreview-tsastats").toggle(statPreviewSelectedChar>0)),$("#statpreview-tsastats").hide(),$("#ba-statpreview-bond-targets").empty().html(getBondTargetsHTML(0,student)),$("#statpreview-status-bond").empty().html(getBondToggleHTML(0,student)),student_bondalts=[],$("#ba-statpreview-status-bond-0-toggle").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_relationship_bonus",[student.Name])),placement:"top",html:!0});for(let e=0;e<student.FavorAlts.length;e++){var u=find(data.students,"Id",student.FavorAlts[e])[0];u.IsReleased[regionID]&&(student_bondalts.push(u),$("#ba-statpreview-bond-targets").append(getBondTargetsHTML(student_bondalts.length,u)),$("#statpreview-status-bond").append(getBondToggleHTML(student_bondalts.length,u)),$(`#ba-statpreview-status-bond-${student_bondalts.length}-toggle`).tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_relationship_bonus",[u.Name])),placement:"top",html:!0}))}if(student.Id in studentCollection){statPreviewStarGrade=studentCollection[student.Id].s,statPreviewLevel=Math.min(studentCollection[student.Id].l,region.StudentMaxLevel),$("#ba-statpreview-levelrange").val(statPreviewLevel),changeStatPreviewLevel(document.getElementById("ba-statpreview-levelrange"),!1),statPreviewEquipment=[Math.min(studentCollection[student.Id].e1,region.EquipmentMaxLevel[0]),Math.min(studentCollection[student.Id].e2,region.EquipmentMaxLevel[1]),Math.min(studentCollection[student.Id].e3,region.EquipmentMaxLevel[2])],$("#ba-statpreview-gear1-range").val(statPreviewEquipment[0]),$("#ba-statpreview-gear2-range").val(statPreviewEquipment[1]),$("#ba-statpreview-gear3-range").val(statPreviewEquipment[2]),statPreviewPotentialLevel={MaxHP:studentCollection[student.Id].pm?studentCollection[student.Id].pm:0,AttackPower:studentCollection[student.Id].pa?studentCollection[student.Id].pa:0,HealPower:studentCollection[student.Id].ph?studentCollection[student.Id].ph:0};for(const e in statPreviewPotentialLevel)$(`#ba-statpreview-potential-${e.toLowerCase()}-range`).val(statPreviewPotentialLevel[e]);statPreviewWeaponGrade=region.WeaponMaxLevel>0?studentCollection[student.Id].ws:0,statPreviewWeaponLevel=Math.min(studentCollection[student.Id].wl,region.WeaponMaxLevel),$("#ba-statpreview-weapon-range").attr("max",region.WeaponMaxLevel).val(statPreviewWeaponLevel),statPreviewBondLevel[0]=Math.min(studentCollection[student.Id].b,region.BondMaxLevel),$("#ba-statpreview-bond-0-range").val(statPreviewBondLevel[0]),$("#ba-statpreview-passiveskill-range").val(studentCollection[student.Id].s3),changeStatPreviewPassiveSkillLevel(document.getElementById("ba-statpreview-passiveskill-range"),!1),statPreviewIncludeBond[0]=!0,statPreviewIncludeEquipment=!0,lockedAttributes=void 0!==studentCollection[student.Id].lock&&studentCollection[student.Id].lock,$("#ba-student-collection-btn").toggleClass("active",!0).html('<i class="fa-solid fa-circle-check"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_remove")),placement:"top",html:!0}),$(".btn-lock-attributes").show()}else $("#ba-student-collection-btn").toggleClass("active",!1).html('<i class="fa-solid fa-circle-plus"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_add")),placement:"top",html:!0}),lockedAttributes=!1,$(".btn-lock-attributes").hide();$(".btn-lock-attributes").toggleClass("deactivated",!lockedAttributes),$(".btn-lock-attributes i").toggleClass("fa-lock",lockedAttributes).toggleClass("fa-lock-open",!lockedAttributes),statPreviewExternalBuffs.changeStudent(student.Id),updateGearIcon(),changeStatPreviewStars(statPreviewStarGrade,statPreviewWeaponGrade,!1),recalculateTerrainAffinity(),changeSkillPreviewTerrain(statPreviewTerrain,!1),changeStatPreviewPassiveSkillLevel(document.getElementById("ba-statpreview-passiveskill-range"),!1),recalculateWeaponPreview(),updateWeaponLevelStatPreview($("#ba-statpreview-weapon-range").val()),recalculateSkillPreview(),recalculateWeaponSkillPreview(),recalculateGearSkillPreview(),recalculateEXSkillPreview(),student.Skills.some(e=>"autoattack"==e.SkillType)?($("#ba-skill-autoattack").show(),recalculateNormalAttackPreview()):$("#ba-skill-autoattack").hide(),recalculateBondPreview(),changeGearLevel(1,document.getElementById("ba-statpreview-gear1-range"),!1),changeGearLevel(2,document.getElementById("ba-statpreview-gear2-range"),!1),changeGearLevel(3,document.getElementById("ba-statpreview-gear3-range"),!1),changePotentialLevel("MaxHP",document.getElementById("ba-statpreview-potential-maxhp-range"),!1),changePotentialLevel("AttackPower",document.getElementById("ba-statpreview-potential-attackpower-range"),!1),changePotentialLevel("HealPower",document.getElementById("ba-statpreview-potential-healpower-range"),!1),"Released"in student.Gear&&student.Gear.Released[regionID]&&changeExGearLevel(document.getElementById("ba-statpreview-gear4-range"),!1);for(let e=0;e<=student_bondalts.length;e++)e>0&&student_bondalts[e-1].Id in studentCollection&&(statPreviewBondLevel[e]=studentCollection[student_bondalts[e-1].Id].b,$(`#ba-statpreview-bond-${e}-range`).val(studentCollection[student_bondalts[e-1].Id].b),statPreviewIncludeBond[e]=!0),changeStatPreviewBondLevel(e,!1);refreshStatTableControls(),recalculateStats(),finalizeLoad(getTranslatedString(student,"Name"),"chara",student.PathName,"View Student",student.Id),student.IsReleased[regionID]||showReleaseWarning(),studentSelectorModal.hide()}function initCharacterSkillInfo(){const e=$("#calculation-student-skills").empty();if(skillInfoCollection=[],0==statPreviewSelectedChar)student.Skills.forEach(t=>{if(("gearnormal"!=t.SkillType||student.Gear.Released[regionID])&&!t.HideCalculation){if("Effects"in t){let a=!1;t.Effects.forEach(e=>{(e.Type.startsWith("DMG")||e.Type.startsWith("Heal")||"Shield"==e.Type||"FormChange"==e.Type||"CrowdControl"==e.Type)&&(a=!0)}),a&&("autoattack"==t.SkillType&&addNormalAttackSkillText(t),skillInfoCollection.push(new SkillDamageInfo(t,e,student)))}if(t.ExtraSkills)for(const a of t.ExtraSkills.filter(e=>e.Effects&&!e.TSAId))a.Effects.find(e=>e.Type.startsWith("DMG")||e.Type.startsWith("Heal")||"Shield"==e.Type||"FormChange"==e.Type||"CrowdControl"==e.Type)&&skillInfoCollection.push(new SkillDamageInfo(a,e,student))}}),null!=student.Gear.Released&&student.Gear.Released[regionID]&&(e.find(".skill-info-gearnormal").toggle(statPreviewGearLevel>=2),e.find(".skill-info-normal").toggle(statPreviewGearLevel<2));else{const t=find(data.summons,"Id",student.Summons[0].Id)[0];if(t.Skills.filter(e=>e.Effects).forEach(t=>{if(t.Effects.find(e=>e.Type.startsWith("DMG")||e.Type.startsWith("Heal")||"Shield"==e.Type||"FormChange"==e.Type||"CrowdControl"==e.Type)){if(t.HideCalculation)return;"autoattack"==t.SkillType&&addNormalAttackSkillText(t),skillInfoCollection.push(new SkillDamageInfo(t,e,student))}}),student.TSAId){const t=find(data.students,"Id",student.TSAId)[0];if(t.IsReleased[regionID])for(const a of t.Skills.filter(e=>e.ExtraSkills))for(const s of a.ExtraSkills.filter(e=>e.TSAId==student.Id))skillInfoCollection.push(new SkillDamageInfo(s,e,student,t));e.find(".skill-info-tsa").toggle(statPreviewTSAStats.enabled)}}0==skillInfoCollection.length&&e.html(`<div class="d-flex px-2 my-2 justify-content-center text-center">${translateUI("skillinfo_empty")}</div>`)}function initRaidSkillInfo(e,t,a){const s=$("#calculation-enemy-skills").empty();if(raidSkillInfoCollection=[],e<1e6){const i=find(e<8e5?data.raids.Raid:data.raids.WorldRaid,"Id",e)[0],l=find(data.enemies,"Id",t)[0];if(i.HasNormalAttack.includes(t)){const e={SkillType:"raidautoattack",IsRaidSkill:!0,RaidDifficulty:0,Effects:[{Type:"DMGSingle",Hits:[1e4],Scale:[1e4],CriticalCheck:"Check"}]};addNormalAttackSkillText(e),raidSkillInfoCollection.push(new SkillDamageInfo(e,s,l))}for(const e of i.RaidSkill)if("Effects"in e){let i=!1;e.Effects.forEach(e=>{(e.Type.startsWith("DMG")||"CrowdControl"==e.Type)&&e.RestrictTo.includes(t)&&(i=!0)}),i&&(e.IsRaidSkill=!0,e.RaidDifficulty=a,"raidautoattack"==e.SkillType&&(e.RaidDifficulty=0,e.Name=translateUI("skill_normalattack"),e.Desc=translateUI("skill_normalattack_target"),e.Parameters=[[`${parseInt(e.Effects[0].Scale[0][0]/100)}%`]]),e.Name||(e.Name=translateUI(`student_skill_${e.SkillType.toLowerCase()}`)),raidSkillInfoCollection.push(new SkillDamageInfo(e,s,l)))}}$("#skill-calculation-tabs").toggle(raidSkillInfoCollection.length>0),0==raidSkillInfoCollection.length&&$("#skill-calculation-tab-student").tab("show")}function addNormalAttackSkillText(e){if(e.Name=translateUI("skill_normalattack"),e.Parameters=[["100%"]],e.Radius&&e.Radius.length)switch(e.Radius[0].Type){case"Circle":e.Desc=translateUI("skill_normalattack_circle"),e.Icon="COMMON_SKILLICON_CIRCLE";break;case"Obb":e.Desc=translateUI("skill_normalattack_line"),e.Icon="COMMON_SKILLICON_LINE";break;case"Fan":e.Desc=translateUI("skill_normalattack_fan"),e.Icon="COMMON_SKILLICON_FAN"}else e.Desc=translateUI("skill_normalattack_target"),e.Icon="COMMON_SKILLICON_TARGET"}function loadStudent(e){"students"==loadedModule?selectCompareMode?(studentCompare=find(data.students,"PathName",e),0==studentCompare.length&&(studentCompare=findOrDefault(data.students,"DevName",e,"Aru")),studentCompare=studentCompare[0],selectCompareMode=!1,changeStudentSummon(0,!1),compareMode=!0,updateCompareModeControl(),recalculateStats(),studentSelectorModal.hide()):(student=find(data.students,"PathName",e),0==student.length&&(student=findOrDefault(data.students,"DevName",e,"Aru")),student=student[0],compareMode&&student.Id==studentCompare.Id&&(compareMode=!1,updateCompareModeControl()),renderStudent()):loadModule("students",e)}function loadStudentById(e){"students"==loadedModule?(student=findOrDefault(data.students,"Id",e,1e4)[0],renderStudent()):loadModule("students")}function loadItem(e){if("items"==loadedModule){var t="",a,s;$(".tooltip").tooltip("hide"),$("#item-select-grid .card-items.selected").removeClass("selected"),$("#ba-furniture-details").hide(),e>=2e6&&e<3e6?(t="equipment",s="equipment",a=findOrDefault(data.equipment,"Id",e-2e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))):e>=1e6&&e<2e6?(t="furniture",s="furniture",a=findOrDefault(data.furniture,"Id",e-1e6,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.SubCategory)),$("#ba-furniture-details").show(),$("#furniture-set").html(getLocalizedString("FurnitureSet",""+a.SetGroupId)),$("#furniture-comfort").html(`<img class="inline-img" src="images/ui/Cafe_Icon_Comfort.png"> ${a.ComfortBonus}`),$("#furniture-size").html("Interiors"==a.Category?"-":`${a.Size[0]} &times; ${a.Size[1]}`)):(t="items",s="item",a=findOrDefault(data.items,"Id",e,1)[0],$("#ba-item-type").html(getLocalizedString("ItemCategory",a.Category))),loadedItem=a,loadedItemType=t,$("#ba-item-name").html(getTranslatedString(a,"Name")),"equipment"==t&&a.Id>=1e3?$("#ba-item-rarity .label").html(`T${a.Tier}`):$("#ba-item-rarity .label").html(getRarityTier(a.Rarity)),$("#ba-item-icon").removeClass("ba-item-n ba-item-r ba-item-sr ba-item-ssr").addClass("ba-item-"+a.Rarity.toLowerCase()),$("#ba-item-icon-img, #item-icon-full").attr("src",`images/${s}/icon/${a.Icon}.webp`),$("#item-icon-full").attr("src",`images/${s}/full/${a.Icon}.webp`);let i=getTranslatedString(a,"Desc").escapeHtml();if(a.ImmediateUse&&(i+=`\n\n<i><i class="fa-solid fa-box-open me-1"></i>${translateUI("item_is_immediateuse")}</i>`),a.ExpiryTime&&a.ExpiryTime[regionID]){const e=(new Date).getTime()/1e3,t=new Date(1e3*a.ExpiryTime[regionID]).toLocaleString([],{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"});a.ExpiryTime[regionID]<=e?i+=`\n\n<i><i class="fa-solid fa-clock me-1"></i>${translateUI("item_is_expired",[t])}</i>`:i+=`\n\n<i><i class="fa-solid fa-clock me-1"></i>${translateUI("item_is_expiring",[t])}</i>`}if($("#ba-item-description").html(i),"equipment"==t&&a.Id>=1e3&&a.Id<=1e4?($("#ba-equipment-details").show(),generateStatTable("#ba-equipment-details",a.StatType,6),a.StatType.forEach((e,t)=>{let s=a.StatValue[t][1];"Coefficient"==e.split("_")[1]&&(s=parseFloat((s/100).toFixed(2))+"%"),$(`#ba-equipment-details .stat-${e} .stat-value`).text("+"+s)})):$("#ba-equipment-details").hide(),a.Category.includes("WeaponExpGrowth")&&$("#ba-item-description").append(`\n\n<i>${getLocalizedString("WeaponPartExpBonus",a.Category)}</i>`),$("#ba-equipment-recipe").empty().hide(),$("#ba-item-usage").empty().hide(),$("#ba-item-sources").empty().hide(),$("#ba-item-shops").empty().hide(),$("#ba-item-craftnodes").empty().hide(),$("#ba-item-consumables").empty().hide(),"Material"==a.Category||"CharacterExpGrowth"==a.Category?($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-sources").html(getItemDropStages(a.Id))):"Consumable"==a.Category?($("#ba-item-sources").html(getItemDropStages(a.Id)),void 0!==a.ConsumeType&&($("#ba-item-usage").html(getConsumableRewards(a)),$("#ba-item-usage .item-drop").tooltip({html:!0}))):"Favor"==a.Category?($("#ba-item-usage").html(getLikedByStudents(a)),$(".ba-item-student").tooltip({html:!0})):"SecretStone"==a.Category?($("#ba-item-sources").html(getItemDropStages(a.Id)),$("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0})):"equipment"==t?($("#ba-item-usage").html(getUsedByStudents(a,t)),$("#ba-item-sources").html(getItemDropStages(a.Id+2e6)),$("#ba-equipment-recipe").html(getEquipmentRecipe(a)),$("#ba-equipment-recipe div").each((function(e,t){$(t).tooltip({html:!0})})),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-craftnodes").html(getItemCraftNodes(a.Id,"Equipment"))):"Coin"==a.Category&&($("#ba-item-sources").html(getItemDropStages(a.Id,!0)),$("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0})),"furniture"==t?($("#ba-item-usage").html(getUsedByStudents(a,t)),$(".ba-item-student").tooltip({html:!0}),$("#ba-item-craftnodes").html(getItemCraftNodes(a.Id,"Furniture"))):"items"==t&&$("#ba-item-craftnodes").html(getItemCraftNodes(a.Id,"Item")),$("#ba-item-consumables").html(getItemConsumables(e)),$("#ba-item-consumables .item-icon-list div").tooltip({html:!0}),a.Shops){let e="";a.Shops.forEach(t=>{t.Released[regionID]&&(e+=getShopCardHTML(t))}),""!=e&&($("#ba-item-shops").html(`<div class="mb-2"><i>${translateUI("item_purchasedfrom")}</i></div><div class="selection-grid stage selection-grid-flex">${e}</div>`).show(),$("#ba-item-shops .shop-cost").tooltip({html:!0,placement:"top"}))}if(region.FurnitureTemplateMax>0&&a.Templates){let e="";a.Templates.forEach(t=>{if(t[0]>region.FurnitureTemplateMax)return;e+=`<div class="selection-grid-card card-shop">\n                <div class="card-img"><img loading="lazy" src="images/furniture/template/${t[0]}.webp"></div>`;let a=getLocalizedString("FurnitureTemplate",t[0]);e+=`<span class="card-badge stage-droprate">&times;${t[1]}</span>`,e+='<div class="card-label">',e+=`<span class="label-text ${a.length>label_enemy_smalltext_threshold[userLang]?"smalltext":""}">${a}</span>`,e+="</div></div>"}),""!=e&&$("#ba-item-shops").html(`<div class="mb-2"><i>${translateUI("furniture_templates")}</i></div><div class="selection-grid stage selection-grid-flex">${e}</div>`).show()}$(`#ba-item-list-tab-${t}`).tab("show"),$("#item-select-"+e).addClass("selected"),loadedItemList!=t&&populateItemList(t),finalizeLoad(getTranslatedString(a,"Name"),"item",e,"View Item",e),a.IsReleased[regionID]||showReleaseWarning()}else loadModule("items",e)}function loadCraft(e){if("craft"==loadedModule)if(loadedCraftId>0&&$("#craft-select-"+loadedCraftId).removeClass("selected"),e<1e5){const t=findOrDefault(data.crafting.Nodes,"Id",e,1)[0];loadedCraftNode=t,loadedCraftId=t.Id,$("#ba-craft-name").html(getTranslatedString(t,"Name")),$("#ba-craft-type").html(getLocalizedString("NodeTier",""+t.Tier)),$("#ba-craft-rarity .label").html(getLocalizedString("NodeQuality",""+t.Quality)),$("#ba-craft-icon").removeClass("ba-node-quality-1 ba-node-quality-2").addClass("ba-node-quality-"+t.Quality),$("#ba-craft-icon-img").attr("src",`images/ui/${t.Icon}.png`),$("#ba-craft-description").text(getTranslatedString(t,"Desc")),$("#ba-craft-rewards-title").text(translateUI("craft_rewards")),$("#ba-craft-rewards").empty();let a="",s=0;t.Groups.forEach(e=>{s+=e.Weight}),$.each(t.Groups,(function(e,t){let i=data.crafting.Groups[t.GroupId],l=0;for(let e=0;e<i.length;e++)l+=i[e].Weight;for(let e=0;e<i.length;e++){let n=(t.Weight/s*(i[e].Weight/l)).toFixed(4),r=i[e].ItemId;"Furniture"==i[e].Type?r+=1e6:"Equipment"==i[e].Type?r+=2e6:"Currency"==i[e].Type&&(r+=3e6),a+=getDropIconHTML(r,n,i[e].AmountMin,i[e].AmountMax,!0)}})),$("#ba-craft-rewards").html(a),$("#ba-craft-rewards div").each((function(e,t){$(t).tooltip({html:!0})})),$("#craft-select-"+loadedCraftNode.Id).addClass("selected"),finalizeLoad(getTranslatedString(t,"Name"),"craftnode",t.Id,"View Crafting",t.Id)}else{const t=findOrDefault(data.crafting.Fusion,"Id",e%1e5,1)[0],a=t.ResultId>=1e6?"furniture":"items",s="items"==a?"item":a,i=find(data[a],"Id",t.ResultId%1e6)[0];loadedCraftNode=t,loadedCraftId=t.Id+1e5,$("#ba-craft-name").html(getTranslatedString(i,"Name")),$("#ba-craft-type").html(translateUI("craft_fusion")),$("#ba-craft-rarity .label").html(getRarityTier(i.Rarity)),$("#ba-craft-icon").removeClass("ba-node-quality-1 ba-node-quality-2 ba-item-n ba-item-r ba-item-sr ba-item-ssr").addClass("ba-item-"+i.Rarity.toLowerCase()),$("#ba-craft-icon-img").attr("src",`images/${s}/icon/${i.Icon}.webp`),$("#ba-craft-description").text(getTranslatedString(i,"Desc")),$("#ba-craft-rewards-title").text(translateUI("craft_recipe_items")),$("#ba-craft-rewards").empty();let l="";l+=getMaterialIconHTML(t.RequireItem[0],t.RequireItem[1]),l+=getMaterialIconHTML(3000001,t.RequireGold),l+='<div class="ba-panel-separator"></div>',data.items.forEach(e=>{e.IsReleased[regionID]&&e.Tags.filter(e=>t.IngredientTag.includes(e)).length>0&&(l+=getDropIconHTML(e.Id,getServerProperty(e,"ShiftingCraftQuality")/t.IngredientExp,1,1,!0))}),data.furniture.forEach(e=>{e.IsReleased[regionID]&&e.Tags.filter(e=>t.IngredientTag.includes(e)).length>0&&(l+=getDropIconHTML(e.Id+1e6,getServerProperty(e,"ShiftingCraftQuality")/t.IngredientExp,1,1,!0))}),$("#ba-craft-rewards").html(l),$("#ba-craft-rewards div").each((function(e,t){$(t).tooltip({html:!0})})),$("#craft-select-"+loadedCraftId).addClass("selected"),finalizeLoad(getTranslatedString(i,"Name"),"craftnode",loadedCraftId,"View Crafting",loadedCraftId),i.IsReleased[regionID]||showReleaseWarning()}else loadModule("craft",e)}function loadRaid(e){if(selectedEnemy=0,"raids"==loadedModule){let t;if(isNaN(parseInt(e))&&(e=1),loadedRaid&&$("#raid-select-"+loadedRaid.Id).removeClass("selected"),$("#ba-raid-entrycost-container").toggle(e<1e6),$("#multifloor-raid-floor").toggle(e>=1e6),$("#ba-raid-info-tabs").toggle(e<1e6),e<1e3){$("#ba-raid-list-tab-raid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").hide(),$("#ba-raid-difficulty").show(),$("#ba-raid-info-tab-profile").show(),raid=findOrDefault(data.raids.Raid,"Id",e,1)[0],raid_difficulty>raid.MaxDifficulty[regionID]&&(raid_difficulty=raid.MaxDifficulty[regionID]);for(let e=0;e<=6;e++)$(`#ba-raid-difficulty-${e}`).toggle(e<=raid.MaxDifficulty[regionID]);$(`#ba-raid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","Raid")),t=getTranslatedString(raid,"Name"),$("#ba-raid-name").text(t),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),$("#ba-raid-profile-page").show(),$("#ba-raid-profile-name").text(getTranslatedString(raid,"Name")),$("#ba-raid-profile-affiliation").text(getLocalizedString("BossFaction",raid.Faction)),$("#ba-raid-profile").html(getTranslatedString(raid,"Profile")),changeRaidDifficulty(raid_difficulty);const a=find(data.raids.RaidSeasons[regionID].Seasons,"RaidId",raid.Id);let s="";const i={year:"2-digit",month:"numeric",day:"numeric"};s+=`<li><h6 class="dropdown-header">${getLocalizedString("StageType","Raid")}</h6></li>`;const l={36:"HC",40:"EXT",44:"INS",48:"TOR",54:"TOR",56:"TOR"};if(a.forEach(e=>{const t=new Date(1e3*e.Start).toLocaleString([],i),a=new Date(1e3*e.End).toLocaleString([],i),n=l[e.RewardSetMax];s+=`<li><a class="dropdown-item" href="javascript:;" class="btn btn-dark" data-season="${e.SeasonId}"><div class="d-flex gap-1 align-items-end"><span class="label p-0">${translateUI("raid_season",[e.SeasonDisplay])}</span><img class="inline-img invert-light" src="images/ui/Terrain_${e.Terrain}.png"><small class="text-bold">${n}</small><small class="ms-1">${t} - ${a}</small></div></a></li>`}),data.raids.RaidSeasons[regionID].EliminateSeasons.length){const e=find(data.raids.RaidSeasons[regionID].EliminateSeasons,"RaidId",raid.Id);e.length&&(s+=`<li><h6 class="dropdown-header">${getLocalizedString("StageType","EliminateRaid")}</h6></li>`),e.forEach(e=>{const t=new Date(1e3*e.Start).toLocaleString([],i),a=new Date(1e3*e.End).toLocaleString([],i);s+=`<li><a class="dropdown-item" href="javascript:;" class="btn btn-dark" data-season="${1e4+e.SeasonId}"><div class="d-flex gap-1 align-items-end"><span class="label p-0">${translateUI("raid_season",[e.SeasonDisplay])}</span><img class=" inline-img invert-light" src="images/ui/Terrain_${e.Terrain}.png"><small class="text-bold ba-col-${e.TormentArmorType.toLowerCase()}">TOR</small><small>${t} - ${a}</small></div></a></li>`})}$("#ba-raid-season").show(),$("#ba-raid-season-list .btn-pill .label").html(translateUI("raid_season_select")),$("#ba-raid-season-list .dropdown-menu").html(s),$("#ba-raid-season-rewards").html("")}else if(e<8e5)$("#ba-raid-list-tab-timeattack").tab("show"),$("#ba-raid-info").hide(),$("#ba-timeattack-info").show(),raid=findOrDefault(data.raids.TimeAttack,"Id",e,1e3)[0],$(`#ba-timeattack-difficulty-${ta_difficulty}`).tab("show"),t=`${raid.Id/1e3}: ${getLocalizedString("TimeAttackStage",raid.DungeonType)}`,$("#ba-timeattack-name").text(t),$("#ba-timeattack-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain}.png`),changeTimeAttackDifficulty(ta_difficulty);else if(e<1e6){$("#ba-raid-list-tab-worldraid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").show(),$("#ba-raid-difficulty").hide(),$("#ba-raid-season").hide(),$("#ba-raid-info-tab-profile").hasClass("active")&&$("#ba-raid-info-tab-skills").tab("show"),$("#ba-raid-info-tab-rewards").hasClass("active")&&$("#ba-raid-info-tab-skills").tab("show"),$("#ba-raid-info-tab-profile").hide(),raid=findOrDefault(data.raids.WorldRaid,"Id",e,814e3)[0];const a=raid.MaxDifficulty[regionID];raid_difficulty>a&&(raid_difficulty=0);let s="";for(let e=0;e<=a;e++)s+=`<a id="ba-worldraid-difficulty-${e}" class="nav-link" data-bs-toggle="tab" href="#" onclick="changeWorldRaidDifficulty(${e})">${raid.DifficultyName[e]}</a>`;$("#ba-worldraid-difficulty").html(s),$(`#ba-worldraid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","WorldRaid")),t=getTranslatedString(raid,"Name"),$("#ba-raid-name").text(t),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),changeWorldRaidDifficulty(raid_difficulty)}else{$("#ba-raid-list-tab-worldraid").tab("show"),$("#ba-raid-info").show(),$("#ba-timeattack-info").hide(),$("#ba-worldraid-difficulty").show(),$("#ba-raid-difficulty").hide(),$("#ba-raid-season").hide(),$("#ba-raid-entrycost").hide(),$("#ba-raid-info-tab-profile").hasClass("active")&&$("#ba-raid-info-tab-skills").tab("show"),$("#ba-raid-info-tab-rewards").hasClass("active")&&$("#ba-raid-info-tab-skills").tab("show"),$("#ba-raid-info-tab-profile").hide(),$("#ba-raid-info-tabs").hide(),raid=findOrDefault(data.raids.MultiFloorRaid,"Id",e,1e6)[0];const a=raid.MaxDifficulty[regionID];raid_difficulty>a&&(raid_difficulty=0);let s="";for(let e=0;e<=a;e++)s+=`<a id="ba-worldraid-difficulty-${e}" class="nav-link" data-bs-toggle="tab" href="#" onclick="changeMultiFloorRaidDifficulty(${e})">${raid.DifficultyStartFloor[e]} ~ ${raid.DifficultyStartFloor[e+1]-1}</a>`;$("#ba-worldraid-difficulty").html(s),$(`#ba-worldraid-difficulty-${raid_difficulty}`).tab("show"),$("#ba-raid-affiliation").text(getLocalizedString("StageType","MultiFloorRaid")),t=getTranslatedString(raid,"Name"),$("#ba-raid-name").html(t+` <small>(${getLocalizedString("ArmorTypeLong",raid.ArmorType)})</small>`),$("#ba-raid-terrain-img").attr("src",`images/ui/Terrain_${raid.Terrain[0]}.png`),raid.Terrain.length>1?($("#ba-raid-terrain-alt-img").attr("src",`images/ui/Terrain_${raid.Terrain[1]}.png`),$("#ba-raid-terrain-alt").show()):$("#ba-raid-terrain-alt").hide(),$("#ba-raid-duration").text(MathHelper.formatDuration(raid.BattleDuration)),changeMultiFloorRaidDifficulty(raid_difficulty)}$("#ba-raid-season-rewards").hide(),loadedRaid=raid,$("#raid-select-"+raid.Id).addClass("selected"),finalizeLoad(t+(e>=1e6?` (${getLocalizedString("ArmorTypeLong",raid.ArmorType)})`:""),"raid",raid.Id,"View Raid",raid.Id),raid.IsReleased[regionID]||showReleaseWarning()}else loadModule("raids",e)}function loadRaidSeasonRewards(e){let t;if(t=e>1e4?find(data.raids.RaidSeasons[regionID].EliminateSeasons,"SeasonId",e-1e4)[0]:find(data.raids.RaidSeasons[regionID].Seasons,"SeasonId",e)[0],t){let a="";const s=data.raids.RaidSeasons[regionID][e>1e4?"EliminateRewardSets":"RewardSets"][`${t.RewardSet}`];s.forEach(([e,s],i)=>{i>t.RewardSetMax||(""!=a&&(a+='<div class="ba-panel-separator"></div>'),a+=`<div class="d-flex"><span class="reward-point">${abbreviateNumber(e)+" Pt"}</span><div class="season-rewards">`,s.forEach(([e,t])=>{a+=getDropIconHTML(e,t)}),a+="</div></div>")}),$("#ba-raid-season-rewards").html(a),$("#ba-raid-season-rewards .season-rewards>div").tooltip({html:!0}),$("#ba-raid-season-rewards").show(),$("#ba-raid-season-list .btn-pill .label").html($(`#ba-raid-season-list a.dropdown-item[data-season="${e}"]`).html()),$("#ba-raid-season-list a.dropdown-item").toggleClass("active",!1),$(`#ba-raid-season-list a.dropdown-item[data-season="${e}"]`).toggleClass("active",!0)}}function changeRaidDifficulty(e){raid_difficulty=e;let t="";$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.PathName}${raid_difficulty>=5?"_Insane":""}_Lobby.png')`),$("#ba-raid-level").text(`Lv. ${raid_level[raid_difficulty]}`),$("#ba-raid-entrycost").html(getStageEntryCurrency(8,1)),$("#ba-raid-entrycost > span").tooltip({html:!0}),$("#ba-raid-duration").text(MathHelper.formatDuration(raid.BattleDuration[raid_difficulty])),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0);let a="";raid.EnemyList[raid_difficulty].forEach((function(e,t){const s=find(data.enemies,"Id",e)[0];null!=s.Icon?a+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon enemy-chibi"><img src="images/enemy/${s.Icon}.webp"></div><span>${getTranslatedString(s,"Name")}</span></a></li>`:a+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon"><img src="images/raid/icon/Icon_${raid.PathName}${raid_difficulty>=5?"_Insane":""}.png"></div><span>${getTranslatedString(s,"Name")}</span></a></li>`})),$("#raid-enemy-list .dropdown-menu").html(a),$("#raid-enemy-list").toggleClass("disabled",raid.EnemyList[raid_difficulty].length<=1),populateRaidSkills("#ba-raid-skills",raid.RaidSkill,raid_difficulty);let s="";find(data.items,"Id",70)[0].IsReleased[regionID]?(s+=`<table class="w-100"><thead class="text-center"><tr><th>${getLocalizedString("StageType","Raid")}</th><th>${getLocalizedString("StageType","EliminateRaid")}</th></tr></thead><tbody><tr><td><div class="item-icon-list">`,s+=getDropIconHTML(7,raid_reward_coin[raid_difficulty][0]),0!=raid_reward_coin[raid_difficulty][1]&&find(data.items,"Id",9)[0].IsReleased[regionID]&&(s+=getDropIconHTML(9,raid_reward_coin[raid_difficulty][1])),s+='</div></td><td><div class="item-icon-list">',find(data.items,"Id",70)[0].IsReleased[regionID]&&(s+=getDropIconHTML(70,raid_reward_coin[raid_difficulty][0]),0!=raid_reward_coin[raid_difficulty][1]&&(s+=getDropIconHTML(71,raid_reward_coin[raid_difficulty][1]))),s+="</div></td></tr></tbody>"):(s+='<div class="item-icon-list">',s+=getDropIconHTML(7,raid_reward_coin[raid_difficulty][0]),0!=raid_reward_coin[raid_difficulty][1]&&find(data.items,"Id",9)[0].IsReleased[regionID]&&(s+=getDropIconHTML(9,raid_reward_coin[raid_difficulty][1])),s+="</div>"),$("#ba-raid-rewards").html(s),$("#ba-raid-rewards .item-drop").each((e,t)=>{$(t).tooltip({html:!0})}),changeRaidEnemy(selectedEnemy)}function changeTimeAttackDifficulty(e){ta_difficulty=e;let t="",a="";$("#ba-timeattack-level").text(`Lv.${raid.EnemyLevel[ta_difficulty]}`),$("#ba-timeattack-entrycost").html(getStageEntryCurrency(17,1)),$("#ba-timeattack-entrycost > span").tooltip({html:!0}),$("#ba-timeattack-duration").text(MathHelper.formatDuration(raid.BattleDuration[ta_difficulty]));const s=["Minion","Elite","Champion","Boss"];raid.Formations[ta_difficulty].EnemyList.forEach((function(e,t){let i=find(data.enemies,"Id",raid.Formations[ta_difficulty].EnemyList[t])[0],l="Summoned"==i.Rank?0:s.indexOf(i.Rank);a+=getEnemyCardHTML(i,raid.Formations[ta_difficulty].Level[l],raid.Terrain,raid.Formations[ta_difficulty].Grade[l],1)})),$("#ba-stage-enemies").html(a),$("#ba-stage-enemies > :first").trigger("click"),raid.Rules[e].forEach(e=>{const a=find(data.raids.TimeAttackRules,"Id",e.Id)[0];""!=t&&(t+='<div class="ba-panel-separator"></div>'),t+=`<div class="d-flex flex-row align-items-start mt-2"><img class="ba-raid-skill d-inline-block me-3" src="images/timeattack/${a.Icon}.webp"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(a,"Name")}</h4><p class="mt-1 mb-2 p-1">${getSkillText({Desc:getTranslatedString(a,"Desc"),Parameters:e.Parameters?e.Parameters:[]},1,{})}</p></div></div></div>`}),$("#ba-timeattack-rules").empty().html(t),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function changeWorldRaidDifficulty(e){raid_difficulty=e;let t="";$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.PathName}_Lobby.png')`),$("#ba-raid-level").text(`Lv. ${raid.Level[raid_difficulty]}`),$("#ba-raid-entrycost").html(getStageEntryCurrency(raid.EntryCost[raid_difficulty][0],raid.EntryCost[raid_difficulty][1])),$("#ba-raid-entrycost > span").tooltip({html:!0}),$("#ba-raid-duration").text(MathHelper.formatDuration(raid.BattleDuration[raid_difficulty])),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0);let a="";raid.EnemyList[raid_difficulty].forEach((function(e,t){const s=find(data.enemies,"Id",e)[0];null!=s.Icon?a+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon enemy-chibi"><img src="images/enemy/${s.Icon}.webp"></div><span>${getTranslatedString(s,"Name")}</span></a></li>`:a+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon"><img src="images/raid/icon/Icon_${raid.PathName}.png"></div><span>${getTranslatedString(s,"Name")}</span></a></li>`})),$("#raid-enemy-list .dropdown-menu").html(a),$("#raid-enemy-list").toggleClass("disabled",raid.EnemyList[raid_difficulty].length<=1);const s=void 0!==raid.UseRaidSkillList?find(data.raids.Raid,"Id",raid.UseRaidSkillList)[0].RaidSkill:raid.RaidSkill;populateRaidSkills("#ba-raid-skills",s,raid_difficulty);let i="";const l=getServerProperty(raid,"Rewards");if(i+=`<h5 class="p-2">${translateUI("stage_original")}</h5><div class="item-icon-list">`,l[raid_difficulty].Items.forEach(e=>{i+=getDropIconHTML(e[0],e[1],e[2],e[2],!0)}),i+="</div>",raid.RewardsRerun){const e=getServerProperty(raid,"RewardsRerun");i+=`<h5 class="p-2">${translateUI("stage_rerun")}</h5><div class="item-icon-list">`,e[raid_difficulty].Items.forEach(e=>{i+=getDropIconHTML(e[0],e[1],e[2],e[2],!0)}),i+="</div>"}l[raid_difficulty].Groups.length>0&&(i+='<div class="item-icon-list mt-2">',l[raid_difficulty].Groups.forEach(e=>{itemsHtml="",e[0].forEach(e=>{itemsHtml+=getDropIconHTML(e[0],e[1],e[2],e[2],!0)});const t=Math.floor(e[1]),a=e[1]%1;let s=[];t>0&&s.push(`100&#37; (&times;${t})`),a>0&&s.push(`${getProbabilityText(a)} (&times;1)`),i+=`<div class="item-group">${itemsHtml}<span class="label-chance">${s.join(", ")}</span></div>`}),i+="</div>"),$("#ba-raid-rewards").html(i),$("#ba-raid-rewards .item-drop").tooltip({html:!0}),changeRaidEnemy(selectedEnemy)}function changeRaidFloor(e){multiFloorRaidFloor=raid.DifficultyStartFloor[raid_difficulty]-1+parseInt(e.value),$("#ba-raid-level").text(`Lv. ${raid.RaidFloors[multiFloorRaidFloor].Level}`),$("#multifloor-raid-floor-label").text(`${multiFloorRaidFloor+1}`),changeRaidEnemy(selectedEnemy)}function changeMultiFloorRaidDifficulty(e,t){raid_difficulty=e,multiFloorRaidFloor=raid.DifficultyStartFloor[raid_difficulty]-1,$("#multifloor-raid-floor-range").val(0).attr("max",raid.DifficultyStartFloor[raid_difficulty+1]-raid.DifficultyStartFloor[raid_difficulty]-1),$("#multifloor-raid-floor-label").text(`${multiFloorRaidFloor+1}`),$("#ba-raid-header").css("background-image",`url('images/raid/Boss_Portrait_${raid.PathName}_Lobby.png')`);const a=raid.RaidFloors[multiFloorRaidFloor].Level;$("#ba-raid-level").text(`Lv. ${a}`),selectedEnemy>=raid.EnemyList[raid_difficulty].length&&(selectedEnemy=0);let s="";raid.EnemyList[raid_difficulty].forEach((function(e,t){const a=find(data.enemies,"Id",e)[0];null!=a.Icon?s+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon enemy-chibi"><img src="images/enemy/${a.Icon}.webp"></div><span>${getTranslatedString(a,"Name")}</span></a></li>`:s+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-enemy-index="${t}" class="btn btn-dark"><div class="icon"><img src="images/raid/icon/Icon_${raid.PathName}.png"></div><span>${getTranslatedString(a,"Name")}</span></a></li>`})),$("#raid-enemy-list .dropdown-menu").html(s),$("#raid-enemy-list").toggleClass("disabled",raid.EnemyList[raid_difficulty].length<=1);const i=void 0!==raid.UseRaidSkillList?find(data.raids.Raid,"Id",raid.UseRaidSkillList)[0].RaidSkill:raid.RaidSkill;populateRaidSkills("#ba-raid-skills",i,raid_difficulty,!0),changeRaidEnemy(selectedEnemy)}function getStageEntryCurrency(e,t){const a=find(data.currency,"Id",e)[0];return`<span class="ba-info-pill bg-theme my-0 me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/item/icon/${a.Icon}.webp`,getTranslatedString(a,"Name").escapeHtml(),getLocalizedString("ItemCategory","Currency"),"",getTranslatedString(a,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img src="images/item/icon/${a.Icon}.webp" style="height:26px;width:auto;"><span class="label ps-0 text-bold">&times;${t}</span></span>`}function populateRaidSkills(e,t,a,s=!1){let i="";t.forEach(e=>{if(a<e.MinDifficulty||void 0!==e.MaxDifficulty&&a>e.MaxDifficulty)return;if(!1===e.ShowInfo)return;let t;switch(e.SkillType){case"EX":t=translateUI("student_skill_ex");break;case"Passive":t=translateUI("student_skill_passive");break;case"Public":t=translateUI("student_skill_normal");break;default:t="unknown"}""!=i&&(i+='<div class="ba-panel-separator"></div>'),i+=`<div class="d-flex flex-row align-items-center mt-2"><img class="ba-raid-skill ${s?"multifloor-skill":""} d-inline-block me-3" src="images/raid/skill/${e.Icon}.png"><div class="d-inline-block"><div><h4 class="me-2 d-inline">${getTranslatedString(e,"Name")}</h4></div><div class="mt-1"><p class="d-inline" style="font-style: italic;">${t}</p>${e.ATGCost>0?'<p class="d-inline text-bold"> ・ <i>ATG:</i> '+e.ATGCost+"</p>":""}</div></div></div><p class="mt-1 mb-2 p-1">${getSkillText(e,a+1,{emphasiseChange:!0})}</p>`}),$(e).empty().html(i).find(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").tooltip({html:!0})}function changeRaidEnemy(e){selectedEnemy=e;let t=find(data.enemies,"Id",raid.EnemyList[raid_difficulty][e])[0],a=1,s,i,l;raid.Id<1e3?(s=raid_level[raid_difficulty],i=raid_difficulty<5?raid.BulletType:raid.BulletTypeInsane,l=t.ArmorType):raid.Id<1e6?(s=raid.Level[raid_difficulty],i=raid_difficulty<5?raid.BulletType:raid.BulletTypeInsane,l=t.ArmorType):(s=raid.RaidFloors[multiFloorRaidFloor].Level,i=raid.BulletType[raid_difficulty],l=raid.ArmorType);let n=new CharacterStats(t,s,1,t.Transcendence?t.Transcendence:[]);if(raid.Id>=1e6&&t.Id in raid.RaidFloors[multiFloorRaidFloor].StatChange){const e=raid.RaidFloors[multiFloorRaidFloor].StatChange[t.Id];for(const t in e)n.addBuff(t,e[t])}raidEnemyStatList.forEach(e=>{if("AmmoCount"==e)$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text("Main"==t.SquadType?n.getBaseString("AmmoCount")+" ("+n.getBaseString("AmmoCost")+")":"-");else if("DefensePower"==e||"StabilityPoint"==e)$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).html(`<span class="has-tooltip">${n.getBaseString(e)}</span>`);else if("GroggyGauge"==e)if(t.GroggyGauge){let a="",s="";switch(t.ArmorType){case"LightArmor":s="Explosion";break;case"HeavyArmor":s="Pierce";break;case"Unarmed":s="Mystic";break;case"ElasticArmor":s="Sonic"}""!=s&&(a+=getLocalizedString("GroggyCondition","TypeDamage",[`<b class="ba-col-${s.toLowerCase()}">${getLocalizedString("BulletType",s)}</b>`]));const i=raid.PathName.split("_")[0];i in data.localization.GroggyCondition&&(a+=(""!=a?"\n":"")+getLocalizedString("GroggyCondition",i)),""!=a?($(`#ba-raid-enemy-stats .stat-${e} .stat-value`).html(`<span class="has-tooltip">${t.GroggyGauge.toLocaleString()}</span>`),$(".stat-GroggyGauge .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(a),html:!0,placement:"top"})):$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text(t.GroggyGauge.toLocaleString())}else $(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text("-");else"GroggyTime"==e?t.GroggyTime?$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text(translateUI("time_seconds",[t.GroggyTime/1e3])):$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text("-"):$(`#ba-raid-enemy-stats .stat-${e} .stat-value`).text(n.getTotalString(e))}),addRaidEnemyBonusStats(t.Id,n,raid_difficulty,"#ba-raid-enemy-stats");let r=translateUI("stat_defense_tooltip",[`<b>${n.getDefenseDamageReduction()}</b>`]);$("#ba-raid-enemy-stats .stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(r),html:!0,placement:"top"});let o=translateUI("stat_stability_tooltip",[`<b>${n.getStabilityMinDamage()}</b>`]);$("#ba-raid-enemy-stats .stat-StabilityPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(o),html:!0,placement:"top"}),$("#raid-enemy-list .dropdown-item").removeClass("active"),$(`#raid-enemy-list .dropdown-item[data-enemy-index="${e}"]`).addClass("active"),$("#raid-enemy-list .active-name").html(getTranslatedString(t,"Name")),null!=t.Icon?($("#ba-raid-enemy-icon div").toggleClass("icon-enemy",!0).toggleClass("icon-enemy-raid",!1),$("#ba-raid-enemy-icon img").attr("src",`images/enemy/${t.Icon}.webp`)):($("#ba-raid-enemy-icon div").toggleClass("icon-enemy",!1).toggleClass("icon-enemy-raid",!0),$("#ba-raid-enemy-icon img").attr("src",`images/raid/icon/Icon_${raid.PathName}${raid.Id<1e3&&raid_difficulty>=5?"_Insane":""}.png`)),$("#ba-raid-enemy-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",i)}`,translateUI("attacktype"),null,getAttackTypeText(i),32),placement:"top",html:!0}),setAttackTypeClass($("#ba-raid-enemy-attacktype .icon-type"),i),$("#ba-raid-enemy-attacktype .label").text(getLocalizedString("BulletType",i)),$("#ba-raid-enemy-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",l)}`,translateUI("defensetype"),null,getDefenseTypeText(l),32),placement:"top",html:!0}),setDefenseTypeClass($("#ba-raid-enemy-defensetype .icon-type"),l),$("#ba-raid-enemy-defensetype .label").text(getLocalizedString("ArmorType",l)),$("#ba-raid-enemy-size").toggle(null!=t.Size).find(".label").text(null!=t.Size?getLocalizedString("CharacterSize",t.Size):""),$("#ba-raid-enemy-name").html(getTranslatedString(t,"Name")),$("#ba-raid-enemy-icon").removeClass("elite champion boss").addClass(t.Rank.toLowerCase()),$("#ba-raid-enemy-level .label").text(`Lv.${s}`);const d=n.terrain[raid.Terrain[0]],c=adaptationAmount[d];$("#ba-raid-enemy-terrain .label").text(c),$("#ba-raid-enemy-terrain .icon-terrain-strength img").attr("src",`images/ui/Ingame_Emo_Adaptresult${c}.png`),$("#ba-raid-enemy-terrain").show().tooltip("dispose").tooltip({title:getRichTooltip(`images/ui/Ingame_Emo_Adaptresult${c}.png`,translateUI("terrain_adaption",[getLocalizedString("AdaptationType",raid.Terrain[0])])+" "+c,null,null,getAdaptationText(raid.Terrain[0],c),30),placement:"top",html:!0}),renderEnemySkills(t,$("#ba-raid-enemy-skills"))}function addRaidEnemyBonusStats(e,t,a,s){let i="",l="";const n=[0,1e3,2500,5e3,1e4,25e3,35e3];switch(e){case 7305701:t.addBuff("MaxHP_Base",1e5);case 7305601:case 7965031:l=t.getTotalString("MaxHP"),i+=`<div class="active-buff me-2"><img src="images/buff/Buff_MAXHP.webp" width="22" height="26" class=""></div><b>${t.getTotalString("MaxHP")}</b>`,t.addBuff("MaxHP_Coefficient",1e4),i+=`\n<div class="active-buff me-2"><img src="images/buff/Buff_MAXHP.webp" width="22" height="26" class=""><span class="stack-count">2</span></div><b>${t.getTotalString("MaxHP")}</b>`,t.addBuff("MaxHP_Coefficient",1e4),i+=`\n<div class="active-buff me-2"><img src="images/buff/Buff_MAXHP.webp" width="22" height="26" class=""><span class="stack-count">3</span></div><b>${t.getTotalString("MaxHP")}</b>`;break;case 7305101:case 7965002:4==a&&t.addBuff("MaxHP_Coefficient",11e3),l=t.getTotalString("MaxHP");break;case 610220107:t.addBuff("MaxHP_Coefficient",2e4);case 610220106:case 610220108:t.addBuff("MaxHP_Base",n[a]),l=t.getTotalString("MaxHP");break;default:l=t.getTotalString("MaxHP")}""!=i?($(`${s} .stat-MaxHP .stat-value`).html(`<span class="has-tooltip">${l}</span>`),$(`${s} .stat-MaxHP .has-tooltip`).tooltip("dispose").tooltip({title:getBasicTooltip(i),html:!0,placement:"top"})):$(`${s} .stat-MaxHP .stat-value`).text(l)}function loadStage(e){if("stages"==loadedModule){let t="";if(loadedStage&&$("#stage-select-"+loadedStage.Id).removeClass("selected"),e>=7e6){const a=parseInt(String(e).slice(0,3));if(conquest_events.includes(a)){t="Conquest",stages=find(data.stages.Conquest,"Id",e),0==stages.length&&(tiles=[],data.stages.ConquestMap.forEach(t=>{t.Maps.forEach(t=>{tiles.push(...find(t.Tiles,"Id",e))})}),stages=find(data.stages.Conquest,"Id",tiles.length>0?tiles[0].StageId:81511211)),stage=stages[0],loadedStage=stage,loadedStageList!=""+stage.EventId%1e4&&populateEventStageList(stage.EventId);const a=`#ba-conquest-step-${"VeryHard"==stage.Difficulty?"c":"n"}${stage.Step}`;$(a).hasClass("active")||$(a).tab("show").trigger("click"),$(".ba-stage-map-tile").removeClass("selected"),$(`.ba-stage-map-tile[data-stage-id="${stage.Id}"]`).addClass("selected")}else t="Event",stage=findOrDefault(data.stages.Event,"Id",e,8012301)[0],stage.Field&&(t="Field"),loadedStage=stage,loadedStageList!=""+stage.EventId%1e4&&populateEventStageList(stage.EventId)}else e>=1e6?(t="Campaign",stage=findOrDefault(data.stages.Campaign,"Id",e,1011101)[0],loadedStage=stage,"missions"!=loadedStageList&&populateStageList("missions")):e>=6e4?(t="SchoolDungeon",stage=findOrDefault(data.stages.SchoolDungeon,"Id",e,60101)[0],loadedStage=stage,"schooldungeon"!=loadedStageList&&populateStageList("schooldungeon")):e>=31e3?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,31101)[0],loadedStage=stage,"commissions"!=loadedStageList&&populateStageList("commissions")):e>=3e4?(t="WeekDungeon",stage=findOrDefault(data.stages.WeekDungeon,"Id",e,30101)[0],loadedStage=stage,"bounty"!=loadedStageList&&populateStageList("bounty")):(t="Campaign",stage=find(data.stages.Campaign,"Id",1011101)[0],loadedStage=stage,"missions"!=loadedStageList&&populateStageList("missions"));if($("#ba-stage-drops-tabs").toggle("WeekDungeon"!=t),"WeekDungeon"==t&&$("#ba-stage-drops-default-tab").tab("show"),$("#ba-stage-tab-conquest").toggle("Conquest"==t),$("#ba-stage-tab-map").toggle("Conquest"!=t),"Event"!=t&&"Field"!=t||701==stage.EventId)$("#stage-version-list").hide();else{let e="",t=[];if(stage.Versions.forEach(a=>{let s;switch(a){case"Rerun":s=1e4+stage.EventId;break;case"Permanent":s=5e4+stage.EventId;break;default:s=stage.EventId}region.Events.includes(s)&&(t.push(a),e+=`<li><a class="dropdown-item" href="javascript:;" class="btn btn-dark" data-version="${a}"><span>${translateUI("stage_"+a.toLowerCase())}</span></a></li>`)}),!t.includes(loadedStageVersion))if(t.length>0)loadedStageVersion=t[0];else{const t=stage.Versions[0];loadedStageVersion=t,e+=`<li><a class="dropdown-item" href="javascript:;" class="btn btn-dark" data-version="${t}"><span>${translateUI("stage_"+t.toLowerCase())}</span></a></li>`,showReleaseWarning()}$("#stage-version-list .dropdown-menu").html(e),$("#stage-version-list").show(),$(`#stage-version-list .dropdown-item[data-version="${loadedStageVersion}"`).toggleClass("active",!0),$("#stage-version-list button .label").text(translateUI("stage_"+loadedStageVersion.toLowerCase()))}"Conquest"!=t&&$("#ba-stage-tab-conquest").hasClass("active")&&$("#ba-stage-tab-enemies").tab("show"),$("#ba-stage-name").html(getStageName(stage,t)),$("#ba-stage-title").html(getStageTitle(stage,t)),$("#ba-stage-level").text(translateUI("rec_level")+" Lv."+getServerProperty(stage,"Level")),$("#ba-stage-terrain-img").attr("src",`images/ui/Terrain_${stage.Terrain}.png`),$("#ba-stage-fog").toggle("Campaign"==t&&1==stage.Difficulty);const a=["Default","FirstClear","ThreeStar"];let s="",i=getVersionProperty(stage,"Rewards",loadedStageVersion),l=region.Name in i?i[region.Name]:i.Jp;const n=[];a.forEach(e=>{if(e in l&&l[e].length>0){let a=null;"Conquest"==t?"Default"!=e||stage.SubStage?("FirstClear"==e||stage.SubStage)&&(a=translateUI("conquest_occupy")):a=getConquestManageString(stage.EventId):"FirstClear"==e&&(a=translateUI("stage_reward_firstclear")),"ThreeStar"==e&&(a='<i class="fa-solid fa-star"></i>'.repeat(3)),l[e].forEach(i=>{const l="FindGift"==stage.Type?i[2]:1;s+=getDropIconHTML(i[0],i[1],l,l,!1,a),"Default"==e&&("Event"==t||"Conquest"==t)&&811!=stage.EventId&&i[1]>=1&&i[0]>=8e4&&i[0]<9e4&&n.push(i)})}});const r=getVersionProperty(stage,"HexaMap",loadedStageVersion),o=getVersionProperty(stage,"StarCondition",loadedStageVersion),d=getVersionProperty(stage,"ChallengeCondition",loadedStageVersion);if(n.length){if(showEventCurrencyBonus){const e=r?r.filter(e=>e.Entity<=101105).length:1;for(reward of n){const a=find(data.items,"Id",reward[0])[0];let i=0,l="",n=getServerProperty(a,"EventBonus");if("Event"==t){const t={Main:Array(4*e).fill(0),Support:Array(2*e).fill(0)},a={Main:Array(4*e).fill(null),Support:Array(2*e).fill(null)};for(bonus of n)if(1==showEventCurrencyBonus||bonus[0]in studentCollection){const e=find(data.students,"Id",bonus[0])[0];for(let s=0;s<t[e.SquadType].length;s++)if(bonus[1]>t[e.SquadType][s]){t[e.SquadType][s]=bonus[1],a[e.SquadType][s]=e.Id;break}}for(type in i=t.Main.concat(t.Support).sum(),a)for(let e=0;e<a[type].length;e++)null!=a[type][e]&&(l+=`<img class="inline-student-img" src="images/student/icon/${a[type][e]}.webp">`)}else if("Conquest"==t)if(1==showEventCurrencyBonus)i=12e3;else{const e={Main:0,Support:0};for(studentId in studentCollection){const t=find(data.students,"Id",studentId)[0];stage.SchoolBuff[0].includes(t.School)&&(e[t.SquadType]+=1)}i=Math.min(4e3*Math.floor((e.Main+e.Support)/2),12e3)}const r=Math.ceil(reward[1]*(i/1e4));r>0&&(s+=getDropIconHTML(reward[0],r,1,1,!1,translateUI("stage_reward_bonus"),""!=l?`\n\n<i>${translateUI("max_bonus_amount",["+"+i/100+"%"])}</i>\n${l}`:""))}}$("#stage-include-bonus").show(),$("#stage-include-bonus-list .dropdown-item").toggleClass("active",!1);const e=$(`#stage-include-bonus-list .dropdown-item[data-option="${showEventCurrencyBonus}"`);e.toggleClass("active",!0),$("#stage-include-bonus-list button .label").text(e.text())}else $("#stage-include-bonus").hide();if("Conquest"==t){const e=1+stage.UpgradeCost.length;let t="",a="Base";(stage.SubStage||"Challenge"==stage.EnemyType)&&(a="Battle"),"Boss"==stage.EnemyType&&(a="Boss"),t+=`<table class="w-100"><thead class="text-center"><tr><th></th><th>${translateUI("base_upgrade_cost")}</th><th>${translateUI("rewards")}</th><th>${translateUI("base_settlement")}</th></tr></thead><tbody>`;for(let s=0;s<e;s++)t+="<tr>",t+=`<td><img src="images/conquest/Conquest_${stage.EventId}_Img_Tile_${a}_${s+1}${"Challenge"==stage.EnemyType?"_Challenge":""}.png" style="height:80px;"><b class="p-2">Lv. ${s+1}</b></td>`,t+='<td><div class="item-icon-list">',s>0&&s-1<stage.UpgradeCost.length&&(t+=getDropIconHTML(stage.UpgradeCost[s-1][0],stage.UpgradeCost[s-1][1],1,1)),t+="</div></td>",t+='<td><div class="item-icon-list">',l[`Upgrade${s+1}`]&&l[`Upgrade${s+1}`].forEach(e=>{t+=getDropIconHTML(e[0],e[1],1,1)}),t+="</div></td>",t+='<td><div class="item-icon-list">',l.Calculate[s].forEach(e=>{t+=getDropIconHTML(e[0],e[1],1,1)}),t+="</div></td>",t+="</tr>";if(t+="</tbody></table>",$("#conquest-tile-info").html(t).find(".item-drop").tooltip({html:!0}),"SchoolBuff"in stage){let e="",t="";if(stage.SchoolBuff[0].forEach(e=>{t+=`<span class="school-bonus-icon"><img class="invert-light" src="images/schoolicon/School_Icon_${e.toUpperCase()}_W.png"></span>`}),""!=t&&(e+=`<div class="p-2"><p class="mb-2 text-center">${getConquestManageString(stage.EventId)}</p><div class="school-bonus-list">${t}</div></div>`),t="",stage.SchoolBuff[1].forEach(e=>{t+=`<span class="school-bonus-icon"><img class="invert-light" src="images/schoolicon/School_Icon_${e.toUpperCase()}_W.png"></span>`}),""!=t&&(e+=`<div class="p-2"><p class="mb-2 text-center">${translateUI("conquest_occupy")}</p><div class="school-bonus-list">${t}</div></div>`),$("#conquest-school-bonus-list").html(`<div class="d-flex justify-content-center gap-2">${e}</div>`),""!=e){let e="";e+='<div class="ba-panel-separator my-2"></div>';for(let t=1;t<=3;t++)e+=`<p class="mb-0"><b>${translateUI("school_bonus_num_students",[2*t])}</b>${translateUI("school_bonus_conquest",[40*t,50*t,getConquestManageString(stage.EventId)])}</p>`;$("#conquest-school-bonus-list").append(e)}$("#conquest-school-bonus").toggle(""!=e)}else $("#conquest-school-bonus").hide()}""!=s?($("#ba-stage-drops").html(`<div class="item-icon-list">${s}</div>`),"FindGift"==stage.Type&&$("#ba-stage-drops").prepend(`<i class="d-block mb-2">${translateUI("rewards_findgift_msg")}</i><div class="d-flex flex-wrap justify-content-center"></div>`),$("#ba-stage-drops .item-drop").each((function(e,t){$(t).tooltip({html:!0})}))):$("#ba-stage-drops").html(`<div class="d-flex flex-wrap justify-content-center"><span class="pb-0 text-center">${translateUI("rewards_none")}</span></div>`);let c="",u={};const g=["Minion","Elite","Champion","Boss"],p=getVersionServerProperty(stage,"Formations",loadedStageVersion);p.length?($("#ba-stage-enemy-list, #ba-stage-enemy-info").show(),p.forEach(e=>{for(let t=0;t<e.EnemyList.length;t++){let a=find(data.enemies,"Id",e.EnemyList[t])[0],s=g.indexOf(a.Rank);u[`${4-s}_${a.Id}_${e.Level[s]}_${e.Grade[s]}`]=a}}),Object.keys(u).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],c+=getEnemyCardHTML(u[e],e_level,stage.Terrain,e_grade)}),$("#ba-stage-enemies").html(c),$("#ba-stage-enemies > :first").trigger("click")):$("#ba-stage-enemy-list, #ba-stage-enemy-info").hide(),conditionsHtml="";const m='<i class="fa-solid fa-star me-2 stage-star"></i>',f='<i class="fa-solid fa-clipboard-list me-2 stage-challenge"></i>';r?($("#ba-stage-tab-map").toggleClass("disabled",!1),drawHexamap(stage,"#ba-stage-map-canvas"),conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_complete")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_sranks",[o[0]])}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_clearturns",[o[1]])}</span></div>`):($("#ba-stage-tab-map").hasClass("active")&&$("#ba-stage-tab-enemies").tab("show"),$("#ba-stage-tab-map").toggleClass("disabled",!0),"Campaign"==t||"Event"==t?(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_defeatall")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_defeatalltime",[o[0]])}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_allsurvive")}</span></div>`):"Conquest"==t?stage.SubStage||(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_defeatall")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_defeatalltime",[o[1]])}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_allsurvive")}</span></div>`):stage.Type&&("Chaser"==stage.Type.slice(0,6)?(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_clear")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_allsurvive")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_cleartime",["150"])}</span></div>`):"Blood"==stage.Type?(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_clear")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_allsurvive")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_cleartime",["120"])}</span></div>`):"FindGift"==stage.Type?(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_earnrewards",["1"])}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_earnrewards",["4"])}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_earnrewards",["5"])}</span></div>`):"School"==stage.Type.slice(0,6)&&(conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_clear")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_allsurvive")}</span></div>`,conditionsHtml+=`<div>${m}<span>${translateUI("starcondition_cleartime",["120"])}</span></div>`))),void 0!==d&&d.length>0&&(conditionsHtml+='<div class="ba-panel-separator my-2"></div>',d.forEach(e=>{switch(e[0]){case"Turns":conditionsHtml+=`<div>${f}<span>${translateUI("starcondition_clearturns",[e[1]])}</span></div>`;break;case"Time":conditionsHtml+=`<div>${f}<span>${translateUI("starcondition_cleartime",[e[1]])}</span></div>`}})),$("#ba-stage-conditions").toggle(""!=conditionsHtml).html(`<div class="d-flex flex-column">${conditionsHtml}</div>`),c="";let h=getVersionProperty(stage,"EntryCost",loadedStageVersion);h&&h.length>0&&h.forEach((e,a)=>{let s;s=e[0]<100?find(data.currency,"Id",e[0])[0]:find(data.items,"Id",e[0])[0];let i="";"Conquest"==t&&(i=0==a?` (${translateUI("conquest_occupy")})`:` (${getConquestManageString(stage.EventId)})`),c+=`<span class="ba-info-pill bg-theme my-0" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/item/icon/${s.Icon}.webp`,getTranslatedString(s,"Name").escapeHtml(),getLocalizedString("ItemCategory","Currency"),"",getTranslatedString(s,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img src="images/item/icon/${s.Icon}.webp" style="height:26px;width:auto;"><span class="label ps-0 text-bold">&times;${e[1]}${i}</span></span>`}),$("#ba-stage-entrycost").html(c),$("#ba-stage-entrycost >span").tooltip({html:!0}),$("#ba-stage-map-enemies").html(`<p class="grid-text">${translateUI("maptile_enemy_default_msg")}</p>`),$("#stage-select-"+stage.Id).addClass("selected"),finalizeLoad($("#ba-stage-title").text(),"stage",stage.Id,"View Stage",e)}else loadModule("stages",e)}function changeStageVersion(e){loadedStageVersion=e,loadStage(loadedStage.Id)}function getVersionProperty(e,t,a){return e.VersionData&&a in e.VersionData&&t in e.VersionData[a]?e.VersionData[a][t]:e[t]}function getVersionServerProperty(e,t,a){const s=region.Name;return e.VersionData&&a in e.VersionData&&t in e.VersionData[a]?getSuffixedProperty(e.VersionData[a],t,s):getSuffixedProperty(e,t,s)}function getServerProperty(e,t){const a=region.Name;return getSuffixedProperty(e,t,a)}function getSuffixedProperty(e,t,a){return a&&t+a in e?e[t+a]:e[t]}function populateEnemyList(e,t){let a="",s={};const i=["Minion","Elite","Champion","Boss"];t.forEach(e=>{for(let t=0;t<e.EnemyList.length;t++){let a=find(data.enemies,"Id",e.EnemyList[t])[0],l=i.indexOf(a.Rank);s[`${4-l}_${a.Id}_${e.Level[l]}_${e.Grade[l]}`]=a}}),Object.keys(s).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],a+=getEnemyCardHTML(s[e],e_level,loadedStage.Terrain,e_grade)}),$(e).html(a),$(e).children().first().trigger("click")}function getStageName(e,t,a=!1){switch(t){case"Event":return`${a?"":getLocalizedString("EventName",""+e.EventId%1e4)+" "}${0==e.Difficulty?getLocalizedString("StageType","Story"):1==e.Difficulty?getLocalizedString("StageType","Quest"):getLocalizedString("StageType","Challenge")} ${e.Stage.toString().padStart(2,"0")}`;case"Field":return`${a?"":getLocalizedString("EventName",""+e.EventId%1e4)+" "}${getLocalizedString("StageType","Field",[e.Area])}`;case"Campaign":return`${e.Area}-${e.Stage} ${1==e.Difficulty?getLocalizedString("StageType","Hard"):getLocalizedString("StageType","Normal")}`;case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageType",e.Type)}`;case"Conquest":return`${getLocalizedString("ConquestMap",e.EventId)}`}return console.log(`No name definition for stage type ${t}`),"undefined!!!"}function getStageTitle(e,t){switch(t){case"Event":case"Campaign":case"Conquest":case"Field":return getTranslatedString(e,"Name");case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,String.fromCharCode(64+e.Stage))}`}return console.log(`No title definition for stage type ${t}`),"undefined!!!"}function getEventStage(e){let t=e.toString().slice(0,3),a=find(data.stages.events,"Id",t);if(a.length>0){let t=find(a[0].Stages,"Id",e);if(t.length>0)return t[0]}return data.stages.events[0].Stages[0]}function loadRegion(e){if(regionID=e,region=data.config.Regions[regionID],"students"==loadedModule){$(".statpreview-level").attr("max",region.StudentMaxLevel),$("#ba-statpreview-level-modal").text(`Lv.1 / ${region.StudentMaxLevel}`),$("#ba-weaponpreview-levelrange, #ba-statpreview-weapon-range").attr("max",region.WeaponMaxLevel),0==region.WeaponMaxLevel&&($("#ba-student-nav-weapon").hide(),$("#ba-statpreview-weapon-container").hide(),$(".weaponpreview-star-1").hide(),$(".weaponpreview-star-2").hide(),$(".weaponpreview-star-3").hide(),statPreviewWeaponGrade=0,$("#ba-student-search-filter-streetbattleadaptation-5").hide(),$("#ba-student-search-filter-outdoorbattleadaptation-5").hide(),$("#ba-student-search-filter-indoorbattleadaptation-5").hide(),$("#ba-student-search-filter-terrainupgrades").hide(),$("#ba-student-search-select-weaponpassivebuff").hide(),$("#ba-student-tab-weapon").hide(),$("#item-search-filter-equipmentcategory-weaponexpgrowth").hide()),$("#ba-bond-levelrange").attr("max",region.BondMaxLevel),$("#ba-statpreview-gear1-range").attr("max",region.EquipmentMaxLevel[0]),$("#ba-statpreview-gear2-range").attr("max",region.EquipmentMaxLevel[1]),$("#ba-statpreview-gear3-range").attr("max",region.EquipmentMaxLevel[2]),$("#ba-statpreview-potential-container").toggle(region.PotentialMax>0),$("#ba-statpreview-potential input").attr("max",region.PotentialMax),$("#ba-student-search-filter-bullettype-sonic").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Sonic"==e.BulletType)),$("#ba-student-search-filter-armortype-elasticarmor").toggle(studentList.some(e=>e.IsReleased[regionID]&&"ElasticArmor"==e.ArmorType)),$("#ba-student-search-filter-tacticrole-vehicle").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Vehicle"==e.TacticRole)),$("#ba-student-search-filter-school-valkyrie").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Valkyrie"==e.School)),$("#ba-student-search-filter-school-etc").toggle(studentList.some(e=>e.IsReleased[regionID]&&"ETC"==e.School)),$("#ba-student-search-filter-school-srt").toggle(studentList.some(e=>e.IsReleased[regionID]&&"SRT"==e.School)),$("#ba-student-search-filter-school-arius").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Arius"==e.School)),$("#ba-student-search-filter-school-tokiwadai").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Tokiwadai"==e.School)),$("#ba-student-search-filter-school-sakugawa").toggle(studentList.some(e=>e.IsReleased[regionID]&&"Sakugawa"==e.School)),$("#ba-student-search-filter-weapontype-rl").toggle(studentList.some(e=>e.IsReleased[regionID]&&"RL"==e.WeaponType)),$("#ba-student-search-filter-weapontype-ft").toggle(studentList.some(e=>e.IsReleased[regionID]&&"FT"==e.WeaponType));const e=studentList.some(e=>e.IsReleased[regionID]&&void 0!==e.Gear.Released&&e.Gear.Released[regionID]);$("#ba-student-search-filter-bondgear").toggle(e),$("#ba-student-gear-separator").toggle(e),$("#ba-student-gear-4").toggle(e)}if("items"==loadedModule)for(let e=101;e<=data.config.Regions[0].FurnitureSetMax;e++)$(`#item-search-filter-furnitureset-${e}`).toggle(e<=region.FurnitureSetMax)}function getAdaptationText(e,t){return translateUI("terrain_adaption_details",[terrain_dmg_bonus[t],getLocalizedString("AdaptationType",e).toLowerCase(),terrain_block_bonus[t]])}function getStatName(e){return getLocalizedString("Stat",e.replace("_Coefficient","").replace("_Base","").replace("100","").replace("1",""))}function getFormattedStatAmount(e){return Number.isInteger(e)?e:`${parseFloat((100*e).toFixed(2))}%`}function changeGearLevel(e,t,a=!0){const s=student.Equipment[e-1],i=parseInt(t.value),l=find(data.equipment,"Id",gearId[s]+i-1)[0];statPreviewEquipment[e-1]=i,$(`#ba-statpreview-gear${e}-icon`).attr("src",`images/equipment/icon/${l.Icon}.webp`),$(`#ba-statpreview-gear${e}-level`).text(`T${i}`),$(`#ba-statpreview-gear${e}-name`).text(getTranslatedString(l,"Name")),$(`#ba-statpreview-gear${e}-description`).html(getGearStatsText(l)),statPreviewIncludeEquipment&&(a&&recalculateStatsWithDelay(),updateGearIcon())}function changePotentialLevel(e,t,a=!0){const s=parseInt(t.value);statPreviewPotentialLevel[e]=s,$(`#ba-statpreview-potential-${e.toLowerCase()}-level`).text(`Lv.${s}`),$(`#ba-statpreview-potential-${e.toLowerCase()}-description`).html(`${getStatName(e)} +<b>${CharacterStats.getPotentialStatAmount(student,e,statPreviewLevel,s)}</b>`),a&&statPreviewIncludePotential&&recalculateStatsWithDelay()}function getEquipmentId(e,t){return find(data.equipment,"Category",e)[t-1]}function getGearStatsText(e,t=", "){let a=[];for(let t=0;t<e.StatType.length;t++){let s=e.StatValue[t][1];"Coefficient"==e.StatType[t].split("_")[1]&&(s=parseFloat((s/100).toFixed(2))+"%"),a.push(`${getStatName(e.StatType[t])} +<b>${s}</b>`)}return a.join(t)}function toggleStrikerBonus(){statPreviewViewSupportStats=!statPreviewViewSupportStats,statPreviewViewSupportStats&&statPreviewSelectedChar>0&&changeStudentSummon(0,!1),$("#ba-student-stat-table").toggleClass("striker-bonus",statPreviewViewSupportStats),$("#ba-statpreview-status-strikerbonus").toggleClass("deactivated",!statPreviewViewSupportStats),recalculateStats()}function toggleGear(){statPreviewIncludeEquipment=!statPreviewIncludeEquipment,$("#ba-statpreview-status-equipment").toggleClass("deactivated",!statPreviewIncludeEquipment),$("#ba-statpreview-gear").toggleClass("disabled",!statPreviewIncludeEquipment),$("#ba-statpreview-gear-toggle").toggleClass("checked",statPreviewIncludeEquipment),$("#ba-statpreview-gear input").prop("disabled",!statPreviewIncludeEquipment),updateGearIcon(),recalculateStats()}function togglePotential(){statPreviewIncludePotential=!statPreviewIncludePotential,$("#ba-statpreview-potential").toggleClass("disabled",!statPreviewIncludePotential),$("#ba-statpreview-potential-toggle").toggleClass("checked",statPreviewIncludePotential),$("#ba-statpreview-potential input").prop("disabled",!statPreviewIncludePotential),recalculateStats()}function toggleBuffs(){statPreviewIncludeBuffs=!statPreviewIncludeBuffs,$("#ba-statpreview-status-buffs").toggleClass("deactivated",!statPreviewIncludeBuffs),$("#ba-statpreview-buff-toggle").toggleClass("checked",statPreviewIncludeBuffs),statPreviewExternalBuffs.toggleDisabled(!statPreviewIncludeBuffs),recalculateStats()}function toggleBond(e){statPreviewIncludeBond[e]=!statPreviewIncludeBond[e],$(`#ba-statpreview-status-bond-${e}-toggle`).toggleClass("deactivated",!statPreviewIncludeBond[e]),$(`#ba-statpreview-bond-${e}-toggle`).toggleClass("checked",statPreviewIncludeBond[e]),$(`#ba-statpreview-bond-${e}`).toggleClass("disabled",!statPreviewIncludeBond[e]),$(`#ba-statpreview-bond-${e} input`).prop("disabled",!statPreviewIncludeBond[e]),recalculateStats()}function togglePassiveSkill(){statPreviewIncludePassive=!statPreviewIncludePassive,$("#ba-statpreview-status-passive-level").toggleClass("deactivated",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill-toggle").toggleClass("checked",statPreviewIncludePassive),$("#ba-statpreview-passiveskill").toggleClass("disabled",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill input").prop("disabled",!statPreviewIncludePassive),recalculateStats()}function toggleTSAStats(){statPreviewTSAStats.enabled=!statPreviewTSAStats.enabled,$("#ba-statpreview-tsastats-toggle").toggleClass("checked",statPreviewTSAStats.enabled),$("#statpreview-tsastats-controls .ba-panel").toggleClass("disabled",!statPreviewTSAStats.enabled),statPreviewSelectedChar>0&&$("#calculation-student-skills .skill-info-tsa").toggle(statPreviewTSAStats.enabled),recalculateStats()}function changeExGearLevel(e,t=!0){const a=parseInt(e.value);statPreviewGearLevel=a,$("#ba-statpreview-gear4-detail").toggleClass("disabled",0==statPreviewGearLevel),$("#ba-statpreview-gear4-level").text(statPreviewGearLevel>0?`T${a}`:translateUI("setting_off")),0==statPreviewSelectedChar&&($("#calculation-student-skills .skill-info-gearnormal").toggle(statPreviewGearLevel>=2),$("#calculation-student-skills .skill-info-normal").toggle(statPreviewGearLevel<2)),updateGearIcon(),statPreviewExternalBuffs.toggleUpgrades(statPreviewGearLevel>=2),t&&recalculateStatsWithDelay()}function changeStatPreviewLevel(e,t=!0){const a=parseInt(e.value);if($(".statpreview-level").val(a),$("#ba-statpreview-level").text("Lv."+a),$("#ba-statpreview-level-modal").text(`Lv.${a} / ${e.max}`),statPreviewIncludeEquipment)for(let e=0;e<3;e++)$(`#ba-statpreview-gear${e+1}`).toggleClass("disabled",a<gear_minlevelreq[e]),$(`#ba-statpreview-gear${e+1}-range`).prop("disabled",a<gear_minlevelreq[e]);if(statPreviewIncludePotential)for(const e in statPreviewPotentialLevel)$(`#ba-statpreview-potential-${e.toLowerCase()}`).toggleClass("disabled",a<90),$(`#ba-statpreview-potential-${e.toLowerCase()}-range`).prop("disabled",a<90);statPreviewLevel=a,t&&recalculateStatsWithDelay()}function changeGearSkillPreviewLevel(e){e.value==e.max?$("#ba-gear-skill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-gear-skill-level").html("Lv."+e.value),recalculateGearSkillPreview()}function changeWeaponSkillPreviewLevel(e){e.value==e.max?$("#ba-weapon-skill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-weapon-skill-level").html("Lv."+e.value),recalculateWeaponSkillPreview()}function changeWeaponPreviewLevel(e){$("#ba-weaponpreview-level").text("Lv."+e.value),recalculateWeaponPreview()}function changeStatPreviewBondLevel(e,t=!0){const a=parseInt($(`#ba-statpreview-bond-${e}-range`).val());$(`#ba-statpreview-bond-${e}-level`).html(`<i class="fa-solid fa-heart me-1"></i> ${a}`),$(`#ba-statpreview-status-bond-${e}-toggle .label`).html(a);const s=Object.entries(getBondStats(0==e?student:student_bondalts[e-1],a));statPreviewBondLevel[e]=a,$(`#ba-statpreview-bond-${e}-description`).html(`${getStatName(s[0][0])} <b>+${getFormattedStatAmount(s[0][1])}</b>, ${getStatName(s[1][0])} <b>+${getFormattedStatAmount(s[1][1])}</b>`),t&&recalculateStatsWithDelay()}function changeStatPreviewWeaponLevel(e){updateWeaponLevelStatPreview(e.value),recalculateStatsWithDelay()}function updateWeaponLevelStatPreview(e){$("#ba-statpreview-weapon-level, #ba-student-weapon-level").html("Lv."+e);let t=getWeaponStats(student,e),a="";$(Object.entries(t)).each((function(e,t){t[1]>0&&(a+=`${getStatName(t[0])} <b>+${getFormattedStatAmount(t[1])}</b>, `)})),statPreviewWeaponLevel=parseInt(e),$("#ba-statpreview-weapon-description").html(a.substring(0,a.length-2))}function changeStatPreviewPassiveSkillLevel(e,t=!0){e.value==e.max?$("#ba-statpreview-passiveskill-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-statpreview-passiveskill-level").html("Lv."+e.value),statPreviewPassiveLevel=parseInt(e.value),updatePassiveSkillStatPreview(),t&&recalculateStatsWithDelay()}function changeStatPreviewSummonSourceSkillLevel(e,t=!0){statPreviewExLevel=parseInt(e.value),updateSummonSourceSkill(),t&&recalculateStatsWithDelay()}function getBondTargetsHTML(e,t){return`<div><div id="ba-statpreview-bond-${e}-toggle" class="d-flex header-toggle" onclick="toggleBond(${e})">\n    <h5 class="flex-fill">${translateUI("student_bond")}</h5>\n    <i class="fa-regular fa-square off"></i>\n    <i class="fa-solid fa-square-check on"></i></div>\n    <div id="ba-statpreview-bond-${e}" class="p-2 mb-2 ba-panel"><div class="mb-1 d-flex flex-row align-items-center"><div class="ba-bond-icon me-2" style="position: relative;"><img src="images/student/icon/${t.Id}.webp"></div><div class="flex-fill"><h5>${getTranslatedString(t,"Name")}</h5><p id="ba-statpreview-bond-${e}-description" class="mb-0" style="font-size: 0.875rem; line-height: 1rem;"></p></div></div><div class="d-flex flex-row align-items-center"><input id="ba-statpreview-bond-${e}-range" oninput="changeStatPreviewBondLevel(${e})" type="range" class="form-range statpreview-bond me-2 flex-fill" value="${statPreviewBondLevel[e]}" min="1" max="${region.BondMaxLevel}"><span id="ba-statpreview-bond-${e}-level" class="ba-slider-label"></span></div></div></div>`}function getBondToggleHTML(e,t){return`<button id="ba-statpreview-status-bond-${e}-toggle" onclick="toggleBond(${e})" class="btn-pill tooltip-button">\n    <div class="icon bond-small"><img src="images/student/icon/${t.Id}.webp" width="28" height="28"></div>\n    <span class="label ps-2"></span>\n    </button>`}function changeBondLevel(e){$("#ba-bond-level").html(e.value),recalculateBondPreview()}function updateGearIcon(){let e,t,a="";for(let s=1;s<=3;s++)t=statPreviewIncludeEquipment?$(`#ba-statpreview-gear${s}-range`).val():1,a+=(""==a?"":" / ")+"T"+$(`#ba-statpreview-gear${s}-range`).val(),e=find(data.equipment,"Id",gearId[student.Equipment[s-1]]+(t-1))[0],$(`#ba-student-gear-${s}-icon`).attr("src",`images/equipment/icon/${e.Icon}.webp`).tooltip("dispose").tooltip({title:getRichTooltip(`images/equipment/icon/${e.Icon}.webp`,getTranslatedString(e,"Name").escapeHtml(),getLocalizedString("ItemCategory",e.Category),`T${t}`,getTranslatedString(e,"Desc").escapeHtml()+`\n\n<b>${translateUI("stat_info")}:</b>\n`+getGearStatsText(e,"\n"),50,"img-scale-larger"),placement:"top",html:!0}).toggleClass("gear-disabled",!statPreviewIncludeEquipment),$(`#ba-student-gear-${s}-icon`).attr("onclick",`loadItem(${e.Id+2e6})`);"Released"in student.Gear&&student.Gear.Released[regionID]&&$("#ba-student-gear-4-icon").toggleClass("gear-disabled",0==statPreviewGearLevel||!statPreviewIncludeEquipment)}function recalculateTerrainAffinity(){let e,t="";["Street","Outdoor","Indoor"].forEach(e=>{const a=student[`${e}BattleAdaptation`]+(5==statPreviewStarGrade&&statPreviewWeaponGrade>=3&&student.Weapon.AdaptationType==e?student.Weapon.AdaptationValue:0),s=adaptationAmount[a];$(`#ba-student-terrain-${e.toLowerCase()}-icon`).attr("src",`images/ui/Ingame_Emo_Adaptresult${s}.png`),$(`#ba-student-terrain-${e.toLowerCase()}`).tooltip("dispose").tooltip({title:getRichTooltip(`images/ui/Ingame_Emo_Adaptresult${s}.png`,translateUI("terrain_adaption",[getLocalizedString("AdaptationType",e)])+" "+s,null,null,getAdaptationText(e,s),30),placement:"top",html:!0}),t+=`<li><a class="dropdown-item dropdown-item-icon" href="javascript:;" data-terrain="${e}" class="btn btn-dark"><div class="icon"><img class="invert-light" src="images/ui/Terrain_${e}.png"></div><span class="me-4">${getLocalizedString("AdaptationType",e)}</span><div class="icon ms-auto me-0"><img style="padding:2px;border-radius:0!important;" src="images/ui/Ingame_Emo_Adaptresult${s}.png"></div></a></li>`}),$(".terrain-list .dropdown-menu").html(t)}function recalculateWeaponPreview(){let e=$("#ba-weaponpreview-levelrange").val(),t=getWeaponStats(student,e);$("#ba-weapon-stat-table .stat-AttackPower .stat-value").text("+"+t.AttackPower.toLocaleString()),$("#ba-weapon-stat-table .stat-MaxHP .stat-value").text("+"+t.MaxHP.toLocaleString()),$("#ba-weapon-stat-table .stat-HealPower .stat-value").text("+"+t.HealPower.toLocaleString())}function generateStatTable(e,t,a,s=0){let i="";t.forEach((function(e){statName=e.replace("_Coefficient","").replace("_Base",""),i+=`\n            <div class="col-${a}"><div class="stat-${e} d-flex align-items-center"><span class="stat-icon"><img class="invert-light" src="images/staticon/Stat_${statName}.png"></span><span class="stat-name">${getLocalizedString("Stat",statName)}</span><span class="flex-fill"></span><span class="stat-value">`,s&&(i+='<span class="stat-base"></span><span class="stat-flat"></span><span class="stat-coefficient"></span><span class="stat-final"></span>'),i+="</span></div></div>"})),i=`<div class="row g-0">${i}</div>`,$(e).html(i)}function recalculateStatsWithDelay(){recalculationLimitTimeout&&clearTimeout(recalculationLimitTimeout),setTimeout(recalculateStats,50)}function recalculateStats(){let e=$("#ba-student-stat-table").hasClass("striker-bonus"),t=$("#ba-statpreview-levelrange").val(),a,s,i;if(statPreviewSelectedChar>0){const e=student.Summons[statPreviewSelectedChar-1];i=find(data.summons,"Id",e.Id)[0],s=new CharacterStats(i,t,1),99999==e.Id&&s.setBase("MaxHP",CharacterStats.interpolateStat(e.ObstacleMaxHP1,e.ObstacleMaxHP100,t))}if(a=new CharacterStats(student,t,statPreviewStarGrade),compareMode&&(studentCompareStats=new CharacterStats(studentCompare,t,statPreviewStarGrade)),statPreviewIncludeEquipment){let e,l;for(let n=0;n<3;n++){if(l=parseInt($(`#ba-statpreview-gear${n+1}-range`).val()),e=find(data.equipment,"Id",gearId[student.Equipment[n]]+l-1)[0],t>=gear_minlevelreq[n])for(let t=0;t<e.StatType.length;t++)a.addBuff(e.StatType[t],e.StatValue[t][1]),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e.StatType[t],e.StatValue[t][1]);if(compareMode&&(e=find(data.equipment,"Id",gearId[studentCompare.Equipment[n]]+l-1)[0],t>=gear_minlevelreq[n]))for(let t=0;t<e.StatType.length;t++)studentCompareStats.addBuff(e.StatType[t],e.StatValue[t][1])}"Released"in student.Gear&&student.Gear.Released[regionID]&&statPreviewGearLevel>=1&&(a.addGearBonuses(student.Gear),statPreviewSelectedChar>0&&99999!=i.Id&&s.addGearBonuses(student.Gear),compareMode&&"Released"in studentCompare.Gear&&studentCompare.Gear.Released[regionID]&&studentCompareStats.addGearBonuses(studentCompare.Gear))}if(statPreviewIncludePotential)for(const e in statPreviewPotentialLevel){const s=statPreviewPotentialLevel[e];if(t>=90){const i=CharacterStats.getPotentialStatAmount(student,e,t,s);if(a.addBuff(e+"_Base",i),compareMode){const a=CharacterStats.getPotentialStatAmount(studentCompare,e,t,s);studentCompareStats.addBuff(e+"_Base",a)}}}if(statPreviewIncludeBond[0]){let e=$("#ba-statpreview-bond-0-range").val(),t=getBondStats(student,Math.min(maxbond[statPreviewStarGrade-1],e));Object.entries(t).forEach(e=>{a.addBuff(e[0],e[1])}),compareMode&&(t=getBondStats(studentCompare,Math.min(maxbond[statPreviewStarGrade-1],e)),Object.entries(t).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}for(let e=1;e<=student_bondalts.length;e++)if(statPreviewIncludeBond[e]){let t=$(`#ba-statpreview-bond-${e}-range`).val(),s=getBondStats(student_bondalts[e-1],t);Object.entries(s).forEach(e=>{a.addBuff(e[0],e[1])})}if($("#statpreview-buff-transferable-conflict").hide(),$("#statpreview-buff-transferable-incompatible").hide(),$("#statpreview-buff-transferable-controls .buff-description span").toggleClass("invalid",!1),statPreviewIncludeBuffs&&void 0!==statPreviewExternalBuffs&&!statPreviewViewSupportStats&&!compareMode){let e=[];statPreviewExternalBuffs.buffs.forEach((t,l)=>{t.Skill.Effects.filter(e=>statPreviewExternalBuffs.effectTypeFilter.includes(e.Type)).forEach((n,r)=>{const o=n.OverrideSlot?n.OverrideSlot:t.Skill.SkillType;let d=ExternalBuffs.checkRestrictions(student,n);"Support"!=student.SquadType||"sub"==t.Skill.SkillType||t.RaidId||(d=!1);let c=statPreviewSelectedChar>0&&ExternalBuffs.checkRestrictions(i,n);if("BuffSelf"==n.Type&&t.StudentId!=student.Id&&(d=!1,c=!1),d||c)if(e.find(e=>e.slot==o&&e.channel==n.Channel))$("#statpreview-buff-transferable-conflict").toggle(statPreviewIncludeBuffs),$(`#statpreview-buff-transferable-controls div[data-index='${l}'] .buff-description span[data-effect='${r}']`).toggleClass("conflict",!0);else{const l=ExternalBuffs.getEffectValue(t,n);d&&(a.addBuff(n.Stat,l),"Icon"in n?a.addActiveBuffIcon(n.Icon,1,"StackSame"in n?t.Stacks:1):a.addActiveBuffIcon(n.Stat,l,"StackSame"in n?t.Stacks:1)),statPreviewSelectedChar>0&&"sub"==t.Skill.SkillType||statPreviewSelectedChar>0&&c&&99999!=i.Id&&(s.addBuff(n.Stat,l),"Icon"in n?s.addActiveBuffIcon(n.Icon,1,"StackSame"in n?t.Stacks:1):s.addActiveBuffIcon(n.Stat,l,"StackSame"in n?t.Stacks:1)),e.push({slot:o,channel:n.Channel})}else $(`#statpreview-buff-transferable-controls div[data-index='${l}'] .buff-description span[data-effect='${r}']`).toggleClass("incompatible",!0)})})}if(statPreviewIncludePassive&&!statPreviewViewSupportStats){const e=parseInt($("#ba-statpreview-passiveskill-range").val()),t=find(student.Skills,"SkillType","passive")[0];if(t.Effects.forEach(t=>{a.addBuff(t.Stat,t.Scale[e-1]),a.addActiveBuffIcon(t.Stat,t.Scale[e-1])}),statPreviewWeaponGrade>=2){const t=find(student.Skills,"SkillType","weaponpassive")[0];t.Effects.forEach(t=>{a.addBuff(t.Stat,t.Scale[e-1],"CriticalPoint_Base"===t.Stat),a.addActiveBuffIcon(t.Stat,t.Scale[e-1])})}if(compareMode){const t=find(studentCompare.Skills,"SkillType","passive")[0];if(t.Effects.forEach(t=>{studentCompareStats.addBuff(t.Stat,t.Scale[e-1])}),statPreviewWeaponGrade>=2){const t=find(studentCompare.Skills,"SkillType","weaponpassive")[0];t.Effects.forEach(t=>{studentCompareStats.addBuff(t.Stat,t.Scale[e-1])})}}}if(void 0===statPreviewCustomBuffs||statPreviewViewSupportStats||compareMode||statPreviewCustomBuffs.buffs.forEach((e,t)=>{a.addBuff(e.Stat,e.Amount),a.addActiveBuffIcon(e.Stat,e.Amount),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e.Stat,e.Amount)}),5==statPreviewStarGrade&&statPreviewWeaponGrade>0){let e=getWeaponStats(student,$("#ba-statpreview-weapon-range").val());Object.entries(e).forEach(e=>{a.addBuff(e[0],e[1]),statPreviewSelectedChar>0&&99999!=i.Id&&s.addBuff(e[0],e[1])}),statPreviewWeaponGrade>=3&&(a.terrain[student.Weapon.AdaptationType]+=student.Weapon.AdaptationValue,statPreviewSelectedChar>0&&99999!=i.Id&&(s.terrain[student.Weapon.AdaptationType]+=student.Weapon.AdaptationValue)),compareMode&&(e=getWeaponStats(studentCompare,$("#ba-statpreview-weapon-range").val()),Object.entries(e).forEach(e=>{studentCompareStats.addBuff(e[0],e[1])}))}if("Main"!=student.SquadType||void 0===statPreviewSupportStats||statPreviewViewSupportStats||compareMode||statPreviewSupportStats.supportStudents.forEach((e,t)=>{const s=getSupportStats(e),i=s.getStrikerBonus("MaxHP",statPreviewSupportStats.supportStudents.length),l=s.getStrikerBonus("AttackPower",statPreviewSupportStats.supportStudents.length),n=s.getStrikerBonus("DefensePower",statPreviewSupportStats.supportStudents.length),r=s.getStrikerBonus("HealPower",statPreviewSupportStats.supportStudents.length);let o="";o+=getStatName("MaxHP")+` +<b>${i}</b>, `,o+=getStatName("AttackPower")+` +<b>${l}</b>, `,o+=getStatName("DefensePower")+` +<b>${n}</b>, `,o+=getStatName("HealPower")+` +<b>${r}</b>`,$(statPreviewSupportStats.elements.controls).find(`div[data-index="${t}"] .support-stats-desc`).html(o),a.addBuff("MaxHP_Base",i),a.addBuff("AttackPower_Base",l),a.addBuff("DefensePower_Base",n),a.addBuff("HealPower_Base",r)}),student.TSAId&&void 0!==statPreviewTSAStats&&!statPreviewViewSupportStats&&!compareMode&&find(data.students,"Id",student.TSAId)[0].IsReleased[regionID]){const e=getSupportStats(statPreviewTSAStats.tsaStudent),t=e.getTSABonus("MaxHP"),a=e.getTSABonus("AttackPower"),i=e.getTSABonus("DefensePower"),l=e.getTSABonus("HealPower");let n="";n+=getStatName("MaxHP")+` +<b>${t}</b>, `,n+=getStatName("AttackPower")+` +<b>${a}</b>, `,n+=getStatName("DefensePower")+` +<b>${i}</b>, `,n+=getStatName("HealPower")+` +<b>${l}</b>`,$(statPreviewTSAStats.elements.controls).find(".support-stats-desc").html(n),statPreviewSelectedChar>0&&statPreviewTSAStats.enabled&&(s.addBuff("MaxHP_Base",t),s.addBuff("AttackPower_Base",a),s.addBuff("DefensePower_Base",i),s.addBuff("HealPower_Base",l))}if(statPreviewSelectedChar>0&&!compareMode){const e=$("#ba-statpreview-summon-range").val(),t=student.Summons[statPreviewSelectedChar-1];for(let i=0;i<t.InheritCasterStat.length;i++)s.addCharacterStatsAsBuff(a,t.InheritCasterStat[i],t.InheritCasterAmount[i][e-1]),s.addActiveBuffIcon(t.InheritCasterStat[i],1)}0!=statPreviewSelectedChar||student.Skills.find(e=>"autoattack"==e.SkillType)||(a.stats.AmmoCount[0]=0),statPreviewSelectedChar>0&&!i.Skills.find(e=>"autoattack"==e.SkillType)&&(s.stats.AmmoCount[0]=0),compareMode&&"Support"==studentCompare.SquadType&&(studentCompareStats.stats.AmmoCount[0]=0);let l=statPreviewSelectedChar>0?s:a;const n=["DefensePower","CriticalPoint","StabilityPoint"];if(statPreviewCharacterStats=l,$("#student-stat-modal-skill-calc-toggle").hasClass("deactivated")||!$("#ba-student-modal-statpreview").hasClass("show")){studentStatListFull.forEach((t,a)=>{let s,i,r="";if(e&&0==statPreviewSelectedChar&&a<4)s="+"+l.getStrikerBonus(t).toLocaleString();else if("AmmoCount"==t){let e=l.getTotalString("AmmoCount"),t=l.getTotalString("AmmoCost");s=0==e?"-":`${e}&nbsp;(${t})`}else s=l.getTotalString(t);if(compareMode){let a,s;a=e?"Support"!=studentCompare.SquadType?l.getStrikerBonus(t):l.getStrikerBonus(t)-studentCompareStats.getStrikerBonus(t):l.getTotal(t)-studentCompareStats.getTotal(t),s="Rate"==t.slice(-4)?`${parseFloat(Math.abs(a/100).toFixed(1)).toLocaleString()}%`:`${Math.abs(a).toLocaleString()}`,r=a<0?`<small class="comparison less"><i class="fa-solid fa-circle-chevron-down"></i>&nbsp;${s}</small>`:a>0?`<small class="comparison greater"><i class="fa-solid fa-circle-chevron-up"></i>&nbsp;${s}</small>`:'<small class="comparison"><i class="fa-solid fa-circle-dot"></i>&nbsp;0</small>'}if(n.includes(t)&&(!e||a>4)&&(s='<span class="has-tooltip">'+s+"</span>"),$("#ba-student-modal-statpreview").hasClass("show")){$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-base`).text(l.getBaseString(t));const e=l.getFlatString(t);$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-flat`).text(e).toggleClass("zero","+0"==e).toggleClass("negative",e.startsWith("-"));const a=l.getCoefficientString(t);$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-coefficient`).text(a).toggleClass("zero","+0%"==a).toggleClass("negative",a.startsWith("-")),$(`#ba-student-stat-modal-table .stat-${t} .stat-value .stat-final`).html(s)}else $(`#ba-student-stat-table .stat-${t} .stat-value`).html(s+r)});let t=translateUI("stat_defense_tooltip",[`<b>${l.getDefenseDamageReduction()}</b>`]),a=translateUI("stat_crit_tooltip");const s=[20,100,500];s.forEach(e=>{a+="\n"+translateUI("stat_crit_amount_tooltip",[`<b>${l.getCriticalHitChanceString(e)}</b>`,e])});let i=translateUI("stat_stability_tooltip",[`<b>${l.getStabilityMinDamage()}</b>`]);$(".student-stat-table .stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(t),html:!0,placement:"top"}),$(".student-stat-table .stat-CriticalPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(a),html:!0,placement:"top"}),$(".student-stat-table .stat-StabilityPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(i),html:!0,placement:"top"})}l.renderActiveBuffs(".active-buffs",7),calculateSkills(),calculateRaidSkills(),student.Id in studentCollection?lockedAttributes||(collectionUpdateTimeout&&clearTimeout(collectionUpdateTimeout),collectionUpdateTimeout=window.setTimeout(()=>{studentCollectionSave(),statPreviewSettingsSave()},50)):(collectionUpdateTimeout&&clearTimeout(collectionUpdateTimeout),collectionUpdateTimeout=window.setTimeout(()=>{statPreviewSettingsSave()},50))}function getSupportStats(e){const t=new CharacterStats(e.student,e.level,e.starGrade);for(let a=0;a<3;a++){const s=e.equipment[a],i=find(data.equipment,"Id",gearId[e.student.Equipment[a]]+s-1)[0];if(e.level>=gear_minlevelreq[a])for(let e=0;e<i.StatType.length;e++)t.addBuff(i.StatType[e],i.StatValue[e][1])}if(e.gear&&"Released"in e.student.Gear&&e.student.Gear.Released[regionID]&&t.addGearBonuses(e.student.Gear),5==e.starGrade&&e.weaponStarGrade>0){const a=getWeaponStats(e.student,e.weaponLevel);Object.entries(a).forEach(e=>{t.addBuff(e[0],e[1])})}const a=getBondStats(e.student,Math.min(maxbond[e.starGrade-1],e.bond[0]));Object.entries(a).forEach(e=>{t.addBuff(e[0],e[1])});for(let a=1;a<e.bond.length;a++){const s=find(data.students,"Id",e.student.FavorAlts[a-1])[0];if(s.IsReleased[regionID]){const i=getBondStats(s,e.bond[a]);Object.entries(i).forEach(e=>{t.addBuff(e[0],e[1])})}}for(const a in e.potential){const s=e.potential[a];if(e.level>=90){const i=CharacterStats.getPotentialStatAmount(e.student,a,e.level,s);t.addBuff(a+"_Base",i)}}return t}function calculateEnemyStats(){const e=find(data.enemies,"Id",statPreviewSelectedEnemyId)[0];let t,a;if(statPreviewSelectedEnemyRaid>=1e6){const s=find(data.raids.MultiFloorRaid,"Id",statPreviewSelectedEnemyRaid)[0];if(t=s.RaidFloors[statPreviewSelectedEnemyRaidFloor].Level,a=new CharacterStats(e,t,statPreviewSelectedEnemyGrade,e.Transcendence?e.Transcendence:[]),$("#calculation-enemy-level input").val(t),e.Id in s.RaidFloors[statPreviewSelectedEnemyRaidFloor].StatChange){const t=s.RaidFloors[statPreviewSelectedEnemyRaidFloor].StatChange[e.Id];for(const e in t)a.addBuff(e,t[e])}}else t=statPreviewSelectedEnemyLevel,a=new CharacterStats(e,t,statPreviewSelectedEnemyGrade,e.Transcendence?e.Transcendence:[]);$("#statpreview-enemy-buff-transferable-conflict").hide(),$("#statpreview-enemy-buff-transferable-incompatible").hide(),$("#statpreview-enemy-buff-transferable-controls .buff-description span").toggleClass("invalid",!1);let s=[];statPreviewEnemyBuffs.buffs.forEach((t,i)=>{let l=!0;t.Skill.Effects.filter(e=>statPreviewEnemyBuffs.effectTypeFilter.includes(e.Type)).forEach((n,r)=>{const o=n.OverrideSlot?n.OverrideSlot:t.Skill.SkillType;if(n.RestrictTo&&!n.RestrictTo.includes(statPreviewSelectedEnemyId)||"BuffTarget"!=n.Type||!ExternalBuffs.checkRestrictions(e,n,{ArmorType:statPreviewSelectedEnemyArmorType}))$(`#statpreview-enemy-buff-transferable-controls div[data-index='${i}'] .buff-description span[data-effect='${r}']`).toggleClass("incompatible",!0);else if(l=!1,s.find(e=>e.slot==o&&e.channel==n.Channel))$("#statpreview-enemy-buff-transferable-conflict").show(),$(`#statpreview-enemy-buff-transferable-controls div[data-index='${i}'] .buff-description span[data-effect='${r}']`).toggleClass("conflict",!0);else{const e=ExternalBuffs.getEffectValue(t,n);a.addBuff(n.Stat,e),"Icon"in n?a.addActiveBuffIcon(n.Icon,1,"StackSame"in n?t.Stacks:1):"StackingIcon"in n?a.addActiveBuffIcon(n.StackingIcon[t.Stacks-1],e,"StackSame"in n?t.Stacks:1):a.addActiveBuffIcon(n.Stat,e,"StackSame"in n?t.Stacks:1),s.push({slot:o,channel:n.Channel})}}),l&&$("#statpreview-enemy-buff-transferable-incompatible").show()}),void 0!==statPreviewEnemyCustomBuffs&&statPreviewEnemyCustomBuffs.buffs.forEach((e,t)=>{a.addBuff(e.Stat,e.Amount),a.addActiveBuffIcon(e.Stat,e.Amount)}),a.renderActiveBuffs(".enemy-active-buffs",8),enemyCalculationStatList.forEach(e=>{let t=a.getTotalString(e,!0);"DefensePower"==e&&(t=`<span class="has-tooltip">${t}</span>`),$(`#calculation-enemy-stat-table .stat-${e} .stat-value`).html(t)}),addRaidEnemyBonusStats(e.Id,a,statPreviewSelectedEnemyRaidDifficulty,"#calculation-enemy-stat-table");let i=translateUI("stat_defense_tooltip",[`<b>${a.getDefenseDamageReduction()}</b>`]);$("#calculation-enemy-stat-table .stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(i),html:!0,placement:"top"}),a.armorType=statPreviewSelectedEnemyArmorType,statPreviewSelectedEnemyStats=a,calculateSkills(),calculateRaidSkills()}function calculateSkills(){if($("#ba-student-modal-statpreview").hasClass("show")){const e=0-Math.max(Math.min(.02*(statPreviewSelectedEnemyStats.level-statPreviewCharacterStats.level),.6),0),t=statPreviewCharacterStats.getEffectiveMod(statPreviewSelectedEnemyStats.armorType);$("#calculation-intermediate-terrain").html(`<img width="24" height="24" src="images/ui/Ingame_Emo_Adaptresult${adaptationAmount[statPreviewCharacterStats.terrain[statPreviewTerrain]]}.png"><span>(${80+10*statPreviewCharacterStats.terrain[statPreviewTerrain]}%)</span>`),$("#calculation-intermediate-effectiveness").text(`${parseFloat((100*t).toFixed(2))}%`).toggleClass("text-weak",t>1).toggleClass("text-resist",t<1),$("#calculation-intermediate-leveldiff").text(`${parseFloat((100*e).toFixed(2))}%`).toggleClass("text-negative",e<0),$("#calculation-intermediate-hitchance").text(statPreviewCharacterStats.getHitChanceString(statPreviewSelectedEnemyStats.getTotal("DodgePoint"))),$("#calculation-intermediate-critchance").text(`${statPreviewCharacterStats.getCriticalHitChanceString(statPreviewSelectedEnemyStats.getTotal("CriticalChanceResistPoint"))}`),$("#calculation-intermediate-variance").text(`${statPreviewCharacterStats.getStabilityMinDamage()} ~ 100%`),!$("#student-stat-modal-skill-calc-toggle").hasClass("deactivated")&&$("#calculation-student-skills").hasClass("active")&&skillInfoCollection.forEach(e=>{e.update(statPreviewCharacterStats,statPreviewSelectedEnemyStats,statPreviewTerrain)})}}function calculateRaidSkills(){$("#ba-student-modal-statpreview").hasClass("show")&&!$("#student-stat-modal-skill-calc-toggle").hasClass("deactivated")&&$("#calculation-enemy-skills").hasClass("active")&&raidSkillInfoCollection.forEach(e=>{e.update(statPreviewSelectedEnemyStats,statPreviewCharacterStats,statPreviewTerrain)})}function refreshStatTableControls(){for(let e=0;e<=student_bondalts.length;e++)$(`#ba-statpreview-status-bond-${e}-toggle`).toggleClass("deactivated",!statPreviewIncludeBond[e]),$(`#ba-statpreview-status-bond-${e}-toggle .label`).html(statPreviewBondLevel[e]),$(`#ba-statpreview-bond-${e}-toggle`).toggleClass("checked",statPreviewIncludeBond[e]),$(`#ba-statpreview-bond-${e}`).toggleClass("disabled",!statPreviewIncludeBond[e]),$(`#ba-statpreview-bond-${e} input`).prop("disabled",!statPreviewIncludeBond[e]);if($("#ba-statpreview-status-passive-level").toggleClass("deactivated",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill-toggle").toggleClass("checked",statPreviewIncludePassive),$("#ba-statpreview-passiveskill").toggleClass("disabled",!statPreviewIncludePassive),$("#ba-statpreview-passiveskill input").prop("disabled",!statPreviewIncludePassive),$("#ba-statpreview-status-buffs").toggleClass("deactivated",!statPreviewIncludeBuffs),statPreviewExternalBuffs.toggleDisabled(!statPreviewIncludeBuffs),$("#ba-statpreview-buff-toggle").toggleClass("checked",statPreviewIncludeBuffs),$("#ba-statpreview-status-equipment").toggleClass("deactivated",!statPreviewIncludeEquipment),$("#ba-statpreview-gear").toggleClass("disabled",!statPreviewIncludeEquipment),$("#ba-statpreview-gear-toggle").toggleClass("checked",statPreviewIncludeEquipment),$("#ba-statpreview-gear input").prop("disabled",!statPreviewIncludeEquipment),statPreviewIncludeEquipment)for(let e=0;e<3;e++)$(`#ba-statpreview-gear${e+1}`).toggleClass("disabled",statPreviewLevel<gear_minlevelreq[e]),$(`#ba-statpreview-gear${e+1}-range`).prop("disabled",statPreviewLevel<gear_minlevelreq[e]);if($("#ba-statpreview-potential").toggleClass("disabled",!statPreviewIncludePotential),$("#ba-statpreview-potential-toggle").toggleClass("checked",statPreviewIncludePotential),$("#ba-statpreview-potential input").prop("disabled",!statPreviewIncludePotential),statPreviewIncludePotential)for(const e in statPreviewPotentialLevel)$(`#ba-statpreview-potential-${e.toLowerCase()}`).toggleClass("disabled",statPreviewLevel<90),$(`#ba-statpreview-potential-${e.toLowerCase()}-range`).prop("disabled",statPreviewLevel<90)}function recalculateEXSkillPreview(){$(".tooltip").tooltip("hide"),skillPreviewExSkillLevel=$("#ba-skillpreview-exrange").val();const e=find(student.Skills,"SkillType","ex")[0];$("#ba-skill-ex-level").html(5==skillPreviewExSkillLevel?'<img src="images/ui/ImageFont_Max.png">':"Lv."+skillPreviewExSkillLevel),$("#ba-skill-ex-description").html(getSkillText(e,skillPreviewExSkillLevel,{bulletType:student.BulletType})),$("#ba-skill-ex-description .skill-hitinfo").tooltip({html:!0}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$("#ba-skill-ex-materials-page .item-icon-list").hide(),$("#ba-skill-ex-materials-"+skillPreviewExSkillLevel).show(),$("#ba-skill-ex-cost").text(e.Cost[skillPreviewExSkillLevel-1]);let t=getSkillExtraInfo(e,student);renderExtraSkills("ex",skillPreviewExSkillLevel),$("#ba-skill-ex-extrainfo").html(t).toggle(""!=t),$("#ba-skill-ex-extrainfo .ba-info-pill-s").tooltip({html:!0}),student.Skills.some(e=>"autoattack"==e.SkillType)&&student.Skills.find(e=>"autoattack"==e.SkillType).InheritScale&&recalculateNormalAttackPreview(),localStorage.setItem("student_skill_ex_level",skillPreviewExSkillLevel)}function recalculateSkillPreview(){$(".tooltip").tooltip("hide"),skillPreviewOtherSkillLevel=$("#ba-skillpreview-range").val();const e=["normal","passive","sub"];$("#ba-skill-level").html(10==skillPreviewOtherSkillLevel?'<img src="images/ui/ImageFont_Max.png">':"Lv."+skillPreviewOtherSkillLevel),e.forEach(e=>{let t;"normal"==e&&showSkillUpgrades&&"Released"in student.Gear&&student.Gear.Released[regionID]?(t=find(student.Skills,"SkillType","gearnormal")[0],$("#ba-skill-normal-icon").toggleClass("plus",!0).find("img").attr("src",`images/skill/${t.Icon}.webp`),$("#ba-skill-normal-plus").toggle(!0)):"passive"==e&&showSkillUpgrades&&region.WeaponMaxLevel>0?(t=find(student.Skills,"SkillType","weaponpassive")[0],$("#ba-skill-passive-icon").toggleClass("plus",!0).find("img").attr("src",`images/skill/${t.Icon}.webp`),$("#ba-skill-passive-plus").toggle(!0)):(t=find(student.Skills,"SkillType",e)[0],$(`#ba-skill-${e}-icon`).toggleClass("plus",!1).find("img").attr("src",`images/skill/${t.Icon}.webp`),$(`#ba-skill-${e}-plus`).toggle(!1)),$(`#ba-skill-${e}-name`).html(t.Name),$(`#ba-skill-${e}-description`).html(getSkillText(t,skillPreviewOtherSkillLevel,{bulletType:student.BulletType})),$(`#ba-skill-${e}-description .skill-hitinfo`).tooltip({html:!0});let a=getSkillExtraInfo(t,student);renderExtraSkills(e,skillPreviewOtherSkillLevel),$(`#ba-skill-${e}-extrainfo`).html(a).toggle(""!=a),$(`#ba-skill-${e}-extrainfo .ba-info-pill-s`).tooltip({html:!0})}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),$("#ba-skill-materials-page .item-icon-list").hide(),$("#ba-skill-materials-"+skillPreviewOtherSkillLevel).show(),student.Skills.some(e=>"autoattack"==e.SkillType)&&student.Skills.find(e=>"autoattack"==e.SkillType).InheritScale&&recalculateNormalAttackPreview(),localStorage.setItem("student_skill_other_level",skillPreviewOtherSkillLevel)}function renderExtraSkills(e,t){let a="";student.Summons.filter(t=>t.SourceSkill==e&&99999!=t.Id).forEach(e=>{const s=find(data.summons,"Id",e.Id)[0];s.Skills.forEach(e=>{if(!1===e.ShowInfo)return;"autoattack"==e.SkillType&&(addNormalAttackSkillText(e),e.Range=s.Range,"DMGMulti"==e.Effects[0].Type&&(e.Effects[0].HitsParameter=1));const i=getSkillExtraInfo(e,s);a+=`<div class="ba-panel-separator"></div>\n            <div class="ps-4">\n                <div class="my-2 d-flex flex-row align-items-start gap-3 w-100">\n                    <div class="skill-icon small bg-skill ${student.BulletType.toLowerCase()}"><img src="images/skill/${e.Icon}.webp"></div>\n                    <div class="d-inline-block flex-fill">\n                        <div>\n                            <h5 class="me-2 d-inline">${e.Name} <small>(${s.Name})</small></h5>\n                        </div>\n                        ${"autoattack"!=e.SkillType?`<div class="d-flex mt-1"><span class="text-italic">${translateUI(`student_skill_${e.SkillType}`)}</span></div>`:""}\n                        <div class="pt-1 d-flex gap-3 align-items-center flex-wrap justify-content-between">\n                            <div class="position-relative">\n                                <p class="mb-1">${getSkillText(e,"autoattack"==e.SkillType?1:t,{bulletType:student.BulletType})}</p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                ${i?`<div class="skill-extrainfo">${i}</div>`:""}\n            </div>`})}),studentExtraSkills=student.Skills.find(t=>t.SkillType==e).ExtraSkills||[];for(const e of studentExtraSkills){const s=getSkillExtraInfo(e,student);if(a+=`<div class="ba-panel-separator"></div>\n        <div class="ps-4">\n            <div class="my-2 d-flex flex-row align-items-start gap-3 w-100">\n                <div class="skill-icon small bg-skill ${student.BulletType.toLowerCase()}"><img src="images/skill/${e.Icon}.webp"></div>\n                <div class="d-inline-block flex-fill">\n                    <div>\n                        <h5 class="me-2 d-inline">${e.Name}</h5>\n                    </div>\n                    <div class="d-flex mt-1">\n                        <span class="text-italic">${translateUI(`student_skill_${e.SkillType}`)}</span>\n                        ${"ex"==e.SkillType?`<span class="text-bold">&nbsp;・&nbsp;<i>COST:</i> ${e.Cost[t-1]}</span>`:""}`,e.TSAId){const t=find(data.students,"Id",e.TSAId)[0];a+=`<span class="ms-auto" onclick="loadStudent('${t.PathName}')" style="cursor:pointer;"><i class="fa-solid fa-link me-1"></i><img class="inline-img circle me-1" src="images/student/icon/${e.TSAId}.webp">${t.Name}</span>`}a+=`</div>\n                    <div class="pt-1 d-flex gap-3 align-items-center flex-wrap justify-content-between">\n                        <div class="position-relative">\n                            <p class="mb-1">${getSkillText(e,t,{bulletType:student.BulletType})}</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${s?`<div class="skill-extrainfo">${s}</div>`:""}\n        </div>`}if(student.TSAId&&"ex"==e){const e=find(data.students,"Id",student.TSAId)[0];if(e.IsReleased[regionID]){studentTSASkills=[],e.Skills.forEach(e=>{e.ExtraSkills&&studentTSASkills.push(e.ExtraSkills.filter(e=>e.TSAId==student.Id))});for(const s of e.Skills.filter(e=>e.ExtraSkills))for(const i of s.ExtraSkills.filter(e=>e.TSAId==student.Id)){const s=getSkillExtraInfo(i,student);a+=`<div class="ba-panel-separator"></div>\n                    <div class="ps-4">\n                        <div class="my-2 d-flex flex-row align-items-start gap-3 w-100">\n                            <div class="skill-icon small bg-skill ${student.BulletType.toLowerCase()}"><img src="images/skill/${i.Icon}.webp"></div>\n                            <div class="d-inline-block flex-fill">\n                                <div>\n                                    <h5 class="me-2 d-inline">${i.Name}</h5>\n                                </div>\n                                <div class="d-flex mt-1">\n                                    <span class="text-italic">${translateUI(`student_skill_${i.SkillType}`)}</span>\n                                    ${"ex"==i.SkillType?`<span class="text-bold">&nbsp;・&nbsp;<i>COST:</i> ${i.Cost[t-1]}</span>`:""}`,a+=`<span class="ms-auto" onclick="loadStudent('${e.PathName}')" style="cursor:pointer;"><i class="fa-solid fa-link me-1"></i><img class="inline-img circle me-1" src="images/student/icon/${e.Id}.webp">${e.Name}</span>`,a+=`</div>\n                                <div class="pt-1 d-flex gap-3 align-items-center flex-wrap justify-content-between">\n                                    <div class="position-relative">\n                                        <p class="mb-1">${getSkillText(i,t,{bulletType:student.BulletType})}</p>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        ${s?`<div class="skill-extrainfo">${s}</div>`:""}\n                    </div>`}}}return $(`#skill-${e}-extra-skills`).html(a),$(`#skill-${e}-extra-skills`).find(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})),""!=a&&$(`#skill-${e}-extra-skills`).find(".ba-info-pill-s, .skill-hitinfo").tooltip({html:!0}),""!==a}function getSkillExtraInfo(e,t){let a="",s=!0;if(e.Radius&&e.Radius.forEach(t=>{let i="",l="",n="";switch(t.Type){case"Circle":i=`${t.Radius}`,l=`${translateUI("radius")}: <b>${t.Radius/100}m (${t.Radius})</b>`,n="COMMON_SKILLICON_CIRCLE",t.Radius==e.Range&&(s=!1);break;case"Donut":i=`${t.ExcludeRadius} - ${t.Radius} / ${t.Degree}&deg;`,l=`${translateUI("radius")}: <b>${t.ExcludeRadius/100}m - ${t.Radius/100}m (${t.ExcludeRadius} - ${t.Radius})</b>\n${translateUI("angle")}: <b>${t.Degree}&deg;</b>`,n="COMMON_SKILLICON_DONUT",t.Radius>=e.Range&&(s=!1);break;case"Fan":i=`${t.Radius} / ${t.Degree}&deg;`,l=`${translateUI("radius")}: <b>${t.Radius/100}m (${t.Radius})</b>\n${translateUI("angle")}: <b>${t.Degree}&deg;</b>`,n="COMMON_SKILLICON_FAN",s=!1;break;case"Obb":i=t.Height>t.Width?`${t.Height}`:`${t.Width} &times; ${t.Height}`,l=`${translateUI("length")}: <b>${t.Height/100}m (${t.Height})</b>\n${translateUI("width")}: <b>${t.Width/100}m (${t.Width})</b>`,n=t.Height>t.Width?"COMMON_SKILLICON_LINE":"COMMON_SKILLICON_RECZONE",t.Height>=e.Range&&(s=!1);break;case"Bounce":i=`${t.Radius}`,l=`${translateUI("bounce")}: <b>${t.Radius/100}m (${t.Radius})</b>`,n="COMMON_SKILLICON_BOUNCEPROJECTILE"}a+=`<div class="ba-info-pill-s bg-theme" title="${getBasicTooltip(l)}"><img class="icon invert-light" src="images/skill/${n}.webp"><span class="label">${i}</span></div>`}),(s||"autoattack"==e.SkillType)&&e.Range&&(a+=`<div class="ba-info-pill-s bg-theme" title="${getBasicTooltip(translateUI("range")+`: <b>${e.Range/100}m (${e.Range})</b>`)}"><img class="icon invert-light" src="images/staticon/Stat_Range.png"><span class="label">${e.Range}</span></div>`),"autoattack"==e.SkillType){const s=e.Effects[0],i=Math.ceil(s.Frames.AttackIngDuration),l=Math.ceil(s.Frames.AttackBurstRoundOverDelay),n=Math.ceil(s.Frames.AttackReloadDuration),r=Math.ceil(s.Frames.AttackStartDuration),o=Math.ceil(s.Frames.AttackEndDuration),d=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(i/30,2),i])}</b>`,c=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(l/30,2),l])}</b>`,u=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(r/30,2),r])}</b>`,g=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(n/30,2),n])}</b>`,p=`<b>${translateUI("time_seconds_frames",[MathHelper.toFixedFloat(o/30,2),o])}</b>`,m=MathHelper.toFixedFloat((i+l)/30,2),f=MathHelper.toFixedFloat((r+n+o)/30,2);0!=m&&(a+=`<div class="ba-info-pill-s bg-theme" title="${getBasicTooltip(translateUI("dmginfo_rate_of_fire_tooltip",[d,c]))}"><i class="fa-solid fa-circle-play ms-2" style="font-size: 14px;"></i><span class="label">${translateUI("time_seconds",[m])}</span></div>`),0!=f&&(a+=`<div class="ba-info-pill-s bg-theme" title="${getBasicTooltip(translateUI("dmginfo_reload_time_tooltip",[g,u,p]))}"><img class="icon invert-light" src="images/skill/COMMON_SKILLICON_RELOAD.webp"><span class="label">${translateUI("time_seconds",[f])}</span></div>`),a+=`<div class="ba-info-pill-s bg-theme"><img class="icon invert-light" src="images/staticon/Stat_AmmoCount.png"><span class="label">${t.AmmoCount} (${t.AmmoCost})</span></div>`}else e.Duration&&(a+=`<div class="ba-info-pill-s bg-theme" title="${getBasicTooltip(translateUI("skill_duration")+":\n<b>"+translateUI("time_seconds_frames",[MathHelper.toFixedFloat(e.Duration/30,2),e.Duration])+"</b>")}"><i class="fa-solid fa-circle-play ms-2" style="font-size: 14px;"></i><span class="label">${translateUI("time_seconds",[MathHelper.toFixedFloat(e.Duration/30,2)])}</span></div>`);return a}function recalculateNormalAttackPreview(){const e=find(student.Skills,"SkillType","autoattack")[0];if(addNormalAttackSkillText(e),e.InheritScale){const t=find(student.Skills,"SkillType",e.InheritScale.Skill)[0],a="ex"==e.InheritScale.Skill?skillPreviewExSkillLevel:skillPreviewOtherSkillLevel;e.Parameters=[[t.Parameters[e.InheritScale.Parameter-1][a-1]]]}e.Range=student.Range,"DMGMulti"==e.Effects[0].Type&&(e.Effects[0].HitsParameter=1),$("#ba-skill-autoattack-icon").find("img").attr("src",`images/skill/${e.Icon}.webp`),$("#ba-skill-autoattack-name").html(e.Name),$("#ba-skill-autoattack-description").html(getSkillText(e,1,{bulletType:student.BulletType})),$("#ba-skill-autoattack-description .skill-hitinfo").tooltip({html:!0});const t=getSkillExtraInfo(e,student);$("#ba-skill-autoattack-extrainfo").html(t),$("#ba-skill-autoattack-extrainfo .ba-info-pill-s").tooltip({html:!0})}function getStudentListCardHTML(e){let t=getTranslatedString(e,"Name"),a;return`\n    <div id="student-select-${e.Id}" class="selection-grid-card card-student" onclick="loadStudent('${e.PathName}')">\n        <div class="card-img">\n            <img src="images/student/collection/${e.Id}.webp">\n        </div>\n        <span class="card-badge student-role top-left bg-${e.SquadType.toLowerCase()}"><img src="images/ui/Role_${e.TacticRole}.png"></span>\n        <span class="card-badge student-type atk bg-atk-${e.BulletType.toLowerCase()}"><img src="images/ui/Type_Attack_s.png"></span>\n        <span class="card-badge student-type def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png"></span>\n        <span class="card-badge student-rarity">${'<i class="fa-solid fa-star"></i>'.repeat(e.StarGrade)}</span>\n        <div class="card-label">\n            <span class="label-text ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}">${t}</span>\n            <span class="label-text hover ${t.length>label_smalltext_threshold[userLang]?"smalltext":""}" style="display: none;">${t}</span>\n        </div>\n    </div>`}function getStageCardHTML(e,t=0,a=!1){let s="",i=label_enemy_smalltext_threshold.En;e.Id>=7e6?s=e.Field?"Field":"Event":e.Id>=1e6?s="Campaign":e.Id>=6e4?(s="SchoolDungeon",i=label_enemy_smalltext_threshold[userLang]):e.Id>=3e4?(s="WeekDungeon",i=label_enemy_smalltext_threshold[userLang]):s="Unknown";let l=r(),n=`<div id="stage-select-${e.Id}" class="selection-grid-card card-stage" onclick="loadStage('${e.Id}')">\n    <div class="card-img"><img loading="lazy" src="images/campaign/${getStageIcon(e,s)}.png"></div>`;return t>0&&(n+=`<span class="card-badge stage-droprate">${getProbabilityText(t)}</span>`),n+='<div class="card-label">',n+=`<span class="label-text ${"Field"==s||l.length>i?"smalltext":""}">${l}</span>`,n+="</div></div>",n;function r(){switch(s){case"Event":case"Campaign":return getStageName(e,s,!0);case"Field":return getStageTitle(e,s);case"WeekDungeon":case"SchoolDungeon":return`${getLocalizedString("StageTitle",e.Type,[String.fromCharCode(64+e.Stage)])}`}}}function getShopCardHTML(e){let t=label_enemy_smalltext_threshold[userLang],a=getLocalizedString("ShopCategory",e.ShopCategory),s,i;switch(e.CostType){case"Item":s=find(data.items,"Id",e.CostId)[0],i=s.Category;break;case"Currency":s=find(data.currency,"Id",e.CostId)[0],i="Currency"}let l='<div class="selection-grid-card card-shop">\n    <div class="card-img"><img loading="lazy" src="images/ui/BG_Shop.png"></div>';return l+=`<span class="card-badge shop-cost" title="${getRichTooltip(`images/item/icon/${s.Icon}.webp`,getTranslatedString(s,"Name").escapeHtml(),getLocalizedString("ItemCategory",i),getRarityTier(s.Rarity),getTranslatedString(s,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img src="images/item/icon/${s.Icon}.webp"><span>&times;${abbreviateNumber(e.CostAmount)}${e.Amount>1?` (${e.Amount})`:""}</span></span>`,l+='<div class="card-label">',l+=`<span class="label-text ${a.length>t?"smalltext":""}">${a}</span>`,l+="</div></div>",l}function getEventCardHTML(e){let t=e%1e4,a=getLocalizedString("EventName",t)+(e>1e4?translateUI("event_rerun"):"");const s=getEventlogoLang(t);let i;switch(e){case 821:i="loadRaid(821001);";break;case 823:i="loadRaid(823000);";break;default:i=`populateEventStageList(${e});`}let l=`\n    <div id="event-select-${e}" class="selection-grid-card card-event" onclick="${i}">\n        <div class="card-bg"><div style="background-image:url('images/campaign/Campaign_Event_${t}_Normal.png');"></div>\n        </div>\n        ${e>1e4?'<img class="event-revival" src="images/ui/Event_Revival.png">':""}\n        <div class="card-img"><img src="images/eventlogo/${t}_${s}.webp"></div>`;return l+=`<div class="card-label"><span class="label-text ${a.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${a}</span></div></div>`,l}function getEventlogoLang(e){return 0!=regionID&&region.Events.includes(e)?"Cn"==userLang?"Tw":"Vi"==userLang||"Zh"==userLang?"Jp":userLang:"Jp"}function getStageIcon(e,t){switch(t){case"Event":case"Field":return`Campaign_Event_${e.EventId>1e4?e.EventId-1e4:e.EventId}_${2==e.Difficulty?"Hard":"Normal"}`;case"Campaign":return`Campaign_Image_${e.Area.toString().padStart(2,"0")}_${1==e.Difficulty?"Hard":"Normal"}`;case"WeekDungeon":return`WeekDungeon_Image_${e.Type}`;case"SchoolDungeon":return`SchoolDungeon_Image_${e.Type}`}}function getRaidCardHTML(e,t=null,a=null){let s=getTranslatedString(e,"Name");const i=t?t.Terrain:"";e.Id>=1e6&&(s+=` (${getLocalizedString("ArmorTypeLong",e.ArmorType)})`),a||(a=e.Id>=1e6?"MultiFloorRaid_Floor_BG":e.Terrain.length>1&&i==e.Terrain[1]?`Boss_Portrait_${e.PathName}_LobbyBG_${i}`:`Boss_Portrait_${e.PathName}_LobbyBG`);let l=`<div id="raid-select-${e.Id}" class="selection-grid-card card-raid" onclick="loadRaid(${e.Id});"><div class="card-bg"><div style="background-image:url('images/raid/${a}.png');"></div></div><div class="card-img ${e.Id>1e5?"worldraid":""}"><img src="images/raid/Boss_Portrait_${e.PathName}_Lobby.png"></div>`;return t&&t.TormentArmorType?l+=`<div class="card-badge raid-def bg-def-${t.TormentArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png"><span class="label">TOR</span></div>`:l+=`<div class="card-badge raid-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense.png"></div>`,""!=i&&(l+=`<div class="card-badge raid-terrain"><img class="invert-light" src="images/ui/Terrain_${i}.png"></div>`),l+=`<div class="card-label"><span class="label-text ${s.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${s}</span></div></div>`,l}function getTimeAttackCardHTML(e){let t=`${e.Id/1e3}: ${getLocalizedString("TimeAttackStage",e.DungeonType)}`,a=`<div id="raid-select-${e.Id}" class="selection-grid-card card-raid" onclick="loadRaid(${e.Id});"><div class="card-bg"><div style="background-image:url('images/timeattack/${timeAttackBG[e.DungeonType]}.png');"></div></div><div class="card-img ta-img"><img src="images/enemy/${e.Icon}.webp"></div><div class="card-badge ta-rules">`;return e.Rules[e.Rules.length-1].forEach(e=>{const t=find(data.raids.TimeAttackRules,"Id",e.Id)[0];a+=`<img src="images/timeattack/${t.Icon}.webp">`}),a+=`</div><div class="card-label"><span class="label-text ${t.length>label_raid_smalltext_threshold[userLang]?"smalltext":""}">${t}</span></div></div>`,a}function getEnemyCardHTML(e,t,a,s,i=0,l=!0){let n=getTranslatedString(e,"Name"),r=getSmallTextThreshold(n,label_enemy_smalltext_threshold),o=`<div class="selection-grid-card card-enemy" ${l?`data-enemy='${e.Id}_${t}_${s}_${i}'`:""} onclick='showEnemyInfo(${e.Id},${t},"${a}",${s},${i},${!l})'><div class="card-img"><img src="images/enemy/${e.Icon}.webp"></div>`;return e.IsNPC?o+='<span class="card-badge enemy-npc">NPC</span>':"Elite"==e.Rank?o+='<div class="card-badge enemy-rank"><img src="images/ui/Common_Icon_Enemy_Elite.png" style="width:22px;"></div>':"Champion"==e.Rank&&(o+='<div class="card-badge enemy-rank"><img src="images/ui/Common_Icon_Enemy_Champion.png" style="width:31px;"></div>'),o+=`<div class="card-badge enemy-level">Lv.${t}</div><div class="card-badge enemy-atk bg-atk-${e.BulletType.toLowerCase()}"><img src="images/ui/Type_Attack_s.png" style="width:100%;"></div>\n    <div class="card-badge enemy-def bg-def-${e.ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="width:100%;"></div><div class="card-label"><span class="label-text ${n.length>r?"smalltext":""}">${n}</span></div></div>`,o}function showEnemyInfo(e,t,a,s=1,i=0,l=!1){$(".card-enemy").removeClass("selected"),"stages"==loadedModule&&l&&$("#ba-stage-tab-enemies").tab("show"),$(`.card-enemy[data-enemy='${e}_${t}_${s}_${i}']`).addClass("selected");let n=find(data.enemies,"Id",e)[0];$("#ba-stage-enemy-name").html(getTranslatedString(n,"Name")),$("#ba-stage-enemy-icon img").attr("src",`images/enemy/${n.Icon}.webp`),$("#ba-stage-enemy-icon").removeClass("elite champion boss").addClass(n.Rank.toLowerCase()),$("#ba-stage-enemy-level .label").text(`Lv.${t}`),$("#ba-stage-enemy-class").removeClass("ba-class-main ba-class-support").addClass(`ba-class-${n.SquadType.toLowerCase()}`),$("#ba-stage-enemy-class .label").text(getLocalizedString("SquadType",n.SquadType)),$("#ba-stage-enemy-size .label").text(null!=n.Size?getLocalizedString("CharacterSize",n.Size):""),$("#ba-stage-enemy-size").toggle(null!=n.Size),setAttackTypeClass($("#ba-stage-enemy-attacktype .icon-type"),n.BulletType),setDefenseTypeClass($("#ba-stage-enemy-defensetype .icon-type"),n.ArmorType),$("#ba-stage-enemy-attacktype .label").text(getLocalizedString("BulletType",n.BulletType)),$("#ba-stage-enemy-defensetype .label").text(getLocalizedString("ArmorType",n.ArmorType)),$("#ba-stage-enemy-attacktype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("BulletType",n.BulletType)}`,translateUI("attacktype"),null,getAttackTypeText(n.BulletType),32),placement:"top",html:!0}),$("#ba-stage-enemy-defensetype").tooltip("dispose").tooltip({title:getRichTooltip(null,`${getLocalizedString("ArmorType",n.ArmorType)}`,translateUI("defensetype"),null,getDefenseTypeText(n.ArmorType),32),placement:"top",html:!0});let r=new CharacterStats(n,t,s,n.Transcendence?n.Transcendence:[],1==i?"TimeAttack":"Standard");if("raids"==loadedModule){if(8e3==raid.Id)switch(e){case 7801003:case 7801103:r.setBase("MaxHP",10);break;case 7801004:case 7801104:case 7801203:r.setBase("MaxHP",15);break;case 7801204:r.setBase("MaxHP",23)}if(19e3==raid.Id)switch(e){case 7810003:case 7810004:r.setBase("MaxHP",250)}if(21e3==raid.Id)switch(e){case 7832101:case 7832102:case 7832103:case 7832104:r.setBase("DefensePower",2e3),r.setBase("DodgePoint",1500);break;case 7832201:case 7832202:case 7832203:case 7832204:r.setBase("DefensePower",2e3),r.setBase("DodgePoint",1e3);break;case 7832301:case 7832302:case 7832303:case 7832304:r.setBase("DefensePower",2e3),r.setBase("DodgePoint",500)}}enemyStatList.forEach(e=>{"AmmoCount"==e?$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).text("Main"==n.SquadType?r.getBaseString("AmmoCount")+" ("+r.getBaseString("AmmoCost")+")":"-"):"DefensePower"==e||"StabilityPoint"==e?$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).html(`<span class="has-tooltip">${r.getBaseString(e)}</span>`):$(`#ba-stage-enemy-stat-table .stat-${e} .stat-value`).text(r.getBaseString(e))});const o=r.terrain[a],d=adaptationAmount[o];$("#ba-stage-enemy-terrain .label").text(d),$("#ba-stage-enemy-terrain .icon-terrain-strength img").attr("src",`images/ui/Ingame_Emo_Adaptresult${d}.png`),$("#ba-stage-enemy-terrain").tooltip("dispose").tooltip({title:getRichTooltip(`images/ui/Ingame_Emo_Adaptresult${d}.png`,translateUI("terrain_adaption",[getLocalizedString("AdaptationType",a)])+" "+d,null,null,getAdaptationText(a,d),30),placement:"top",html:!0});let c=translateUI("stat_defense_tooltip",[`<b>${r.getDefenseDamageReduction()}</b>`]);$(".stat-DefensePower .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(c),html:!0,placement:"top"});let u=translateUI("stat_stability_tooltip",[`<b>${r.getStabilityMinDamage()}</b>`]);$(".stat-StabilityPoint .has-tooltip").tooltip("dispose").tooltip({title:getBasicTooltip(u),html:!0,placement:"top"}),renderEnemySkills(n,$("#ba-stage-enemy-skills"))}function renderEnemySkills(e,t){const a=/[0-9.]+(?:%|s|秒|초| วินาที)/g;let s="";if(void 0!==e.Skills){""==s&&(s='<div class="ba-panel-separator mb-2"></div><ul>');for(const t of e.Skills)s+=`<li>${replaceBuffPlaceholders(t.replace(a,(function(e){return`<strong>${e}</strong>`})))}</li>`}if(void 0!==e.PhaseChange){""==s&&(s='<div class="ba-panel-separator mb-2"></div><ul>');for(const t of e.PhaseChange)switch(t.Trigger){case"HPUnder":s+=`<li>${getLocalizedString("RaidChangePhase","HPUnder",[`<b>${t.Phase+1}</b>`,`<b class="text-emphasis">${t.Argument.toLocaleString()}</b>`])}</li>`}}""==s?t.empty().hide():(s+="</ul>",t.html(s),t.show(),t.find(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})})))}function populateMapEnemyList(e){stageMapModal.hide();let t={};const a=["Minion","Elite","Champion","Boss"];let s=find(loadedStage.Formations,"Id",e)[0],i="";for(let e=0;e<s.EnemyList.length;e++){let i=find(data.enemies,"Id",s.EnemyList[e])[0],l=a.indexOf(i.Rank);t[`${4-l}_${i.Id}_${s.Level[l]}_${s.Grade[l]}`]=i}Object.keys(t).sort().forEach(e=>{e_level=e.split("_")[2],e_grade=e.split("_")[3],i+=getEnemyCardHTML(t[e],e_level,loadedStage.Terrain,e_grade,0,!1)}),$("#ba-stage-map-enemies").html(i),window.scrollTo({top:$("#ba-stage-map-enemies").prop("offsetTop"),left:0})}function getMaterialIconHTML(e,t){let a,s,i;return e>=3e6?(a=find(data.currency,"Id",e-3e6)[0],s="Currency"):(a=find(data.items,"Id",e)[0],s=a.Category),i=`<div class="drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${a.Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/item/icon/${a.Icon}.webp`,getTranslatedString(a,"Name").escapeHtml(),getLocalizedString("ItemCategory",s),getRarityTier(a.Rarity),getTranslatedString(a,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${a.Rarity.toLowerCase()}" src="images/item/icon/${a.Icon}.webp" alt="${a.Name}">${0!=t?`<span class="ba-material-label" style="cursor:pointer;">&times;${t}</span>`:""}</div>`,i}function getDropIconHTML(e,t,a=1,s=1,i=!1,l=null,n=null){let r,o,d,c,u;if(e>=4e6&&e<5e6){const t=find(data.groups,"Id",e-4e6);if(!(t.length>0))return"";d=t[0],o="GachaGroup",u="Box",iconPath="item",c=!1}else e>=3e6&&e<4e6?(r=find(data.currency,"Id",e-3e6)[0],o="Currency",u="Currency",iconPath="item",c=!1):e>=2e6&&e<3e6?(r=find(data.equipment,"Id",e-2e6)[0],o="Equipment",u=r.Category,iconPath="equipment",c=!0):e>=1e6&&e<2e6?(r=find(data.furniture,"Id",e-1e6)[0],o="Furniture",u=r.Category,iconPath="furniture",c=!0):(r=find(data.items,"Id",e)[0],o="Item",u=r.Category,iconPath="item",c=!0);let g="";r&&(g="Equipment"==o&&r.Id>=1e3?`T${r.Id%10+1}`:getRarityTier(r.Rarity));let p="";if("GachaGroup"==o){let e="N";if(1==d.ItemList.length)return getDropIconHTML(d.ItemList[0][0],t<1?t:d.ItemList[0][3]);{let a,s,i;if(d.Id>=6e5&&d.Id<7e5){i=translateUI("item_equipment_box")+"\n",iconPath="equipment";let e="",t="";const l=d.ItemList.reduce((e,t)=>e+t[1],0);for(let s=0;s<d.ItemList.length;s++){let n=find(data.equipment,"Id",d.ItemList[s][0]-2e6)[0];i+=`${getTranslatedString(n,"Name")} (${getProbabilityText(d.ItemList[s][1]/l)})\n`,a=n.Icon,t=getLocalizedString("ItemCategory",n.Category),""!=e&&(e+="/"),e+=`T${n.Id%10+1}`}s=translateUI("item_randombox_tier",[e,t])}else if(d.Id>=4e5&&d.Id<41e4){i=translateUI("item_equipment_box")+"\n",iconPath="item",a="item_icon_equipment_random",e="N";const t=d.Id%10+1;s=translateUI("item_randombox_tier",["T"+t,getLocalizedString("ItemCategory","Equipment")]);const l=d.ItemList.reduce((e,t)=>e+t[1],0);for(let e=0;e<d.ItemList.length;e++){let t;i+=`${getTranslatedString(find(data.equipment,"Id",d.ItemList[e][0]-2e6)[0],"Name")} (${getProbabilityText(d.ItemList[e][1]/l)})\n`}}else if(d.Id>=3e5&&d.Id<=300075){i=translateUI("item_equipment_box")+"\n",iconPath="equipment";let e="",t="";const l=d.ItemList.reduce((e,t)=>e+t[1],0);for(let s=0;s<d.ItemList.length;s++){let n=find(data.equipment,"Id",d.ItemList[s][0]-2e6)[0];i+=`${getTranslatedString(n,"Name")} (${getProbabilityText(d.ItemList[s][1]/l)})\n`,0==s&&(e=`T${n.Id%10+1} `,a=n.Icon),""!=t&&(t+="/"),t+=getLocalizedString("ItemCategory",n.Category)}s=translateUI("item_randombox_tier",[e,t])}else if(d.Id>=300660&&d.Id<37e4){i=translateUI("item_contains_random")+"\n"+translateUI("item_is_immediateuse")+"\n",iconPath="item";let t=0,l=0;const n=d.ItemList.reduce((e,t)=>e+t[1],0);for(let e=0;e<d.ItemList.length;e++){let a=find(data.items,"Id",d.ItemList[e][0])[0];i+=`${getTranslatedString(a,"Name")} (${getProbabilityText(d.ItemList[e][1]/n)})\n`,t=Math.max(a.Id%10,t),l=Math.floor(a.Id/1e3)}const r=find(data.items,"Id",1e4*l+t)[0];s=r.Name,a=r.Icon,e=r.Rarity}else if(d.Id>=10100&&d.Id<=10200){const t=find(data.items,"Id",d.ItemList[0][0])[0];e=t.Rarity,a=`item_icon_material_random_${t.Id.toString().slice(-1)}`,s=translateUI("item_randombox_tier",[e,getLocalizedString("ItemCategory","Artifact")]),i=translateUI("item_artifact_box")+"\n";const l=d.ItemList.reduce((e,t)=>e+t[1],0);for(let e=0;e<d.ItemList.length;e++){let t;i+=`${getTranslatedString(find(data.items,"Id",d.ItemList[e][0])[0],"Name")} (${getProbabilityText(d.ItemList[e][1]/l)})\n`}}("Box"==u||r.ImmediateUse)&&(i+=`<i><i class="fa-solid fa-box-open" style="font-size: 12px;"></i> ${translateUI("item_is_immediateuse")}</i>`),p=`<div class="item-drop drop-shadow" style="position: relative; data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/${iconPath}/icon/${a}.webp`,s,getLocalizedString("ItemCategory","Box"),"",i,50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.toLowerCase()}" src="images/${iconPath}/icon/${a}.webp" alt="${s}"><span class="ba-material-label">${"Box"==u||r.ImmediateUse?'<i class="fa-solid fa-box-open" style="font-size: 12px;"></i> ':""}${getProbabilityText(t)}</span>${null!=l?`<span class="label-droptype">${l}</span>`:""}</div>`}}else{let o=getTranslatedString(r,"Desc").escapeHtml().replace("&","&amp;");if(r.ImmediateUse&&(o+=`\n<i><i class="fa-solid fa-box-open" style="font-size: 12px;"></i> ${translateUI("item_is_immediateuse")}</i>`),r.Id>91e6&&"Random"==r.ConsumeType){const e=getServerProperty(r,"Contains");e.forEach(e=>{const t=find(data.items,"Id",e[0])[0];o+=`\n${getTranslatedString(t,"Name")} (${getProbabilityText(e[1])})`})}n&&(o+=n),p=`<div class="item-drop drop-shadow" style="position: relative; ${c?'cursor:pointer;" onclick="loadItem('+e+')"':'"'} title="${getRichTooltip(`images/${iconPath}/icon/${r.Icon}.webp`,getTranslatedString(r,"Name").escapeHtml(),getLocalizedString("ItemCategory",u),g,o,50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${r.Rarity.toLowerCase()}" src="images/${iconPath}/icon/${r.Icon}.webp" alt="${r.Name}"><span class="ba-material-label" ${c?'style="cursor:pointer;"':""}>${"Box"==u||r.ImmediateUse?'<i class="fa-solid fa-box-open" style="font-size: 12px;"></i> ':""}${s>1||i?parseFloat((100*t).toFixed(2))+"&#37;":getProbabilityText(t)}</span>${s>1?`<span class="label-qty">&times;${a!=s?abbreviateNumber(a)+"~"+abbreviateNumber(s):abbreviateNumber(s)}</span>`:""}${null!=l?`<span class="label-droptype">${l}</span>`:""}</div>`}return p}function formatString(e,t=[]){return e.replace(/\{([0-9]+)\}/g,(e,a)=>a<t.length?t[a]:"")}function getProbabilityText(e){return e>=1?"&times;"+abbreviateNumber(parseInt(e).toFixed(0)).toLocaleString():parseFloat((100*e).toFixed(1))+"&#37;"}function getStudentIconSmall(e,t=null,a=null){var s;return`<div class="ba-item-student drop-shadow d-inline-block" style="position: relative; cursor: pointer;" data-bs-toggle="tooltip" data-bs-placement="top" onclick="loadStudent('${e.PathName}')" title="${getRichTooltip(`images/student/icon/${e.Id}.webp`,getTranslatedString(e,"Name"),translateUI("student"),getRarityStars(e.StarGrade),null==a?getTranslatedString(e,"ProfileIntroduction").split("\n")[0].escapeHtml().replace("&","&amp;"):a,50,"circle")}"><img src="images/student/icon/${e.Id}.webp" alt="${e.Name}">${null!=t?`<span class="bonus-label" style="cursor:pointer;">${t}</span>`:""}</div>`}function getFavourIconHTML(e,t){return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${e.Id})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/item/icon/${e.Icon}.webp`,getTranslatedString(e,"Name").escapeHtml(),getLocalizedString("ItemCategory",e.Category),getRarityTier(e.Rarity),getTranslatedString(e,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.Rarity.toLowerCase()}" src="images/item/icon/${e.Icon}.webp" alt="${e.Name}"><img class="ba-favor-label" src="images/ui/Cafe_Interaction_Gift_0${t+1}.png"></div>`}function getFurnitureIconHTML(e){var t;return`<div class="ba-favor-item drop-shadow" style="position: relative; cursor:pointer;" onclick="loadItem(${e.Id+1e6})" data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/furniture/icon/${e.Icon}.webp`,getTranslatedString(e,"Name").escapeHtml(),getLocalizedString("ItemCategory",e.Category),getRarityStars(e.Rarity),getTranslatedString(e,"Desc").escapeHtml().replace("&","&amp;"),50,"img-scale-larger")}"><img class="ba-item-icon ba-item-${e.Rarity.toLowerCase()} mb-2" src="images/furniture/icon/${e.Icon}.webp" alt="${e.Name}"></div>`}function recalculateWeaponSkillPreview(){let e=$("#ba-weapon-skillpreview-range").val(),t=find(student.Skills,"SkillType","weaponpassive")[0];$("#ba-skill-weaponpassive-description").html(getSkillText(t,e,{bulletType:student.BulletType})),$("#ba-skill-weaponpassive-description .skill-hitinfo").tooltip({html:!0}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function recalculateGearSkillPreview(){if(!("Released"in student.Gear))return;let e=$("#ba-gear-skillpreview-range").val(),t=find(student.Skills,"SkillType","gearnormal")[0];$("#ba-skill-gearnormal-description").html(getSkillText(t,e,{bulletType:student.BulletType})),$("#ba-skill-gearnormal-description .skill-hitinfo").tooltip({html:!0}),$(".ba-skill-debuff, .ba-skill-buff, .ba-skill-special, .ba-skill-cc").each((function(e,t){$(t).tooltip({html:!0})}))}function recalculateBondPreview(){var e=$("#ba-bond-levelrange").val(),t=getBondStats(student,e);$(`#ba-bond-stat-table .stat-${student.FavorStatType[0]} .stat-value`).text("+"+t[student.FavorStatType[0]].toLocaleString()),$(`#ba-bond-stat-table .stat-${student.FavorStatType[1]} .stat-value`).text("+"+t[student.FavorStatType[1]].toLocaleString())}function getBondStats(e,t){var a=0,s=0;for(let i=1;i<Math.min(t,50);i++)i<20?(a+=e.FavorStatValue[Math.floor(i/5)][0],s+=e.FavorStatValue[Math.floor(i/5)][1]):i<50&&(a+=e.FavorStatValue[2+Math.floor(i/10)][0],s+=e.FavorStatValue[2+Math.floor(i/10)][1]);return{[e.FavorStatType[0]]:a,[e.FavorStatType[1]]:s}}function getWeaponStats(e,t){let a={MaxHP:0,AttackPower:0,HealPower:0},s=(t-1)/99;return"Standard"==e.Weapon.StatLevelUpType&&(s=s.toFixed(4)),a.AttackPower=Math.round(e.Weapon.AttackPower1+(e.Weapon.AttackPower100-e.Weapon.AttackPower1)*s),a.MaxHP=Math.round(e.Weapon.MaxHP1+(e.Weapon.MaxHP100-e.Weapon.MaxHP1)*s),a.HealPower=Math.round(e.Weapon.HealPower1+(e.Weapon.HealPower100-e.Weapon.HealPower1)*s),a}function changeStatPreviewStars(e,t,a=!0){let s=statPreviewWeaponGrade;statPreviewStarGrade=e,statPreviewWeaponGrade=t;for(let t=1;t<=5;t++)$(`.statpreview-star-${t}`).toggleClass("active",t<=e);for(let e=1;e<=3;e++)$(`.weaponpreview-star-${e}`).toggleClass("active",e<=t);const i=parseInt($("#ba-statpreview-bond-0-range").val());if(i>maxbond[e-1]&&($("#ba-statpreview-bond-0-range").val(maxbond[e-1]),changeStatPreviewBondLevel(0,!1)),$("#ba-statpreview-bond-0-range").attr("max",Math.min(maxbond[e-1],region.BondMaxLevel)),t>0){$("#ba-statpreview-weapon").toggleClass("disabled",!1),$(".statpreview-weapon-range").prop("disabled",!1);let e=20+10*t;$(".statpreview-weapon-range").attr("max",e),a&&$(".statpreview-weapon-range").val(e),updateWeaponLevelStatPreview(e)}else $("#ba-statpreview-weapon").toggleClass("disabled",!0),$(".statpreview-weapon-range").prop("disabled",!0);$("#ba-student-weapon-level").toggle(statPreviewWeaponGrade>0),(3==t&&s<3||3==s&&t<3)&&recalculateTerrainAffinity(),(t>=2&&s<2||s>=2&&t<2)&&updatePassiveSkillStatPreview(),a&&recalculateStats()}function updatePassiveSkillStatPreview(){const e=$("#ba-statpreview-passiveskill-range").val(),t=statPreviewWeaponGrade>=2;let a="";const s=find(student.Skills,"SkillType","passive")[0];if(s.Effects.forEach(t=>{const s=t.Stat.includes("_Coefficient")?t.Scale[e-1]/1e4:t.Scale[e-1];s>0&&(a+=`${getStatName(t.Stat)} <b>+${getFormattedStatAmount(s)}</b>, `),s<0&&(a+=`${getStatName(t.Stat)} <b>${getFormattedStatAmount(s)}</b>, `)}),t){const t=find(student.Skills,"SkillType","weaponpassive")[0];t.Effects.forEach(t=>{const s=t.Stat.includes("_Coefficient")?t.Scale[e-1]/1e4:t.Scale[e-1];s>0&&(a+=`${getStatName(t.Stat)} <b>+${getFormattedStatAmount(s)}</b>, `),s<0&&(a+=`${getStatName(t.Stat)} <b>${getFormattedStatAmount(s)}</b>, `)}),$("#ba-statpreview-passiveskill-name").html(getTranslatedString(t,"Name")),$("#ba-statpreview-passiveskill-icon img, #ba-statpreview-status-passive-icon").attr("src",`images/skill/${t.Icon}.webp`)}else $("#ba-statpreview-passiveskill-name").html(getTranslatedString(s,"Name")),$("#ba-statpreview-passiveskill-icon img, #ba-statpreview-status-passive-icon").attr("src",`images/skill/${s.Icon}.webp`);$("#ba-statpreview-passiveskill-desc").html(a.substring(0,a.length-2)),$(".statpreview-passive").toggleClass("plus",t),$("#ba-statpreview-status-passive-level .label").html(e<10?`Lv.${e}`:'<img src="images/ui/ImageFont_Max.png" style="height:16px;">')}function updateSummonSourceSkill(){if(statPreviewSelectedChar>0){$("#ba-statpreview-summon").show();const e=student.Summons[statPreviewSelectedChar-1],t=find(student.Skills,"SkillType",e.SourceSkill)[0],a="ex"==e.SourceSkill?5:10;$("#ba-statpreview-summon-range").attr("max",a);const s=$("#ba-statpreview-summon-range").val();s==a?$("#ba-statpreview-summon-level").html('<img src="images/ui/ImageFont_Max.png">'):$("#ba-statpreview-summon-level").html("Lv."+s),$("#ba-statpreview-summon-name").html(getTranslatedString(t,"Name")),$("#ba-statpreview-summon-desc").empty(),$("#ba-statpreview-summon-icon img").attr("src",`images/skill/${t.Icon}.webp`);for(let t=0;t<e.InheritCasterStat.length;t++)$("#ba-statpreview-summon-desc").append((0==t?"":"\n")+translateUI("summon_inheritance",[`<b>${parseFloat((e.InheritCasterAmount[t][s-1]/100).toPrecision(3))}%</b>`,getTranslatedString(student,"Name"),getStatName(e.InheritCasterStat[t])]))}else $("#ba-statpreview-summon").hide()}function populateItemList(e){let t="",a,s=function(e){return`<div id="item-select-${e}" data-itemid="${e}" class="selection-grid-card ${"compact"==gridItemDisplayStyle?"compact":""} card-items" style="display:none;"></div>`};switch(gridItemDisplayStyle){case"detailed":a=n;break;case"compact":a=r}const i=getItemIdOffset(e);data[e].forEach(e=>{e.IsReleased[regionID]&&(t+=s(e.Id+i))});const l=(new Date).getTime()/1e3;if(t+=`<div id="item-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`,$("#item-search-filters-panel .item-filter-group").hide(),$(`#item-search-filters-panel .item-filter-group.show-${e}`).show(),$('#item-search-filters-panel [class*="only-"]').hide(),$(`#item-search-filters-panel .only-${e}`).show(),loadedItemList=e,$("#item-select-grid").html(t),updateItemList(!0),loadedItemType==e){$(`#item-select-${loadedItem.Id+getItemIdOffset(e)}`).addClass("selected");let t=$(`#item-select-${loadedItem.Id+getItemIdOffset(e)}`).prop("offsetTop")-100;$("#ba-item-list-container .card-body").scrollTop(void 0===t?0:t)}function n(e){const t=find(data[loadedItemList],"Id",e>=2e7?e:e%1e6)[0],a="items"==loadedItemList?"item":loadedItemList,s=getTranslatedString(t,"Name"),i=getSmallTextThreshold(s,label_craft_smalltext_threshold);let n=`<div class="card-img ba-item-${t.Rarity.toLowerCase()}"><img loading="lazy" src="images/${a}/icon/${t.Icon}.webp"></div>`;return"furniture"==loadedItemList&&t.Interaction[regionID]&&(n+='<div class="card-badge furniture-interaction"><img src="images/ui/Cafe_Icon_Interaction.png"></div>'),"equipment"==loadedItemList&&t.Id>=1e3&&(n+=`<div class="card-badge equipment-tier">T${t.Tier}</div>`),"items"==loadedItemList&&(t.ExpiryTime&&t.ExpiryTime[regionID]&&(n+=`<div class="card-badge equipment-tier"><i class="fa-solid fa-clock me-1"></i>${t.ExpiryTime[regionID]>l?durationStringShort(t.ExpiryTime[regionID]-l):'<i class="fa-solid fa-xmark"></i>'}</div>`),t.ImmediateUse&&(n+='<div class="card-badge equipment-tier"><i class="fa-solid fa-box-open"></i></div>')),n+=`<div class="card-label"><span class="label-text ${s.length>i?"smalltext":""}">${s}</span></div>`,n}function r(e){const t=find(data[loadedItemList],"Id",e>=2e7?e:e%1e6)[0],a="items"==loadedItemList?"item":loadedItemList,s=getTranslatedString(t,"Name").escapeHtml().replace(/"/g,"&quot;");return`<div class="card-compact ba-item-${t.Rarity.toLowerCase()}" title="${getBasicTooltip(s)}"><img loading="lazy" src="images/${a}/icon/${t.Icon}.webp"></div>`}loadObserver&&loadObserver.disconnect(),loadObserver=new IntersectionObserver((function(e,t){e.forEach(e=>{e.isIntersecting&&(e.target.innerHTML=a(parseInt(e.target.id.replace("item-select-",""))),"compact"==gridItemDisplayStyle&&$(e.target).children(".card-compact").tooltip({html:!0,placement:"top",delay:{show:200,hide:0},container:$(".card-body")}),loadObserver.unobserve(e.target))})}),{root:$("#ba-item-list-container .card-body")[0]}),$("#item-select-grid div[data-itemid]").each((function(e,t){loadObserver.observe(t)}))}function getItemIdOffset(e){switch(e.toLowerCase()){case"furniture":return 1e6;case"equipment":return 2e6;case"currency":return 3e6;default:return 0}}function populateCraftList(){html=["","",""],html[0]="",html[1]="",html[2]="",html_h1=`<div id="craft-list-grid-header-1" class="w-100 ba-grid-header mb-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","1")}</h3></div>`,html_h2=`<div id="craft-list-grid-header-2" class="w-100 ba-grid-header my-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","2")}</h3></div>`,html_h3=`<div id="craft-list-grid-header-3" class="w-100 ba-grid-header my-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier","3")}</h3></div>`,data.crafting.Nodes.sort((e,t)=>e.Quality-t.Quality),data.crafting.Nodes.sort((e,t)=>t.Icon.localeCompare(e.Icon));const e=$("#craft-search-text").val();$.each(data.crafting.Nodes,(function(t,a){a.Weight>0&&(""==e||getTranslatedString(a,"Name").toLowerCase().includes(e.toLowerCase()))&&(html[a.Tier-1]+=getCraftingCardHTML(a,a.Weight/data.crafting.TotalWeight[a.Tier-1],showNodeProbability))})),$("#craft-select-grid").empty();for(let e=0;e<3;e++)""!=html[e]&&$("#craft-select-grid").append(`<div id="craft-list-grid-header-${e+1}" class="w-100 ba-grid-header mb-2 p-2"><h3 class="mb-0">${getLocalizedString("NodeTier",e+1)}</h3></div>${html[e]}`);0==$("#craft-select-grid").children().length&&$("#craft-select-grid").append(`<div id="craft-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`),html="",data.crafting.Fusion.forEach(e=>{const t=e.ResultId>=1e6?"furniture":"items",a=find(data[t],"Id",e.ResultId%1e6)[0];a.IsReleased[regionID]&&(html+=getFusionRecipeCardHTML(e))}),""!=html?$("#fusion-select-grid").html(html):$("#fusion-select-grid").html(`<div id="fusion-select-noresult" class="p-2 grid-text">${translateUI("no_results")}</div>`),$("#craft-select-"+loadedCraftId).addClass("selected");let t=$(`#craft-select-${loadedCraftId}`).prop("offsetTop")-100;$("#ba-craft-list-container .card-body").scrollTop(void 0===t?0:t)}function getCraftingCardHTML(e,t=-1,a=!1,s=0,i=0){let l=getTranslatedString(e,"Name"),n=label_craft_smalltext_threshold[userLang],r=`<div id="craft-select-${e.Id}" class="selection-grid-card card-craft" onclick="loadCraft(${e.Id})"><div class="card-img ba-node-quality-${e.Quality}"><img loading="lazy" src="images/ui/${e.Icon}.png"></div>`;return t>=0&&(r+=`<span class="card-badge stage-droprate ${a?"":"hidden"}">${getProbabilityText(t)+(i>1?` (${s}${i>s?`~${i}`:""})`:"")}</span>`),r+='<div class="card-label">',r+=`<span class="label-text ${l.length>n?"smalltext":""}">${l}</span>`,r+="</div></div>",r}function getFusionRecipeCardHTML(e){const t=e.ResultId>=1e6?"furniture":"items",a=find(data[t],"Id",e.ResultId%1e6)[0],s="items"==t?"item":t,i=getTranslatedString(a,"Name"),l=getSmallTextThreshold(i,label_craft_smalltext_threshold);return`<div id="craft-select-${e.Id+1e5}" data-itemid="${e.Id+1e5}" class="selection-grid-card card-items"><div class="card-img ba-item-${a.Rarity.toLowerCase()}"><img loading="lazy" src="images/${s}/icon/${a.Icon}.webp"></div><div class="card-label"><span class="label-text ${i.length>l?"smalltext":""}">${i}</span></div></div>`}function getSmallTextThreshold(e,t){return("En"==userLang||"Th"==userLang)&&e.codePointAt(0)>=12288&&e.codePointAt(0)<=40959?t.Jp:t[userLang]}function populateStageList(e){let t="",a="";switch(e){case"missions":$.each(data.stages.Campaign,(function(e,a){a.Area>region.CampaignMax||(region.CampaignExtra||"A"!=a.Stage)&&(t+=getStageCardHTML(a))})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-missions").tab("show"),$("#stage-select-grid").html(t);break;case"bounty":$.each(data.stages.WeekDungeon,(function(e,s){if(s.Id<31e3){if(s.Type!=a){let e=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`;t+=e}s.Stage<=region.ChaserMax&&(t+=getStageCardHTML(s)),a=s.Type}})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-bounty").tab("show"),$("#stage-select-grid").html(t);break;case"commissions":a="",$.each(data.stages.WeekDungeon,(function(e,s){if(s.Id>=31e3){if(s.Type!=a){let e=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`;t+=e}s.Stage<=(s.Id>=32e3?region.BloodMax:region.FindGiftMax)&&(t+=getStageCardHTML(s)),a=s.Type}})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-commissions").tab("show"),$("#stage-select-grid").html(t);break;case"schooldungeon":a="",$.each(data.stages.SchoolDungeon,(function(e,s){s.Type!=a&&(t+=`<div id="stages-list-grid-header-${s.Type}" class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType",""+s.Type)}</h3></div>`),s.Stage<=region.SchoolDungeonMax&&(t+=getStageCardHTML(s)),a=s.Type})),$(".stage-list").hide(),$("#stage-list").show(),$("#ba-stages-list-tab-schooldungeon").tab("show"),$("#stage-select-grid").html(t);break;case"events":region.Events.forEach(e=>{e<1e4&&(t+=getEventCardHTML(e))}),$(".stage-list").hide(),$("#event-list").show(),$("#ba-stages-list-tab-events").tab("show"),$("#event-select-grid").html(t)}if(loadedStageList=e,$("#stage-select-"+loadedStage.Id).addClass("selected"),loadedStage.Id<7e6){let e=$(`#stage-select-${loadedStage.Id}`).prop("offsetTop")-100;$("#ba-stages-list-container .card-body").scrollTop(void 0===e?0:e)}}function populateEventStageList(e){if("stages"==loadedModule){let t=0,a=0,s=0;const i=getEventlogoLang(e%=1e4);let l=`<div class="ba-grid-header ba-panel p-2 eventlist-header" style="grid-column: 1/-1;order: 0;"><button id="stages-eventlist-back" type="button" class="btn btn-dark me-2" style="min-width:fit-content;" onclick="populateStageList('events')"><i class="fa-solid fa-chevron-left"></i><span class="d-inline ms-2">${getLocalizedString("StageType","Event")}</span></button><img class="mx-auto mx-lg-1" src="images/eventlogo/${e}_${i}.webp"><h4 class="flex-fill text-center px-1 mb-0">${getLocalizedString("EventName",""+e)}</h4></div></div>`;if(conquest_events.includes(e)){$(".stage-list").hide(),$("#conquest-list").show();let t=find(data.stages.ConquestMap,"EventId",e)[0];loadedConquest=t,$("#ba-conquest-header").html(l),$("#ba-conquest-step-n0").tab("show");for(let e=0;e<4;e++)$(`#ba-conquest-step-n${e}`).text(translateUI("conquest_area",[e+1]));changeConquestMap(0,0)}else{let i;find(data.stages.Event,"EventId",e).forEach(i=>{if((i.Versions.includes("Original")||region.Events.includes(e+1e4))&&!(701==e&&i.Stage>region.Event701Max[i.Difficulty]))if(i.Field)i.Area!=a&&(l+=`<div class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType","Field",[i.Area])}</h3></div>`),l+=getStageCardHTML(i),a=i.Area;else{if(i.Difficulty!=t||i.EventId!=s){let e,t;switch(i.Difficulty){case 0:e=getLocalizedString("StageType","Story");break;case 1:e=getLocalizedString("StageType","Quest");break;case 2:e=getLocalizedString("StageType","Challenge")}l+=`<div class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${e}</h3></div>`}l+=getStageCardHTML(i),t=i.Difficulty,s=i.EventId}}),$(".stage-list").hide(),$("#stage-list").show(),$("#stage-select-grid").html(l),$("#stage-select-"+loadedStage.Id).addClass("selected")}loadedStageList=""+e,$("#ba-stages-list-tab-events").tab("show"),$("#ba-stages-list-container .card-body").scrollTop(0)}else conquest_events.includes(e)?loadModule("stages",find(data.stages.Conquest,"EventId",e%1e4)[0].Id):(e>1e4&&(loadedStageVersion="Rerun"),loadModule("stages",find(data.stages.Event,"EventId",e%1e4)[0].Id))}function populateRaidList(){var e="",e;e="",$.each(data.raids.Raid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a))})),$("#raid-select-grid").html(e),e="",$.each(data.raids.TimeAttack,(function(t,a){a.IsReleased[regionID]&&(e+=getTimeAttackCardHTML(a))})),$("#timeattack-select-grid").html(e),$("#worldraid-select-grid").empty(),e="",$.each(data.raids.WorldRaid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a,null,a.IconBG))})),""!=e&&(e=`<div class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType","WorldRaid")}</h3></div>`+e),$("#worldraid-select-grid").append(e),e="",$.each(data.raids.MultiFloorRaid,(function(t,a){a.IsReleased[regionID]&&(e+=getRaidCardHTML(a,null,a.IconBG))})),""!=e&&(e=`<div class="ba-grid-header p-2" style="grid-column: 1/-1;order: 0;"><h3 class="mb-0">${getLocalizedString("StageType","MultiFloorRaid")}</h3></div>`+e),$("#worldraid-select-grid").append(e)}function getUsedByStudents(e,t){let a="",s=translateUI("item_usedby"),i="";if("equipment"==t)$.each(data.students,(function(t,s){s.IsReleased[regionID]&&(s.StyleId>0||s.Equipment[0]!=e.Category&&s.Equipment[1]!=e.Category&&s.Equipment[2]!=e.Category||(a+=getStudentIconSmall(s)))}));else if("furniture"==t)s=`<img class="inline-img" src="images/ui/Cafe_Icon_Interaction.png"> ${translateUI("furniture_interaction_list")}`,interactiveStudents=[],$.each(data.students,(function(t,a){if(a.IsReleased[regionID]&&!(a.StyleId>0))for(let t=0;t<a.FurnitureInteraction[regionID].length;t++)if(e.Id==a.FurnitureInteraction[regionID][t][0])return void interactiveStudents.push([a,a.FurnitureInteraction[regionID][t][1]])})),interactiveStudents.forEach(e=>{1==interactiveStudents.length?a+=getStudentIconSmall(e[0]):1==e[1]||0==e[1]&&interactiveStudents.some(e=>2==e[1])?a+=getStudentIconSmall(e[0],'<i class="fa-solid fa-user"></i><span class="mx-1">/</span><i class="fa-solid fa-users"></i>'):0==e[1]?a+=getStudentIconSmall(e[0],'<i class="fa-solid fa-users"></i>'):2==e[1]?a+=getStudentIconSmall(e[0],'<i class="fa-solid fa-users"></i>'):3==e[1]&&(a+=getStudentIconSmall(e[0],'<i class="fa-solid fa-user"></i>'))});else if("items"==t)if("Material"==e.Category)s=translateUI("item_usedby_skill"),$.each(data.students,(function(t,s){if(!s.IsReleased[regionID])return;if(s.StyleId>0)return;let l=[0,0];for(let t=0;t<s.SkillExMaterial.length;t++)for(let a=0;a<s.SkillExMaterial[t].length;a++)e.Id==s.SkillExMaterial[t][a]&&(l[0]+=s.SkillExMaterialAmount[t][a]);for(let t=0;t<s.SkillMaterial.length;t++)for(let a=0;a<s.SkillMaterial[t].length;a++)e.Id==s.SkillMaterial[t][a]&&(l[1]+=s.SkillMaterialAmount[t][a]);if(l[0]>0||l[1]>0){const e=l[0]+3*l[1];a+=getStudentIconSmall(s,`&times;${e}`,`${translateUI("item_usedby_exskill_amount",[l[0]])}\n${translateUI("item_usedby_skill_amount",[l[1]])}`)}if("Released"in s.Gear&&s.Gear.Released[regionID])for(let t=0;t<s.Gear.TierUpMaterial.length;t++)for(let a=0;a<s.Gear.TierUpMaterial[t].length;a++)e.Id==s.Gear.TierUpMaterial[t][a]&&(i+=getStudentIconSmall(s,`&times;${s.Gear.TierUpMaterialAmount[t][a]}`))}));else if("SecretStone"==e.Category){s=translateUI("item_usedby_eleph");let t=find(data.students,"Id",e.Id)[0];a+=getStudentIconSmall(t)}else"Coin"==e.Category&&void 0!==e.EventBonus&&(s=translateUI("item_eventbonus"),getServerProperty(e,"EventBonus").forEach(e=>{const t=find(data.students,"Id",e[0]);t.length&&(a+=getStudentIconSmall(t[0],`+${e[1]/100}%`))}));return""!=a?($("#ba-item-usage").show(),a=`<div class="mb-2"><i>${s}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+a+"</div>",""!=i&&(a+=`<div class="my-2"><i>${translateUI("item_usedby_gear")}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${i}</div>`),a):""}function getConsumableRewards(e){let t="",a="";const s=getServerProperty(e,"Contains");switch(e.ConsumeType){case"Random":a=translateUI("item_contains_random"),s.forEach(e=>{t+=getDropIconHTML(e[0],e[1],e[2],e[3])});break;case"Choice":a=translateUI("item_contains_choice"),s.forEach(e=>{t+=getDropIconHTML(e[0],e[1],e[2],e[3])});break;case"All":a=translateUI("item_contains"),s.forEach(e=>{t+=getDropIconHTML(e[0],e[2])})}return""!=t?($("#ba-item-usage").show(),t=`<div class="mb-2"><i>${a}</i></div><div class="item-icon-list">`+t+"</div>",t):""}function getEquipmentRecipe(e){let t="",a=translateUI("craft_using");if("Recipe"in e){for(let a=0;a<e.Recipe.length;a++)t+=getDropIconHTML(e.Recipe[a][0]+2e6,e.Recipe[a][1]);t+=getDropIconHTML(3000001,e.RecipeCost)}return""!=t?($("#ba-equipment-recipe").show(),`<div class="mb-2"><i>${a}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap">`+t+"</div>"):""}function getLikedByStudents(e){let t=["","",""],a="";const s=data.config.CommonFavorItemTags,i=e.Tags.filter(e=>s.includes(e)).length;data.students.forEach(i=>{if(!i.IsReleased[regionID])return;if(i.StyleId>0)return;const l=[...i.FavorItemTags,...i.FavorItemUniqueTags,...s],n=e.Tags.filter(e=>l.includes(e)),r=Math.min(n.length,3);r>0&&(t[r-1]+=getStudentIconSmall(i)),"Released"in i.Gear&&i.Gear.Released[regionID]&&i.Gear.TierUpMaterial.forEach(t=>{t.includes(e.Id)&&(a+=getStudentIconSmall(i))})});let l="";for(let a=t.length;a>0;a--)a-i!=0&&""!=t[a-1]&&(l+=`<div class="mb-2"><i>${translateUI("item_student_favor",[e.ExpValue*(a+1),`<img class="inline-img" src="images/ui/Cafe_Interaction_Gift_0${1+a}.png">`])}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${t[a-1]}</div>`);return l+=`<div class="mb-2"><i>${translateUI(""==l?"item_student_favor_all":"item_student_favor_default",[e.ExpValue*(i+1),`<img class="inline-img" src="images/ui/Cafe_Interaction_Gift_0${1+i}.png">`])}</i></div>`,""!=a&&(l+=`<div class="mb-2"><i>${translateUI("item_usedby_gear")}</i></div><div class="d-flex align-items-center justify-content-center flex-wrap mb-2">${a}</div>`),$("#ba-item-usage").show(),l}function getItemDropStages(e,t=!1){let a="",s=[],i=[data.stages.Campaign,data.stages.SchoolDungeon,data.stages.WeekDungeon];return t&&i.push(data.stages.Event),$.each(i,(function(t,a){a.forEach(t=>{if(!stageIsReleased(t))return;let a=!1,i=0,l=!1,n=0,r=[];if(t.Versions)for(const e of t.Versions){let a=getVersionProperty(t,"Rewards",e);r.push(...(region.Name in a?a[region.Name]:a.Jp).Default)}else r.push(...(region.Name in t.Rewards?t.Rewards[region.Name]:t.Rewards.Jp).Default);for(let t=0;t<r.length;t++)if(r[t][0]>=4e6&&r[t][0]<5e6){const s=find(data.groups,"Id",r[t][0]-4e6)[0],o=s.ItemList.reduce((e,t)=>e+t[1],0);s.ItemList.forEach(s=>{e==s[0]&&(a=!0,l=!0,r[t][1]>=1?(n=r[t][1],dropCertainChance=s[1]/o):i=r[t][1]*(s[1]/o))})}else if(e==r[t][0]){a=!0,i=r[t][1];break}if(a){if(l&&n>0){let e=1-Math.pow(1-dropCertainChance,n),t=i;i=e+i-e*i}s.push({chance:i,stage:t,box:l})}})})),s=s.sort((e,t)=>t.chance-e.chance),$.each(s,(function(e,t){a+=getStageCardHTML(t.stage,t.chance,!1)})),""!=a?($("#ba-item-sources").show(),`<div class="mb-2"><i>${translateUI("item_obtainedfrom_stage")}</i></div><div class="selection-grid stage selection-grid-flex">`+a+"</div>"):""}function getItemCraftNodes(e,t){let a=["","",""],s="";if(data.crafting.Nodes.forEach(s=>{if(s.Weight>0){let i=s.Groups.reduce((e,t)=>e+t.Weight,0);for(group of s.Groups){const l=data.crafting.Groups[group.GroupId];let n=l.reduce((e,t)=>e+t.Weight,0);for(groupItem of l)if(groupItem.Type==t&&groupItem.ItemId==e){let e=group.Weight/i*(groupItem.Weight/n);a[s.Tier-1]+=getCraftingCardHTML(s,e,!0)}}}}),""!=a[0]||""!=a[1]||""!=a[2]){s+=`<div class="mb-2"><i>${translateUI("item_obtainedfrom_synthesis")}</i></div>`,s+='<table class="w-100 text-center"><tbody>';for(let e=0;e<a.length;e++)""!=a[e]&&(s+=`<tr><td><p class="p-2 m-0">${getLocalizedString("NodeTier",""+(e+1))}</p></td><td><div class="selection-grid craft selection-grid-flex my-2">${a[e]}</div></td></tr>`,$("#ba-item-craftnodes").show());s+="</tbody></table>"}return fusionRecipe=find(data.crafting.Fusion,"ResultId",e+getItemIdOffset(t)),fusionRecipe.length>0&&(s+=`<div class="mb-2"><i>${translateUI("item_obtainedfrom_fusion")}</i></div>`,s+=`<div class="selection-grid craft selection-grid-flex my-2">${getFusionRecipeCardHTML(fusionRecipe[0])}</div>`,$("#ba-item-craftnodes").show()),s}function getItemConsumables(e){let t=["",""],a="";if(data.items.filter(e=>"ConsumeType"in e&&e.IsReleased[regionID]&&!e.ImmediateUse).forEach(a=>{const s=getServerProperty(a,"Contains");s.forEach(s=>{s[0]==e&&("Random"==a.ConsumeType?t[1]+=getDropIconHTML(a.Id,s[1],s[2],s[3]):t[0]+=getMaterialIconHTML(a.Id,0))})}),""!=t[0]||""!=t[1]){a+=`<div class="mb-2"><i>${translateUI("item_obtainedfrom_consumable")}</i></div>`,a+='<div class="item-icon-list">';for(let e=0;e<t.length;e++)""!=t[e]&&(a+=t[e],$("#ba-item-consumables").show());a+="</div>"}return a}function loadJSON(e,t){let a={},s=Object.entries(e).map((function(e){return $.getJSON(e[1],(function(t){a[e[0]]=t}))}));return Promise.all(s).then((function(){t(a)}))}function find(e,t,a){var s=[];return $.each(e,(function(e,i){i[t]==a&&s.push(i)})),s}function findOrDefault(e,t,a,s){var i=[],l=[];return $.each(e,(function(e,n){n[t]==a&&i.push(n),n[t]==s&&l.push(n)})),0==i.length?l:i}function getAttackTypeText(e){let t="";if("Mixed"==e)t=translateUI("attack_type_mixed_desc");else if("Normal"==e)t=translateUI("attack_type_normal_desc");else for(armorType in data.config.TypeEffectiveness[e]){if("Structure"==armorType)continue;if("ElasticArmor"==armorType&&2==regionID)continue;const a=data.config.TypeEffectiveness[e][armorType]/1e4;1!=a&&(t+=""==t?"":"\n",t+=translateUI("attack_type_desc",[a,`<b class='ba-col-${armorType.toLowerCase()}'>${getLocalizedString("ArmorTypeLong",armorType)}</b>`]))}return t}function getDefenseTypeText(e){let t="";if("Mixed"==e)t=translateUI("defense_type_mixed_desc");else if("Normal"==e)t=translateUI("defense_type_normal_desc");else for(bulletType in data.config.TypeEffectiveness){if("Sonic"==bulletType&&2==regionID)continue;const a=data.config.TypeEffectiveness[bulletType][e]/1e4;1!=a&&(t+=""==t?"":"\n",t+=translateUI("defense_type_desc",[a,`<b class='ba-col-${bulletType.toLowerCase()}'>${getLocalizedString("BulletType",bulletType)}</b>`]))}return t}function setAttackTypeClass(e,t){e.removeClass("bg-atk-normal bg-atk-explosion bg-atk-pierce bg-atk-mystic bg-atk-sonic bg-atk-mixed").addClass(`bg-atk-${t.toLowerCase()}`)}function setDefenseTypeClass(e,t){e.removeClass("bg-def-lightarmor bg-def-heavyarmor bg-def-unarmed bg-def-normal bg-def-elasticarmor bg-def-mixed").addClass(`bg-def-${t.toLowerCase()}`)}function getSkillText(e,t,{renderBuffs:a=!0,bulletType:s=null,emphasiseChange:i=!1,renderSkillHits:l=!0}){let n=e.Desc;const r=/[0-9.]+(?:%|s|秒|초| วินาที)/g,o=/<kb:(\d+)>/g;n=n.replace(r,(function(e){return`<strong>${e}</strong>`})),n=n.replace(o,(function(a,s){const i=e.Effects.filter(e=>"Knockback"==e.Type)[s-1];return`<strong>${2*i.Scale[t-1]}</strong>`}));const d=null==s?"ba-col-emphasis":`ba-col-${s.toLowerCase()}`;let c={},u={};if("Effects"in e&&e.Effects.filter(e=>"HitsParameter"in e).forEach(e=>{"HitFrames"in e?(c[e.HitsParameter]=[],"Hits"in e?e.HitFrames.forEach(t=>c[e.HitsParameter].push(...e.Hits)):e.HitFrames.forEach(t=>c[e.HitsParameter].push(1e4))):c[e.HitsParameter]=e.Hits,u[e.HitsParameter]=[...e.Scale]}),"Parameters"in e)for(let a=1;a<=e.Parameters.length;a++)for(;n.includes(`<?${a}>`);)if(i)n=1==t&&e.Parameters[a-1][t-1]!=e.Parameters[a-1][t]||t>1&&e.Parameters[a-1][t-1]!=e.Parameters[a-1][t-2]?n.replace(`<?${a}>`,`<span class="${d}">${e.Parameters[a-1][t-1]}</span>`):n.replace(`<?${a}>`,e.Parameters[a-1][t-1].replace(r,(function(e){return`<strong>${e}</strong>`})));else if(l&&a in c){let i;i=a in u?u[a][t-1]:100*parseFloat(e.Parameters[a-1][t-1].replace("%","")),n=n.replace(`<?${a}>`,`<span class="${d} skill-hitinfo" data-bs-toggle="tooltip" data-bs-placement="top" title="${getBasicTooltip(getSkillHitsText(c[a],i,s.toLowerCase()))}">${e.Parameters[a-1][t-1]}</span>`)}else n=n.replace(`<?${a}>`,`<span class="${d}">${e.Parameters[a-1][t-1]}</span>`);return n=replaceBuffPlaceholders(n,a),n}function replaceBuffPlaceholders(e,t=!0){let a=e;const s=["Buff","Debuff","CC","Special"];return s.forEach(e=>{const s=new RegExp(`<${e.slice(0,1).toLowerCase()}:(\\w+)(?:='([^']*)')?>`,"g");a=t?a.replace(s,(function(t,a,s){return getBuffTag(e,a,{tooltip:!0,overrideName:s||null})})):a.replace(s,(function(t,a,s){const i=e+"_"+a;return`<b>${s||getLocalizedString("BuffName",i)}</b>`}))}),a}function getBuffTag(e,t,{tooltip:a,overrideName:s=null}){const i=`${e}_${t}`;return`<span class="ba-skill-${e.toLowerCase()}" ${a?`data-bs-toggle="tooltip" data-bs-placement="top" title="${getRichTooltip(`images/buff/${i}.webp`,getLocalizedString("BuffNameLong",i),getLocalizedString("BuffType",e),null,getLocalizedString("BuffTooltip",i),30)}"`:""}><img class="buff-icon" src="images/buff/${i}.webp"><span class="buff-label">${null!==s?s:getLocalizedString("BuffName",i)}</span></span>`}function getSkillHitsText(e,t,a){let s={},i="";return e.forEach(e=>{e=parseFloat((e/1e4*(t/100)).toFixed(1))+"%",s[e]=s[e]?s[e]+1:1}),Object.keys(s).forEach(e=>{i+=`${""==i?"":"\n"}<span class='ba-col-${a}'>${e}</span> <b>&times;${s[e]}</b>`}),translateUI("skill_hits_tooltip",[`<b>${e.length}</b>`])+`\n<small>${i}</small>`}function getSkillHits(e){if(!e||!e.Effects)return 0;const t=e.Effects.find(e=>("DMGMulti"==e.Type||"DMGZone"==e.Type)&&void 0!==e.Hits);return void 0===t?void 0!==e.Effects.find(e=>"DMGSingle"==e.Type)?1:0:t.Hits.length}function getNormalAttackHitsText(e,t,a,s){let i={},l="",n;switch(e.forEach(e=>{e=parseFloat((e/1e4*100).toFixed(1))+"%",i[e]=i[e]?i[e]+1:1}),Object.keys(i).forEach(e=>{l+=`${""==l?"":"\n"}<span class='ba-col-${s}'>${e}</span> <b>&times;${i[e]}</b>`}),a){case"GL":case"RL":case"MT":case"Cannon":n=translateUI("stat_ammocount_tooltip_area",[`<b>${t}</b>`,`<b>${e.length}</b>`]);break;case"RG":n=translateUI("stat_ammocount_tooltip_line",[`<b>${t}</b>`,`<b>${e.length}</b>`]);break;case"FT":n=translateUI("stat_ammocount_tooltip_fan",[`<b>${t}</b>`,`<b>${e.length}</b>`]);break;default:n=translateUI("stat_ammocount_tooltip",[`<b>${t}</b>`,`<b>${e.length}</b>`])}return n+`\n<small>${l}</small>`}function getRichTooltip(e,t,a,s,i,l=50,n=""){var r="<span class='ba-tooltip'>";return r+="<div class='ba-tooltip-header'>",null!=e&&(r+=`<div class='ba-tooltip-img'><img class='${n}' src='${e}' width='${l}' height='${l}'></div>`),r+=`<div class='flex-fill d-flex flex-column'><div class='flex-fill d-flex flex-column justify-content-center'><div class='ba-tooltip-title'>${t.replace(/\"/g,"&quot;")}</div></div>`,null==a&&null==s||(r+="<div class='d-flex align-items-center mt-auto'>",r+=null!=a?`<span class='ba-tooltip-subtitle flex-fill'>${a}</span>`:"",r+=null!=s?`<span class='ba-tooltip-rarity text-bold'>${s}</span>`:"",r+="</div>"),r+="</div></div>",null!=i&&""!=i&&(r+=`<div class='ba-tooltip-body'>${i.replace(/\"/g,"&quot;")}</div>`),r+="</span>"}function getBasicTooltip(e){var t="<span class='ba-tooltip'>";return t+="<div class='ba-tooltip-header m-0'>",t+=`<div class='d-flex justify-content-center w-100'><div class='ba-tooltip-title text-center fs-6'>${e}</div></div>`,t+="</div>",t+="</span>"}function abbreviateNumber(e){for(var t=e,a=0,s=["","K","M","B"];t>=1e3;)a++,t/=1e3;return t+s[a]}function toggleDarkTheme(e){darkTheme=e,$("#ba-navbar-themeswitcher button").removeClass("active"),$(`#ba-navbar-themeswitcher-${e}`).addClass("active"),localStorage.setItem("theme",e),pixelMode&&(pixelMode=!1,localStorage.setItem("cheat_code",!1),loadModule(loadedModule)),applyThemeToBody(e)}function setPixelTheme(){$("#ba-navbar-themeswitcher button").removeClass("active"),applyThemeToBody("pixel")}function applyThemeToBody(e){if("pixel"==e)$("body").toggleClass("pixel",!0),$("body").toggleClass("theme-dark",!1),$('meta[name="theme-color"]').attr("content","#21009c"),$("#ba-navbar-logo").html("<img src='./images/logo_pixel.png'>");else{$("#ba-navbar-logo").load("./images/logo_schalegg.svg");const t="auto"==e?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==e;$("body").toggleClass("pixel",!1),$("body").toggleClass("theme-dark",t),$('meta[name="theme-color"]').attr("content",t?"#212529":"#dee2e6")}}function toggleHighContrast(e){highContrast=e,$("#ba-navbar-contrast-toggle button").removeClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),localStorage.setItem("high_contrast",highContrast),$("body").toggleClass("high-contrast",highContrast)}function changeRegion(e){e!=regionID&&(json_server_list=getServerJSONList(e),loadJSON(json_server_list,e=>{data=Object.assign(data,e)}).then((function(t){$(`#ba-navbar-regionselector-${regionID}`).removeClass("active"),regionID=e,region=data.config.Regions[regionID],localStorage.setItem("region",regionID),$("#ba-navbar-regionselector span").text($(`#ba-navbar-regionselector-${regionID} span`).text()),$(`#ba-navbar-regionselector-${regionID}`).addClass("active"),EnemyFinder.generateEnemyList(),populateStudentSkillFilters(),studentStatsList=null,loadModule(loadedModule)}),(function(e){console.error(e)})))}function populateStudentSkillFilters(){passiveStatList=[],weaponPassiveStatList=[],subStatList=[];let e=new Set,t=new Set;search_options.filterSelect.PassiveBuff=[],search_options.filterSelect.WeaponPassiveBuff=[],search_options.filterSelect.SubBuff=[],studentList.forEach(a=>{if(a.IsReleased[regionID]){for(skill of a.Skills)switch(skill.SkillType){case"passive":skill.Effects.forEach(e=>{const t=e.Stat.split("_")[0];passiveStatList.includes(t)||passiveStatList.push(t)});break;case"weaponpassive":skill.Effects.forEach(e=>{const t=e.Stat.split("_")[0];weaponPassiveStatList.includes(t)||weaponPassiveStatList.push(t)});break;default:skill.Effects.filter(e=>e.Type.startsWith("Buff")).forEach(a=>{const s=a.Stat.split("_")[0];"BuffTarget"==a.Type?t.add(s):e.add(s)})}"Support"==a.SquadType&&a.Skills.find(e=>"sub"==e.SkillType).Effects.forEach(e=>{const t=e.Stat.split("_")[0];subStatList.includes(t)||subStatList.push(t)})}});const a=(e,t)=>getLocalizedString("Stat",e).localeCompare(getLocalizedString("Stat",t));passiveStatList=passiveStatList.sort(a),subStatList=subStatList.sort(a),weaponPassiveStatList=weaponPassiveStatList.sort(a),studentBuffStatFilters=[...e].sort(a),enemyBuffStatFilters=[...t].sort(a)}function changeLanguage(e){e!=userLang&&(json_lang_list=getLanguageJSONList(e.toLowerCase()),loadJSON(json_lang_list,e=>{data=Object.assign(data,e)}).then((function(t){setSortedDataLists(),EnemyFinder.generateEnemyList(),populateStudentSkillFilters(),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).removeClass("active"),$("body").removeClass(`font-${userLang.toLowerCase()}`),userLang=e,delete data.voice,localStorage.setItem("language",e),$("#ba-navbar-languageselector span").text($(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).text()),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).addClass("active"),loadModule(loadedModule)}),(function(e){console.error(e)})))}function loadLanguage(e){$("body").addClass(`font-${e.toLowerCase()}`),$("*[data-localize-id]").each((function(e,t){let[a,s]=$(t).data("localize-id").split(",");if($(t).data("localize-replacement-id")){let[e,i]=$(t).data("localize-replacement-id").split(",");$(t).html(getLocalizedString(a,s,[getLocalizedString(e,i)]))}else $(t).html(getLocalizedString(a,s))})),$("*[data-ph-localize-id]").each((function(e,t){let a=$(t).data("ph-localize-id").split(",")[0],s=$(t).data("ph-localize-id").split(",")[1];$(t).attr("placeholder",getLocalizedString(a,s))})),$("*[data-tooltip-id]").each((function(e,t){let a=$(t).data("tooltip-id").split(",")[0],s=$(t).data("tooltip-id").split(",")[1];$(t).tooltip({title:getBasicTooltip(getLocalizedString(a,s)),placement:"top",html:!0})}));const t=duration((new Date).getTime()/1e3-data.config.build)[0];$("#navbar-version").text(`v${cache_ver} - ${translateUI("version_lastupdated",[new Date(1e3*data.config.build).toLocaleString([],{year:"numeric",month:"numeric",day:"numeric"}),0==t?"<1":t])}`),$("#ba-navbar-regionselector span").text($(`#ba-navbar-regionselector-${regionID} span`).text())}function getRarityStars(e){switch(e){case"N":case"R":case 1:return"<i class='fa-solid fa-star'></i>".repeat(1);case"SR":case 2:return"<i class='fa-solid fa-star'></i>".repeat(2);case"SSR":case 3:return"<i class='fa-solid fa-star'></i>".repeat(3)}}function getRarityTier(e){return`<i class='fa-solid fa-circle me-2 col-item-${e.toLowerCase()}'></i>${e}`}function searchContains(e,t){if("En"!=userLang){if(t.toLowerCase().includes(e))return!0}else{let a=(t=t.replace("&#x27;","").replace("&quot;","").replace("&amp;","&")).toLowerCase().replace(/['"!\?<>\(\)\.\-]/g,""),s=e.toLowerCase().replace(/['"!\?<>\(\)\.\-]/g,"");if(a.startsWith(s))return!0;for(;a.includes(" ");)if(a=a.substring(a.indexOf(" ")+1),a.startsWith(s))return!0}return!1}function allSearch(){let e=$("#ba-navbar-search").val().toLowerCase();if("uuddlrlrba"==e&&(pixelMode=!0,localStorage.setItem("cheat_code",!0),setPixelTheme(),loadModule(loadedModule),e="",$("#ba-navbar-search").val("")),$("#navbar-search-results").scrollTop(0),""==e)return $("#navbar-search-results").html("").hide(),$("#navbar-search").removeClass("has-text"),$("#ba-navbar-search").removeClass("results-open"),$("#navbar-search-clear").hide(),searchResultsCount=0,searchResultsSelection=0,!0;$("#navbar-search-clear").show(),$("#navbar-search").addClass("has-text"),$("#navbar-search-results").html("").show();let t=[],a=25;if($.each(data.students,(function(a,s){if(s.IsReleased[regionID]&&!s.StyleId&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/student/icon/"+s.Id+".webp",type:translateUI("student"),rarity:"",rarity_text:getRarityStars(s.StarGrade),onclick:`loadStudent('${s.PathName}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.raids.Raid,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:`images/raid/icon/Icon_${s.PathName}.png`,type:getLocalizedString("StageType","Raid"),rarity:"",rarity_text:"",onclick:`loadRaid(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.raids.WorldRaid,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:`images/raid/icon/Icon_${s.PathName}.png`,type:getLocalizedString("StageType","WorldRaid"),rarity:"",rarity_text:"",onclick:`loadRaid(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.raids.MultiFloorRaid,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name")+` (${getLocalizedString("ArmorTypeLong",s.ArmorType)})`,icon:`images/raid/icon/Icon_${s.PathName}.png`,type:getLocalizedString("StageType","MultiFloorRaid"),rarity:"",rarity_text:"",onclick:`loadRaid(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.items,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/item/icon/"+s.Icon+".webp",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:getRarityTier(s.Rarity),onclick:`loadItem(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.furniture,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/furniture/icon/"+s.Icon+".webp",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:getRarityStars(s.Rarity),onclick:`loadItem(${s.Id+1e6})`}),t.length>=25))return!1})),t.length<25&&$.each(data.equipment,(function(a,s){if(s.IsReleased[regionID]&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/equipment/icon/"+s.Icon+".webp",type:getLocalizedString("ItemCategory",s.Category),rarity:s.Rarity,rarity_text:s.Id>=1e3?`T${s.Tier}`:getRarityTier(s.Rarity),onclick:`loadItem(${s.Id+2e6})`}),t.length>=25))return!1})),t.length<25&&$.each(data.crafting.Nodes,(function(a,s){if(s.Weight>0&&searchContains(e,getTranslatedString(s,"Name"))&&(t.push({name:getTranslatedString(s,"Name"),icon:"images/ui/"+s.Icon+".png",type:getLocalizedString("NodeTier",s.Tier),rarity:`node-${s.Quality}`,rarity_text:getLocalizedString("NodeQuality",s.Quality),onclick:`loadCraft(${s.Id})`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.Campaign,(function(a,s){let i=getStageName(s,"Campaign"),l=getStageTitle(s,"Campaign");if(s.Area<=region.CampaignMax&&(searchContains(e,i)||searchContains(e,l))&&(t.push({name:l,icon:"images/campaign/"+getStageIcon(s,"Campaign")+".png",type:i,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.WeekDungeon,(function(a,s){let i=getStageName(s,"WeekDungeon"),l=getStageTitle(s,"WeekDungeon");if(stageIsReleased(s)&&(searchContains(e,i)||searchContains(e,l))&&(t.push({name:l,icon:"images/campaign/"+getStageIcon(s,"WeekDungeon")+".png",type:i,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.SchoolDungeon,(function(a,s){let i=getStageName(s,"SchoolDungeon"),l=getStageTitle(s,"SchoolDungeon");if(stageIsReleased(s)&&(searchContains(e,i)||searchContains(e,l))&&(t.push({name:l,icon:"images/campaign/"+getStageIcon(s,"SchoolDungeon")+".png",type:getLocalizedString("StageType",s.Type),rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length<25&&$.each(data.stages.Event,(function(a,s){let i=s.Field?"Field":"Event",l=getStageName(s,i),n=l.replace("\n"," "),r=getStageTitle(s,i);if(region.Events.includes(s.EventId)&&(searchContains(e,n)||searchContains(e,r))&&(t.push({name:r,icon:"images/campaign/"+getStageIcon(s,i)+".png",type:l,rarity:"",rarity_text:"",onclick:`loadStage('${s.Id}')`}),t.length>=25))return!1})),t.length>0){let e="<div>";for(let a=0;a<t.length;a++)e+=`<div id="ba-search-result-item-${a+1}" class="ba-search-result-item" onclick="${t[a].onclick}; $('#navbar-search-clear').trigger('click');">\n            <div class='ba-search-img'><img src='${t[a].icon}' class='ba-item-${t[a].rarity.toLowerCase()}'></div>\n            <div class='flex-fill d-flex flex-column' style="min-width:0;"><div class='flex-fill d-flex flex-column justify-content-center'><div class='ba-search-name'>${t[a].name}</div></div>\n            <div class='d-flex align-items-center mt-auto'>\n            <span class='ba-search-subtitle flex-fill'>${t[a].type}</span>\n            <span class='ba-search-rarity'>${t[a].rarity_text}</span></div></div></div>`;e+="</div>",$("#navbar-search-results").html(e),$("#ba-navbar-search").addClass("results-open"),searchResultsCount=t.length,searchResultsSelection=0}else $("#navbar-search-results").hide(),$("#ba-navbar-search").removeClass("results-open"),searchResultsCount=0,searchResultsSelection=0}function searchNavigate(e){switch(e.code){case"Enter":e.preventDefault(),"keyup"==e.type&&(0==searchResultsSelection&&searchResultsCount>0?$("#ba-search-result-item-1").trigger("onclick"):$("#ba-search-result-item-"+searchResultsSelection).trigger("onclick"));break;case"ArrowDown":e.preventDefault(),"keydown"==e.type&&searchResultsSelection<searchResultsCount&&(searchResultsSelection++,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected"),$(`#ba-search-result-item-${searchResultsSelection}`)[0].scrollIntoView({behavior:"auto",block:"nearest"}));break;case"ArrowUp":e.preventDefault(),"keydown"==e.type&&searchResultsSelection>1&&(searchResultsSelection--,$(".ba-search-result-item").removeClass("selected"),$("#ba-search-result-item-"+searchResultsSelection).addClass("selected"),$(`#ba-search-result-item-${searchResultsSelection}`)[0].scrollIntoView({behavior:"auto",block:"nearest"}));break;case"Escape":e.preventDefault(),$("#navbar-search-clear").trigger("click")}}function getLocalizedString(e,t,a=[]){return data.localization.hasOwnProperty(e)&&data.localization[e].hasOwnProperty(t)?formatString(data.localization[e][t],a):(console.log(`Localization not defined for "${e}, ${t}"`),`${e}_${t}`)}function translateUI(e,t=[]){return getLocalizedString("ui",e,t)}function getTranslatedString(e,t){return e[t]?e[t]:e[t+userLang]?e[t+userLang]:e[t+"En"]?e[t+"En"]:e[t+"Jp"]?e[t+"Jp"]:(console.log(`No translations defined for "${e}.${t}"`),"")}function getCacheVerResourceName(e){return e+"?v="+cache_ver}function stageIsReleased(e){return e.Id>8e6?region.Events.includes(e.EventId):e.Id>1e6?!(e.Area>region.CampaignMax)&&!(!region.CampaignExtra&&"A"==e.Stage):e.Id>6e4?e.Stage<=region.SchoolDungeonMax:e.Id>32e3?e.Stage<=region.BloodMax:e.Id>31e3?e.Stage<=region.FindGiftMax:e.Id>3e4&&e.Stage<=region.ChaserMax}function changeStudentSummon(e,t=!0){if(statPreviewSelectedChar=e,statPreviewViewSupportStats&&statPreviewSelectedChar>0&&toggleStrikerBonus(),compareMode&&(compareMode=!1,updateCompareModeControl()),$(".summon-list .dropdown-item").removeClass("active"),$(`.summon-list .dropdown-item[data-summon-id="${e}"]`).addClass("active"),statPreviewSelectedChar>0){const t=find(data.summons,"Id",student.Summons[e-1].Id)[0],a=find(student.Skills,"SkillType",student.Summons[e-1].SourceSkill)[0];$(".summon-list .active-name").html(getTranslatedString(t,"Name")),$(".summon-list .active-icon img").attr("src",`images/skill/${a.Icon}.webp`).addClass(`bg-skill ${student.BulletType.toLowerCase()}`)}else $(".summon-list .active-name").html(getTranslatedString(student,"Name")),$(".summon-list .active-icon img").attr("src",`images/student/icon/${student.Id}.webp`).removeClass("bg-skill explosion pierce mystic sonic");student.TSAId&&find(data.students,"Id",student.TSAId)[0].IsReleased[regionID]&&$("#statpreview-tsastats").toggle(statPreviewSelectedChar>0),updateSummonSourceSkill(),t&&(initCharacterSkillInfo(),recalculateStats())}function changeSkillPreviewTerrain(e,t=!0){statPreviewTerrain!=e&&(statPreviewTerrain=e,t&&recalculateStats()),$(".terrain-list .dropdown-item").removeClass("active"),$(`.terrain-list .dropdown-item[data-terrain="${e}"]`).addClass("active"),$(".terrain-list .terrain-list-active-name").text(getLocalizedString("AdaptationType",e)),$(".terrain-list .terrain-list-active-icon").attr("src",`images/ui/Terrain_${e}.png`)}function updateCompareModeControl(){$(".comparemode-on").toggle(compareMode),$("#ba-student-stat-table").toggleClass("compare",compareMode),$("#ba-statpreview-status-compare").toggleClass("deactivated",!compareMode),compareMode?($("#ba-statpreview-status-title-compare").html(getTranslatedString(studentCompare,"Name")),$("#ba-statpreview-status-title-compare-icon").attr("src",`images/student/icon/${studentCompare.Id}.webp`).removeClass("bg-skill explosion pierce mystic sonic"),$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_compare_remove")),placement:"top",html:!0})):$("#ba-statpreview-status-compare").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_compare")),placement:"top",html:!0})}function openStudentComparison(){compareMode?(compareMode=!1,updateCompareModeControl(),recalculateStats()):($("#student-select-grid .selection-grid-card.disabled").removeClass("disabled"),$(`#student-select-${student.Id}`).addClass("disabled"),selectCompareMode=!0,studentSelectorModal.show())}function drawHexamap(e,t){$(t).empty();const a=90;let s=99,i=99,l=-99,n=-99,r=999999,o=0,d=50;e.HexaMap.forEach(e=>{s=Math.min(s,e.Pos[0]),i=Math.min(i,e.Pos[1]),n=Math.max(n,e.Pos[0]),l=Math.max(l,e.Pos[1])}),e.HexaMap.forEach(e=>{let t=e.Pos[0]-s,a=e.Pos[1]-i;r=Math.min(r,90*t+90*a*.5),o=Math.max(o,90+90*t+90*a*.5)});let c=new Array(e.HexaMap.length).fill(0),u=0;e.HexaMap.forEach((a,n)=>{let d=a.Pos[0]-s,g=a.Pos[1]-i;const p=90*d+90*g*.5-r,m=g*Math.sqrt(3*Math.pow(45,2))+50,f=[102101,902101,903108],h=[102201,903101];let v="",b="";if(void 0!==a.Trigger&&(f.includes(e.HexaMap[a.Trigger].Entity)||h.includes(e.HexaMap[a.Trigger].Entity))&&0==c[n]&&0==c[a.Trigger]&&(u++,c[n]=u,c[a.Trigger]=u),"Entity"in a)if(a.Entity>1e8){let t=find(e.Formations,"Id",a.Entity)[0],s;if(v+=`<img class="ba-stage-map-enemy" src="images/enemy/${t.MapIcon}.webp" style="z-index:${g}">`,v+='<div class="map-info">',b=` onclick="populateMapEnemyList(${a.Entity});" `,"Guard"==t.MoveType?v+='<span class="move-type guard"><i class="fa-solid fa-triangle-exclamation"></i></span>':"Pursuit"==t.MoveType&&(v+='<span class="move-type pursuit"><i class="fa-solid fa-angles-left"></i></span>'),v+=`<span class="def-type bg-def-${find(data.enemies,"Id",t.EnemyList[0])[0].ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="height:100%;"></span>`,v+="</div>","Grade"==t.UnitGrade.slice(0,5)){let e;v+=`<span class="unit-grade"><span class="grade">RANK<img src="images/ui/Strategy_Icon_EnemyRank_${parseInt(t.UnitGrade.slice(-1))}.png"></span></span>`}else"Boss"==t.UnitGrade&&(v+='<span class="unit-grade boss"></span>')}else if(a.Entity>1e6){let e;v+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(getTranslatedString(find(data.currency,"Id",4)[0],"Name")+" &times;50")}"><i class="fa-solid fa-gift"></i></span>`}else switch(a.Entity){case 101101:case 101102:case 101103:case 101104:case 101105:v+='<span class="start-tile"></span>';break;case 102101:case 902101:case 903108:v+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_spawn"))}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);"></i></span>`;break;case 103101:case 103102:v+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_drone"))}"><i class="fa-solid fa-eye"></i></span>`;break;case 102201:case 903101:v+=`<span class="tile-icon" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_remove"))}"><i class="fa-solid fa-shoe-prints" style="transform:rotate(315deg);font-size: 20px;"></i><i class="fa-solid fa-ban" style="position: absolute;font-size: 38px;"></i></span>`;break;case 104101:case 104102:v+=`<span class="tile-icon group-${a.Entity-104100}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_twoway"))}"><i class="fa-solid fa-up-long"></i><i class="fa-solid fa-down-long"></i></span>`;break;case 105101:case 105201:v+=`<span class="tile-icon group-${(a.Entity-105001)/100+2}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_oneway_entrance"))}"><i class="fa-solid fa-up-long"></i></span>`;break;case 105102:case 105202:v+=`<span class="tile-icon group-${(a.Entity-105002)/100+2}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_teleport_oneway_exit"))}"><i class="fa-solid fa-down-long"></i></span>`;break;case 106101:v+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_food"))}"><i class="fa-solid fa-bowl-rice"></i></span>`;break;case 107101:v+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_atk"))}"><i class="fa-solid fa-gun"></i></span>`;break;case 107201:v+=`<span class="tile-item" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_item_def"))}"><i class="fa-solid fa-shield"></i></span>`;break;case 109201:case 109202:case 109203:v+=`<span class="tile-icon lowered group-${a.Entity-109200}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_down"))}"><i class="fa-solid fa-chevron-up" style="margin-top: 12px;"></i></span>`;break;case 109204:case 109205:case 109206:v+=`<span class="tile-icon raised group-${a.Entity-109200-3}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_up"))}"><i class="fa-solid fa-chevron-down"></i></span>`;break;case 109301:case 109302:case 109303:v+=`<span class="tile-icon switch-tile lowered group-${a.Entity-109300}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_target_down"))}"></span>`;break;case 109304:case 109305:case 109306:v+=`<span class="tile-icon switch-tile group-${a.Entity-109300-3}" style="z-index:${g}" title="${getBasicTooltip(translateUI("maptile_switch_target_up"))}"></span>`}v=`<div class="ba-stage-map-tile map-tile-${n} ${void 0!==a.Trigger&&f.includes(e.HexaMap[a.Trigger].Entity)?"hidden-tile":""} ${a.Type.startsWith("DisposableTileObject")?"cracked-tile":""}" ${b} style="left:${p}px;top:${m.toFixed(0)}px;${""!=b?"cursor:pointer;":""}">${v}</div>`,$(t).css("width",`${o-r}px`),$(t).css("height",`${150+(l-i)*Math.sqrt(3*Math.pow(45,2))}px`),$(t).append(v),$(".tile-icon, .tile-item").tooltip({html:!0})}),c.forEach((e,t)=>{$(`.map-tile-${t}`).addClass(`group-${e}`)})}function makeDraggable(e){$(e).on("mousedown",t=>{$(e).toggleClass("scrolling",!0),scrolling=!0,scrollPosition={left:e.scrollLeft(),top:e.scrollTop(),x:t.clientX,y:t.clientY}}),$(e).on("mouseleave",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mouseup",t=>{scrolling=!1,$(e).toggleClass("scrolling",!1)}),$(e).on("mousemove",t=>{t.preventDefault(),scrolling&&($(e).scrollLeft(scrollPosition.left-(t.clientX-scrollPosition.x)),$(e).scrollTop(scrollPosition.top-(t.clientY-scrollPosition.y)))})}function openStageMapModal(){drawHexamap(loadedStage,"#ba-stage-modal-map-canvas"),$("#ba-stage-modal-map .modal-title").text($("#ba-stage-name").text()),stageMapModal.show()}function changeConquestMap(e){drawConquestHexamap(loadedConquest,e,"#ba-conquest-map-canvas")}function drawConquestHexamap(e,t,a){$(a).empty(),filteredTiles=e.Maps[t].Tiles;const s=90,i=90,l=15;let n=99,r=99,o=-99,d=-99;const c=20,u=20;let g=999999,p=0,m="VeryHard"==e.Maps[t].Difficulty?60:120;filteredTiles.forEach(e=>{n=Math.min(n,e.Pos[0]),r=Math.min(r,e.Pos[1]),d=Math.max(d,e.Pos[0]),o=Math.max(o,e.Pos[1])}),filteredTiles.forEach(e=>{let t=e.Pos[0]-n,a=e.Pos[1]-r;g=Math.min(g,90*t+Math.max(15*(t+.5*a),0)+90*a*.5),p=Math.max(p,90+90*t+Math.max(15*(t+.5*a),0)+90*a*.5)}),filteredTiles.sort((e,t)=>e.Pos[1]-t.Pos[1]).forEach((t,s)=>{let i=t.Pos[0]-n,l=t.Pos[1]-r,d=!1;const c=20+90*i+Math.max(15*(i+.5*l),0)+90*l*.5-g,u=l*Math.sqrt(3*Math.pow(45,2))+m;let f="",h="",v=0;if("Start"==t.Type&&(f+='<span class="start-tile"></span>'),t.StageId){const e=find(data.stages.Conquest,"Id",t.StageId)[0],a=e.Formations[0];if(f+=`<img class="ba-stage-map-enemy" src="images/enemy/${a.MapIcon}.webp" style="z-index:${100+l}">`,f+='<div class="map-info">',h=` onclick="loadStage(${e.Id});" `,v=e.Id,"None"!=e.Team){const t=e.Team.replace("Team","");f+=`<span class="move-type team-${t}">${t}</span>`}let s;f+=`<span class="def-type bg-def-${find(data.enemies,"Id",a.EnemyList[0])[0].ArmorType.toLowerCase()}"><img src="images/ui/Type_Defense_s.png" style="height:100%;"></span>`,f+="</div>","Normal"==e.EnemyType||"Challenge"==e.EnemyType?f+=`<span class="unit-grade"><span class="grade">Lv. ${e.Level}</span></span>`:"Boss"==e.EnemyType?(f+='<span class="unit-grade boss"></span>',d=!0):"MiddleBoss"==e.EnemyType&&(f+='<span class="unit-grade leader"></span>')}f=`<div data-x="${i}" data-y="${l}" ${v>0?`data-stage-id="${v}" `:""} class="ba-stage-map-tile map-tile-${s} conquest-tile event-${e.EventId} conquest-tile-${d?"boss":t.Type.toLowerCase()} ${loadedStage.Id==v?"selected":""}" ${h} style="left:${c}px; top:${u.toFixed(0)-45*d}px; ${""!=h?"cursor:pointer;":""}">${f}</div>`,$(a).css("width",`${p-g+40}px`),$(a).css("height",`${m+40+90+(o-r)*Math.sqrt(3*Math.pow(45,2))}px`),$(a).append(f),$(".tile-icon, .tile-item").tooltip({html:!0})})}function getConquestManageString(e){switch(e){case 815:return translateUI("conquest_operate");case 822:return translateUI("conquest_analyze");default:return translateUI("conquest_operate")}}function toggleOwned(){student.Id in studentCollection?(delete studentCollection[student.Id],$("#ba-student-collection-btn").toggleClass("active",!1).html('<i class="fa-solid fa-circle-plus"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_add")),placement:"top",html:!0}),$(".btn-lock-attributes").hide()):(studentCollectionSave(),$("#ba-student-collection-btn").toggleClass("active",!0).html('<i class="fa-solid fa-circle-check"></i>'),$("#ba-student-collection-btn").tooltip("dispose").tooltip({title:getBasicTooltip(translateUI("tooltip_collection_remove")),placement:"top",html:!0}),$(".btn-lock-attributes").show(),lockedAttributes=!1),$("#ba-student-collection-btn").blur(),$(".btn-lock-attributes").toggleClass("deactivated",!lockedAttributes),$(".btn-lock-attributes i").toggleClass("fa-lock",lockedAttributes).toggleClass("fa-lock-open",!lockedAttributes),(search_options.filter.Collection.Owned||search_options.filter.Collection.NotOwned)&&updateStudentList(),localStorage.setItem("student_collection",JSON.stringify(studentCollection)),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0)}function changeCombatStyle(){student.LinkedCharacterId&&loadStudentById(student.LinkedCharacterId)}function studentCollectionSave(){studentCollection[student.Id]={s:statPreviewStarGrade,l:parseInt($("#ba-statpreview-levelrange").val()),e1:parseInt($("#ba-statpreview-gear1-range").val()),e2:parseInt($("#ba-statpreview-gear2-range").val()),e3:parseInt($("#ba-statpreview-gear3-range").val()),ws:statPreviewWeaponGrade,wl:parseInt($("#ba-statpreview-weapon-range").val()),b:parseInt($("#ba-statpreview-bond-0-range").val()),s3:parseInt($("#ba-statpreview-passiveskill-range").val()),pm:parseInt($("#ba-statpreview-potential-maxhp-range").val()),pa:parseInt($("#ba-statpreview-potential-attackpower-range").val()),ph:parseInt($("#ba-statpreview-potential-healpower-range").val()),lock:lockedAttributes};for(let e=1;e<=student_bondalts.length;e++)student_bondalts[e-1].Id in studentCollection&&!studentCollection[student_bondalts[e-1].Id].lock&&(studentCollection[student_bondalts[e-1].Id].b=parseInt($(`#ba-statpreview-bond-${e}-range`).val()));localStorage.setItem("student_collection",JSON.stringify(studentCollection))}function maxStudentAttributes(){statPreviewStarGrade=5,statPreviewLevel=region.StudentMaxLevel,$("#ba-statpreview-levelrange").val(statPreviewLevel),changeStatPreviewLevel(document.getElementById("ba-statpreview-levelrange"),!1),statPreviewIncludeEquipment=!0,statPreviewEquipment=[...region.EquipmentMaxLevel],$("#ba-statpreview-gear1-range").val(statPreviewEquipment[0]),$("#ba-statpreview-gear2-range").val(statPreviewEquipment[1]),$("#ba-statpreview-gear3-range").val(statPreviewEquipment[2]),changeGearLevel(1,document.getElementById("ba-statpreview-gear1-range"),!1),changeGearLevel(2,document.getElementById("ba-statpreview-gear2-range"),!1),changeGearLevel(3,document.getElementById("ba-statpreview-gear3-range"),!1),region.WeaponMaxLevel>0?(statPreviewWeaponGrade=3,statPreviewWeaponLevel=region.WeaponMaxLevel,$("#ba-statpreview-weapon-range").attr("max",region.WeaponMaxLevel).val(statPreviewWeaponLevel)):(statPreviewWeaponGrade=0,statPreviewWeaponLevel=0),changeStatPreviewStars(statPreviewStarGrade,statPreviewWeaponGrade,!1),statPreviewPassiveLevel=10,$("#ba-statpreview-passiveskill-range").val(statPreviewPassiveLevel),changeStatPreviewPassiveSkillLevel(document.getElementById("ba-statpreview-passiveskill-range"),!1);for(let e=0;e<=student_bondalts.length;e++)statPreviewBondLevel[e]=region.BondMaxLevel,$(`#ba-statpreview-bond-${e}-range`).val(statPreviewBondLevel[e]),changeStatPreviewBondLevel(e,!1),statPreviewIncludeBond[e]=!0;if("Released"in student.Gear&&student.Gear.Released[regionID]){const e=$("#ba-statpreview-gear4-range").attr("max");$("#ba-statpreview-gear4-range").val(e),changeExGearLevel(document.getElementById("ba-statpreview-gear4-range"),!1)}recalculateTerrainAffinity(),refreshStatTableControls(),recalculateStats()}function statPreviewSettingsSave(){let e={StarGrade:statPreviewStarGrade,WeaponGrade:statPreviewWeaponGrade,Level:statPreviewLevel,WeaponLevel:statPreviewWeaponLevel,Equipment:statPreviewEquipment,Potential:statPreviewPotentialLevel,BondLevel:statPreviewBondLevel,PassiveLevel:statPreviewPassiveLevel,ExLevel:statPreviewExLevel,GearLevel:statPreviewGearLevel,IncludePassive:statPreviewIncludePassive,IncludeBond:statPreviewIncludeBond,IncludeEquipment:statPreviewIncludeEquipment,IncludePotential:statPreviewIncludePotential,IncludeBuffs:statPreviewIncludeBuffs};localStorage.setItem("student_settings",JSON.stringify(e))}function statPreviewSettingsLoad(){let e={};localStorage.getItem("student_settings")&&(e=JSON.parse(localStorage.getItem("student_settings"))),statPreviewStarGrade=e.StarGrade?e.StarGrade:3,statPreviewWeaponGrade=e.WeaponGrade?e.WeaponGrade:0,statPreviewLevel=e.Level?e.Level:1,statPreviewWeaponLevel=e.WeaponLevel?e.WeaponLevel:1,statPreviewEquipment=e.Equipment?e.Equipment:[99,99,99],statPreviewPotentialLevel=e.Potential?e.Potential:{MaxHP:0,AttackPower:0,HealPower:0},statPreviewBondLevel=Array.isArray(e.BondLevel)?e.BondLevel:[20,20,20],statPreviewPassiveLevel=e.PassiveLevel?e.PassiveLevel:10,statPreviewExLevel=e.ExLevel?e.ExLevel:5,statPreviewGearLevel=e.GearLevel?e.GearLevel:0,statPreviewIncludePassive=!!e.IncludePassive&&e.IncludePassive,statPreviewIncludeBond=Array.isArray(e.IncludeBond)?e.IncludeBond:[!1,!1,!1],statPreviewIncludeEquipment=!!e.IncludeEquipment&&e.IncludeEquipment,statPreviewIncludePotential=!!e.IncludePotential&&e.IncludePotential,statPreviewIncludeBuffs=!!e.IncludeBuffs&&e.IncludeBuffs}function exportDataString(e){const t=btoa(JSON.stringify(studentCollection));$(e).val(t),navigator.clipboard.writeText(t),toastMessage(`<i class="fa-solid fa-circle-exclamation me-2"></i>${translateUI("toast_import_copy")}`,2500,"alert")}function parseImport(e){try{let t=JSON.parse(atob(e)),a={};return Object.entries(t).forEach(e=>{a[e[0]]={s:e[1].s,l:e[1].l,e1:e[1].e1,e2:e[1].e2,e3:e[1].e3,ws:e[1].ws,wl:e[1].wl,b:e[1].b,s3:e[1].s3,lock:void 0!==e[1].lock&&e[1].lock}}),a}catch(e){console.log(e)}try{let t=JSON.parse(e),a={};return t.characters.forEach(e=>{e.eleph.unlocked&&(a[e.id]={s:e.current.star,l:e.current.level,e1:Math.max(e.current.gear1,1),e2:Math.max(e.current.gear2,1),e3:Math.max(e.current.gear3,1),ws:e.current.ue,wl:e.current.ue_level,b:e.current.bond,s3:Math.max(e.current.passive,1),lock:!1})}),a}catch(e){console.log(e)}return null}function importCollection(e){null!=e&&(localStorage.setItem("student_collection",JSON.stringify(e)),studentCollection=JSON.parse(localStorage.getItem("student_collection")),toastMessage(`<i class="fa-solid fa-circle-check me-2"></i>${translateUI("toast_import_success",[Object.keys(studentCollection).length])}`,2500,"success"),"students"==loadedModule&&(loadStudent(student.PathName),$("#ba-student-search-filter-collection").toggle(Object.keys(studentCollection).length>0),(search_options.filter.Collection.Owned||search_options.filter.Collection.NotOwned)&&updateStudentList()))}function toastMessage(e,t,a){toastMessageTimeout&&clearTimeout(toastMessageTimeout),$("#toast-message").removeClass().addClass("p-2 ba-panel show").addClass(a).html(`<p class="m-0">${e}</p>`),toastMessageTimeout=window.setTimeout((function(){$("#toast-message").removeClass("show")}),t)}function showReleaseWarning(){toastMessage(`<i class="fa-solid fa-circle-exclamation me-2"></i>${translateUI("toast_release_warning")}`,4e3,"alert")}localStorage.getItem("theme")&&applyThemeToBody(localStorage.getItem("theme")),$("#ba-navbar-logo").html("<img src='./images/logo_pixel.png'>"),$.when($.ready,loadPromise).then((function(){"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js"),gtag("config","G-XQEWDXR13H",{custom_map:{dimension1:"user_language"}}),statPreviewSettingsLoad(),localStorage.getItem("student_collection")&&(studentCollection=JSON.parse(localStorage.getItem("student_collection"))),localStorage.getItem("enemy_bookmarks")&&(statPreviewEnemyBookmarks=JSON.parse(localStorage.getItem("enemy_bookmarks"))),localStorage.getItem("student_skill_ex_level")&&(skillPreviewExSkillLevel=JSON.parse(localStorage.getItem("student_skill_ex_level"))),localStorage.getItem("student_skill_other_level")&&(skillPreviewOtherSkillLevel=JSON.parse(localStorage.getItem("student_skill_other_level"))),localStorage.getItem("student_skill_show_summons")&&(skillPreviewShowSummonSkills=JSON.parse(localStorage.getItem("student_skill_show_summons")));let e=bootstrap.Tooltip.Default.allowList;e.ruby=[],e.rt=[],e.rp=[],loadRegion(regionID),setSortedDataLists(),EnemyFinder.generateEnemyList(),populateStudentSkillFilters(),darkTheme=localStorage.getItem("theme")?localStorage.getItem("theme"):"auto",pixelMode=!!localStorage.getItem("cheat_code")&&"true"==localStorage.getItem("cheat_code"),pixelMode?setPixelTheme():toggleDarkTheme(darkTheme),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{"auto"!=darkTheme||pixelMode||applyThemeToBody("auto")}),highContrast=localStorage.getItem("high_contrast")?"true"==localStorage.getItem("high_contrast"):!CSS.supports("backdrop-filter","blur(1px)")||window.matchMedia("(prefers-contrast: more)").matches,$("body").toggleClass("high-contrast",highContrast),$("body").on("click",".tooltip-button",e=>{"touch"==e.originalEvent.pointerType&&$(".tooltip").tooltip("hide")}).on("mouseleave",".tooltip-button",e=>{$(".tooltip").tooltip("hide")}),$("#ba-navbar-regionselector span").text(getLocalizedString("ServerName",""+regionID)),$(`#ba-navbar-regionselector-${regionID}`).addClass("active"),$("#ba-navbar-languageselector span").text($(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).text()),$(`#ba-navbar-languageselector-${userLang.toLowerCase()}`).addClass("active"),$(`#ba-navbar-contrast-toggle-${highContrast}`).addClass("active"),$("#ba-navbar-search").on("input",(function(){searchDelayTimeout&&clearTimeout(searchDelayTimeout),searchDelayTimeout=setTimeout(allSearch,100)})).on("keydown",searchNavigate).on("keyup",searchNavigate),$("#navbar-search-clear").on("click",(function(){$("#"+this.dataset.target).val("").trigger("blur"),allSearch(),$(this).hide()}));const t=new URL(window.location.href).searchParams,a=t.has("links");let s="";if($.each(data.config.Changelog,(function(e,t){s+=`<h5 class="text-emphasis px-2">${t.date}</h5>`,s+='<div class="p-2 mb-3">';for(let e=0;e<t.contents.length;e++)s+=`<div>${t.contents[e]}</div>`;s+="</div>"})),$("#modal-changelog-content").html(s),$("#modal-links").on("show.bs.modal",(function(e){let t="";data.config.links.forEach(e=>{t+=`<h4>${e.section}</h4>`,e.content.forEach(e=>{t+=`<p><a href="${e.url}">${e.title} <i class="fa-solid fa-external-link"></i></a> <small class="ms-1">by ${e.author}</small><br/>${e.description}</p>`})}),$("#modal-links-content").html(t)})),a)$("#modal-links").modal("show");else{const e=parseInt(data.config.Changelog[0].date.replace(/\//g,""));localStorage.getItem("changelog_seen")?e>parseInt(localStorage.getItem("changelog_seen"))&&($("#modal-changelog").modal("show"),localStorage.setItem("changelog_seen",e)):($("#modal-changelog").modal("show"),localStorage.setItem("changelog_seen",e))}if($(document).on("keydown",(function(e){if("Escape"===e.code&&($("input:focus").trigger("blur"),$("#ba-navbar-content").collapse("hide")),(e.ctrlKey||e.metaKey)&&"KeyK"===e.code&&(t(),e.preventDefault()),!$("input:focus").length)switch(e.code){case"Slash":t(),e.preventDefault();break;case"KeyL":"students"!==loadedModule||$("#ba-student-modal-students").hasClass("show")||$("#ba-student-modal-students").modal("show","shortcut"),e.preventDefault()}function t(){$("#ba-student-modal-students").hasClass("show")?$("#ba-student-search-text").trigger("focus"):($("#ba-navbar-content").collapse("show"),$("#ba-navbar-search").trigger("focus"))}})),$("#collection-import-string").on("input",(function(e){if(""!=$("#collection-import-string").val()){const e=parseImport($("#collection-import-string").val());null==e?($("#collection-import-status").html(`<i class="fa-solid fa-circle-xmark me-2 text-negative"></i>${translateUI("collection_import_status_invalid")}`),$("#collection-data-import-btn").attr("disabled",!0)):(console.log(e),$("#collection-import-status").html(`<i class="fa-solid fa-circle-check me-2 text-positive"></i>${translateUI("collection_import_status_valid",[Object.keys(e).length])}`),$("#collection-data-import-btn").attr("disabled",!1))}else $("#collection-import-status").empty(),$("#collection-data-import-btn").attr("disabled",!0)})),$("#collection-data-import-btn").on("click",(function(e){importCollection(parseImport($("#collection-import-string").val()))})),$("#collection-data-export-btn").on("click",(function(e){exportDataString("#collection-export-string")})),t.get("importcollection"))try{let e={};const a=t.get("importcollection").split("__");a.forEach(t=>{if(""!=t){const a=t.split("_");e[a[0]]={s:parseInt(a[1]),l:parseInt(a[2]),e1:parseInt(a[3]),e2:parseInt(a[4]),e3:parseInt(a[5]),ws:parseInt(a[6]),wl:parseInt(a[7]),b:parseInt(a[8]),s3:parseInt(a[9]),lock:!1}}}),importCollection(e)}catch(e){console.log(e),toastMessage(`<i class="fa-solid fa-circle-xmark me-2"></i>${translateUI("toast_import_failure")}`,2500,"failure")}$(window).on("popstate",()=>loadModuleFromURL(!1)),loadModuleFromURL(!0)}));